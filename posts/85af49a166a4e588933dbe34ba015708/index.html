<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker&#43;Nginx&#43;KeepaLived实现Nginx一主一从高可用 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/85af49a166a4e588933dbe34ba015708/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Docker&#43;Nginx&#43;KeepaLived实现Nginx一主一从高可用">
  <meta property="og:description" content="系统版本 Centos7
IP：10.10.11.79 Master
IP：10.10.11.81 Slave
虚拟ip：10.10.11.77
客户端发起一个请求 ，请求没有到Nginx的实际IP上，而是请求的虚拟IP(会和实际IP通过配置文件进行绑定）
如果有一台Nginx服务器挂了，Keepalived会自动在备Nginx服务器上选一台当主服务器
1. 主从两台机器上分别启动nginx容器： 两台nginx容器要用相同的端口号：
docker run -d --privileged=true --name keepalivedNginx -p 82:80 nanlist/nginx1.23.1:v1.0 2.在两台宿主机器上分别安装 keepalived （注意：keepalived安装在实体机上，不是安装到Docker容器中） 1.联网下载到/usr/local目录下并解压有可能会提示连接不成功,加上它提示的命令再下载就好了 如果下载不下来用浏览器下载下来再传到服务上面也可以
两台服务器分别执行下：
主：
[root@Master html]# cd /usr/local [root@Master local]# wget https://www.keepalived.org/software/keepalived-1.4.2.tar.gz [root@Master local]# tar -zxvf keepalived-1.4.2.tar.gz 从：
[root@Slave html]# cd /usr/local [root@Slave local]# wget https://www.keepalived.org/software/keepalived-1.4.2.tar.gz [root@Slave local]# tar -zxvf keepalived-1.4.2.tar.gz 2.安装相关依赖,有不用下载了 主：
[root@Master local]# yum install -y gcc openssl-devel popt-devel 从：
[root@Slave local]# yum install -y gcc openssl-devel popt-devel 3.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-02-20T13:27:46+08:00">
    <meta property="article:modified_time" content="2023-02-20T13:27:46+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker&#43;Nginx&#43;KeepaLived实现Nginx一主一从高可用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>系统版本 Centos7<br> IP：10.10.11.79 Master<br> IP：10.10.11.81 Slave<br> 虚拟ip：10.10.11.77</p> 
<p>客户端发起一个请求 ，请求没有到Nginx的实际IP上，而是请求的虚拟IP(会和实际IP通过配置文件进行绑定）<br> 如果有一台Nginx服务器挂了，Keepalived会自动在备Nginx服务器上选一台当主服务器</p> 
<h2><a id="1_nginx_8"></a>1. 主从两台机器上分别启动nginx容器：</h2> 
<p>两台nginx容器要用相同的端口号：</p> 
<pre><code>docker run -d --privileged=true --name keepalivedNginx -p 82:80 nanlist/nginx1.23.1:v1.0
</code></pre> 
<h2><a id="2_keepalived_keepalivedDocker_15"></a>2.在两台宿主机器上分别安装 keepalived （注意：keepalived安装在实体机上，不是安装到Docker容器中）</h2> 
<h3><a id="1usrlocal_17"></a>1.联网下载到/usr/local目录下并解压有可能会提示连接不成功,加上它提示的命令再下载就好了</h3> 
<p>如果下载不下来用浏览器下载下来再传到服务上面也可以<br> 两台服务器分别执行下：<br> 主：</p> 
<pre><code>[root@Master html]# cd /usr/local
[root@Master local]# wget https://www.keepalived.org/software/keepalived-1.4.2.tar.gz
[root@Master local]# tar -zxvf keepalived-1.4.2.tar.gz
</code></pre> 
<p>从：</p> 
<pre><code>[root@Slave html]# cd /usr/local
[root@Slave local]# wget https://www.keepalived.org/software/keepalived-1.4.2.tar.gz
[root@Slave local]# tar -zxvf keepalived-1.4.2.tar.gz
</code></pre> 
<h3><a id="2_33"></a>2.安装相关依赖,有不用下载了</h3> 
<p>主：</p> 
<pre><code>[root@Master local]# yum install -y gcc openssl-devel popt-devel
</code></pre> 
<p>从：</p> 
<pre><code>[root@Slave local]# yum install -y gcc openssl-devel popt-devel
</code></pre> 
<h3><a id="3_43"></a>3.编译安装</h3> 
<p>主：</p> 
<pre><code>[root@Master local]# cd keepalived-1.4.2
[root@Master keepalived-1.4.2]# ./configure --prefix=/usr/local/keepalived
[root@Master keepalived-1.4.2]# make
[root@Master keepalived-1.4.2]# make install
</code></pre> 
<p>从：</p> 
<pre><code>[root@Slave local]# cd keepalived-1.4.2
[root@Slave keepalived-1.4.2]# ./configure --prefix=/usr/local/keepalived
[root@Slave keepalived-1.4.2]# make
[root@Slave keepalived-1.4.2]# make install

</code></pre> 
<h3><a id="4_61"></a>4.相关配置,按命令执行</h3> 
<p>主：</p> 
<pre><code>[root@Master keepalived-1.4.2]# pwd
/usr/local/keepalived-1.4.2
You have new mail in /var/spool/mail/root
[root@Master keepalived-1.4.2]# cp /usr/local/keepalived-1.4.2/keepalived/etc/init.d/keepalived /etc/init.d/
[root@Master keepalived-1.4.2]# mkdir /etc/keepalived
[root@Master keepalived-1.4.2]# cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/
[root@Master keepalived-1.4.2]# cp /usr/local/keepalived-1.4.2/keepalived/etc/sysconfig/keepalived /etc/sysconfig/
[root@Master keepalived-1.4.2]# cp /usr/local/keepalived/sbin/keepalived /usr/sbin/

</code></pre> 
<p>从：</p> 
<pre><code>[root@Slave keepalived-1.4.2]# pwd
/usr/local/keepalived-1.4.2
You have new mail in /var/spool/mail/root
[root@Slave keepalived-1.4.2]# cp /usr/local/keepalived-1.4.2/keepalived/etc/init.d/keepalived /etc/init.d/
[root@Slave keepalived-1.4.2]# mkdir /etc/keepalived
[root@Slave keepalived-1.4.2]# cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/
[root@Slave keepalived-1.4.2]# cp /usr/local/keepalived-1.4.2/keepalived/etc/sysconfig/keepalived /etc/sysconfig/
[root@Slave keepalived-1.4.2]# cp /usr/local/keepalived/sbin/keepalived /usr/sbin/
[root@Slave keepalived-1.4.2]#

</code></pre> 
<h3><a id="_etckeepalived_keepalivedconf__89"></a>安装之后，在 /etc/keepalived目录下有个 keepalived.conf 配置文件：</h3> 
<p>主：</p> 
<pre><code>vim /etc/keepalived/keepalived.conf
</code></pre> 
<p>编辑内容：</p> 
<pre><code>global_defs {  
	router_id LVS_DEVEL 
}  

# 检查nginx状态的脚本，健康监测脚本
vrrp_script chk_nginx {
	script "/etc/keepalived/nginx_check.sh" # 脚本路径
	interval 2 # 脚本执行间隔时间
	weight -20
}
  
vrrp_instance VI_1 {  
    state MASTER  
    interface ens192  # 当前进行vrrp通讯的网络接口卡(当前centos的网卡) 用ifconfig查看你具体的网卡
    virtual_router_id 51  # 虚拟路由编号，主从要一至
    priority 150 # 优先级，数值越大，获取处理请求的优先级越高 master要大于slave
	advert_int 1
	unicast_src_ip 10.10.11.79 # 本机ip
	
	track_script {
		chk_nginx
	}

    nopreempt
    authentication {  
        auth_type PASS  # 指定认证方式。PASS简单密码认证(推荐),AH:IPSEC认证(不推荐)
        auth_pass 1111  # 指定认证所使用的密码。最多8位
    }  
    unicast_peer { # 另外一台的服务器ip，如果是多台就配多个ip
        10.10.11.81
    }
    virtual_ipaddress {  # 指定VIP地址
        10.10.11.77
    }  

}  
   

</code></pre> 
<p>从：</p> 
<p>编辑：</p> 
<pre><code>vim /etc/keepalived/keepalived.conf
</code></pre> 
<p>配置内容：</p> 
<pre><code>global_defs {
	router_id LVS_DEVEL
}

vrrp_script chk_nginx {
	script "/etc/keepalived/nginx_check.sh"
	interval 2
	weight -20 
}

vrrp_instance VI_1 {
	state Slave
	interface ens192
	virtual_router_id 51
	priority 90
	advert_int 1
	unicast_src_ip 10.10.11.81
	unicast_peer {
		10.10.11.79
	}

	nopreempt
	authentication {
		auth_type PASS
		auth_pass 1111
	}

	track_script {
		chk_nginx
	}

	virtual_ipaddress {
		10.10.11.77
	}
}

</code></pre> 
<h3><a id="_186"></a>健康监测脚本</h3> 
<p>主从机都需配置检测nginx是否在运行,不在允许就直接启动nginx的脚本,和keepalived放在一起<br> 脚本名称 nginx_check.sh<br> 如果 nginx 停止运行，尝试启动，如果无法启动则杀死本机的 keepalived 进程，keepalived将虚拟 ip 绑定到 BACKUP 机器上。内容如下：</p> 
<pre><code>#!/bin/bash
#version 0.0.1
#当nginx进程不存在时，会自动重启nginx服务；
A=`ps -C nginx --no-header |wc -l`
if [ $A -eq 0 ];then
     docker restart keepalivedNginx     #重启nginx
     sleep 2
     if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then
        systemctl stop keepalived
     fi 
fi
</code></pre> 
<p>编辑完以后放入到/etc/keepalived目录下：<br> <img src="https://images2.imgbox.com/83/28/wXtfzjAb_o.png" alt="在这里插入图片描述"><br> 只要配置好了,以后直接启动keepalived就好了,keepalived运行之后就会检测nginx是否在运行,不在运行就通过脚本去启动</p> 
<p>自动重启不了解决方案</p> 
<h3><a id="_210"></a>查看脚本是否有运行的权限</h3> 
<p>如果你是root登陆的话(不是的话，切换到root用户，对*.sh 赋可执行的权限)</p> 
<pre><code>chmod 777*.sh
</code></pre> 
<p>或者</p> 
<pre><code>chmod +x *.sh
</code></pre> 
<p><strong>主从两台服务器这一步授权一定要执行不然脚本会失效：</strong></p> 
<pre><code>[root@Master keepalived]# chmod +x nginx_check.sh 
[root@Master keepalived]# ll
total 12
-rw-r--r-- 1 root root 572 Oct 12 03:55 keepalived.conf
-rw-r--r-- 1 root root 3550 Oct 12 03:48 keepalived.conf.bak
-rwxr-xr-x 1 root root 205 Oct 12 04:04 nginx_check.sh
[root@Master keepalived]#

</code></pre> 
<p>脚本上传以后重启keepalived。</p> 
<h3><a id="keepalived_235"></a>keepalived常用命令</h3> 
<p>#启动</p> 
<pre><code>service keepalived start
</code></pre> 
<p>#停止</p> 
<pre><code>service keepalived stop
</code></pre> 
<p>#查看状态</p> 
<pre><code>service keepalived status
</code></pre> 
<h3><a id="_254"></a>验证</h3> 
<p>1：如果验证主从是否可以自动切换实现热备效果可以把其中一台机器的keepalived服务stop掉，然后刷新虚拟ip。<br> 2：如果验证健康脚本是否生效，可以把nginx容器stop掉，过两秒再次查看一下nginx容器是否启动。</p> 
<p>注意：可能出现检测脚本不执行</p> 
<p>可能的原因是selinux和防火墙没有关闭<br> 1：</p> 
<pre><code>setenforce 0
</code></pre> 
<p>2：</p> 
<pre><code>vim /etc/selinux/config
</code></pre> 
<pre><code>将ELINUX的值修改为

ELINUX=disabled
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/12875f356ef41055a3c855aa20977d0d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">时间序列分析——平滑法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3c084aafddaa08f4ff59452de821bfee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JavaScript Boolean（布尔） 对象</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>