<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>cas单点登录-服务端部署 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/d0ae4eb6e5dcba6ad568ab2e2c975d8e/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="cas单点登录-服务端部署">
  <meta property="og:description" content="一.需求描述
公司开发系统越来越多，每个系统都有自己的登录认证流程，给用户很繁琐的体验，统一认证单点登录迫在眉睫
二.流程图
三.本地运行cas服务端
1.拉取cas服务端代码，切换到对应分支（我使用的是6.4.x）
https://github.com/apereo/cas-overlay-template
2.由于6.4版本默认jdk11以上，所以在idea进行如下配置
3.在build.gradle文件加入mysql、jdbc依赖配置，并下载依赖
implementation &#34;org.apereo.cas:cas-server-support-json-service-registry:${project.&#39;cas.version&#39;}&#34; implementation &#34;org.apereo.cas:cas-server-support-jdbc:${project.&#39;cas.version&#39;}&#34; implementation &#34;org.apereo.cas:cas-server-support-jdbc-drivers:${project.&#39;cas.version&#39;}&#34; implementation &#34;mysql:mysql-connector-java:5.1.46&#34; 4.yml配置数据源以及http请求支持
cas: authn: jdbc: query[0]: sql: SELECT * FROM user WHERE username = ? url: jdbc:mysql://xxxxxx:3306/cas?useUnicode=true&amp;amp;characterEncoding=utf8&amp;amp;useSSL=false user: root password: xxxx fieldPassword: password driverClass: com.mysql.jdbc.Driver password-encoder: type: DEFAULT encoding-algorithm: MD5 character-encoding: UTF-8 fieldExpired: expired #是否提示改密码的字段 fieldDisabled: disabled #是否禁用用户的字段 accept: enabled: false tgc: secure: false service-registry: core: init-from-json: true json: location: file:/etc/cas/services #cas.authn.accept 指定的就是默认登录用户casuser, 密码Mellon，enabled设为false，则默认用户便不能登录 #如果 cas.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-06T11:38:33+08:00">
    <meta property="article:modified_time" content="2023-06-06T11:38:33+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">cas单点登录-服务端部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p></p> 
<p></p> 
<p>一.需求描述</p> 
<p>公司开发系统越来越多，每个系统都有自己的登录认证流程，给用户很繁琐的体验，统一认证单点登录迫在眉睫</p> 
<p>二.流程图</p> 
<p><img alt="" height="652" src="https://images2.imgbox.com/79/b1/u0tLpKxM_o.png" width="899"></p> 
<p>三.本地运行cas服务端</p> 
<p>1.拉取cas服务端代码，切换到对应分支（我使用的是6.4.x）</p> 
<p><a href="https://github.com/apereo/cas-overlay-template" title="https://github.com/apereo/cas-overlay-template">https://github.com/apereo/cas-overlay-template</a></p> 
<p> 2.由于6.4版本默认jdk11以上，所以在idea进行如下配置</p> 
<p><img alt="" height="339" src="https://images2.imgbox.com/c9/b5/rfrRuXaM_o.png" width="1200"></p> 
<p>3.在build.gradle文件加入mysql、jdbc依赖配置，并下载依赖</p> 
<p><img alt="" height="778" src="https://images2.imgbox.com/1e/c2/pFo04rQ7_o.png" width="1200"></p> 
<pre><code class="hljs">implementation "org.apereo.cas:cas-server-support-json-service-registry:${project.'cas.version'}"
implementation "org.apereo.cas:cas-server-support-jdbc:${project.'cas.version'}"
implementation "org.apereo.cas:cas-server-support-jdbc-drivers:${project.'cas.version'}"
implementation "mysql:mysql-connector-java:5.1.46"</code></pre> 
<p> <img alt="" height="261" src="https://images2.imgbox.com/84/fd/hODgoHtJ_o.png" width="699"></p> 
<p> 4.yml配置数据源以及http请求支持</p> 
<pre><code class="language-XML">cas:
  authn:
    jdbc:
      query[0]:
        sql: SELECT * FROM user WHERE username = ?
        url: jdbc:mysql://xxxxxx:3306/cas?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false
        user: root
        password: xxxx
        fieldPassword: password
        driverClass: com.mysql.jdbc.Driver
        password-encoder:
          type: DEFAULT
          encoding-algorithm: MD5
          character-encoding: UTF-8
        fieldExpired: expired #是否提示改密码的字段
        fieldDisabled: disabled #是否禁用用户的字段
    accept:
      enabled: false
  tgc:
    secure: false
  service-registry:
    core:
      init-from-json: true
    json:
      location: file:/etc/cas/services
#cas.authn.accept 指定的就是默认登录用户casuser, 密码Mellon，enabled设为false，则默认用户便不能登录
#如果 cas.authn.jdbc.query[0].password-encoder.type设为NONE，则不适用密码加密，数据库中需存明文密码</code></pre> 
<p> 5.在jdk的bin目录生成证书thekeystore</p> 
<pre><code class="language-XML">keytool -genkeypair（keytool -genkeypair）来生成对应的keystore</code></pre> 
<p> 6.在项目对应的盘根目录创建对应子目录（etc/cas/service）,把证书和json文件放进对应的位置</p> 
<p><img alt="" height="155" src="https://images2.imgbox.com/25/75/jPX0L75m_o.png" width="1087"></p> 
<p><img alt="" height="180" src="https://images2.imgbox.com/aa/3c/DXhu9Foq_o.png" width="1200"></p> 
<pre><code class="language-XML">{
  "@class": "org.apereo.cas.services.RegexRegisteredService",
  "serviceId": "^(https|http)://.*",
  "name": "HTTPS and HTTP",
  "id": 10000001,
  "description": "This service definition authorizes all application urls that support HTTPS and HTTP protocols.",
  "evaluationOrder": 10000
}</code></pre> 
<p> 7.mysql创建数据库和对应的表，并插入数据</p> 
<pre><code class="language-sql">CREATE TABLE `cas` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(255) DEFAULT NULL COMMENT '用户名',
  `password` varchar(255) DEFAULT NULL COMMENT '密码',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</code></pre> 
<p>由于cas对密码经过md5加密的，所以密码需要处理后再插入</p> 
<p><img alt="" height="127" src="https://images2.imgbox.com/15/7b/22hEgKmR_o.png" width="671"></p> 
<p>8.运行启动cas </p> 
<p><img alt="" height="651" src="https://images2.imgbox.com/27/a3/blOkdZIS_o.png" width="1200"></p> 
<p>四. docker-compose部署cas服务</p> 
<p>1. 将项目上传到linux服务器，通过命令生成对应的镜像</p> 
<pre><code class="language-bash">docker build -t cas.tar:6.4 .</code></pre> 
<p>2.编写docker-compose.yml</p> 
<pre><code class="language-XML">version: "3"
services:
  cas:
    image: cas:6.4
    container_name: cas-server
    restart: always
    ports:
      - 8083:8080
      - 8443:8443
    volumes:
      - ./conf/cas.properties:/etc/cas/config/cas.properties:ro
      - ./conf/thekeystore:/etc/cas/thekeystore:ro
      - ./conf/HTTPSandHTTP-10000001.json:/etc/cas/services/HTTPSandHTTP-10000001.json:ro</code></pre> 
<p>3.编写cas.properties</p> 
<pre><code class="language-XML">as.server.name=https://自己的域名:8443
cas.server.prefix=${cas.server.name}/cas

logging.config=file:/etc/cas/config/log4j2.xml

cas.tgc.secure=false
cas.serviceRegistry.initFromJson=true
cas.serviceRegistry.json.location=file:/etc/cas/services</code></pre> 
<p>4.启动并访问</p> 
<p><img alt="" height="581" src="https://images2.imgbox.com/0a/ad/TMMq3Pi4_o.png" width="1200"></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/70b57b3aed0b6b8a04f85098d52c57d3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ClickHouse数据查询处理高级技巧</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7a10c61b70fbea152d1d80e59e47e11d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">中国地面气候资料日值数据集（V3.0）数据说明以及数据处理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>