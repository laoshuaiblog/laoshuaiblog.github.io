<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何在 Next.js 中快速集成 @microsoft/signalr - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/44d0d50c30fcbffbadb2e282fe1d763c/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="如何在 Next.js 中快速集成 @microsoft/signalr">
  <meta property="og:description" content="如何在 Next.js 中快速集成 @microsoft/signalr 虽然只有少数项目需要集成 WebSockets 来在界面发生变化时实时响应而不重新获取数据，但这些项目仍然数量庞大。
这是一项必不可少的工作，我们不会讨论它们或者比较提供更好开发体验的第三方库。
我的目标是展示如何快速集成 @microsoft/signalr 到 Next.js 中，以及在开发过程中遇到的问题如何解决。
首先，我希望每个人都已经在本地安装和部署了 Next.js 项目。在我的案例中，版本是 13.2.4。让我们添加一些重要的库：swr（版本 2.1.5）用于数据获取以及与本地缓存进一步工作，以及 @microsoft/signalr（版本 7.0.5） - 用于 WebSockets 的 API。
npm install --save @microsoft/signalr swr 让我们从创建一个简单的 fetcher 函数和一个名为 useChatData 的新 hook 开始，以从我们的 REST API 获取初始数据。它返回了聊天消息列表、检测错误和加载状态的字段，以及允许更改缓存数据的 mutate 方法。
// hooks/useChatData.ts import useSWR from &#39;swr&#39;; type Message = { content: string; createdAt: Date; id: string; }; async function fetcher&amp;lt;TResponse&amp;gt;(url: string, config: RequestInit): Promise&amp;lt;TResponse&amp;gt; { const response = await fetch(url, config); if (!">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-06T10:37:26+08:00">
    <meta property="article:modified_time" content="2023-09-06T10:37:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何在 Next.js 中快速集成 @microsoft/signalr</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_Nextjs__microsoftsignalr_1"></a>如何在 Next.js 中快速集成 @microsoft/signalr</h2> 
<p>虽然只有少数项目需要集成 WebSockets 来在界面发生变化时实时响应而不重新获取数据，但这些项目仍然数量庞大。</p> 
<p>这是一项必不可少的工作，我们不会讨论它们或者比较提供更好开发体验的第三方库。</p> 
<p>我的目标是展示如何快速集成 <code>@microsoft/signalr</code> 到 Next.js 中，以及在开发过程中遇到的问题如何解决。</p> 
<p>首先，我希望每个人都已经在本地安装和部署了 Next.js 项目。在我的案例中，版本是 <code>13.2.4</code>。让我们添加一些重要的库：<code>swr</code>（版本 <code>2.1.5</code>）用于数据获取以及与本地缓存进一步工作，以及 <code>@microsoft/signalr</code>（版本 <code>7.0.5</code>） - 用于 WebSockets 的 API。</p> 
<pre><code class="prism language-shell"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> @microsoft/signalr swr
</code></pre> 
<p>让我们从创建一个简单的 <code>fetcher</code> 函数和一个名为 <code>useChatData</code> 的新 hook 开始，以从我们的 REST API 获取初始数据。它返回了聊天消息列表、检测错误和加载状态的字段，以及允许更改缓存数据的 <code>mutate</code> 方法。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// hooks/useChatData.ts</span>
<span class="token keyword">import</span> useSWR <span class="token keyword">from</span> <span class="token string">'swr'</span><span class="token punctuation">;</span>

type Message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
    <span class="token literal-property property">createdAt</span><span class="token operator">:</span> Date<span class="token punctuation">;</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> fetcher<span class="token operator">&lt;</span>TResponse<span class="token operator">&gt;</span><span class="token punctuation">(</span>url<span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">config</span><span class="token operator">:</span> RequestInit<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>TResponse<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useChatData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> data<span class="token punctuation">,</span> error<span class="token punctuation">,</span> isLoading<span class="token punctuation">,</span> mutate <span class="token punctuation">}</span> <span class="token operator">=</span> useSWR<span class="token operator">&lt;</span>Message<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'OUR_API_URL'</span><span class="token punctuation">,</span> fetcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        isLoading<span class="token punctuation">,</span>
        <span class="token literal-property property">isError</span><span class="token operator">:</span> error<span class="token punctuation">,</span>
        mutate<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>为了测试它是否按预期工作，让我们更新我们的页面组件。在顶部导入我们的 hook，并像下面的代码片段中那样从中提取数据。如果它工作正常，你将看到渲染的数据。如你所见，这很简单。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// pages/chat.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useChatData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hooks/useChatData'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">Chat</span><span class="token operator">:</span> <span class="token function-variable function">NextPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useChatData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">{<!-- --></span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>下一步需要连接我们未来的页面到 WebSockets，捕获 <code>NewMessage</code> 事件，并使用新消息更新缓存。我建议从一个单独的文件中构建 socket 服务。</p> 
<p>根据 SignalR 文档中的示例，我们需要创建一个连接实例以后续监听事件。我还添加了一个 connections 对象，以防止重复连接，以及两个用于启动/停止连接的帮助函数。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// api/socket.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> HubConnection<span class="token punctuation">,</span> HubConnectionBuilder<span class="token punctuation">,</span> LogLevel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@microsoft/signalr'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> connections <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> string<span class="token punctuation">;</span> connection<span class="token operator">:</span> HubConnection<span class="token punctuation">;</span> started<span class="token operator">:</span> boolean <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">messageType</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> connectionObj <span class="token operator">=</span> connections<span class="token punctuation">[</span>messageType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connectionObj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SOCKET: Registering on server events '</span><span class="token punctuation">,</span> messageType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HubConnectionBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUrl</span><span class="token punctuation">(</span><span class="token string">'API_URL'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">logger</span><span class="token operator">:</span> LogLevel<span class="token punctuation">.</span>Information<span class="token punctuation">,</span>
                <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withAutomaticReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        connections<span class="token punctuation">[</span>messageType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> messageType<span class="token punctuation">,</span>
            <span class="token literal-property property">connection</span><span class="token operator">:</span> connection<span class="token punctuation">,</span>
            <span class="token literal-property property">started</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> connections<span class="token punctuation">[</span>messageType<span class="token punctuation">]</span><span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">startConnection</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">messageType</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> connectionObj <span class="token operator">=</span> connections<span class="token punctuation">[</span>messageType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connectionObj<span class="token punctuation">.</span>started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        connectionObj<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'SOCKET: '</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionObj<span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">stopConnection</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">messageType</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> connectionObj <span class="token operator">=</span> connections<span class="token punctuation">[</span>messageType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionObj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SOCKET: Stoping connection '</span><span class="token punctuation">,</span> messageType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionObj<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionObj<span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">registerOnServerEvents</span><span class="token punctuation">(</span>
    <span class="token literal-property property">messageType</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">payload</span><span class="token operator">:</span> Message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">createConnection</span><span class="token punctuation">(</span>messageType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'NewIncomingMessage'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">payload</span><span class="token operator">:</span> Message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">callback</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">onclose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">stopConnection</span><span class="token punctuation">(</span>messageType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startConnection</span><span class="token punctuation">(</span>messageType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'SOCKET: '</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> socketService <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    registerOnServerEvents<span class="token punctuation">,</span>
    stopConnection<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>因此，现在我们的页面可能如下所示。我们获取并提取了包含消息列表的 <code>data</code>，并进行了渲染。此外，上面的 <code>useEffect</code> 注册了 <code>NewMessage</code> 事件，创建了连接，并监听后端。</p> 
<p>当事件触发时，hook 中的 <code>mutate</code> 方法会使用新对象更新现有列表。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// pages/chat.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useChatData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hooks/useChatData'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> socketService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'api/socket'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">Chat</span><span class="token operator">:</span> <span class="token function-variable function">NextPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useChatData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        socketService<span class="token punctuation">.</span><span class="token function">registerOnServerEvents</span><span class="token punctuation">(</span>
            <span class="token string">'NewMessage'</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">payload</span><span class="token operator">:</span> Message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token operator">...</span>data<span class="token punctuation">,</span> payload<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">revalidate</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            socketService<span class="token punctuation">.</span><span class="token function">stopConnection</span><span class="token punctuation">(</span><span class="token string">'NewMessage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">{<!-- --></span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>看起来不错，它可以工作，我们可以看到新消息如何出现在消息列表中。我选择了一个聊天的基本示例，因为它非常清晰且易于理解</p> 
<p>。当然，你可以根据自己的逻辑应用它。</p> 
<h4><a id="_178"></a>小额奖励</h4> 
<p>使用其中一个版本的 <code>@microsoft/signalr</code>，我们遇到了重复的问题。这与 <code>useEffect</code> 中的依赖数组有关。每次依赖项更改时，<code>connection.on(event, callback);</code> 都会缓存回调并一次又一次地触发它。</p> 
<pre><code class="prism language-javascript"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// data 默认为空数组（registerOnServerEvents 第1次运行），</span>
    <span class="token comment">// 但在初始数据获取后它会变化（registerOnServerEvents 第2次运行）</span>
    <span class="token comment">// 每个事件都会更改数据并触发 registerOnServerEvents 的运行</span>
    socketService<span class="token punctuation">.</span><span class="token function">registerOnServerEvents</span><span class="token punctuation">(</span>
        <span class="token string">'NewMessage'</span><span class="token punctuation">,</span>
        <span class="token comment">// 回调函数被缓存</span>
        <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">payload</span><span class="token operator">:</span> Message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 每次数据更改都会多次调用 mutate</span>
            <span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token operator">...</span>data<span class="token punctuation">,</span> payload<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">revalidate</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在收到3条消息事件后，我们竟然渲染了4条消息，哈哈</span>
</code></pre> 
<p>我们找到的最快最可靠的解决方案是在 React <code>ref</code> 中保留数据的副本，并在 <code>useEffect</code> 中使用它进行未来的更新。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// pages/chat.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useChatData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'hooks/useChatData'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> socketService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'api/socket'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">Chat</span><span class="token operator">:</span> <span class="token function-variable function">NextPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useChatData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> messagesRef <span class="token operator">=</span> useRef<span class="token operator">&lt;</span>Message<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        messagesRef<span class="token punctuation">.</span>current <span class="token operator">=</span> chatData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>chatData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        socketService<span class="token punctuation">.</span><span class="token function">registerOnServerEvents</span><span class="token punctuation">(</span>
            <span class="token string">'NewMessage'</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">payload</span><span class="token operator">:</span> Message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> messagesCopy <span class="token operator">=</span> messagesRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token operator">...</span>messagesCopy<span class="token punctuation">,</span> payload<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">revalidate</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            socketService<span class="token punctuation">.</span><span class="token function">stopConnection</span><span class="token punctuation">(</span><span class="token string">'NewMessage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">{<!-- --></span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>目前，我们使用了 <code>@microsoft/signalr</code> 的新版本，它似乎已经修复了必要的问题。但无论如何，如果有人发现这个解决方案有用，并使用了这个解决办法，我会很高兴。总之，我想说，我对 SignalR 的经验非常积极，安装不需要任何特定的依赖项或设置，它运行良好且满足我们的需求。</p> 
<pre><code>
请注意，在文档中有一些 `OUR_API_URL`、`API_URL` 等需要替换为实际的 API 地址的占位符。此外，如果需要更多的翻译或有任何其他问题，请随时提出。
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5497dcbc91af7949bc903967bb4df889/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">RabbitMq消息模型-队列消息</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/294b6e0f2bd09a56720bbccdd1e05ffe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">adb shell 常用命令（持续更新）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>