<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s入门到实战（十四）—— Helm详细介绍及使用 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/cd5cf7ccbb1ab5b97fbd80acff529b51/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="k8s入门到实战（十四）—— Helm详细介绍及使用">
  <meta property="og:description" content="Helm 使用 Helm 是一个 k8s 应用的包管理工具，类似于 Ubuntu 的 APT 和 CentOS 中的 YUM。
Helm 使用 chart 来封装 k8s 应用的 yaml 文件，我们只需要设置自己的参数，就可以实现自动化的快速部署应用。
Helm 通过打包的方式，支持发布的版本管理和控制，很大程度上简化了 k8s 应用的部署和管理。
Helm 有一个跟 docker Hub 类似的应用中心（https://artifacthub.io/），我们可以在里面找到我们需要部署的应用。
helm 概述 Helm 是一个流行的 k8s 包管理工具，它用于简化在 k8s 上部署、管理和扩展应用程序的过程。Helm 允许用户定义可重复使用的 k8s 部署模板，称为 “charts”，并使用这些 charts 来创建、配置和管理 k8s 中的应用程序。
Helm 由两个核心组件组成：
Helm Client（helm）：这是与用户交互的命令行工具。用户可以使用 Helm Client 来搜索、安装、升级和删除 charts，并管理 Helm Repositories（存储 charts 的位置）。
Tiller（已弃用）：在 Helm 2.x 版本中，Tiller 是 Helm 的服务端组件，负责将 charts 渲染为 k8s 资源对象，并将它们部署到 k8s 集群中。然而，在 Helm 3.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-27T18:30:16+08:00">
    <meta property="article:modified_time" content="2024-03-27T18:30:16+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s入门到实战（十四）—— Helm详细介绍及使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Helm__0"></a>Helm 使用</h2> 
<p>Helm 是一个 k8s 应用的包管理工具，类似于 Ubuntu 的 APT 和 CentOS 中的 YUM。</p> 
<p>Helm 使用 chart 来封装 k8s 应用的 yaml 文件，我们只需要设置自己的参数，就可以实现自动化的快速部署应用。</p> 
<p>Helm 通过打包的方式，支持发布的版本管理和控制，很大程度上简化了 k8s 应用的部署和管理。</p> 
<p>Helm 有一个跟 docker Hub 类似的应用中心（https://artifacthub.io/），我们可以在里面找到我们需要部署的应用。</p> 
<h3><a id="helm__10"></a>helm 概述</h3> 
<p>Helm 是一个流行的 k8s 包管理工具，它用于简化在 k8s 上部署、管理和扩展应用程序的过程。Helm 允许用户定义可重复使用的 k8s 部署模板，称为 “charts”，并使用这些 charts 来创建、配置和管理 k8s 中的应用程序。</p> 
<p>Helm 由两个核心组件组成：</p> 
<ol><li> <p>Helm Client（helm）：这是与用户交互的命令行工具。用户可以使用 Helm Client 来搜索、安装、升级和删除 charts，并管理 Helm Repositories（存储 charts 的位置）。</p> </li><li> <p>Tiller（已弃用）：在 Helm 2.x 版本中，Tiller 是 Helm 的服务端组件，负责将 charts 渲染为 k8s 资源对象，并将它们部署到 k8s 集群中。然而，在 Helm 3.x 版本中，Tiller 已被移除，取而代之的是直接通过 Helm Client 与 k8s API 交互。</p> </li></ol> 
<p>Helm 的主要优势在于它提供了模板化的部署方式，使得应用程序的部署过程更加可重复和可管理。通过使用 Helm，您可以轻松地创建自定义的 charts，并轻松地在不同的环境中部署和管理应用程序，从而提高了开发人员和运维人员的效率。</p> 
<h3><a id="helm__24"></a>helm 优点</h3> 
<p>Helm 在 k8s 中具有许多优点，以下是其中一些主要优点：</p> 
<ul><li>简化部署和管理：Helm 允许用户将应用程序打包为可重复使用的 charts，简化了应用程序的部署和管理过程。通过使用 Helm，用户可以轻松地创建、安装、升级和删除应用程序，而无需手动处理底层的 k8s 资源对象。</li><li>可重用的部署模板：Helm Charts 是可重用的部署模板，可以定义应用程序的整个部署配置，包括容器、服务、配置文件、存储卷等。这样，用户可以通过 Charts 快速创建和部署应用程序，减少了编写和维护大量 YAML 文件的工作量。</li><li>版本控制和回滚：Helm 具备版本控制功能，可以管理不同版本的 Charts 和应用程序。这使得用户可以轻松地进行升级、回滚和管理应用程序的不同版本，提高了应用程序的可控性和可靠性。</li><li>社区支持和生态系统：Helm 是一个开源项目，有一个活跃的社区支持和贡献。Helm 社区维护了一个官方的 Charts 仓库，其中包含了大量常用的应用程序 Charts，用户可以直接使用这些 Charts 来部署和管理应用程序。此外，还有许多第三方 Charts 仓库可供选择，扩展了 Helm 的功能和应用场景。</li><li>可扩展性和灵活性：Helm 具有良好的扩展性和灵活性，用户可以根据自己的需求定制 Charts 和插件，以满足特定的部署和管理需求。用户可以根据需要配置应用程序的各种参数和选项，以适应不同的环境和场景。</li></ul> 
<p>总的来说，Helm 提供了简化和标准化 k8s 应用程序部署和管理的解决方案，使得用户能够更高效地进行应用程序的开发、部署和运维工作。</p> 
<h3><a id="_helm_36"></a>安装 helm</h3> 
<p>安装地址：https://helm.sh/zh/docs/intro/install/</p> 
<pre><code class="prism language-sh"><span class="token comment"># 国内下载不了</span>
<span class="token function">curl</span> https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 <span class="token operator">|</span> <span class="token function">bash</span>
</code></pre> 
<p>我们手动下载安装包</p> 
<pre><code class="prism language-sh"><span class="token function">wget</span> https://get.helm.sh/helm-v3.10.0-linux-amd64.tar.gz
</code></pre> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@k8s-master home<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">14196</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">14530566</span> Mar <span class="token number">27</span> 04:05 helm-v3.10.0-linux-amd64.tar.gz
drwxr-xr-x <span class="token number">2</span> root root     <span class="token number">4096</span> Mar <span class="token number">27</span> 02:31 k8s
</code></pre> 
<p>下载完成后，解压</p> 
<pre><code class="prism language-sh"><span class="token comment"># 解压压缩包</span>
<span class="token punctuation">[</span>root@k8s-master home<span class="token punctuation">]</span><span class="token comment"># tar -zxvf helm-v3.10.0-linux-amd64.tar.gz</span>
linux-amd64/
linux-amd64/helm
linux-amd64/LICENSE
linux-amd64/README.md
<span class="token punctuation">[</span>root@k8s-master home<span class="token punctuation">]</span><span class="token comment"># cd linux-amd64/</span>
<span class="token punctuation">[</span>root@k8s-master linux-amd64<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">43992</span>
-rwxr-xr-x <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span> <span class="token number">45031424</span> Sep <span class="token number">22</span>  <span class="token number">2022</span> helm
-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>    <span class="token number">11373</span> Sep <span class="token number">22</span>  <span class="token number">2022</span> LICENSE
-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>     <span class="token number">3367</span> Sep <span class="token number">22</span>  <span class="token number">2022</span> README.md
<span class="token comment"># 在解压目中找到helm程序，移动到需要的目录中</span>
<span class="token punctuation">[</span>root@k8s-master linux-amd64<span class="token punctuation">]</span><span class="token comment"># mv helm /usr/local/bin</span>
<span class="token comment"># 出现以下版本信息代表安装成功</span>
<span class="token punctuation">[</span>root@k8s-master linux-amd64<span class="token punctuation">]</span><span class="token comment"># helm version</span>
version.BuildInfo<span class="token punctuation">{<!-- --></span>Version:<span class="token string">"v3.10.0"</span>, GitCommit:<span class="token string">"ce66412a723e4d89555dc67217607c6579ffcb21"</span>, GitTreeState:<span class="token string">"clean"</span>, GoVersion:<span class="token string">"go1.18.6"</span><span class="token punctuation">}</span>
</code></pre> 
<p>添加一个稳定仓库</p> 
<pre><code class="prism language-sh"><span class="token comment"># 添加稳定仓库</span>
<span class="token punctuation">[</span>root@k8s-master linux-amd64<span class="token punctuation">]</span><span class="token comment"># helm repo add bitnami https://charts.bitnami.com/bitnami</span>
<span class="token string">"bitnami"</span> has been added to your repositories
<span class="token comment"># 验证仓库是否添加完成</span>
<span class="token punctuation">[</span>root@k8s-master linux-amd64<span class="token punctuation">]</span><span class="token comment"># helm repo list</span>
NAME   	URL                               
bitnami	https://charts.bitnami.com/bitnami
</code></pre> 
<h3><a id="_94"></a>三大概念</h3> 
<p>Chart 代表着 Helm 包。</p> 
<ul><li>它包含运行应用程序需要的所有资源定义和依赖，相当于模版。</li><li>类似于 maven 中的 <code>pom.xml</code>、Apt中的 <code>dpkb</code> 或 Yum 中的 <code>RPM</code>。</li></ul> 
<p>Repository（仓库）用来存放和共享 charts。</p> 
<ul><li>不用的应用放在不同的仓库中。</li></ul> 
<p>Release 是运行 chart 的实例。</p> 
<p>一个 chart 通常可以在同一个集群中安装多次。</p> 
<p>每一次安装都会创建一个新的 release，<code>release name </code>不能重复。</p> 
<h3><a id="_mysql__113"></a>下载一个 mysql 来启动</h3> 
<p>helm 的仓库中心：https://artifacthub.io/，相当于 docker hub</p> 
<p>进入这个页面搜索 mysql，里面有下载的命令以及配置参数的详细信息</p> 
<p>下载命令：容器名为<code>my-mysql</code></p> 
<pre><code class="prism language-sh">helm <span class="token function">install</span> my-mysql bitnami/mysql
</code></pre> 
<p>参数：</p> 
<ul><li><code>--set</code>：后面跟 key=value 的格式，用于配置使用容器的一些参数，key 在页面中有详细介绍</li><li><code>--version</code>：指定容器的 charts 的版本，默认是最新版</li></ul> 
<p>接下来我们下载一个 mysql 玩玩：</p> 
<pre><code class="prism language-sh">helm <span class="token function">install</span> my-mysql --set-string <span class="token assign-left variable">auth.rootPassword</span><span class="token operator">=</span><span class="token string">"123456"</span> bitnami/mysql
</code></pre> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@k8s-master linux-amd64<span class="token punctuation">]</span><span class="token comment"># helm install my-mysql --set-string auth.rootPassword="123456" bitnami/mysql</span>
NAME: my-mysql
LAST DEPLOYED: Wed Mar <span class="token number">27</span> 04:24:17 <span class="token number">2024</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class="token number">1</span>
TEST SUITE: None
NOTES:
CHART NAME: mysql
CHART VERSION: <span class="token number">10.1</span>.0
APP VERSION: <span class="token number">8.0</span>.36

<span class="token comment"># helm安装项目之后，它会帮我们生成一个详细的使用文档</span>
** Please be patient <span class="token keyword">while</span> the chart is being deployed **

Tip:

  Watch the deployment status using the command: kubectl get pods <span class="token parameter variable">-w</span> <span class="token parameter variable">--namespace</span> default

<span class="token comment"># 在k8s网络中如何访问该服务</span>
Services:

  <span class="token builtin class-name">echo</span> Primary: my-mysql.default.svc.cluster.local:3306

Execute the following to get the administrator credentials:

  <span class="token builtin class-name">echo</span> Username: root
  <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get secret <span class="token parameter variable">--namespace</span> default my-mysql <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"{.data.mysql-root-password}"</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span><span class="token variable">)</span></span>

<span class="token comment"># 连接到数据库的方式</span>
To connect to your database:

  <span class="token number">1</span>. Run a pod that you can use as a client:

      kubectl run my-mysql-client <span class="token parameter variable">--rm</span> <span class="token parameter variable">--tty</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">--restart</span><span class="token operator">=</span><span class="token string">'Never'</span> <span class="token parameter variable">--image</span>  docker.io/bitnami/mysql:8.0.36-debian-12-r8 <span class="token parameter variable">--namespace</span> default <span class="token parameter variable">--env</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token variable">$MYSQL_ROOT_PASSWORD</span> <span class="token parameter variable">--command</span> -- <span class="token function">bash</span>

  <span class="token number">2</span>. To connect to primary <span class="token function">service</span> <span class="token punctuation">(</span>read/write<span class="token punctuation">)</span>:

      mysql <span class="token parameter variable">-h</span> my-mysql.default.svc.cluster.local <span class="token parameter variable">-uroot</span> -p<span class="token string">"<span class="token variable">$MYSQL_ROOT_PASSWORD</span>"</span>

WARNING: There are <span class="token string">"resources"</span> sections <span class="token keyword">in</span> the chart not set. Using <span class="token string">"resourcesPreset"</span> is not recommended <span class="token keyword">for</span> production. For production installations, please <span class="token builtin class-name">set</span> the following values according to your workload needs:
  - primary.resources
  - secondary.resources
+info https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
</code></pre> 
<p>它的本质是在我们的 k8s 集群上启动了一个 pod</p> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod</span>
NAME         READY   STATUS    RESTARTS            AGE
my-mysql-1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>                   3m14s <span class="token comment"># stafulset类型的，可以部署有状态应用。</span>
<span class="token comment"># **Release** 是运行 chart 的实例。</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># helm ls</span>
NAME    	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART       	APP
my-mysql	default  	<span class="token number">1</span>       	<span class="token number">2024</span>-3-27 <span class="token number">13</span>:38:53.228239944 +0800 CST	deployed	mysql-10.1.0	<span class="token number">8.0</span>.36     
</code></pre> 
<h3><a id="_helm_197"></a>探究 helm</h3> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@k8s-master k8s<span class="token punctuation">]</span><span class="token comment"># helm create hello-world</span>
Creating hello-world
<span class="token punctuation">[</span>root@k8s-master k8s<span class="token punctuation">]</span><span class="token comment"># cd hello-world/</span>
<span class="token punctuation">[</span>root@k8s-master hello-world<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">16</span>
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">4096</span> Mar <span class="token number">27</span> 04:44 charts			<span class="token comment"># 当前我们创建的这个charts是否依赖与其他的charts，如果有就在这里面</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1147</span> Mar <span class="token number">27</span> 04:44 Chart.yaml		<span class="token comment"># charts信息</span>
drwxr-xr-x <span class="token number">3</span> root root <span class="token number">4096</span> Mar <span class="token number">27</span> 04:44 templates		<span class="token comment"># k8s 资源文件， 模版 {<!-- -->{ 插值 }}</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1878</span> Mar <span class="token number">27</span> 04:44 values.yaml	<span class="token comment"># 具体的值</span>
<span class="token punctuation">[</span>root@k8s-master hello-world<span class="token punctuation">]</span><span class="token comment"># cd templates/</span>
<span class="token punctuation">[</span>root@k8s-master templates<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">32</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1856</span> Mar <span class="token number">27</span> 04:44 deployment.yaml
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1822</span> Mar <span class="token number">27</span> 04:44 _helpers.tpl
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">928</span> Mar <span class="token number">27</span> 04:44 hpa.yaml
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">2087</span> Mar <span class="token number">27</span> 04:44 ingress.yaml
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1763</span> Mar <span class="token number">27</span> 04:44 NOTES.txt
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">328</span> Mar <span class="token number">27</span> 04:44 serviceaccount.yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">373</span> Mar <span class="token number">27</span> 04:44 service.yaml
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">4096</span> Mar <span class="token number">27</span> 04:44 tests
</code></pre> 
<p>本质里面就是一堆 k8s 的资源文件，helm 启动这个 charts，相当于帮我们执行了 apply -f</p> 
<p>我们可以检测这个 chart 是否有问题</p> 
<pre><code class="prism language-sh">helm lint charts目录
</code></pre> 
<pre><code class="prism language-sh"><span class="token comment"># 检测 charts 包是否有问题</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># helm lint ./hello-world/</span>
<span class="token operator">==</span><span class="token operator">&gt;</span> Linting ./hello-world/
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Chart.yaml: icon is recommended

<span class="token number">1</span> chart<span class="token punctuation">(</span>s<span class="token punctuation">)</span> linted, <span class="token number">0</span> chart<span class="token punctuation">(</span>s<span class="token punctuation">)</span> failed
</code></pre> 
<p>这样就是没有问题</p> 
<blockquote> 
 <p>将 Helm Charts 渲染为 k8s 资源对象的 yaml 文件，而不进行实际的部署操作</p> 
</blockquote> 
<pre><code class="prism language-sh">helm template charts包名
</code></pre> 
<p>这个命令非常有用，可以方便地查看 Charts 的最终生成结果</p> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@k8s-master k8s<span class="token punctuation">]</span><span class="token comment"># helm template hello-world/</span>
---
<span class="token comment"># Source: hello-world/templates/serviceaccount.yaml</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-hello-world
  labels:
    helm.sh/chart: hello-world-0.1.0
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: <span class="token string">"1.16.0"</span>
    app.kubernetes.io/managed-by: Helm
---
<span class="token comment"># Source: hello-world/templates/service.yaml</span>
apiVersion: v1
kind: Service
metadata:
  name: release-name-hello-world
  labels:
    helm.sh/chart: hello-world-0.1.0
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: <span class="token string">"1.16.0"</span>
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: <span class="token number">80</span>
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/instance: release-name
---
<span class="token comment"># Source: hello-world/templates/deployment.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: release-name-hello-world
  labels:
    helm.sh/chart: hello-world-0.1.0
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: <span class="token string">"1.16.0"</span>
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app.kubernetes.io/name: hello-world
      app.kubernetes.io/instance: release-name
  template:
    metadata:
      labels:
        app.kubernetes.io/name: hello-world
        app.kubernetes.io/instance: release-name
    spec:
      serviceAccountName: release-name-hello-world
      securityContext:
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      containers:
        - name: hello-world
          securityContext:
            <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
          image: <span class="token string">"nginx:1.16.0"</span>
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: <span class="token number">80</span>
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          resources:
            <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
---
<span class="token comment"># Source: hello-world/templates/tests/test-connection.yaml</span>
apiVersion: v1
kind: Pod
metadata:
  name: <span class="token string">"release-name-hello-world-test-connection"</span>
  labels:
    helm.sh/chart: hello-world-0.1.0
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: <span class="token string">"1.16.0"</span>
    app.kubernetes.io/managed-by: Helm
  annotations:
    <span class="token string">"helm.sh/hook"</span><span class="token builtin class-name">:</span> <span class="token builtin class-name">test</span>
spec:
  containers:
    - name: <span class="token function">wget</span>
      image: busybox
      command: <span class="token punctuation">[</span><span class="token string">'wget'</span><span class="token punctuation">]</span>
      args: <span class="token punctuation">[</span><span class="token string">'release-name-hello-world:80'</span><span class="token punctuation">]</span>
  restartPolicy: Never
</code></pre> 
<blockquote> 
 <p>安装</p> 
</blockquote> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@k8s-master k8s<span class="token punctuation">]</span><span class="token comment"># helm install helloworld hello-world/</span>
NAME: helloworld
LAST DEPLOYED: Wed Mar <span class="token number">27</span> 04:56:06 <span class="token number">2024</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class="token number">1</span>
NOTES:
<span class="token number">1</span>. Get the application URL by running these commands:
  <span class="token builtin class-name">export</span> <span class="token assign-left variable">POD_NAME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token parameter variable">--namespace</span> default <span class="token parameter variable">-l</span> <span class="token string">"app.kubernetes.io/name=hello-world,app.kubernetes.io/instance=helloworld"</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"{.items[0].metadata.name}"</span><span class="token variable">)</span></span>
  <span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTAINER_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">--namespace</span> default $POD_NAME <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"{.spec.containers[0].ports[0].containerPort}"</span><span class="token variable">)</span></span>
  <span class="token builtin class-name">echo</span> <span class="token string">"Visit http://127.0.0.1:8080 to use your application"</span>
  kubectl <span class="token parameter variable">--namespace</span> default port-forward <span class="token variable">$POD_NAME</span> <span class="token number">8080</span>:<span class="token variable">$CONTAINER_PORT</span>
</code></pre> 
<p>可以直接通过仓库找到 charts 来安装！</p> 
<p>也可以自己编写 charts 包来安装！git 下载 charts</p> 
<h3><a id="helm__mysql__378"></a>helm 部署 mysql 主从复制集群</h3> 
<p>https://artifacthub.io/packages/helm/bitnami/mysql</p> 
<p>安装过程中有两种方式传递配置数据：</p> 
<ul><li><code>-f (或--values)</code>：使用 yaml 文件覆盖默认配置。可以指定多次，优先使用最右边的文件。</li><li><code>--set</code>：通过命令行的方式对指定项进行覆盖。</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">auth</span><span class="token punctuation">:</span>
  <span class="token key atrule">rootPassword</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>

<span class="token key atrule">primary</span><span class="token punctuation">:</span>
  <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
    <span class="token key atrule">size</span><span class="token punctuation">:</span> 2Gi
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">secondary</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
    <span class="token key atrule">size</span><span class="token punctuation">:</span> 2Gi
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">architecture</span><span class="token punctuation">:</span> replication
</code></pre> 
<p>如果同时使用两种方式，则 <code>--set</code>中的值会被合并到 <code>-f</code>中，但是 <code>--set</code>中的值优先级更高。</p> 
<p>主从复制原理：</p> 
<p>通过部署无头服务（Headless Service）将写操作指向固定的数据库。</p> 
<p>部署一个 Service 用来做读操作的负载均衡。</p> 
<p>数据库之间通过同步程序保持数据一致。</p> 
<p><img src="https://images2.imgbox.com/b9/56/OcraDCNb_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>初始化容器（Init Containers）</p> 
</blockquote> 
<p>初始化容器（Init Containers）是一种特殊容器，它在 Pod 内的应用容器启动之前运行。</p> 
<p>初始化容器未执行完毕或以错误状态退出，Pod 内的应用容器不会启动。</p> 
<p>初始化容器需要在 <code>initContainers</code> 中定义，与 <code>containers</code> 同级。</p> 
<p>基于上面的特性，初始化容器通常用于</p> 
<ul><li>生成配置文件</li><li>执行初始化命令或脚本</li><li>执行健康检查（检查依赖的服务是否处于 Ready 或健康 Health 的状态）</li></ul> 
<hr> 
<p>这里有两个初始化容器。</p> 
<ul><li><code>init-mysql</code>为 MySQL 实例分配<code>server-id</code>，并将<code>mysql-0</code>的配置文件设置为<code>primary.cnf</code>，其他副本设置为<code>replica.cnf</code></li><li><code>clone-mysql</code>从前一个<code>Pod</code>中获取备份的数据文件放到自己的数据目录下</li></ul> 
<p><img src="https://images2.imgbox.com/63/ca/PdldK2UR_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>边车 Sidecar</p> 
</blockquote> 
<p>Pod 中运行了2个容器，MySQL 容器和一个充当辅助工具的 xtrabackup 容器，我们称之为边车（sidecar）。</p> 
<p>Xtrabackup 是一个开源的 MySQL 备份工具，支持在线热备份（备份时不影响数据读写），是目前各个云厂商普遍使用的 MySQL 备份工具。</p> 
<p><img src="https://images2.imgbox.com/af/52/R6Omg3JH_o.png" alt="在这里插入图片描述"></p> 
<p><code>sidecar</code>容器负责将备份的数据文件发送给下一个<code>Pod</code>，并在副本服务器初次启动时，使用数据文件完成数据的导入。</p> 
<p>MySQL 使用<code>bin-log</code>同步数据，但是，当数据库运行一段时间后，产生了一些数据，这时候如果我们进行扩容，创建了一个新的副本，有可能追溯不到<code>bin-log</code>的源头(可能被手动清理或者过期自动删除)，因此需要将现有的数据导入到副本之后，再开启数据同步，<code>sidecar</code>只负责数据库初次启动时完成历史数据导入，后续的数据 MySQL 会自动同步。</p> 
<p>补充：端口转发，临时暴露服务</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                          READY   STATUS    RESTARTS            AGE
pod/my-db-mysql-primary-0     <span class="token number">1</span>/1     Running   <span class="token number">0</span>                   15m
pod/my-db-mysql-secondary-0   <span class="token number">1</span>/1     Running   <span class="token number">0</span>                   15m
pod/my-db-mysql-secondary-1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>                   13m
pod/nginx                     <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>invalid<span class="token operator">&gt;</span> ago<span class="token punctuation">)</span>   91m

NAME                                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
service/kubernetes                       ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    4d17h
service/my-db-mysql-primary              ClusterIP   <span class="token number">10.96</span>.140.100   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3306</span>/TCP   15m
service/my-db-mysql-primary-headless     ClusterIP   None            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3306</span>/TCP   15m
service/my-db-mysql-secondary            ClusterIP   <span class="token number">10.96</span>.64.24     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3306</span>/TCP   15m
service/my-db-mysql-secondary-headless   ClusterIP   None            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3306</span>/TCP   15m

NAME                                     READY   AGE
statefulset.apps/my-db-mysql-primary     <span class="token number">1</span>/1     15m
statefulset.apps/my-db-mysql-secondary   <span class="token number">2</span>/2     15m
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl port-forward pods/my-db-mysql-primary-0 --address=192.168.0.111 33060:3306</span>
Forwarding from <span class="token number">192.168</span>.0.111:33060 -<span class="token operator">&gt;</span> <span class="token number">3306</span>
Handling connection <span class="token keyword">for</span> <span class="token number">33060</span>
Handling connection <span class="token keyword">for</span> <span class="token number">33060</span>
</code></pre> 
<p>这个命令是前台命令，退出后，端口转发就失效了。常用来做测试。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/efa8a46ad27961862ad3c2c1932bc2ec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">k8s入门到实战（十一）—— DaemonSet详细介绍及使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/615707bfc6b8a56aac6bc9cd9374c522/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">KubeSphere简单介绍及安装使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>