<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Clickhouse表引擎的总结 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/48ce56ef29405aea824da963f2696fd7/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Clickhouse表引擎的总结">
  <meta property="og:description" content="官方文档https://clickhouse.com/docs/en/engines/table-engines
MergerTree引擎家族，只要带MergerTree的就是
MergerTree
ReplicatedMergeTree
ReplicatedAggregatingMergeTree
ReplicatedReplacingMergeTree
ReplicatedSummingMergeTree
ReplacingMergeTree
SummingMergeTree
AggregatingMergeTree
其他引擎
Distributed
Merge
MaterializedView
最佳实践：
4节点的集群，1-2节点为分片1，且1-2互为对方副本，3-4节点为分片2，且3-4互为对方副本，集群配置文件中的子配置项分片权重的配置不用配置会直接使用默认值1即数据平分到2个现有分片，集群配置文件中的子配置项&amp;lt;internal_replication&amp;gt;&amp;lt;/internal_replication&amp;gt;数据是否同时写入多个副本的配置配置为true即写操作只选一个正常的副本写入数据然后数据的复制工作交给实际需要写入数据的表本身而不是分布式表。
创建Distributed分布式表其中该分布式表使用ReplicatedMergeTree引擎的表作为子表，分布式表不再需要配置sharding_key，数据插入Distributed分布式表后，此时在4个节点上查看到的分布式表数据都是一样的
创建Distributed分布式表其中该分布式表使用ReplicatedMergeTree引擎的表作为子表，分布式表不再需要配置sharding_key，数据插入各个节点的ReplicatedMergeTree引擎子表，此时在4个节点上查看到的分布式表数据是一样的
创建Distributed分布式表其中该分布式表使用MergeTree引擎的表作为子表，数据库插入Distributed分布式表或各个节点的MergeTree引擎子表后，在4个节上看到的分布式表数据不一致，且经常错乱无章
仅仅使用ENGINE = MergeTree()表引擎的话，Clickhouse缺少了两个功能————数据高可用(HA)和横向扩展。HA的目的是为了如果有一个数据副本丢失或者损坏不至于完全丢失数据，至于横向扩展自然是为了提高数据存储能力了。数据高可用(HA)的实现需要使用ReplicatedMergeTree表引擎，横向扩展的实现需要使用Distributed表引擎，Clickhouse github上有一段总结
if your data is too big to fit/ to process on one server - use sharding
to balance the load between replicas and to combine the result of selects from different shards - use Distributed table.
MergeTree表引擎
https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree
ENGINE = MergeTree()括号里面没有参数，所以不受宏配置macros的影响。但是ENGINE = MergeTree()有setting选项enable_mixed_granularity_parts，如果您的表里有很大的行，可以开启enable_mixed_granularity_parts这项配置来提升SELECT查询的性能。
MergeTree 系列的引擎被设计用于插入极大量的数据到一张表当中。数据可以以数据片段的形式一个接着一个的快速写入，数据片段在后台按照一定的规则进行合并。相比在插入时不断修改（重写）已存储的数据，这种策略会高效很多。其实就是批量数据快速插入和后台并发处理的两大优势。
Clickhouse集群4节点，在节点1执行如下">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-01T21:52:22+08:00">
    <meta property="article:modified_time" content="2023-12-01T21:52:22+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Clickhouse表引擎的总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>官方文档https://clickhouse.com/docs/en/engines/table-engines</p> 
<p>MergerTree引擎家族，只要带MergerTree的就是<br> MergerTree<br> ReplicatedMergeTree<br> ReplicatedAggregatingMergeTree<br> ReplicatedReplacingMergeTree<br> ReplicatedSummingMergeTree<br> ReplacingMergeTree<br> SummingMergeTree<br> AggregatingMergeTree</p> 
<p>其他引擎<br> Distributed<br> Merge<br> MaterializedView</p> 
<p>最佳实践：<br> 4节点的集群，1-2节点为分片1，且1-2互为对方副本，3-4节点为分片2，且3-4互为对方副本，集群配置文件中的子配置项分片权重的配置不用配置会直接使用默认值1即数据平分到2个现有分片，集群配置文件中的子配置项&lt;internal_replication&gt;&lt;/internal_replication&gt;数据是否同时写入多个副本的配置配置为true即写操作只选一个正常的副本写入数据然后数据的复制工作交给实际需要写入数据的表本身而不是分布式表。<br> 创建Distributed分布式表其中该分布式表使用ReplicatedMergeTree引擎的表作为子表，分布式表不再需要配置sharding_key，数据插入Distributed分布式表后，此时在4个节点上查看到的分布式表数据都是一样的<br> 创建Distributed分布式表其中该分布式表使用ReplicatedMergeTree引擎的表作为子表，分布式表不再需要配置sharding_key，数据插入各个节点的ReplicatedMergeTree引擎子表，此时在4个节点上查看到的分布式表数据是一样的</p> 
<p>创建Distributed分布式表其中该分布式表使用MergeTree引擎的表作为子表，数据库插入Distributed分布式表或各个节点的MergeTree引擎子表后，在4个节上看到的分布式表数据不一致，且经常错乱无章</p> 
<p>仅仅使用ENGINE = MergeTree()表引擎的话，Clickhouse缺少了两个功能————数据高可用(HA)和横向扩展。HA的目的是为了如果有一个数据副本丢失或者损坏不至于完全丢失数据，至于横向扩展自然是为了提高数据存储能力了。数据高可用(HA)的实现需要使用ReplicatedMergeTree表引擎，横向扩展的实现需要使用Distributed表引擎，Clickhouse github上有一段总结<br> if your data is too big to fit/ to process on one server - use sharding<br> to balance the load between replicas and to combine the result of selects from different shards - use Distributed table.</p> 
<p><strong>MergeTree表引擎</strong><br> https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree</p> 
<p>ENGINE = MergeTree()括号里面没有参数，所以不受宏配置macros的影响。但是ENGINE = MergeTree()有setting选项enable_mixed_granularity_parts，如果您的表里有很大的行，可以开启enable_mixed_granularity_parts这项配置来提升SELECT查询的性能。</p> 
<p>MergeTree 系列的引擎被设计用于插入极大量的数据到一张表当中。数据可以以数据片段的形式一个接着一个的快速写入，数据片段在后台按照一定的规则进行合并。相比在插入时不断修改（重写）已存储的数据，这种策略会高效很多。其实就是批量数据快速插入和后台并发处理的两大优势。</p> 
<p>Clickhouse集群4节点，在节点1执行如下</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_mergetree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_mergetree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest2.table_mergetree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest2.table_mergetree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>以下结果只在节点1可以查询到结果12行，其他节点查询的结果都是0行</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetree<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest2.table_mergetree<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token variable"><span class="token variable">`</span>create table lukestest1.table1 <span class="token punctuation">(</span>country String, province String, value String <span class="token punctuation">)</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> partition by <span class="token punctuation">(</span>country, province<span class="token punctuation">)</span> order by value<span class="token punctuation">;</span><span class="token variable">`</span></span> 
</code></pre> 
<p>–不指定cluster cluster_2shared2replicas表示只在当前节点创建表</p> 
<pre><code class="prism language-bash">insert into lukestest1.table1 <span class="token punctuation">(</span>country, province, value<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'JXi'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'SXi'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'SD'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'JS'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>–engine=MergeTree()只在当前节点insert数据<br> 在节点1创建表，发现节点2，3，4都没有这张表，数据也只在节点1有</p> 
<pre><code class="prism language-bash">create table lukestest1.table2 on cluster cluster_2shared2replicas <span class="token punctuation">(</span>country String, province String, value String <span class="token punctuation">)</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> partition by <span class="token punctuation">(</span>country, province<span class="token punctuation">)</span> order by value<span class="token punctuation">;</span> 
</code></pre> 
<p>指定cluster cluster_2shared2replicas表示只在所有节点创建表</p> 
<pre><code class="prism language-bash">insert into lukestest1.table2 <span class="token punctuation">(</span>country, province, value<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'JXi'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'SXi'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'SD'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token string">'China'</span>,<span class="token string">'JS'</span>,<span class="token string">'good'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>–engine=MergeTree()只在当前节点insert数据<br> 在节点1创建表并插入数据，发现节点2，3，4有这张表，但是只有节点1有数据，节点2，3，4都没有数据</p> 
<p><strong>ReplicatedMergeTree表引擎</strong><br> https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/replication</p> 
<p>ENGINE = ReplicatedMergeTree()括号里面没有cluster但是有shard和replica参数，所以受宏配置macros的影响</p> 
<p>Clickhouse只有MergeTree 系列里的表可支持副本, 其中<em>可以是Summing，Replacing，Aggregating等名称的Replicated</em>MergeTree的表就是MergeTree系列里面支持副本的引擎，ReplicatedMergeTreez只是其中可支持数据副本的一种引擎，副本是表级别的，不是整个服务器级的。所以，服务器里可以同时有复制表和非复制表。副本不依赖分片。每个分片有它自己的独立副本。ClickHouse 使用 Apache ZooKeeper 存储副本的元信息。请使用 ZooKeeper 3.4.5 或更高版本。要使用副本，需在 Zookeeper 服务器的配置部分设置相应参数。</p> 
<p>Replicated*MergeTree 参数和建表语句<br> zoo_path — ZooKeeper 中该表的路径。–见下例中的/clickhouse/tables/{layer}-{shard}/table_name<br> replica_name — ZooKeeper 中的该表的副本名称。 --见下例中的{replica}<br> 示例:</p> 
<pre><code class="prism language-bash">CREATE TABLE table_name
<span class="token punctuation">(</span>
    EventDate DateTime,
    CounterID UInt32,
    UserID UInt32
<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token string">'/clickhouse/tables/{layer}-{shard}/table_name'</span>, <span class="token string">'{replica}'</span><span class="token punctuation">)</span>
PARTITION BY toYYYYMM<span class="token punctuation">(</span>EventDate<span class="token punctuation">)</span>
ORDER BY <span class="token punctuation">(</span>CounterID, EventDate, intHash32<span class="token punctuation">(</span>UserID<span class="token punctuation">))</span>
SAMPLE BY intHash32<span class="token punctuation">(</span>UserID<span class="token punctuation">)</span>
</code></pre> 
<p>/clickhouse/tables/ 是公共前缀，我们推荐使用这个。<br> {layer}-{shard} 是分片标识部分。<br> table_name 是该表在 ZooKeeper 中的名称。<br> {replica}副本名称用于标识同一个表分片的不同副本。<br> 你也可以显式指定这些参数，而不是使用宏macros替换。使用大型集群时，我们建议使用宏替换，因为它可以降低出错的可能性。我个人环境中的宏macros配置如下(1-2节点配置01，3-4节点配置02，的话每个节点配置为自己的服务器名即可比如DAILACHDBUD001配置为DAILACHDBUD001)。</p> 
<pre><code>&lt;macros&gt;
        &lt;shard&gt;01&lt;/shard&gt;
        &lt;replica&gt;DAILACHDBUD001&lt;/replica&gt;
&lt;/macros&gt;
</code></pre> 
<p>Clickhouse集群4节点，在节点1执行如下</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_ReplicatedMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_ReplicatedMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest2.table_ReplicatedMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest2.table_ReplicatedMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>以下结果在节点1和节点2可以查询到结果12行，节点3和节点4查询的结果都是0行，原因是因为节点1和节点2是同一个shard分片下面的replica，也就是节点1和节点2互为对方的副本</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest2.table_ReplicatedMergeTree<span class="token punctuation">;</span>
</code></pre> 
<p><strong>ReplicatedReplacingMergeTree表引擎</strong><br> Clickhouse集群4节点，在节点1执行如下</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_ReplicatedReplacingMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedReplacingMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_ReplicatedReplacingMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest2.table_ReplicatedReplacingMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedReplacingMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest2.table_ReplicatedReplacingMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>以下结果在节点1和节点2可以查询到结果12行，节点3和节点4查询的结果都是0行，原因是因为节点1和节点2是同一个shard分片下面的replica，也就是节点1和节点2互为对方的副本</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedReplacingMergeTree<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest2.table_ReplicatedReplacingMergeTree<span class="token punctuation">;</span>
</code></pre> 
<p><strong>ReplicatedAggregatingMergeTree表引擎</strong><br> Clickhouse集群4节点，在节点1执行如下</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_ReplicatedAggregatingMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedAggregatingMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_ReplicatedAggregatingMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest2.table_ReplicatedAggregatingMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedAggregatingMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest2.table_ReplicatedAggregatingMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>以下结果在节点1和节点2可以查询到结果12行，节点3和节点4查询的结果都是0行，原因是因为节点1和节点2是同一个shard分片下面的replica，也就是节点1和节点2互为对方的副本</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedAggregatingMergeTree<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest2.table_ReplicatedAggregatingMergeTree<span class="token punctuation">;</span>
</code></pre> 
<p><strong>Distributed引擎</strong><br> https://clickhouse.com/docs/zh/engines/table-engines/special/distributed</p> 
<p>ENGINE = Distributed()括号里面有cluster和sharding_key参数，不受宏配置macros的影响，但是受集群配置中指定集群的影响，比如个人案例受cluster_2shared2replicas这个指定集群的影响</p> 
<p>ENGINE = Distributed()分布式表引擎本身不存储数据，但可以在多个服务器上进行分布式查询，实际上ENGINE = Distributed()分布式表是一种view，映射到ClickHouse集群的本地表。读是自动并行的。读取时，远程服务器表的索引（如果有的话）会被使用。<br> 通过分布式引擎可以像使用本地服务器一样使用集群。但是，集群不是自动扩展的：你必须编写集群配置到集群环境下的所有服务器的配置文件中。</p> 
<p>查询一个Distributed表时，SELECT查询被发送到所有的分片，不管数据是如何分布在分片上的(它们可以完全随机分布)。当您添加一个新分片时，您不必将旧数据传输到它。相反，您可以使用更重的权重向其写入新数据——数据的分布会稍微不均匀，但查询将正确有效地工作。</p> 
<p>向集群写数据的方法有两种：<br> 一，自已指定要将哪些数据写入哪些服务器，并直接在每个分片上执行写入。换句话说，在ENGINE = Distributed()分布式表上执行select，在数据表(ENGINE = Distributed()分布式表的子表)上INSERT。 这是最灵活的解决方案，也是最佳解决方案，因为数据可以完全独立地写入不同的分片。<br> 二，在ENGINE = Distributed()分布式表上执行INSERT。在这种情况下，分布式表会跨服务器分发插入数据。 为了写入分布式表，必须要配置分片键sharding_key。当然，如果只有一个分片，则写操作在没有分片键的情况下也能工作，因为这种情况下分片键没有意义。每个分片的写入权重可以在集群配置文件中的子配置项中定义。默认情况下，权重等于1。数据依据分片权重按比例分发到分片上。例如，如果有两个分片，第一个分片的权重是9，而第二个分片的权重是10，则发送9/19的行到第一个分片，10/19的行到第二个分片。分片数据该写入一个副本还是写入所有副本，可在集群配置文件中的子配置项&lt;internal_replication&gt;&lt;/internal_replication&gt;中定义。此参数设置为true时，写操作只选一个正常的副本写入数据。如果分布式表的子表是复制表(*ReplicaMergeTree)，请使用此方案。换句话说，这其实是把数据的复制工作交给实际需要写入数据的表本身而不是分布式表。若此参数设置为false（默认值），写操作会将数据写入所有副本。</p> 
<p>备注：在创建ENGINE = Distributed()表时指定sharding_key或不指定sharding_key或随意指定sharding_key值，并不会影响各个节点执行select count(*) from ENGINE = Distributed()表的总行数</p> 
<p>Clickhouse集群4节点，在节点1执行如下</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_Distributed_mergetree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_mergetree,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into lukestest1.table_Distributed_mergetree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'25'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'26'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'27'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'28'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest1.table_Distributed_ReplicatedMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_ReplicatedMergeTree,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into lukestest1.table_Distributed_ReplicatedMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'25'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'26'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'27'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'28'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest2.table_Distributed_mergetree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest2, table_mergetree,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into lukestest2.table_Distributed_mergetree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'25'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'26'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'27'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'28'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest2.table_Distributed_ReplicatedMergeTree ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest2, table_ReplicatedMergeTree,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into lukestest2.table_Distributed_ReplicatedMergeTree <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'25'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'26'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'27'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'28'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>以下结果在节点1可以分别查询到14(20),20,18(20),20行<br> 以下结果在节点2可以分别查询到0(6),20,0(2),20行<br> 以下结果在节点3可以分别查询到6(20),20,0(18),20行<br> 以下结果在节点4可以分别查询到0(14),20,2(20),20行</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_Distributed_mergetree<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_ReplicatedMergeTree<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest2.table_Distributed_mergetree<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest2.table_Distributed_ReplicatedMergeTree<span class="token punctuation">;</span>
</code></pre> 
<p>以下结果在节点1可以分别查询到14,15,18,18行<br> 以下结果在节点2可以分别查询到0,15,0,18行<br> 以下结果在节点3可以分别查询到6,5,0,2行<br> 以下结果在节点4可以分别查询到0,5,2,2行</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetree<span class="token punctuation">;</span> 
<span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree<span class="token punctuation">;</span> 
<span class="token keyword">select</span> * from lukestest2.table_mergetree<span class="token punctuation">;</span> 
<span class="token keyword">select</span> * from lukestest2.table_ReplicatedMergeTree<span class="token punctuation">;</span> 
</code></pre> 
<p>已有数据表的情况下，即当Distributed表指向当前服务器上已经存在的一个表时，需要使用CREATE TABLE Distributed_table_name ON CLUSTER CLUSTER_NAME AS existed_table_name ENGINE = Distributed()</p> 
<p>Clickhouse集群4节点，已有数据表是MergeTree()引擎，执行如下情况</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.tableMergeTree1 ON CLUSTER cluster_2shared2replicas <span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.tableMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'13'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'14'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.tableMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点2执行
insert into lukestest1.tableMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'31'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'32'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'33'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'34'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点3执行
insert into lukestest1.tableMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'41'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'42'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'43'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'44'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点4执行

CREATE TABLE lukestest1.tableMergeTree1_view ON CLUSTER cluster_2shared2replicas AS lukestest1.tableMergeTree1 ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, tableMergeTree1<span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
CREATE TABLE lukestest1.tableMergeTree1_view01 ON CLUSTER cluster_2shared2replicas AS lukestest1.tableMergeTree1 ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, tableMergeTree1,01<span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
CREATE TABLE lukestest1.tableMergeTree1_view02 ON CLUSTER cluster_2shared2replicas AS lukestest1.tableMergeTree1 ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, tableMergeTree1,02<span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
CREATE TABLE lukestest1.tableMergeTree1_view_rand ON CLUSTER cluster_2shared2replicas AS lukestest1.tableMergeTree1 ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, tableMergeTree1,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
--节点1执行
</code></pre> 
<p>以下结果在节点1可以分别查到4,8行数据库，分别是看到只有自己的11-14，看到只有11-14和31-34的8行<br> 以下结果在节点2可以分别查到4,8行数据库，分别是看到只有自己的21-24，看到只有21-24和41-44的8行<br> 以下结果在节点3可以分别查到4,8行数据库，分别是看到只有自己的31-34，看到只有11-14和31-34的8行<br> 以下结果在节点4可以分别查到4,8行数据库，分别是看到只有自己的41-44，看到只有21-24和41-44的8行</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.tableMergeTree1<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.tableMergeTree1_view<span class="token punctuation">;</span>
</code></pre> 
<p>备注：也就是1-3节点看到的Distributed数据一致，2-4节点看到的Distributed数据一致，而且不管Distributed中shard_key是如何设置,每个节点看到Distributed引擎的表的数据都只有8行而不是16行。Distributed中shard_key设置可以为如下Distributed(cluster_2shared2replicas, lukestest1, tableMergeTree1)，Distributed(cluster_2shared2replicas, lukestest1, tableMergeTree1,01)，Distributed(cluster_2shared2replicas, lukestest1, tableMergeTree1,02)，Distributed(cluster_2shared2replicas, lukestest1, tableMergeTree1,rand())</p> 
<p>Clickhouse集群4节点，已有数据表是ReplicatedMergeTree()引擎，执行如下情况</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_ReplicatedMergeTree1 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
--节点1执行

insert into lukestest1.table_ReplicatedMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'13'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'14'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_ReplicatedMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点2执行
insert into lukestest1.table_ReplicatedMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'31'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'32'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'33'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'34'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点3执行
insert into lukestest1.table_ReplicatedMergeTree1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'41'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'42'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'43'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'44'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点4执行

CREATE TABLE lukestest1.table_ReplicatedMergeTree1_view ON CLUSTER cluster_2shared2replicas AS lukestest1.table_ReplicatedMergeTree1 ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_ReplicatedMergeTree1,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
--节点1执行
</code></pre> 
<p>以下结果在节点1可以分别查到8,16行数据库，分别是看到只有自己的11-14和节点2的21-24，看到所有16行<br> 以下结果在节点2可以分别查到8,16行数据库，分别是看到只有自己的21-24和节点1的11-14，看到所有16行<br> 以下结果在节点3可以分别查到8,16行数据库，分别是看到只有自己的31-34和节点4的41-44，看到所有16行<br> 以下结果在节点4可以分别查到8,16行数据库，分别是看到只有自己的41-44和节点3的31-44，看到所有16行</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree1<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree1_view<span class="token punctuation">;</span>
</code></pre> 
<p>创建Distributed分布式表其中该分布式表使用ReplicatedMergeTree引擎的表作为子表，数据插入各个节点的ReplicatedMergeTree引擎子表，此时在4个节点上查看到的分布式表数据是一致的，如下实验</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_ReplicatedMergeTree2 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
--节点1执行
CREATE TABLE lukestest1.table_Distributed_ReplicatedMergeTree2 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_ReplicatedMergeTree2,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_ReplicatedMergeTree2 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_ReplicatedMergeTree2 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点2执行
insert into lukestest1.table_ReplicatedMergeTree2 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'31'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'32'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'33'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'34'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点3执行
insert into lukestest1.table_ReplicatedMergeTree2 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'41'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'42'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'43'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'44'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点4执行
</code></pre> 
<p>以下结果在节点1可以分别查询到8,16行，8行数据与节点2数据一致，16行数据和其他节点一致<br> 以下结果在节点2可以分别查询到8,16行，8行数据与节点1数据一致，16行数据和其他节点一致<br> 以下结果在节点3可以分别查询到8,16行，8行数据与节点4数据一致，16行数据和其他节点一致<br> 以下结果在节点4可以分别查询到8,16行，8行数据与节点3数据一致，16行数据和其他节点一致</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree2<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_ReplicatedMergeTree2<span class="token punctuation">;</span>
</code></pre> 
<p>ENGINE = Distributed的表不能做update操作</p> 
<pre><code class="prism language-bash">ALTER TABLE lukestest1.tableMergeTree1_view ON CLUSTER cluster_2shared2replicas UPDATE <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">11</span> where <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span>
ALTER TABLE lukestest1.tableMergeTree1_view ON CLUSTER cluster_2shared2replicas UPDATE create_time <span class="token operator">=</span> <span class="token string">'2022-11-17'</span> where create_time <span class="token operator">=</span> <span class="token string">'2020-11-17'</span><span class="token punctuation">;</span>
两者都报错DB::Exception: Table engine Distributed doesn't support mutations. <span class="token punctuation">(</span>NOT_IMPLEMENTED<span class="token punctuation">)</span> <span class="token punctuation">(</span>version <span class="token number">23.4</span>.2.11 <span class="token punctuation">(</span>official build<span class="token punctuation">))</span>
</code></pre> 
<p>ENGINE = MergeTree()的表不能对ORDER BY的字段做update</p> 
<pre><code class="prism language-bash">ALTER TABLE lukestest1.tableMergeTree1 ON CLUSTER cluster_2shared2replicas UPDATE <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">101</span> where <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span>--报错DB::Exception: Cannot UPDATE key <span class="token function">column</span> <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span><span class="token builtin class-name">.</span> <span class="token punctuation">(</span>CANNOT_UPDATE_COLUMN<span class="token punctuation">)</span> <span class="token punctuation">(</span>version <span class="token number">23.4</span>.2.11 <span class="token punctuation">(</span>official build<span class="token punctuation">))</span>
ALTER TABLE lukestest1.tableMergeTree1 ON CLUSTER cluster_2shared2replicas UPDATE create_time <span class="token operator">=</span> <span class="token string">'2022-11-17'</span> where create_time <span class="token operator">=</span> <span class="token string">'2020-11-17'</span><span class="token punctuation">;</span>
正常执行,不再报错
</code></pre> 
<p>创建ENGINE = Distributed分布式表，分布式表名和子表名(子表就是Distributed(cluster_2shared2replicas, lukestest1, table_distributed1,rand())里面的表名)不能一致</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_distributed1 ON CLUSTER cluster_2shared2replicas <span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_distributed1,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
报错DB::Exception: Distributed table table_distributed1 looks at itself. <span class="token punctuation">(</span>INFINITE_LOOP<span class="token punctuation">)</span> <span class="token punctuation">(</span>version <span class="token number">23.4</span>.2.11 <span class="token punctuation">(</span>official build<span class="token punctuation">))</span>. <span class="token punctuation">(</span>INFINITE_LOOP<span class="token punctuation">)</span>
</code></pre> 
<p>创建ENGINE = Distributed分布式表，分布式表名lukestest1.table_distributed1,子表名lukestest1.table_MergeTree1,但是子表名不存在，此时分布式表可以创建成功，但是插入数据会报错子表不存在，必须先在各个节点创建好子表后再插入数据</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_distributed1 ON CLUSTER cluster_2shared2replicas <span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_MergeTree1,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
--表正常创建，不再报错
insert into lukestest1.table_distributed1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'13'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'14'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>报错DB::Exception: Table lukestest1.table_MergeTree1 doesn't exist. <span class="token punctuation">(</span>UNKNOWN_TABLE<span class="token punctuation">)</span>
</code></pre> 
<p>额外的实验1，ENGINE = Distributed和ENGINE = MergeTree()，数据只插入节点1和节点2，或数据只插入节点1和节点3，或数据只插入节点1</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_mergetree3 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
--节点1执行
CREATE TABLE lukestest1.table_Distributed_mergetree3 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_mergetree3,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
--节点1执行

insert into lukestest1.table_mergetree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_mergetree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点2执行
</code></pre> 
<p>以下结果在节点1可以分别查询到4,4行，第一个4行数据与节点2数据不一致，第二个4行数据与节点2数据不一致，节点1的数据全是自己的1,2,3,4<br> 以下结果在节点2可以分别查询到4,4行，第一个4行数据与节点1数据不一致，第二个4行数据和节点1数据不一致，节点1的数据全是自己的21,22,23,24<br> 以下结果在节点3可以分别查询到0,4行，4行数据与节点1一致,是1,2,3,4<br> 以下结果在节点4可以分别查询到0,4行，4行数据与节点2一致,是21,22,23,24</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetree3<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_mergetree3<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash">insert into lukestest1.table_mergetree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'13'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'14'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_mergetree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'31'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'32'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'33'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'34'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点3执行
</code></pre> 
<p>以下结果在节点1可以分别查询到8,12行，8行数据是1,2,3,4,11,12,13,14，12行数据是1,2,3,4,11,12,13,14,31,32,33,34<br> 以下结果在节点2可以分别查询到4,8行，4行数据是21,22,23,24，8行数据是21,22,23,24,31,32,33,34<br> 以下结果在节点3可以分别查询到4,8行，4行数据是31,32,33,34，8行数据是21,22,23,24,31,32,33,34<br> 以下结果在节点4可以分别查询到0,8或4行，4行和8行不定期出现一会出现4行一会出现8行，4行数据是21,22,23,24，8行数据是1,2,3,4,11,12,13,14</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetree3<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_mergetree3<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash">insert into lukestest1.table_mergetree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'111'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'112'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'113'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'114'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
</code></pre> 
<p>以下结果在节点1可以分别查询到12,12或16行，12行是1,2,3,4,11,12,13,14,111,112,113,114,分布式表有时出现12行和有时出现16行<br> 以下结果在节点2可以分别查询到4,4或8行，4行数据是21,22,23,24，分布式表有时出现4行和有时出现8行<br> 以下结果在节点3可以分别查询到4,8或16行，4行数据是31,32,33,34，分布式表有时出现8行和有时出现16行<br> 以下结果在节点4可以分别查询到0,4或12行，分布式表有时出现4行和有时出现12行</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetree3<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_mergetree3<span class="token punctuation">;</span>
</code></pre> 
<p>额外的实验2，ENGINE = Distributed和ENGINE = ReplicatedMergeTree()，数据只插入节点1和节点2，或数据只插入节点1和节点3，或数据只插入节点1</p> 
<p>数据只插入节点1和节点2</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_ReplicatedMergeTree3 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
--节点1执行
CREATE TABLE lukestest1.table_Distributed_ReplicatedMergeTree3 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table_ReplicatedMergeTree3,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_ReplicatedMergeTree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_ReplicatedMergeTree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'24'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点2执行
</code></pre> 
<p>以下结果在节点1可以分别查询到8,8行，第一个8行数据与节点2数据一致，第二个8行数据和其他节点一致<br> 以下结果在节点2可以分别查询到8,8行，第一个8行数据与节点1数据一致，第二个8行数据和其他节点一致<br> 以下结果在节点3可以分别查询到0,8行，8行数据和其他节点一致<br> 以下结果在节点4可以分别查询到0,8行，8行数据和其他节点一致</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree3<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_ReplicatedMergeTree3<span class="token punctuation">;</span>
</code></pre> 
<p>数据只插入节点1和节点3</p> 
<pre><code class="prism language-bash">insert into lukestest1.table_ReplicatedMergeTree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'13'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'14'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
insert into lukestest1.table_ReplicatedMergeTree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'31'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'32'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'33'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'34'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点3执行
</code></pre> 
<p>以下结果在节点1可以分别查询到12,16行，12行数据与节点2数据一致，16行数据和其他节点一致<br> 以下结果在节点2可以分别查询到12,16行，12行数据与节点1数据一致，16行数据和其他节点一致<br> 以下结果在节点3可以分别查询到4,16行，4行数据与节点4数据一致，16行数据和其他节点一致<br> 以下结果在节点4可以分别查询到4,16行，4行数据与节点3数据一致，16行数据和其他节点一致</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree3<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_ReplicatedMergeTree3<span class="token punctuation">;</span>
</code></pre> 
<p>数据只插入节点1</p> 
<pre><code class="prism language-bash">insert into lukestest1.table_ReplicatedMergeTree3 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'111'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'112'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'113'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'114'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
--节点1执行
</code></pre> 
<p>以下结果在节点1可以分别查询到16,20行，16行数据与节点2数据一致，20行数据和其他节点一致<br> 以下结果在节点2可以分别查询到16,20行，16行数据与节点1数据一致，20行数据和其他节点一致<br> 以下结果在节点3可以分别查询到4,20行，4行数据与节点4数据一致，20行数据和其他节点一致<br> 以下结果在节点4可以分别查询到4,20行，4行数据与节点3数据一致，20行数据和其他节点一致</p> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_ReplicatedMergeTree3<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_Distributed_ReplicatedMergeTree3<span class="token punctuation">;</span>
</code></pre> 
<p>额外的实验3<br> 节点1执行</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table41 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
CREATE TABLE lukestest1.table41_all ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>cluster_2shared2replicas, lukestest1, table41,rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into lukestest1.table41_all <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>table4_all在四个节点的数据一致<br> table4在节点1、2数据一致，table4在节点3、4一致，shard1的数据落在节点1、2上，shard2的数据落在节点3、4上，节点1(或节点2)+节点3(或节点4)的数据刚好等于table4_all</p> 
<p>额外的实验4<br> 节点1执行</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table51 ON CLUSTER cluster_2shared2replicas<span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> PARTITION BY toYYYYMM<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table51 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'2'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'3'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'4'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'5'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'6'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'7'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'8'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'9'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'10'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>只有节点1、2有数据且数据一致且是全量数据,因为节点1和节点2互为对方副本,节点3、4该表存在但是都没有数据</p> 
<p><strong>Merge引擎</strong><br> https://clickhouse.com/docs/zh/engines/table-engines/special/merge<br> Merge引擎跟MergeTree引擎不是同一个概念不要混淆两者， Merge引擎本身不存储数据，但可用于同时从任意多个其他的表中读取数据。 读是自动并行的，不支持写入。读取时，那些被真正读取到数据的表的索引（如果有的话）会被使用。<br> Merge 引擎的参数：一个数据库名和一个用于匹配表名的正则表达式。<br> 示例：Merge(hits, ‘^WatchLog’)表示数据会从 hits 数据库中表名匹配正则 ‘^WatchLog’ 的表中读取。</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_mergetest1 <span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_mergetest1 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'1'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest1.table_mergetest12 <span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_mergetest12 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'122'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest1.table_mergetest23 <span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_mergetest23 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'233'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CREATE TABLE lukestest1.table_mergetest1_Merge <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>Merge<span class="token punctuation">(</span>lukestest1, <span class="token string">'^table_mergetest1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetest1_Merge<span class="token punctuation">;</span>
--看到lukestest1.table_mergetest1和table_mergetest12两表的数据
</code></pre> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_mergetest2_Merge <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>Merge<span class="token punctuation">(</span>lukestest1, <span class="token string">'^table_mergetest2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> * from lukestest1.table_mergetest2_Merge<span class="token punctuation">;</span>
--只看到lukestest1.table_mergetest23表的数据
</code></pre> 
<p><strong>MaterializedView 引擎</strong><br> https://clickhouse.com/docs/zh/engines/table-engines/special/materializedview<br> https://clickhouse.com/docs/zh/sql-reference/statements/create/view<br> 它需要使用一个不同的引擎来存储数据，这个引擎要在创建物化视图时指定。当从表中读取时，它就会使用该引擎。<br> CREATE MATERIALIZED VIEW [IF NOT EXISTS] [db.]table_name [ON CLUSTER] [TO[db.]name] [ENGINE = engine] [POPULATE] AS SELECT …<br> 创建不带TO [db].[table]的物化视图时，必须指定ENGINE – 用于存储数据的表引擎。<br> 使用TO [db].[table] 创建物化视图时，不得使用POPULATE。<br> ClickHouse 中的物化视图更像是插入触发器。 如果视图查询中有一些聚合，则它仅应用于一批新插入的数据。 对源表现有数据的任何更改（如更新、删除、删除分区等）都不会更改物化视图。<br> 物化视图是查询结果的持久化，可以理解为一张时刻在与计算的表，创建过程中用了一个特殊引擎。但是对更新、删除 操作支持并不好，更像是个插入触发器。<br> 如果指定POPULATE，则在创建视图时将现有表数据插入到视图中，就像创建一个CREATE TABLE … AS SELECT …一样。 否则，查询仅包含创建视图后插入表中的数据。 我们不建议使用POPULATE，因为在创建视图期间插入表中的数据不会插入其中。</p> 
<p>创建MaterializedView时必须指定engine，且这个engine的格式和创建表时一样，比如使用engine=MergeTree() 后面必须加order by 这些。</p> 
<pre><code class="prism language-bash">CREATE TABLE lukestest1.table_mergetest2 <span class="token punctuation">(</span>id String,create_time datetime<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> ORDER BY <span class="token function">id</span><span class="token punctuation">;</span>
insert into lukestest1.table_mergetest2 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'11'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'12'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'13'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'21'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'22'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'23'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

create materialized view lukestest1.table_mergetest2_materialized <span class="token assign-left variable">engine</span><span class="token operator">=</span>MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> POPULATE as <span class="token keyword">select</span> * from lukestest1.table_mergetest2 where <span class="token function">id</span> like <span class="token string">'%2%'</span><span class="token punctuation">;</span>--报错DB::Exception: ORDER BY or PRIMARY KEY clause is missing. Consider using extended storage definition syntax with ORDER BY or PRIMARY KEY clause. With deprecated old syntax <span class="token punctuation">(</span>highly not recommended<span class="token punctuation">)</span> storage MergeTree requires <span class="token number">3</span> to <span class="token number">4</span> parameters:

create materialized view lukestest1.table_mergetest2_materialized <span class="token assign-left variable">engine</span><span class="token operator">=</span>MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> order by <span class="token function">id</span> POPULATE as <span class="token keyword">select</span> * from lukestest1.table_mergetest2 where <span class="token function">id</span> like <span class="token string">'%2%'</span> <span class="token punctuation">;</span>
create materialized view lukestest1.table_mergetest2_materialized_nopopulate <span class="token assign-left variable">engine</span><span class="token operator">=</span>MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> order by <span class="token function">id</span> as <span class="token keyword">select</span> * from lukestest1.table_mergetest2 where <span class="token function">id</span> like <span class="token string">'%2%'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetest2_materialized<span class="token punctuation">;</span>
--有四条数据
<span class="token keyword">select</span> * from lukestest1.table_mergetest2_materialized_nopopulate<span class="token punctuation">;</span>
--没有数据
</code></pre> 
<pre><code class="prism language-bash">insert into lukestest1.table_mergetest2 <span class="token punctuation">(</span>id ,create_time<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token string">'222'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'223'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token string">'224'</span>,<span class="token string">'2020-11-17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token keyword">select</span> * from lukestest1.table_mergetest2_materialized<span class="token punctuation">;</span>
--有7条数据
<span class="token keyword">select</span> * from lukestest1.table_mergetest2_materialized_nopopulate<span class="token punctuation">;</span>
--有三条数据
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7aca282a678092f514aed8b9f69e2738/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Clickhouse遇到密码错误如何修改密码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c8266d16033d201b626992e76e0c9eac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">国内maven镜像</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>