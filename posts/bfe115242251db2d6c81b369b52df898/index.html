<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Spring Security权限框架】SpringBoot整合Spring Security实现权限控制 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/bfe115242251db2d6c81b369b52df898/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="【Spring Security权限框架】SpringBoot整合Spring Security实现权限控制">
  <meta property="og:description" content="文章目录 Spring Security介绍Spring Security案例1、快速搭建一个springboot工程2、导入SpringSecurity整合springboot工程3、认证3.1、登录流程校验3.2、入门案例的原理3.3、实现思路3.4、实现认证流程（自定义）3.5、正式实现3.5.1 实现数据库的校验3.5.2 密码加密存储3.5.3 自定义登陆接口实现3.5.4 自定义实现认证过滤器3.5.5 退出登录 4、授权4.1 授权基本流程4.2 授权实现（不结合数据库）4.2.1 限制访问资源所需权限4.2.2 封装权限信息 4.3 授权实现（结合数据库）4.3.1 设计数据库表4.3.2 代码实现4.3.3 测试 5、自定义访问失败处理5.1、自定义实现类5.2、配置给SpringSecurity 6、跨域问题7、扩展7.1、自定义权限校验方法7.2、基于配置的权限控制 8、 demo源码9、特别鸣谢 Spring Security介绍 要对Web资源进行保护，最好的办法莫过于Filter
要想对方法调用进行保护，最好的办法莫过于AOP。
Spring Security进行认证和鉴权的时候,就是利用的一系列的Filter来进行拦截的。
如图所示，一个请求想要访问到API就会从左到右经过蓝线框里的过滤器，其中绿色部分是负责认证的过滤器，蓝色部分是负责异常处理，橙色部分则是负责授权。进过一系列拦截最终访问到我们的API。
这里面我们只需要重点关注两个过滤器即可：
UsernamePasswordAuthenticationFilter负责登录认证，
FilterSecurityInterceptor负责权限授权。
一般Web应用的需要进行认证和授权。
​ 认证（Authentication）：验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户
​ 授权（Authorization）：经过认证后判断当前用户是否有权限进行某个操作
​ 而认证和授权就是SpringSecurity作为安全框架的核心功能。
说明：Spring Security的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了Spring Security！这个框架的使用方式就是对这些过滤器和组件进行扩展。
Spring Security案例 1、快速搭建一个springboot工程 此步骤省略
建议整合knif4j方便调试
访问接口文档：http://localhost:8081/doc.html（端口为自己设置的端口，默认是8080）
springboot工程搭建完成
2、导入SpringSecurity整合springboot工程 导入SpringSecurity依赖（版本跟随boot版本） &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-boot-starter-security&amp;lt;/artifactId&amp;gt; &amp;lt;/dependency&amp;gt; 重新启动项目进行测试：访问路径：http://localhost:8081/ayo/hhy/1 这时我们可以看到当我们访问我们的接口的时候，就会自动跳转到一个SpringSecurity的默认登陆页面(后期是需要整合到自己系统的登录页面来做认证）
这时候需要我们登录才可以进行访问，我们可以看到控制台有一串字符串，其实那就是SpringSecurity初始化生成给我的密码
用户名默认为 ：user
密码在控制台打印出来了
输入用户和密码登录后，就可以正常访问接口了
3、认证 3.1、登录流程校验 核心是通过用户输入的用户名和密码去和数据库中的数据进行比对，如果比对无误
那么就会使用jwt工具根据用户名和密码去生成一个token传给前端存储起来
在登录过后用户想要访问别的资源都要在请求头里面携带token，后端会对前端请求的token拿到并且解析出来用户的id
根据用户的id获取相关的信息，来判断用户是否有访问资格，如果有，则访问目标资源返回给前端，若没有，则返回错误信息（无权限访问）">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-08-14T13:38:58+08:00">
    <meta property="article:modified_time" content="2023-08-14T13:38:58+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Spring Security权限框架】SpringBoot整合Spring Security实现权限控制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#Spring_Security_1" rel="nofollow">Spring Security介绍</a></li><li><a href="#Spring_Security_26" rel="nofollow">Spring Security案例</a></li><li><ul><li><a href="#1springboot_27" rel="nofollow">1、快速搭建一个springboot工程</a></li><li><a href="#2SpringSecurityspringboot_37" rel="nofollow">2、导入SpringSecurity整合springboot工程</a></li><li><a href="#3_60" rel="nofollow">3、认证</a></li><li><ul><li><a href="#31_61" rel="nofollow">3.1、登录流程校验</a></li><li><a href="#32_70" rel="nofollow">3.2、入门案例的原理</a></li><li><a href="#33_87" rel="nofollow">3.3、实现思路</a></li><li><a href="#34_105" rel="nofollow">3.4、实现认证流程（自定义）</a></li><li><a href="#35_430" rel="nofollow">3.5、正式实现</a></li><li><ul><li><a href="#351___431" rel="nofollow">3.5.1 实现数据库的校验</a></li><li><a href="#352___526" rel="nofollow">3.5.2 密码加密存储</a></li><li><a href="#353___576" rel="nofollow">3.5.3 自定义登陆接口实现</a></li><li><a href="#354___726" rel="nofollow">3.5.4 自定义实现认证过滤器</a></li><li><a href="#355___888" rel="nofollow">3.5.5 退出登录</a></li></ul> 
    </li></ul> 
    </li><li><a href="#4_939" rel="nofollow">4、授权</a></li><li><ul><li><a href="#41___945" rel="nofollow">4.1 授权基本流程</a></li><li><a href="#42___950" rel="nofollow">4.2 授权实现（不结合数据库）</a></li><li><ul><li><a href="#421___951" rel="nofollow">4.2.1 限制访问资源所需权限</a></li><li><a href="#422___975" rel="nofollow">4.2.2 封装权限信息</a></li></ul> 
     </li><li><a href="#43___1023" rel="nofollow">4.3 授权实现（结合数据库）</a></li><li><ul><li><a href="#431___1030" rel="nofollow">4.3.1 设计数据库表</a></li><li><a href="#432___1195" rel="nofollow">4.3.2 代码实现</a></li><li><a href="#433___1244" rel="nofollow">4.3.3 测试</a></li></ul> 
    </li></ul> 
    </li><li><a href="#5_1257" rel="nofollow">5、自定义访问失败处理</a></li><li><ul><li><a href="#51_1266" rel="nofollow">5.1、自定义实现类</a></li><li><a href="#52SpringSecurity_1330" rel="nofollow">5.2、配置给SpringSecurity</a></li></ul> 
    </li><li><a href="#6_1380" rel="nofollow">6、跨域问题</a></li><li><a href="#7_1424" rel="nofollow">7、扩展</a></li><li><ul><li><a href="#71_1425" rel="nofollow">7.1、自定义权限校验方法</a></li><li><a href="#72_1458" rel="nofollow">7.2、基于配置的权限控制</a></li></ul> 
    </li><li><a href="#8_demo_1462" rel="nofollow">8、 demo源码</a></li><li><a href="#9_1465" rel="nofollow">9、特别鸣谢</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="Spring_Security_1"></a>Spring Security介绍</h3> 
<p>要对Web资源进行保护，最好的办法莫过于Filter<br> 要想对方法调用进行保护，最好的办法莫过于<a href="https://so.csdn.net/so/search?q=AOP&amp;spm=1001.2101.3001.7020">AOP</a>。</p> 
<p>Spring Security进行认证和鉴权的时候,就是利用的一系列的Filter来进行拦截的。<br> <img src="https://images2.imgbox.com/3d/19/XDy1XsFC_o.png" alt="在这里插入图片描述"><br> 如图所示，一个请求想要访问到API就会从左到右经过蓝线框里的过滤器，其中<strong>绿色部分是负责认证的过滤器，蓝色部分是负责异常处理，橙色部分则是负责授权</strong>。进过一系列拦截最终访问到我们的API。<br> <img src="https://images2.imgbox.com/c4/84/glEr9mCb_o.png" alt="在这里插入图片描述"><br> 这里面我们只需要重点关注两个过滤器即可：<br> <code>UsernamePasswordAuthenticationFilter</code>负责登录认证，<br> <code>FilterSecurityInterceptor</code>负责权限授权。</p> 
<p>一般Web应用的需要进行认证和授权。</p> 
<p>​ <code>认证（Authentication）</code>：<strong>验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户</strong></p> 
<p>​ <code>授权（Authorization）</code>：<strong>经过认证后判断当前用户是否有权限进行某个操作</strong></p> 
<p>​ 而认证和授权就是SpringSecurity作为安全框架的核心功能。</p> 
<p><img src="https://images2.imgbox.com/36/36/BwvRgb2K_o.png" alt="在这里插入图片描述"></p> 
<p>说明：<strong>Spring Security的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了Spring Security</strong>！这个框架的使用方式就是对这些过滤器和组件进行扩展。</p> 
<h3><a id="Spring_Security_26"></a>Spring Security案例</h3> 
<h4><a id="1springboot_27"></a>1、快速搭建一个springboot工程</h4> 
<p>此步骤省略</p> 
<blockquote> 
 <p><strong>建议整合knif4j方便调试</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/3b/95/yXCqina8_o.png" alt="在这里插入图片描述"><br> 访问接口文档：http://localhost:8081/doc.html（端口为自己设置的端口，默认是8080）<br> <img src="https://images2.imgbox.com/e2/57/f3fXwcTj_o.png" alt="在这里插入图片描述"><br> springboot工程搭建完成</p> 
<h4><a id="2SpringSecurityspringboot_37"></a>2、导入SpringSecurity整合springboot工程</h4> 
<ol><li>导入SpringSecurity依赖（版本跟随boot版本）</li></ol> 
<pre><code class="prism language-cpp"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>security<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

</code></pre> 
<ol start="2"><li>重新启动项目进行测试：<strong>访问路径：http://localhost:8081/ayo/hhy/1</strong></li></ol> 
<blockquote> 
 <p>这时我们可以看到当我们访问我们的接口的时候，就会自动跳转到一个SpringSecurity的默认登陆页面<code>(后期是需要整合到自己系统的登录页面来做认证）</code></p> 
</blockquote> 
<p><code>这时候需要我们登录才可以进行访问，</code>我们可以看到控制台有一串字符串，其实那就是SpringSecurity初始化生成给我的密码</p> 
<p><img src="https://images2.imgbox.com/78/1b/QdfqoHDF_o.png" alt="在这里插入图片描述"><br> <code>用户名</code>默认为 ：<code>user</code><br> <code>密码</code>在控制台打印出来了<br> <img src="https://images2.imgbox.com/91/fe/sQaecatF_o.png" alt="在这里插入图片描述"><br> 输入用户和密码登录后，就可以正常访问接口了<br> <img src="https://images2.imgbox.com/d9/26/PRVRCFqg_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3_60"></a>3、认证</h4> 
<h5><a id="31_61"></a>3.1、登录流程校验</h5> 
<p>核心是通过用户输入的用户名和密码去和数据库中的数据进行比对，如果比对无误</p> 
<p>那么就会使用jwt工具根据用户名和密码去生成一个token传给前端存储起来</p> 
<p>在登录过后用户想要访问别的资源都要在请求头里面携带token，后端会对前端请求的token拿到并且解析出来用户的id</p> 
<p>根据用户的id获取相关的信息，来判断用户是否有访问资格，如果有，则访问目标资源返回给前端，若没有，则返回错误信息（无权限访问）<br> <img src="https://images2.imgbox.com/36/b2/A2LVtHGb_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="32_70"></a>3.2、入门案例的原理</h5> 
<p><strong>前后端进行认证的流程：</strong><br> <img src="https://images2.imgbox.com/54/94/XTbp8SjJ_o.png" alt="在这里插入图片描述"><br> <strong>具体流程：</strong></p> 
<p><img src="https://images2.imgbox.com/f8/aa/6dLLpKu2_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>在上面的案例整合springSecurity，进入默认的登录页面进行登录的时候，是<code>查询内存中的用户名和密码</code>的，后期我们做项目肯定是要改成去数据库里面查询用户名和密码比对</p> 
</blockquote> 
<p>其中：</p> 
<ul><li> <p><strong>Authentication接口</strong>：它的实现类，表示当前访问系统的用户，封装了用户相关信息。</p> </li><li> <p><strong>AuthenticationManager接口</strong>：定义了认证Authentication的方法。</p> </li><li> <p><strong>UserDetailsService接口</strong>：加载用户特定数据的核心接口。里面定义了一个根据用户名查询用户信息的方法。</p> </li><li> <p><strong>UserDetails接口</strong>：提供核心用户信息。通过<code>UserDetailsService</code>根据用户名获取处理的用户信息要封装成<code>UserDetails</code>对象返回。然后将这些信息封装到<code>Authentication</code>对象中。</p> </li></ul> 
<h5><a id="33_87"></a>3.3、实现思路</h5> 
<p><strong>登录流程：</strong></p> 
<ol><li>登录认证成功之后根据用户名和密码通过<code>jwt生成一个token</code>返回给前端（前端每次请求都会携带token到请求里面），同时将token存入redis（其中用户id作为key，用户信息作为value）（主要是为了不让后续的校验流程频繁的查询数据库）</li><li>这里的<code>UserDetailsService</code>默认是去查内存来认证用户名和密码的，需要自定义<code>UserDetailsService</code>这个接口去查自己的数据库的数据进行认证</li><li>我们可以自定义一个UserDetailsService,让SpringSecurity使用我们的UserDetailsService。我们自己的UserDetailsService可以从数据库中查询用户名和密码。</li></ol> 
<p><img src="https://images2.imgbox.com/35/b9/tKqsPXKG_o.png" alt="在这里插入图片描述"><br> <strong>校验流程：</strong></p> 
<blockquote> 
 <p>获取token，解析token获取到其中的userId；<br> 根据userId，从redis中获取用户信息，存入SecurityContextHolder。</p> 
</blockquote> 
<ol><li>前端每次发送请求的时候，请求头都会携带token。</li><li>后端从redis根据key去拿到token，并且通过jwt解析出用户的信息。</li><li>通过用户的信息查询用户可以使用的权限，然后返回给前端去访问能访问的资源</li></ol> 
<p><img src="https://images2.imgbox.com/88/ab/XB0R6mVn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="34_105"></a>3.4、实现认证流程（自定义）</h5> 
<p><strong>准备工作：</strong><br> <strong>1. 引入依赖</strong>（jjwt、reids、fastjson，mysql，mybatis-plus）</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>redis<span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
			<span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
			<span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>data<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>		fastjson2<span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
			<span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson2<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
			<span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>fastjson2<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
			<span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.0</span><span class="token number">.25</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>jjwt<span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
			<span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>jsonwebtoken<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
			<span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jjwt<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
			<span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.9</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
		
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>baomidou<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>mybatis<span class="token operator">-</span>plus<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.4</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>mysql<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>


</code></pre> 
<p><strong>2. 添加相关配置</strong></p> 
<blockquote> 
 <p>redis建议直接使用stringRedisTemplate，如果使用redisTemplate需要对数据进行序列化做相关的配置<br> 参考链接：<a href="https://blog.csdn.net/qq_43842093/article/details/121846823?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168985874616800211557686%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=168985874616800211557686&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-121846823-null-null.142%5Ev90%5Econtrol_2,239%5Ev3%5Econtrol&amp;utm_term=redistemplate%E5%92%8Cstringtemplate&amp;spm=1018.2226.3001.4187">redisTemplate和stringRedisTemplate对比、redisTemplate几种序列化方式比较</a></p> 
</blockquote> 
<p><strong>因为是前后端分离，所以需要一统一结果返回类 R类（不唯一能用就行）</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span> <span class="token comment">//编码：1成功，0和其它数字为失败</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span> <span class="token comment">//错误信息</span>

    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span> <span class="token comment">//数据</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//动态数据</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">T</span> object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>data <span class="token operator">=</span> object<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">,</span><span class="token class-name">T</span> object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>data <span class="token operator">=</span> object<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><strong>导入jwt工具类</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * JWT工具类
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//有效期为</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">JWT_TTL</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span><span class="token number">1000L</span><span class="token punctuation">;</span><span class="token comment">// 60 * 60 *1000  一个小时</span>
    <span class="token comment">//设置秘钥明文</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">JWT_KEY</span> <span class="token operator">=</span> <span class="token string">"qx"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 生成jtw  jwt加密
     * @param subject token中要存放的数据（json格式）
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token class-name">String</span> subject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtBuilder</span> builder <span class="token operator">=</span> <span class="token function">getJwtBuilder</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置过期时间</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成jtw  jwt加密
     * @param subject token中要存放的数据（json格式）
     * @param ttlMillis token超时时间
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token class-name">String</span> subject<span class="token punctuation">,</span> <span class="token class-name">Long</span> ttlMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtBuilder</span> builder <span class="token operator">=</span> <span class="token function">getJwtBuilder</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> ttlMillis<span class="token punctuation">,</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置过期时间</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 创建token jwt加密
     * @param id
     * @param subject
     * @param ttlMillis
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> subject<span class="token punctuation">,</span> <span class="token class-name">Long</span> ttlMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtBuilder</span> builder <span class="token operator">=</span> <span class="token function">getJwtBuilder</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> ttlMillis<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置过期时间</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JwtBuilder</span> <span class="token function">getJwtBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span> subject<span class="token punctuation">,</span> <span class="token class-name">Long</span> ttlMillis<span class="token punctuation">,</span> <span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SignatureAlgorithm</span> signatureAlgorithm <span class="token operator">=</span> <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKey</span> secretKey <span class="token operator">=</span> <span class="token function">generalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> nowMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>nowMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ttlMillis<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            ttlMillis<span class="token operator">=</span><span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token constant">JWT_TTL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> expMillis <span class="token operator">=</span> nowMillis <span class="token operator">+</span> ttlMillis<span class="token punctuation">;</span>
        <span class="token class-name">Date</span> expDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span>              <span class="token comment">//唯一的ID</span>
                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>   <span class="token comment">// 主题  可以是JSON数据</span>
                <span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span><span class="token string">"sg"</span><span class="token punctuation">)</span>     <span class="token comment">// 签发者</span>
                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>      <span class="token comment">// 签发时间</span>
                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span> <span class="token comment">//使用HS256对称加密算法签名, 第二个参数为秘钥</span>
                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>expDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//jwt加密</span>
        <span class="token class-name">String</span> jwt <span class="token operator">=</span> <span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//jwt解密</span>
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token function">parseJWT</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> subject <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成加密后的秘钥 secretKey
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SecretKey</span> <span class="token function">generalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encodedKey <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token constant">JWT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKey</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>encodedKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> encodedKey<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * jwt解密
     *
     * @param jwt
     * @return
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Claims</span> <span class="token function">parseJWT</span><span class="token punctuation">(</span><span class="token class-name">String</span> jwt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SecretKey</span> secretKey <span class="token operator">=</span> <span class="token function">generalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre> 
<p><strong>导入实体类</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 用户表(User)实体类
 *
 *
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"sys_user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">40356785423868312L</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
    * 主键
    */</span>
    <span class="token annotation punctuation">@TableId</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 用户名
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 昵称
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickName<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 密码
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 账号状态（0正常 1停用）
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 邮箱
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 手机号
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phonenumber<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 用户性别（0男，1女，2未知）
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 头像
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatar<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 用户类型（0管理员，1普通用户）
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userType<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 创建人的用户id
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> createBy<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 创建时间
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 更新人
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> updateBy<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 更新时间
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 删除标志（0代表未删除，1代表已删除）
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> delFlag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>数据库建表并且配置数据库</strong></p> 
<pre><code class="prism language-java"><span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `sys_user` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'主键'</span><span class="token punctuation">,</span>
  `user_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'NULL'</span> <span class="token constant">COMMENT</span> <span class="token char">'用户名'</span><span class="token punctuation">,</span>
  `nick_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'NULL'</span> <span class="token constant">COMMENT</span> <span class="token char">'昵称'</span><span class="token punctuation">,</span>
  `password` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'NULL'</span> <span class="token constant">COMMENT</span> <span class="token char">'密码'</span><span class="token punctuation">,</span>
  `status` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '账号状态（<span class="token number">0</span>正常 <span class="token number">1</span>停用）'<span class="token punctuation">,</span>
  `email` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'邮箱'</span><span class="token punctuation">,</span>
  `phonenumber` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'手机号'</span><span class="token punctuation">,</span>
  `sex` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> '用户性别（<span class="token number">0</span>男，<span class="token number">1</span>女，<span class="token number">2</span>未知）'<span class="token punctuation">,</span>
  `avatar` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'头像'</span><span class="token punctuation">,</span>
	`user_type` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'1'</span> <span class="token constant">COMMENT</span> '用户类型：<span class="token number">1</span>代表普通用户，<span class="token number">0</span>代表管理员'<span class="token punctuation">,</span>
  `create_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> '创建人的用户id'<span class="token punctuation">,</span>
  `create_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `update_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新人'</span><span class="token punctuation">,</span>
  `update_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新时间'</span><span class="token punctuation">,</span>
  `del_flag` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '删除标志（<span class="token number">0</span>代表未删除，<span class="token number">1</span>代表已删除）'<span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token constant">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">14787164048663</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token constant">COMMENT</span><span class="token operator">=</span><span class="token char">'用户表'</span><span class="token punctuation">;</span>

</code></pre> 
<pre><code class="prism language-java">  datasource<span class="token operator">:</span>
    druid<span class="token operator">:</span>
      driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
      url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>security<span class="token operator">?</span>characterEncoding<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span>
      username<span class="token operator">:</span> root
      password<span class="token operator">:</span> root

</code></pre> 
<p><strong>定义mapper、service、serviceImpl并测试mapper能正常使用</strong><br> 省略（可以使用代码生成器）<br> <img src="https://images2.imgbox.com/e4/05/Rr6xhJab_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="35_430"></a>3.5、正式实现</h5> 
<h6><a id="351___431"></a>3.5.1 实现数据库的校验</h6> 
<ul><li>创建一个类实现<code>UserDetailsService</code>接口，重写其中的<code>（loadUserByUsername）</code>方法。增加用户名从数据库中查询用户信息<br> <img src="https://images2.imgbox.com/5e/7f/ukm9CaTN_o.png" alt="在这里插入图片描述"> - 这里只是查了用户信息，对于用户权限还没有查（这部分是属于授权部分的内容），因为最后是把用户信息和权限信息封装成UserDetails进行返回的</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//查询用户信息</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUserName</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果没有查询到用户就抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">"用户名或密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//TODO 查询对应的权限信息</span>
        <span class="token comment">//把数据封装成UserDetails返回</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>自定义一个实现UserDetails的（LoginUser）类，实现接口的方法；用来接收存储数据（用户信息和权限信息）</strong></p> 
<ul><li>将用户属性注入进来，更改里面获取用户名和密码的get方法，使其获得user的信息</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginUser</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>

<span class="token comment">//这里先不管权限信息这个集合</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//获取用户的用户的密码</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>此次再次启动服务访问任意接口：（这个时候走的就是查我们自己的数据库了，可以在实现类里面打断点测试）</p> 
<p>此时后端控制台就不会打印出在内存中的密码了，因为我们重写了UserDetailsService 接口的loadUserByUsername，程序走我们自己的方法。<br> <img src="https://images2.imgbox.com/45/c7/VzcJWp0M_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>注意：点击登录后，这里会出现一个问题</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/6e/e5/98ySStGX_o.png" alt="在这里插入图片描述"><br> 当输入正确的用户名和密码还是会显示密码错误</p> 
<p>控制台打印的错误信息可以看出<br> <img src="https://images2.imgbox.com/33/d8/UuXieI9u_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f1/6a/hw5Xrh58_o.png" alt="在这里插入图片描述"></p> 
<ul><li>因为我们数据库的密码是明文保存的，而PasswordEncoder方法其实是将数据库的加密的密码解密后再和用户输入的明文密码进行比对的</li></ul> 
<p>处理办法：<strong>在 Spring Security 中，{noop} 前缀告诉系统直接将密码存储为明文，即未经过哈希或其他加密算法处理。</strong><br> <img src="https://images2.imgbox.com/4c/60/wA90Dsgn_o.png" alt="在这里插入图片描述"><br> 再次登录测试：能够成功访问接口方法</p> 
<h6><a id="352___526"></a>3.5.2 密码加密存储</h6> 
<ul><li>实际项目中我们不会把密码明文存储在数据库中。<br> 默认使用的<code>PasswordEncoder</code>要求数据库中的密码格式为：<code>{id}password</code>，它会根据id去判断密码的加密方式。但是我们一般不会采用这种方式，所以需要<code>替换PasswordEncoder</code>。\</li><li>我们一般使用SpringSecurity为我们提供的<code>BCryptPasswordEncoder</code>。</li><li>我们只需要把<code>BCryptPasswordEncoder对象注入Spring容器</code>，SpringSecurity就会使用该<code>PasswordEncoder</code>来进行密码校验。</li></ul> 
<p><strong>我们可以定义一个SpringSecurity的配置类，SpringSecurity要求这个配置类要<code>继承WebSecurityConfigurerAdapter</code>。</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
 <span class="token comment">//创建BCryptPasswordEncoder注入容器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>相当于将原来的PasswordEncoder 中的方法覆盖掉，转而执行BCryptPasswordEncoder中的方法</p> 
</blockquote> 
<p>其中BCryptPasswordEncoder对象中的三个方法分别作用是：<br> <img src="https://images2.imgbox.com/aa/36/RT6jjKaB_o.png" alt="在这里插入图片描述"></p> 
<ul><li>encode ： 用于对密码进行加密</li><li>matches：用于判断给定的原始密码与已加密的密码是否匹配</li><li>upgradeEncoding：用于升级密码的加密方式</li></ul> 
<p>这个时候数据库里面的用户密码必须是加密过的密码，这样在进行认证的时候，根据用户名查询到加密的密码，然后再根据passwordEncoder中的密码匹配方法来判断密码是否正确。（若数据库还是明文密码，那么肯定是会密码错误认证失败的）</p> 
<p><strong>咱可以先把数据库的明文密码加密放回原用户：（编写Test方法加密用户密码）</strong></p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">BCryptPasswordEncoder</span> passwordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> encode <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre> 
<p>得到加密的密码填入数据库：<br> <img src="https://images2.imgbox.com/e0/6c/p6UIgaWm_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ab/d1/4gste7hP_o.png" alt="在这里插入图片描述"></p> 
<p><strong>重启系统登录测试，登陆成功，正常访问接口</strong></p> 
<h6><a id="353___576"></a>3.5.3 自定义登陆接口实现</h6> 
<blockquote> 
 <p>其实质就是不让登录走整合SpringSecurity默认的登录页面了，而是走我们自己定义的登录接口</p> 
</blockquote> 
<p><code>接下我们需要自定义登陆接口，然后让SpringSecurity对这个接口放行,让用户访问这个接口的时候不用登录也能访问</code>。</p> 
<p>​ 在接口中我们通过<code>AuthenticationManager</code>的<code>authenticate方法</code>来进行用户认证,所以需要<code>在SecurityConfig中配置把AuthenticationManager注入容器</code>。</p> 
<p>​ 认证成功的话要<code>生成一个jwt</code>，放入响应中返回。并且为了让<code>用户下回请求时能通过jwt识别出具体的是哪个用户</code>，我们需要把<code>用户信息存入redis</code>，可以把用户id作为key。</p> 
<p><strong>创建<code>LoginController </code>登录接口</strong></p> 
<ul><li>其中LoginService 接口和实现接口类省略</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginService</span> loginService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> loginService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>那么我们可以在loginService实现类中编写login方法<br> 其中验证是通过<code>通过AuthenticationManager的authenticate方法</code>来进行用户认证,需要在<code>SecurityConfig中配置把AuthenticationManager注入容器</code></p> 
<p>并且进行一个<code>configure的配置</code>才能使用</p> 
<p>·<code>SecurityConfig·</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//创建BCryptPasswordEncoder注入容器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//把AuthenticationManager注入容器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http
                <span class="token comment">//关闭csrf</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//不通过Session获取SecurityContext</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">STATELESS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 对于登录接口 允许匿名访问</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/user/login"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 除上面外的所有请求全部需要鉴权认证</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>这个时候就可以编写登录接口了</p> 
<ol><li>通过<code>UsernamePasswordAuthenticationToken</code>获取用户名和密码<br> 2.<code>AuthenticationManager</code>委托机制对<code>authenticationToken </code>进行用户认证</li><li>如果认证没有通过，给出对应的提示</li><li>如果认证通过，使用user生成jwt ， jwt存入R返回</li><li>如果认证通过，拿到这个当前登录用户信息</li><li>把完整的用户信息存入redis <code>userid为key</code> <code>用户信息为value</code></li></ol> 
<blockquote> 
 <p>此时只有用户信息，还没有包括权限信息，后续授权会完善</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">LoginService</span> <span class="token punctuation">{<!-- --></span>



    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token comment">//认证委托</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//通过UsernamePasswordAuthenticationToken获取用户名和密码</span>
        <span class="token class-name">UsernamePasswordAuthenticationToken</span> authenticationToken<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span>
                                                                <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//AuthenticationManager委托机制对authenticationToken 进行用户认证</span>

        <span class="token class-name">Authentication</span> authenticate <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//如果认证没有通过，给出对应的提示</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>authenticate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"登录失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果认证通过，使用user生成jwt  jwt存入R 返回</span>

        <span class="token comment">//如果认证通过，拿到这个当前登录用户信息</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LoginUser</span><span class="token punctuation">)</span> authenticate<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取当前用户的userid</span>
        <span class="token class-name">String</span> userid <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> jwt <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">createJWT</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//把完整的用户信息存入redis  userid为key   用户信息为value</span>
 <span class="token comment"> 将对象转换为 JSON 字符串  存入redis</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token operator">+</span>userid<span class="token punctuation">,</span> jsonString <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"登陆成功"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>重启服务进行登录测试（建议打断点一步步测试数据）</strong></p> 
<blockquote> 
 <p>这里我们用postman进行登录测试<br> user/login被放行，可以不用登录认证直接访问</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/4e/c0/hvieJ9Dh_o.png" alt="在这里插入图片描述"></p> 
<p>输入url：localhost:8081/user/login</p> 
<p>通过json传输用户信息<br> <img src="https://images2.imgbox.com/f1/df/Y0jGbNl0_o.png" alt="在这里插入图片描述"><br> 结果返回：<br> <img src="https://images2.imgbox.com/4c/77/ISvGGAaZ_o.png" alt="在这里插入图片描述"><br> <strong>并且查看reids</strong><img src="https://images2.imgbox.com/78/c2/ooRr2LyT_o.png" alt="在这里插入图片描述"></p> 
<p><strong>此时认证成功~</strong></p> 
<h6><a id="354___726"></a>3.5.4 自定义实现认证过滤器</h6> 
<p>我们需要自定义一个过滤器，这个<code>过滤器会去获取请求头中的token</code>，对token进行解析取出其中的<code>userid</code>。</p> 
<p>使用userid去redis中获取对应的<code>LoginUser对象</code>。然后封装<code>Authentication</code>对象存入<code>SecurityContextHolder</code></p> 
<p><strong>定义过滤类：<code>JwtAuthenticationTokenFilter</code></strong></p> 
<p>流程：</p> 
<ol><li>过滤器拦截到请求，并且从请求头中拿到token</li><li>根据拿到的token根据jwt工具类解析得到用户的ID（userId）</li><li>根据userId（也就是之前reids存token的key）去redis拿到用户信息</li><li>若用户信息不为null，代表该用户没有登录过，抛异常</li><li>若能拿到用户信息封装Authentication对象存入<code>SecurityContextHolder</code>并且<code>获取权限信息封装到Authentication中</code>(这里属于授权过程，暂不实现）</li><li>放行</li></ol> 
<p><strong>封装Authentication对象:包括两部分</strong></p> 
<ol><li>用户信息</li><li>用户权限信息</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//从前端发起请求的请求头获取token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//放行</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//解析token</span>
        <span class="token class-name">String</span> userid<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">parseJWT</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userid <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">"token非法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//从redis中获取用户信息</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">"login:"</span> <span class="token operator">+</span> userid<span class="token punctuation">;</span>
        <span class="token comment">//将json转换为对象类</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">LoginUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户未登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//封装Authentication对象存入SecurityContextHolder</span>
        <span class="token comment">//TODO 获取权限信息封装到Authentication中</span>
        <span class="token class-name">UsernamePasswordAuthenticationToken</span> authenticationToken <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//放行</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>把token校验过滤器添加到过滤器链中（注入到配置类（<code>SecurityConfig</code>）加入过滤器链）</strong></p> 
<pre><code class="prism language-java">
   <span class="token comment">//把token校验过滤器注入配置类</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">JwtAuthenticationTokenFilter</span> jwtAuthenticationTokenFilter<span class="token punctuation">;</span>

<span class="token comment">//把token校验过滤器添加到过滤器链中并且添加到UsernamePasswordAuthenticationFilter之前</span>
  http<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>jwtAuthenticationTokenFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//创建BCryptPasswordEncoder注入容器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//把AuthenticationManager注入容器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
   <span class="token comment">//把token校验过滤器注入配置类</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">JwtAuthenticationTokenFilter</span> jwtAuthenticationTokenFilter<span class="token punctuation">;</span>

  

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http
                <span class="token comment">//关闭csrf</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//不通过Session获取SecurityContext</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">STATELESS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 对于登录接口 允许匿名访问</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/user/login"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 除上面外的所有请求全部需要鉴权认证</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//把token校验过滤器添加到过滤器链中</span>
                http<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>jwtAuthenticationTokenFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><strong>测试：</strong></p> 
<ul><li>编写一个接口来判断登录过后是否可以拿到token并且解析出用户信息<br> <img src="https://images2.imgbox.com/15/ed/QopejQf2_o.png" alt="在这里插入图片描述"></li></ul> 
<p><strong>测试1：不登录直接访问</strong>：访问路径localhost:8081/ayo/coo<br> <img src="https://images2.imgbox.com/7d/c0/4UKrZKZq_o.png" alt="在这里插入图片描述"></p> 
<p><strong>断点调试</strong><code>JwtAuthenticationTokenFilter</code>：</p> 
<ul><li>此时过滤器拦截到请求，发现请求头里面没有token（代表用户没有登录），直接放行retrun 认证失败</li></ul> 
<p><img src="https://images2.imgbox.com/98/7d/4X7DAk4Z_o.png" alt="在这里插入图片描述"></p> 
<p><strong>测试2：登录后设置请求头（登录生成的token）再次访问</strong> ：访问路径localhost:8081/ayo/coo</p> 
<blockquote> 
 <p>记录登录成功的token值</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/d4/dd/RUlLLeDO_o.png" alt="在这里插入图片描述"><br> 在访问路径localhost:8081/ayo/coo时，在请求头加上登录过后生成的token<br> <img src="https://images2.imgbox.com/5e/b8/NZ8VqYj1_o.png" alt="在这里插入图片描述"><br> 此时<strong>断点调试</strong><code>JwtAuthenticationTokenFilter</code>：成功从请求头拿到token<br> <img src="https://images2.imgbox.com/81/5c/EafLLm4l_o.png" alt="在这里插入图片描述"></p> 
<p>然后根据token解析到用户的id（userId），根据userId从redis取出用户的信息，然后将用户的信息（和权限信息）<code>封装成Authentication对象</code>存入<code>SecurityContextHolder</code></p> 
<ul><li>SecurityContextHolder</li></ul> 
<blockquote> 
 <p>SecurityContextHolder 类提供了一种方便的方式来获取当前用户的安全信息，如身份验证信息和角色信息。它是一个线程本地的存储，可以在应用程序的不同层级中访问</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/1c/02/lu7dSxW7_o.png" alt="在这里插入图片描述"><br> 返回此次调用接口的数据：<br> <img src="https://images2.imgbox.com/98/77/mkTuKk6s_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="355___888"></a>3.5.5 退出登录</h6> 
<p>流程：</p> 
<ol><li>执行退出登录的请求时，请求头携带token</li><li>进入<code>doFilterInternal</code>过滤器，解析token，得到用户userId</li><li>根据userId从redis中拿到用户信息，并且将用户信息封装成 <code>Authentication</code>对象，并且存入<code>SecurityContextHolder</code></li></ol> 
<blockquote> 
 <p><code>SecurityContextHolder.getContext().setAuthentication(authenticationToken);</code></p> 
</blockquote> 
<ol start="4"><li>执行controller的方法—&gt;service中的logout方法</li></ol> 
<blockquote> 
 <ul><li>从<code>SecurityContextHolder中获取用户的userid</code></li><li>根据<code>userid找到redis对应值进行删除</code></li></ul> 
</blockquote> 
<p><code>controller层</code></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> loginService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><code>service实现类：</code></p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * 注销接口
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//从SecurityContextHolder中的userid</span>
        <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span>
                        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LoginUser</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> userid <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//根据userid找到redis对应值进行删除</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"login:"</span><span class="token operator">+</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"注销成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>其中的核心是通过过滤器将用户的<code>userId</code>放入<code>SecurityContextHolder</code>中中了，在注销登录的时候可以直接拿到userId再去<code>删除redis中的token信息</code></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/7f/69/kQ9AwuBJ_o.png" alt="在这里插入图片描述"></p> 
<p><strong>注意</strong>：这个时候再去访问其他接口的时候，发送过来的请求的请求头所携带的<code>还是之前的登录时的token</code>，这个时候进入过滤器的时候可以根据<code>token获得用户的userId</code>，但是在根据userId去redis获得用户信息的时候是获取不到的（<code>注销的时候已经删除该用户对应的信息</code>），抛出未登录异常.</p> 
<p><img src="https://images2.imgbox.com/d4/6d/geOSdQri_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b5/3d/INh16fdd_o.png" alt="在这里插入图片描述"><br> 控制台报错：<br> <img src="https://images2.imgbox.com/1a/65/OeLVBD5F_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_939"></a>4、授权</h4> 
<hr> 
<p><strong>权限系统的作用</strong>：让不同的用户可以使用不同的功能。</p> 
<blockquote> 
 <p><code>实现</code>：不能只依赖前端去判断用户的权限来选择显示哪些菜单哪些按钮。因为<code>让前端判断权限，别人可以根据对应功能的接口地址，直接发送请求来实现相关的操作</code>。<br> 所以，我们还需要在后台进行用户权限的判断，判断当前用户是否有响应的权限，必须具有所需权限才能进行相应的操作。</p> 
</blockquote> 
<h5><a id="41___945"></a>4.1 授权基本流程</h5> 
<hr> 
<blockquote> 
 <p>在<code>SpringSecurity</code>中，会使用默认的<code>FilterSecurityInterceptor</code>来进行权限校验。在<code>FilterSecurityInterceptor</code>中，会从<code>SecurityContextHolder</code>获取其中的<code>Authentication</code>，然后获取其中的权限信息。当前用户是否拥有访问当前资源所需的权限。<br> 所以我们在项目中需要把当前登录用户的权限信息也存入<code>Authentication</code>，然后设置我们的资源所需要的权限即可。</p> 
</blockquote> 
<h5><a id="42___950"></a>4.2 授权实现（不结合数据库）</h5> 
<h6><a id="421___951"></a>4.2.1 限制访问资源所需权限</h6> 
<hr> 
<p>SpringSecurity为我们提供了基于注解的权限控制方案，这也是我们项目中主要采用的方式，我们可以<code>使用注解去指定访问对应的资源所需的权限</code>。</p> 
<p>使用前先在SpringSecurity配置类上开启相关配置</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> 
<p>这样就代表开启了使用注解去指定访问权限的功能，例如：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"权限测试接口"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('tset')"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/auth"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"权限测试接口访问成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>@PreAuthorize(“hasAuthority(‘tset’)”) 的含义是<code>只有具有 "tset" 权限的用户才能够调用被注解的方法</code>。<br> hasAuthority() 是 Spring Security 提供的一个表达式，用于<code>检查用户是否具有指定的权限</code>。在这种情况下，只有<code>当用户拥有 "tset" 权限（权限名称为 "tset"）时</code>，才能访问被注解的方法。</p> 
</blockquote> 
<h6><a id="422___975"></a>4.2.2 封装权限信息</h6> 
<hr> 
<p><strong>封装权限信息的步骤</strong></p> 
<ol><li>首先在用户进行认证登录成功之后就会在<code>UserDetailsService</code>接口的实现类方法<code>loadUserByUsername</code>去获得用户信息和<code>权限信息</code>，把数据封装成UserDetails返回。</li></ol> 
<blockquote> 
 <p>这里的权限信息集合我们先写死成<code>“test”</code>（后续是从数据库根据用户查出来的权限信息集合）<br> 此时<code>LoginUser需要封装user和AuthList两个对象</code>，所以需要<code>改造登录封装类LoginUser</code></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/49/71/8MF5EDFD_o.png" alt="在这里插入图片描述"></p> 
<p><strong>改造登录封装类LoginUser</strong></p> 
<ul><li>就是将登录认证后查到的权限集合，封装到LoginUser，默认框架是不会去调用我们自己定义的权限集合的，需要将自己传入的权限集合通过getAuthorities()方法封装成一个属性为<code>SimpleGrantedAuthority</code>的权限集合，供框架做权限控制。</li></ul> 
<p><img src="https://images2.imgbox.com/52/7a/Vonxs0qy_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>小细节：因为将数据存到redis是会序列化的，但是SimpleGrantedAuthority序列化会报错，所以，存入权限信息的时候存入<code>permissions</code>就可以了（string类型）<br> 使用注解 <code>@JSONField(serialize = false) </code>让其不序列化</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/a5/2a/xie3XB0G_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>然后再过滤器中，根据每次请求携带的token（进行登录的时候，所有的用户信息和权限信息都在redis中），解析用户id，然后根据用户id去redis查询用户信息和权限信息，<code>将权限信息和用户信息封装到Authentication中</code>。</li></ol> 
<p><img src="https://images2.imgbox.com/c3/48/bwv8vg2z_o.png" alt="在这里插入图片描述"></p> 
<p><strong>断点测试</strong>：</p> 
<ul><li>在进行登录的时候通过委托认证中的<code>loadUserByUsername</code>方法将权限信息和用户信息封装成LoginUser对象。</li><li>在登录验证通过后，会将完整的信息存入redis中</li></ul> 
<p><strong>reids数据如下</strong>：</p> 
<blockquote> 
 <p>这里为什么redis显示<code>authorities</code>没有数据呢，其实数据已经存进去了，只是在属性上加上了注解<code>@JSONField(serialize = false)</code>使其不序列化展示出来，数据还是有的</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/6f/5c/9ZbrQ0N2_o.png" alt="在这里插入图片描述"><br> 访问带权限的接口时：</p> 
<ul><li>过滤器会根据解析token的用户id去redis查询用户的所有信息，<code>封装到Authentication</code>对象交给框架去做方法授权，其中里面包括了权限信息（这里举例：test）</li></ul> 
<p><img src="https://images2.imgbox.com/fd/d2/uJkoETOe_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/1c/a3/n8TXPHec_o.png" alt="在这里插入图片描述"><br> 能够成功访问：<br> <img src="https://images2.imgbox.com/6f/53/HbFIENsy_o.png" alt="在这里插入图片描述"></p> 
<p><strong>同理</strong>：如果这个controller设置的权限，通过不了框架的授权验证，肯定是不能访问的，会报错。</p> 
<p>、、、、、、、、更新中</p> 
<h5><a id="43___1023"></a>4.3 授权实现（结合数据库）</h5> 
<hr> 
<p>因为之前实现授权，是将权限集合写死了，我们通常在项目中，权限应该是从数据库根据用户对应的角色中查出来的，如下图：<br> <img src="https://images2.imgbox.com/f5/1c/ziEIKZys_o.png" alt="在这里插入图片描述"><br> <strong>RBAC权限模型</strong>：也就是上图<br> RBAC权限模型（Role-Based Access Control）即：基于角色的权限控制。这是目前最常被开发者使用也是相对易用、通用的权限模型。<br> <img src="https://images2.imgbox.com/88/b8/d0RHwzis_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="431___1030"></a>4.3.1 设计数据库表</h6> 
<hr> 
<p>需要设置角色表、权限表，以及用户角色关联表，角色权限关联表</p> 
<p><img src="https://images2.imgbox.com/96/25/nXHGpJpv_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `sys_user` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'主键'</span><span class="token punctuation">,</span>
  `user_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'NULL'</span> <span class="token constant">COMMENT</span> <span class="token char">'用户名'</span><span class="token punctuation">,</span>
  `nick_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'NULL'</span> <span class="token constant">COMMENT</span> <span class="token char">'昵称'</span><span class="token punctuation">,</span>
  `password` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'NULL'</span> <span class="token constant">COMMENT</span> <span class="token char">'密码'</span><span class="token punctuation">,</span>
  `status` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '账号状态（<span class="token number">0</span>正常 <span class="token number">1</span>停用）'<span class="token punctuation">,</span>
  `email` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'邮箱'</span><span class="token punctuation">,</span>
  `phonenumber` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'手机号'</span><span class="token punctuation">,</span>
  `sex` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> '用户性别（<span class="token number">0</span>男，<span class="token number">1</span>女，<span class="token number">2</span>未知）'<span class="token punctuation">,</span>
  `avatar` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'头像'</span><span class="token punctuation">,</span>
	`user_type` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'1'</span> <span class="token constant">COMMENT</span> '用户类型：<span class="token number">1</span>代表普通用户，<span class="token number">0</span>代表管理员'<span class="token punctuation">,</span>
  `create_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> '创建人的用户id'<span class="token punctuation">,</span>
  `create_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `update_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新人'</span><span class="token punctuation">,</span>
  `update_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新时间'</span><span class="token punctuation">,</span>
  `del_flag` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '删除标志（<span class="token number">0</span>代表未删除，<span class="token number">1</span>代表已删除）'<span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token constant">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">14787164048663</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token constant">COMMENT</span><span class="token operator">=</span><span class="token char">'用户表'</span><span class="token punctuation">;</span>

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `sys_menu` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'菜单ID'</span><span class="token punctuation">,</span>
  `menu_name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'菜单名称'</span><span class="token punctuation">,</span>
  `path` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'路由地址'</span><span class="token punctuation">,</span>
  `component` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'组件路径'</span><span class="token punctuation">,</span>
  `visible` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '菜单状态（<span class="token number">0</span>显示 <span class="token number">1</span>隐藏）'<span class="token punctuation">,</span>
  `status` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '菜单状态（<span class="token number">0</span>正常 <span class="token number">1</span>停用）'<span class="token punctuation">,</span>
  `perms` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'权限标识'</span><span class="token punctuation">,</span>
  `icon` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'#'</span> <span class="token constant">COMMENT</span> <span class="token char">'菜单图标'</span><span class="token punctuation">,</span>
  `create_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'创建者'</span><span class="token punctuation">,</span>
  `create_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `update_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新者'</span><span class="token punctuation">,</span>
  `update_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新时间'</span><span class="token punctuation">,</span>
  `remark` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'备注'</span><span class="token punctuation">,</span>
  `del_flag` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token constant">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2029</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token constant">COMMENT</span><span class="token operator">=</span><span class="token char">'菜单权限表'</span><span class="token punctuation">;</span>

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `sys_role` <span class="token punctuation">(</span>
  `id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'角色ID'</span><span class="token punctuation">,</span>
  `name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'角色名称'</span><span class="token punctuation">,</span>
  `role_key` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> '角色权限字符串'<span class="token punctuation">,</span>
  `status` <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> '角色状态（<span class="token number">0</span>正常 <span class="token number">1</span>停用）'<span class="token punctuation">,</span>
  `del_flag` <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> '删除标志（<span class="token number">0</span>代表存在 <span class="token number">1</span>代表删除）'<span class="token punctuation">,</span>
  `create_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'创建者'</span><span class="token punctuation">,</span>
  `create_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  `update_by` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新者'</span><span class="token punctuation">,</span>
  `update_time` datetime <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'更新时间'</span><span class="token punctuation">,</span>
  `remark` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'备注'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token constant">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">3</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token constant">COMMENT</span><span class="token operator">=</span><span class="token char">'角色信息表'</span><span class="token punctuation">;</span>

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `sys_role_menu` <span class="token punctuation">(</span>
  `role_id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'角色ID'</span><span class="token punctuation">,</span>
  `menu_id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> <span class="token char">'菜单ID'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`role_id`<span class="token punctuation">,</span>`menu_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token constant">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token constant">COMMENT</span><span class="token operator">=</span>'角色和菜单关联表'<span class="token punctuation">;</span>

<span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `sys_user_role` <span class="token punctuation">(</span>
  `user_id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'用户ID'</span><span class="token punctuation">,</span>
  `role_id` <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token char">'0'</span> <span class="token constant">COMMENT</span> <span class="token char">'角色ID'</span><span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`user_id`<span class="token punctuation">,</span>`role_id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token constant">COMMENT</span><span class="token operator">=</span>'用户和角色关联表'<span class="token punctuation">;</span>

</code></pre> 
<p><strong>导入菜单实体类：</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 菜单表(Menu)实体类
 *
 */</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"sys_menu"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@JsonInclude</span><span class="token punctuation">(</span><span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span><span class="token constant">NON_NULL</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Menu</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">54979041104113736L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@TableId</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 菜单名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> menuName<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 路由地址
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 组件路径
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> component<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 菜单状态（0显示 1隐藏）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> visible<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 菜单状态（0正常 1停用）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 权限标识
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> perms<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 菜单图标
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> icon<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> createBy<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> updateBy<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 是否删除（0未删除 1已删除）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> delFlag<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 备注
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



</code></pre> 
<p>因为需要查询菜单表，所以需要定义菜单表的mapper接口分别增删查改。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MenuMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Menu</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>之后需要使用mapper的xml来实现多表查询</strong></p> 
<p>在resource下建包：<br> <img src="https://images2.imgbox.com/ca/2c/B0G4aLfW_o.png" alt="在这里插入图片描述"><br> 在mapper接口使用快捷方式（alt+enter）生成选择mapper文件夹的位置创建xml映射文件<br> <img src="https://images2.imgbox.com/7c/ee/tIDWnYg0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/65/48/yqqpbvLx_o.png" alt="在这里插入图片描述"></p> 
<p><code>在application.yml中配置mapperXML文件的位置</code></p> 
<pre><code class="prism language-java">#      配置mapperXML文件的位置
mybatis<span class="token operator">-</span>plus<span class="token operator">:</span>
  mapper<span class="token operator">-</span>locations<span class="token operator">:</span> classpath<span class="token operator">*</span><span class="token operator">:</span><span class="token operator">/</span>mapper<span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>xml

</code></pre> 
<h6><a id="432___1195"></a>4.3.2 代码实现</h6> 
<p>我们只需要根据用户id，通过多表联查，去查询到其所对应的权限信息即可。<br> 这里就需要使用mapper的xml来实现多表查询，</p> 
<ol><li>在menu的mapper里面定义根据用户id去查询权限的方法</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MenuMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Menu</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectPermsByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userid<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>在xml文件里面编写查询权限的sql</li></ol> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> mapper <span class="token constant">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>mapper namespace<span class="token operator">=</span><span class="token string">"com.hhy.springboot_demo.mapper.MenuMapper"</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"selectPermsByUserId"</span> resultType<span class="token operator">=</span><span class="token string">"java.lang.String"</span><span class="token operator">&gt;</span>
        select
            <span class="token constant">DISTINCT</span> m<span class="token punctuation">.</span>`perms`
        <span class="token constant">FROM</span>
            sys_user_role ur
                <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> `sys_role` r <span class="token constant">ON</span> ur<span class="token punctuation">.</span>`role_id` <span class="token operator">=</span> r<span class="token punctuation">.</span>`id`
                <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> `sys_role_menu` rm <span class="token constant">ON</span> ur<span class="token punctuation">.</span>`role_id` <span class="token operator">=</span> rm<span class="token punctuation">.</span>`role_id`
                <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> `sys_menu` m <span class="token constant">ON</span> m<span class="token punctuation">.</span>`id` <span class="token operator">=</span> rm<span class="token punctuation">.</span>`menu_id`
        <span class="token class-name">WHERE</span>
            user_id <span class="token operator">=</span> #<span class="token punctuation">{<!-- --></span>userId<span class="token punctuation">}</span>
          <span class="token constant">AND</span> r<span class="token punctuation">.</span>`status` <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">//保证角色是正常状态才查询</span>
          <span class="token constant">AND</span> m<span class="token punctuation">.</span>`status` <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">//保证菜单是正常状态才查询</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>mapper<span class="token operator">&gt;</span>

</code></pre> 
<ol start="3"><li>UserDetailsServiceImpl的登录认证方法中去调用该mapper的方法查询权限信息封装到LoginUser对象中即可（也就是替换之前写死的List集合）。<br> <img src="https://images2.imgbox.com/83/42/NVV5jT6G_o.png" alt="在这里插入图片描述"></li><li>对方法权限根据数据库设置的权限改动，然后进行测试</li></ol> 
<p><strong>数据库表对应说明：</strong><br> <img src="https://images2.imgbox.com/1d/b9/Dbhgf1l9_o.png" alt="在这里插入图片描述"><br> <strong>接口方法权限设置</strong><br> <img src="https://images2.imgbox.com/4f/e9/7sgZ5rh8_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="433___1244"></a>4.3.3 测试</h6> 
<hr> 
<ol><li><strong>测试用户：</strong><code>libai</code></li></ol> 
<ul><li>该用户对应拥有<code>权限测试1</code>和<code>权限测试2</code>的访问权限<br> <img src="https://images2.imgbox.com/50/29/NXreiBcd_o.png" alt="在这里插入图片描述"><br> <strong>成功访问</strong>：满足预期效果、<img src="https://images2.imgbox.com/ca/8c/uiYK0IS0_o.png" alt="在这里插入图片描述"></li></ul> 
<ol start="2"><li><strong>测试用户：</strong><code>test</code></li></ol> 
<ul><li>该用户对应只拥有<code>权限测试2</code>的访问权限</li></ul> 
<p><strong>成功访问</strong>：满足预期结果<br> <img src="https://images2.imgbox.com/b0/e6/H1Ioa9Fi_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5_1257"></a>5、自定义访问失败处理</h4> 
<p>我们希望在认证失败或者是授权失败的情况下，也能和我们的接口一样返回相同结构的json，这样可以让前端对响应进行统一的处理。要实现这个功能我们需要知道<code>SpringSecurity的异常处理机制</code>。</p> 
<ul><li>在SpringSecurity中，如果我们在认证或者授权的过程中出现了异常会被ExceptionTranslationFilter捕获到。在<code>ExceptionTranslationFilter</code>中会去判断是认证失败还是授权失败出现的异常。</li><li><code>如果是认证过程中出现的异常</code>会被封装成AuthenticationException，然后调用AuthenticationEntryPoint对象的方法进行异常处理。</li><li><code>如果是授权过程中出现的异常，</code>会被封装成AccessDeniedException，然后调用AccessDeniedHandler对象的方法进行异常处理。</li><li>所以，如果我们需要自定义异常处理，我们只需要<code>自定义AuthenticationEntryPoint和AccessDeniedHandler，然后配置给SpringSecurity即可</code>。</li></ul> 
<h5><a id="51_1266"></a>5.1、自定义实现类</h5> 
<p><code>AuthenticationEntryPointImpl</code></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 处理认证异常
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationEntryPointImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> authException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">R<span class="token punctuation">.</span>AuthenticationEntryPointImpl</span><span class="token punctuation">(</span><span class="token string">"用户名认证失败请重新登录"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//处理移除</span>
        <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>AccessDeniedHandlerImpl</code></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @Desc : 授权的异常处理
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessDeniedHandlerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDeniedHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">R<span class="token punctuation">.</span>AuthenticationEntryPointImpl</span><span class="token punctuation">(</span><span class="token string">"您的权限不足"</span><span class="token punctuation">,</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//处理移除</span>
        <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>其中<code> WebUtils.renderString</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebUtils</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 在 HttpServletResponse 中渲染字符串的方法。
     * 它将给定的字符串写入 HttpServletResponse 的输出流，
     * 并设置相应的响应状态码、内容类型和字符编码。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">renderString</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span><span class="token class-name">String</span> string<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="52SpringSecurity_1330"></a>5.2、配置给SpringSecurity</h5> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">AccessDeniedHandler</span> accessDeniedHandler<span class="token punctuation">;</span>


<span class="token comment">//配置异常处理器</span>
http<span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//认证失败处理器</span>
        <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>authenticationEntryPoint<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span>accessDeniedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre> 
<p><strong>测试------未改造之前会出现的问题：</strong></p> 
<hr> 
<p>在用户名出错的时候会抛出异常，是因为在执行<code>loadUserByUsername</code>方法时查询用户查询不到<br> <img src="https://images2.imgbox.com/47/48/hP3EZm1i_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2f/72/DLDkN5wb_o.png" alt="在这里插入图片描述"><br> 但是如果用户名没错，密码错了就不会抛出异常：<br> <img src="https://images2.imgbox.com/09/e6/grOE5xMQ_o.png" alt="在这里插入图片描述"><br> 因为在<code>loadUserByUsername</code>方法执行完成是可以找到用户的，获取用户的全部信息，所以在做密码验证的时候，方法内部验证密码的时候报错了。<br> <img src="https://images2.imgbox.com/1f/3a/6e7w7s8B_o.png" alt="在这里插入图片描述"><br> <strong>改造自定义异常处理之后：</strong></p> 
<ul><li>密码错误（这里走的是用户名无误，在查密码时，）下面的委托机制抛出的异常</li></ul> 
<pre><code class="prism language-java">  <span class="token class-name">Authentication</span> authenticate <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ac/67/SoxHQ5xY_o.png" alt="在这里插入图片描述"></p> 
<ul><li>用户名错误（这里走的是在查不到用户的时候自定义的异常）<br> <img src="https://images2.imgbox.com/77/4d/jbAJbFCk_o.png" alt="在这里插入图片描述"></li><li>权限不足–改造之后：</li></ul> 
<blockquote> 
 <p>没改造之前，异常信息也是拿不到的<br> <img src="https://images2.imgbox.com/0f/3a/wHevHnmJ_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>改造之后，走授权异常处理器</p> 
<p><img src="https://images2.imgbox.com/f3/0f/u4j20RIg_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="6_1380"></a>6、跨域问题</h4> 
<ul><li>浏览器出于安全的考虑，使用 XMLHttpRequest对象发起 HTTP请求时必须遵守同源策略，否则就是跨域的HTTP请求，默认情况下是被禁止的。 同源策略要求源相同才能正常进行通信，即协议、域名、端口号都完全一致。</li><li>前后端分离项目，前端项目和后端项目一般都不是同源的，所以肯定会存在跨域请求的问题。</li></ul> 
<p>​ 所以我们就要处理一下，让前端能进行跨域请求。</p> 
<p>SpringBoot配置，运行跨域请求</p> 
<p><code>CorsConfig</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CorsConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCorsMappings</span><span class="token punctuation">(</span><span class="token class-name">CorsRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置允许跨域的路径</span>
        registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span>
                <span class="token comment">// 设置允许跨域请求的域名</span>
                <span class="token punctuation">.</span><span class="token function">allowedOriginPatterns</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>
                <span class="token comment">// 是否允许cookie</span>
                <span class="token punctuation">.</span><span class="token function">allowCredentials</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token comment">// 设置允许的请求方式</span>
                <span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">)</span>
                <span class="token comment">// 设置允许的header属性</span>
                <span class="token punctuation">.</span><span class="token function">allowedHeaders</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>
                <span class="token comment">// 跨域允许时间</span>
                <span class="token punctuation">.</span><span class="token function">maxAge</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>在SecurityConfig的配置类中开启开启SpringSecurity的跨域访问</strong></p> 
<p><code>由于我们的资源都会收到SpringSecurity的保护，所以想要跨域访问还要让SpringSecurity运行跨域访问。</code></p> 
<pre><code class="prism language-java"> <span class="token comment">//允许跨域</span>
        http<span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/27/ab/BLBToywy_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="7_1424"></a>7、扩展</h4> 
<h5><a id="71_1425"></a>7.1、自定义权限校验方法</h5> 
<ul><li>我们也可以定义自己的权限校验方法，在@PreAuthorize注解中使用我们的方法。</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"ex"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QXExpressionRoot</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">//String authority 这里是后端赋给它的权限</span>
    <span class="token comment">//从数据库获取登录用户的权限功能  和authority 进行对比</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token class-name">String</span> authority<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取当前用户得权限</span>
        <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LoginUser</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断用户权限集合中是否存在  authority</span>
        <span class="token keyword">return</span> permissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>authority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<ul><li>在SPEL表达式中使用 @ex相当于获取容器中bean的名字为ex的对象。然后再调用这个对象的hasAuthority方法</li></ul> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
    <span class="token comment">//自定义的权限功能</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"@ex.hasAuthority('system:dept:list')"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


</code></pre> 
<h5><a id="72_1458"></a>7.2、基于配置的权限控制</h5> 
<hr> 
<ul><li>在配置类中配置<br> <img src="https://images2.imgbox.com/67/96/NCcAyFry_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="8_demo_1462"></a>8、 demo源码</h4> 
<p><a href="https://gitee.com/he-hongyuhh/spring-security_demo" rel="nofollow">SpringBoot整合Spring Security实现权限控制----------gitee</a></p> 
<h4><a id="9_1465"></a>9、特别鸣谢</h4> 
<p><a href="https://blog.csdn.net/weixin_50569789/article/details/123766739?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168984907216800180668149%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=168984907216800180668149&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-123766739-null-null.142%5Ev90%5Econtrol_2,239%5Ev3%5Econtrol&amp;utm_term=springsecurity&amp;spm=1018.2226.3001.4187">作者：不易撞的网名<br> </a><br> <a href="https://blog.csdn.net/weixin_45581692/article/details/127755783?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168985578716800197089615%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=168985578716800197089615&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-127755783-null-null.142%5Ev90%5Econtrol_2,239%5Ev3%5Econtrol&amp;utm_term=springsecurity%E4%B8%89%E6%9B%B4&amp;spm=1018.2226.3001.4187">作者：北莽<br> </a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/775812eaf0435832138812db69eb7224/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【问题解决】uniapp-Vue3中u-popup滑动页面穿透问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7416a216ee77758baf0b51df8e3ba9e3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">批量打印-----jsPDF将图片转为pdf，并合并pdf</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>