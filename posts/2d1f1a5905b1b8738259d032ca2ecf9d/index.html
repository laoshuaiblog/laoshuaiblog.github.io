<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PaddleDetection的学习笔记 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/2d1f1a5905b1b8738259d032ca2ecf9d/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="PaddleDetection的学习笔记">
  <meta property="og:description" content="1. PaddleDetection介绍 PaddleDetection是由百度推出的目标检测开源模型库；
1.1 常见格式 .pdparams：保存参数权重的文件格式。
2. 安装PaddleDetection Python版本：python &amp;lt;= 3.10；
PaddlePaddle PaddlePaddle版本：[PaddlePaddle/PaddleDetection]，需要到安装说明中查看，一般是在满足最低版本要求后安装最新的稳定版本；
PaddlePaddle安装：开始使用_飞桨
3. 数据集设置：COCO 数据集目录结构如下：
PaddleDetection └── dataset └── coco ├── train2017 ├── val2017 └── annotations 4. 模型训练/评估/预测 train.py —— 模型训练 python -m paddle.distributed.launch --gpus 0,1,2,3,4,5,6,7 tools/train.py -c configs/ppyoloe/ppyoloe_plus_crn_l_80e_coco.yml --eval --amp -c：指定配置文件 -r: resume，恢复训练 后面加上存档的epoch索引（从0开始）；
infer.py —— 模型预测 # 预测 python tools/infer.py -c configs/faster_rcnn_r50_1x.yml --infer_img=demo/000000570688.jpg # 在CPU上进行推理 python tools/infer.py -c configs/ppyolo/ppyolo_r50vd_dcn_1x_coco.yml -o use_gpu=false weights=https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_1x_coco.pdparams --infer_img=demo/000000014439.jpg # CPU推理需要显式指定：use_gpu=false # demo/000000014439.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-29T19:52:51+08:00">
    <meta property="article:modified_time" content="2023-04-29T19:52:51+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PaddleDetection的学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_PaddleDetection_0"></a>1. PaddleDetection介绍</h2> 
<p>PaddleDetection是由百度推出的目标检测开源模型库；</p> 
<h3><a id="11__2"></a>1.1 常见格式</h3> 
<p><code>.pdparams</code>：保存参数权重的文件格式。</p> 
<h2><a id="2_PaddleDetection_5"></a>2. 安装PaddleDetection</h2> 
<p>Python<a href="https://www.paddlepaddle.org.cn/install/quick?docurl=/documentation/docs/zh/install/conda/windows-conda.html#:~:text=%E8%B5%84%E8%AE%AF-,%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8,-%E7%94%A8%E9%A3%9E%E6%A1%A8" rel="nofollow">版本</a>：python &lt;= 3.10；</p> 
<h3><a id="PaddlePaddle_7"></a>PaddlePaddle</h3> 
<p>PaddlePaddle版本：<a href="https://github.com/PaddlePaddle/PaddleDetection">[PaddlePaddle/PaddleDetection]</a>，需要到安装说明中查看，一般是在满足最低版本要求后安装最新的稳定版本；<br> PaddlePaddle安装：<a href="https://www.paddlepaddle.org.cn/install/quick?docurl=/documentation/docs/zh/install/conda/windows-conda.html" rel="nofollow">开始使用_飞桨</a></p> 
<h2><a id="3_COCO_10"></a>3. 数据集设置：COCO</h2> 
<p>数据集目录结构如下：</p> 
<pre><code class="prism language-bash">PaddleDetection
└── dataset
    └── coco
        ├── train2017
        ├── val2017 
        └── annotations  
</code></pre> 
<h2><a id="4__21"></a>4. 模型训练/评估/预测</h2> 
<h3><a id="trainpy___22"></a>train.py —— 模型训练</h3> 
<pre><code class="prism language-bash">python -m paddle.distributed.launch --gpus <span class="token number">0,1</span>,2,3,4,5,6,7 tools/train.py -c configs/ppyoloe/ppyoloe_plus_crn_l_80e_coco.yml --eval --amp
</code></pre> 
<h4><a id="chttpsgithubcomPaddlePaddlePaddleDetectionblobrelease25ppdetutilsclipyL46L50_26"></a><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/release/2.5/ppdet/utils/cli.py#L46-L50">-c</a>：指定配置文件</h4> 
<h4><a id="r_resumehttpsgithubcomPaddlePaddlePaddleDetectionblobrelease26docstutorialsGETTING_STARTED_cnmdtext2Dr2D2Dresume_checkpointE69D83E9878DE8B7AFE5BE84_27"></a><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/release/2.6/docs/tutorials/GETTING_STARTED_cn.md#:~:text=%2Dr/%2D%2Dresume_checkpoint,%E6%9D%83%E9%87%8D%E8%B7%AF%E5%BE%84">-r: resume，恢复训练</a></h4> 
<p>后面加上存档的epoch索引（从0开始）；</p> 
<h3><a id="inferpy___29"></a>infer.py —— 模型预测</h3> 
<pre><code class="prism language-bash"><span class="token comment"># 预测</span>
python tools/infer.py -c configs/faster_rcnn_r50_1x.yml --infer_img<span class="token operator">=</span>demo/000000570688.jpg

<span class="token comment"># 在CPU上进行推理</span>
python tools/infer.py -c configs/ppyolo/ppyolo_r50vd_dcn_1x_coco.yml -o <span class="token assign-left variable">use_gpu</span><span class="token operator">=</span>false <span class="token assign-left variable">weights</span><span class="token operator">=</span>https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_1x_coco.pdparams --infer_img<span class="token operator">=</span>demo/000000014439.jpg
<span class="token comment"># CPU推理需要显式指定：use_gpu=false</span>
<span class="token comment"># demo/000000014439.jpg已经内置在PaddleDetection的repo文件夹中</span>
</code></pre> 
<p>Note：在<code>output</code>目录下生成的同名的测试文件会被替换。</p> 
<h2><a id="4__41"></a>4 模型配置说明</h2> 
<h3><a id="42_modelyml_42"></a>4.2 模型设置：model.yml</h3> 
<p>在PaddleDetection使用model.yml来配置模型的结构，配置文件的路径一般如下所示：</p> 
<blockquote> 
 <p>PaddleDetection/configs/model/model_***_coco.yml</p> 
</blockquote> 
 
<p>模型参数：</p> 
<ul><li><code>Model</code>：模型整体设置</li><li><code>Backbone</code>：主干网络设置</li><li><code>PostProcess</code>：后处理操作，（仅用于“CornerNet”模型）</li></ul> 
 
<h4><a id="421_Model_51"></a>4.2.1 模型类设置：Model</h4> 
<p>输入参数：</p> 
<ul><li><code>backbone</code>：主干网络类名</li><li><code>neck</code>：检测颈类名</li><li><code>head</code>：检测头类名</li></ul> 
<h4><a id="422_Backbone_56"></a>4.2.2 主干类设置：Backbone</h4> 
<p>输入参数：</p> 
<ul><li><code>depth</code>：主干网络深度</li><li><code>variant</code>：变体型号</li><li><code>norm_type</code>：归一化层类名</li></ul> 
<h4><a id="422_Neck_61"></a>4.2.2 检测颈设置：Neck</h4> 
<p>输入参数：</p> 
<ul><li><code>in_channels</code>：<strong>list</strong>，输入通道数</li><li><code>out_channel</code>：<strong>int</strong>，输出通道数（所有输出stage的通道数一样）</li><li><code>extra_stage</code>：额外输出的层数</li></ul> 
<h5><a id="FPN_66"></a>FPN：特征金字塔</h5> 
<blockquote> 
 <p>Note<br> <code>FPN</code>模块在初始化时，会使用backbone输出的<code>out_shape</code>更新<code>FPN</code>的输入参数，而导致config中<code>FPN.in_channels</code>的设置失效。</p> 
</blockquote> 
<h3><a id="43_optimizeryml_69"></a>4.3 优化器设置：optimizer.yml</h3> 
<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>TrainReader.batch_size</td><td>每张卡上的batch-size</td></tr></tbody></table> 
<h2><a id="5__74"></a>5 代码文件说明</h2> 
<h3><a id="51_configsrotate_75"></a>5.1 configs/rotate：旋转框数据集处理</h3> 
<h4><a id="511_configsrotatetools_76"></a>5.1.1 configs/rotate/tools：旋转框处理工具</h4> 
<h5><a id="configsrotatetoolsprepare_datapy_DOTA_77"></a>configs/rotate/tools/prepare_data.py: 进行DOTA数据集的切图处理</h5> 
<h3><a id="52_ppdetutils_78"></a>5.2 ppdet/utils：训练和调优的工具类和函数</h3> 
<h4><a id="521_utilscheckpointpy_79"></a>5.2.1 <code>utils/checkpoint.py</code></h4> 
<h5><a id="load_weighthttpsgithubcomPaddlePaddlePaddleDetectionblobdevelopppdetutilscheckpointpyL48_80"></a><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/develop/ppdet/utils/checkpoint.py#L48">load_weight()</a>：载入模型权重</h5> 
<p>存档权重的格式要求是<code>.pdparams</code>；</p> 
<h3><a id="52_ppdetoptimizerpy_83"></a>5.2 ppdet/optimizer.py：优化器设置</h3> 
<p><code>ppdet/optimizer.py</code>包含了PaddleDetection优化器的设置代码；</p> 
<table><thead><tr><th>Class</th><th>Description</th></tr></thead><tbody><tr><td><code>OptimizerBuilder</code></td><td>根据config的设置构建优化器</td></tr></tbody></table> 
<h3><a id="53_toolsinferpy_88"></a>5.3 tools/infer.py</h3> 
<p>用于进行图像的预测</p> 
<h4><a id="531__90"></a>5.3.1 路径预设代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os<span class="token punctuation">,</span> sys
<span class="token comment"># add python path of PadleDetection to sys.path</span>
parent_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'..'</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> parent_path <span class="token keyword">not</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">:</span>
    sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>parent_path<span class="token punctuation">)</span>
    <span class="token comment"># 使用sys.path.append添加环境变量，在脚本执行完成之后则会失效</span>
</code></pre> 
<h3><a id="54_utilspost_processpy_99"></a>5.4 utils/post_process.py</h3> 
<p>用于目标检测的后处理；</p> 
<h4><a id="541_corner_post_process_101"></a>5.4.1 corner_post_process()</h4> 
<p>用于CornerNet的后处理函数；<br> 参数：</p> 
<ul><li><code>results</code>:<br> dict{‘bbox’, ‘im_id’}，检测结果；其中字典中的属性含义如下： 
  <ul><li><code>bbox</code>: 检测框信息，包含类别和坐标信息</li><li><code>im_id</code>: 图像id</li></ul> </li></ul> 
<h5><a id="_109"></a>代码说明：</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">corner_post_process</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span> config<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    detections <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    keep_inds <span class="token operator">=</span> <span class="token punctuation">(</span>detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    detections <span class="token operator">=</span> detections<span class="token punctuation">[</span>keep_inds<span class="token punctuation">]</span>
    labels <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    scores <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    boxes <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>
    cls_boxes <span class="token operator">=</span> get_nms_result<span class="token punctuation">(</span>
        boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> config<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> background_label<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">)</span>
    results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'bbox'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>cls_boxes<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>cls_boxes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="6__122"></a>6 函数和类说明</h2> 
<h3><a id="61__123"></a>6.1 数据集处理函数</h3> 
<h4><a id="process_single_samplehttpsgithubcomPaddlePaddlePaddleDetectionblobrelease25configsrotatetoolsconvertpyL81_124"></a><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/release/2.5/configs/rotate/tools/convert.py#L81"><code>process_single_sample()</code></a>：处理单个样本</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">process_single_sample</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> image_id<span class="token punctuation">,</span> class_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_file <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token string">'image_file'</span><span class="token punctuation">]</span>
    single_image <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    single_image<span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span>image_file<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    single_image<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
    image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>image_file<span class="token punctuation">)</span>
    height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> _ <span class="token operator">=</span> image<span class="token punctuation">.</span>shape
    single_image<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span> <span class="token operator">=</span> width
    single_image<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span> <span class="token operator">=</span> height

    <span class="token comment"># process annotation field</span>
    single_objs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    objects <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token string">'annotation'</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> objects<span class="token punctuation">:</span>
        poly<span class="token punctuation">,</span> name<span class="token punctuation">,</span> difficult <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">'poly'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span><span class="token string">'difficult'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> difficult <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        single_obj <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        single_obj<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> class_names<span class="token punctuation">.</span>index<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
        single_obj<span class="token punctuation">[</span><span class="token string">'segmentation'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>poly<span class="token punctuation">]</span>
        single_obj<span class="token punctuation">[</span><span class="token string">'iscrowd'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>poly<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>poly<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>poly<span class="token punctuation">[</span>
            <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>poly<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 使用间隔索引的方法获得四个点的X或Y坐标，并取最小值和最大值，作为bbox的坐标</span>
        width<span class="token punctuation">,</span> height <span class="token operator">=</span> xmax <span class="token operator">-</span> xmin<span class="token punctuation">,</span> ymax <span class="token operator">-</span> ymin
        single_obj<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">]</span>
        single_obj<span class="token punctuation">[</span><span class="token string">'area'</span><span class="token punctuation">]</span> <span class="token operator">=</span> height <span class="token operator">*</span> width
        single_obj<span class="token punctuation">[</span><span class="token string">'image_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
        single_objs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>single_obj<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>single_image<span class="token punctuation">,</span> single_objs<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="62_sample_transforms_159"></a>6.2 预处理和数据增广：<code>sample_transforms</code></h3> 
<p>官方文档：<a href="https://github.com/PaddlePaddle/PaddleDetection/blob/release/2.5/docs/advanced_tutorials/READER.md#3%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86">数据预处理算子 - PaddleDetection/READER.md at release/2.5</a></p> 
<h4><a id="621_DecodehttpsgithubcomPaddlePaddlePaddleDetectionblobrelease25ppdetdatatransformoperatorspyL111L115_161"></a>6.2.1 <a href="https://github.com/PaddlePaddle/PaddleDetection/blob/release/2.5/ppdet/data/transform/operators.py#L111-L115">Decode</a>：图像解码操作（从文件中读取图像）</h4> 
<h2><a id="7_PaddlePaddle_163"></a>7 PaddlePaddle学习笔记</h2> 
<h3><a id="71__164"></a>7.1 张量</h3> 
<h4><a id="711_Paddleimg_tensor_2_1_0___165"></a>7.1.1 Paddle张量不支持括号索引：img_tensor[:, (2, 1, 0), :, :]</h4> 
<p>今天在使用Paddle时，使用括号索引改变颜色分量顺序时，代码报错了，<br> 期望改变图像张量的颜色分量顺序：</p> 
<pre><code class="prism language-python">img_tensor <span class="token operator">=</span> img_tensor<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre> 
<p>Paddle报错：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">..</span>.
  File <span class="token string">"D:\Professional\Paddle\Paddle_oriented_reppoints\ppdet<span class="token entity" title="\e">\e</span>ngine<span class="token entity" title="\t">\t</span>rain_aligner.py"</span>, line <span class="token number">461</span>, <span class="token keyword">in</span> train
    img_tensor <span class="token operator">=</span> img_tensor<span class="token punctuation">[</span>:, <span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span>, :, :<span class="token punctuation">]</span>
  File <span class="token string">"C:\Users\songyuc\.conda<span class="token entity" title="\e">\e</span>nvs<span class="token entity" title="\c">\c</span>onda-paddle\lib\site-packages\paddle<span class="token entity" title="\f">\f</span>luid\dygraph<span class="token entity" title="\v">\v</span>arbase_patch_methods.py"</span>, line <span class="token number">753</span>, <span class="token keyword">in</span> __getitem__
    <span class="token builtin class-name">return</span> self._getitem_index_not_tensor<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
ValueError: <span class="token punctuation">(</span>InvalidArgument<span class="token punctuation">)</span> Currently, Tensor.__indices__<span class="token punctuation">(</span><span class="token punctuation">)</span> only allows indexing by Integers,
Slices, Ellipsis, None, tuples of these types and list of Bool and Integers, but received tuple <span class="token keyword">in</span>
2th slice item <span class="token punctuation">(</span>at <span class="token punctuation">..</span><span class="token punctuation">\</span>paddle/fluid/pybind/slice_utils.h:295<span class="token punctuation">)</span>
</code></pre> 
<p>感觉好像就是Paddle不支持这种索引操作；</p> 
<h2><a id="8_PPYOLOE_184"></a>8 PP-YOLOE</h2> 
<p>关于PP-YOLOE的论文学习笔记，请参考<a href="https://blog.csdn.net/songyuc/article/details/124929684">《PP-YOLOE的译读笔记》</a>；<br> 学习资料：<br> <a href="https://aistudio.baidu.com/aistudio/education/lessonvideo/2606380" rel="nofollow">Paddle目标检测算法课程——PPYOLOE</a><br> <a href="https://aistudio.baidu.com/aistudio/education/preview/2606436" rel="nofollow">Paddle目标检测算法课程——PPYOLOE | PPT</a><br> 技术一览表：</p> 
<table><thead><tr><th>名称</th><th>超参数</th></tr></thead><tbody><tr><td>Input size</td><td>640</td></tr><tr><td>Down sample</td><td><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/e9a5428f855a65480072e5c813949fba5f356eeb/ppdet/modeling/heads/ppyoloe_head.py#L146">AdaptiveAvgPool2d</a><br>(目前是在Head部分的代码中看到此算子作为下采样的方式)</td></tr><tr><td>Act</td><td><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/99920ab168642615f8b8e31462599fd662282546/configs/ppyoloe/_base_/ppyoloe_crn.yml#L17-L24">Swish (SiLU)</a></td></tr><tr><td>Head</td><td><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/99920ab168642615f8b8e31462599fd662282546/ppdet/modeling/heads/ppyoloe_head.py#L46-L72">PPYOLOEHead</a></td></tr><tr><td>Optimizer</td><td>SGD with momentum and L2-regularization</td></tr><tr><td>Weight decay</td><td><a href="https://github.com/PaddlePaddle/PaddleDetection/blob/a653cc4c2c77e467fa4fb05fdd390f62593dbf7a/configs/ppyoloe/_base_/optimizer_300e.yml#L17">0.0005</a></td></tr></tbody></table> 
<h3><a id="51_PyTorchmiemie2013miemiedetectionhttpsgithubcommiemie2013miemiedetection_198"></a>5.1 PyTorch实现：<a href="https://github.com/miemie2013/miemiedetection">[miemie2013/miemiedetection]</a></h3> 
<p>关于这个repo的说明文档，请参阅<a href="https://zhuanlan.zhihu.com/p/514860567" rel="nofollow">《PPYOLO、PPYOLOv2、PPYOLOE的pytorch实现三合一！尽在miemiedetection!》</a>；</p> 
<h3><a id="52__200"></a>5.2 学习笔记</h3> 
<h4><a id="PPYOLOEbiasweight_decay_201"></a>PP-YOLOE对bias项的weight_decay是怎么处理的呢？</h4> 
<p>关于PP-YOLOE对bias项weight_decay的处理，请参考<a href="https://github.com/PaddlePaddle/PaddleDetection/blob/release/2.4/ppdet/modeling/backbones/cspresnet.py#L54">[PaddleDetection | backbones/cspresnet.py]</a>；<br> 总的来说，就是对BN层的所有参数不使用weight_decay，即：</p> 
<pre><code class="prism language-python">self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2D<span class="token punctuation">(</span>
    ch_out<span class="token punctuation">,</span>
    weight_attr<span class="token operator">=</span>ParamAttr<span class="token punctuation">(</span>regularizer<span class="token operator">=</span>L2Decay<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    bias_attr<span class="token operator">=</span>ParamAttr<span class="token punctuation">(</span>regularizer<span class="token operator">=</span>L2Decay<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="PyTorchL2Decay_210"></a>如何在使用PyTorch实现L2Decay呢？</h4> 
<p>这里我们参考的是<a href="https://github.com/miemie2013/miemiedetection">[miemie2013/miemiedetection]</a>的实现方法：<a href="https://github.com/miemie2013/miemiedetection">[miemiedetection]</a>是从<a href="https://github.com/miemie2013/miemiedetection/tree/main/mmdet">[mmdetection]</a>中移植过来的，这里继承了mmdetection的书写方式<a href="https://github.com/miemie2013/miemiedetection/blob/442427e4ed1e3defb6a7eb982b9a2cb24836d783/mmdet/core/trainer.py#L469-L480">[code – add_param_group]</a>：<br> <img src="https://images2.imgbox.com/16/3d/vJughE5h_o.png" alt="在这里插入图片描述"><br> 这里的model.add_param_group调用的是模型的.add_param_group()方法<a href="https://github.com/miemie2013/miemiedetection/blob/442427e4ed1e3defb6a7eb982b9a2cb24836d783/mmdet/models/architectures/ppyoloe.py#L33-L36">[ppyoloe.py – add_param_group()]</a>；</p> 
<h2><a id="7_nbspPaddleC_215"></a>7 自定义 Paddle-C++算子</h2> 
<h3><a id="_216"></a>数据类型宏转换</h3> 
<p>Paddle文档：<a href="https://www.paddlepaddle.org.cn/documentation/docs/zh/guides/custom_op/new_cpp_op_cn.html#yunsuanhanshushixian:~:text=%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E5%90%8C%E6%97%B6%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%EF%BC%8C%E4%BE%8B%E5%A6%82%E5%90%8C%E6%97%B6%E6%94%AF%E6%8C%81%20float32%20%E4%B8%8E%20float64%20%E7%9A%84%E8%AE%A1%E7%AE%97%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E7%9B%B8%E5%BA%94%E7%9A%84DIAPATCH%E5%AE%8F%E8%BF%9B%E8%A1%8C%E5%A3%B0%E6%98%8E%EF%BC%8C%E7%A4%BA%E4%BE%8B%E5%A6%82%E4%B8%8B%EF%BC%9A" rel="nofollow">《自定义C++算子-PaddlePaddle文档 | 支持多种数据类型》</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/88271c67af89e8f62d69f6b68b006985/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android使用Webview展示微信公众号链接碰到的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c5d766bbf7e712380692eb9d8cf872e0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java 反射机制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>