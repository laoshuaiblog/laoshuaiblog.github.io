<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PL/SQL之包的创建和应用 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/592ec187cd10cde2ef485dcc2c697490/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="PL/SQL之包的创建和应用">
  <meta property="og:description" content="PL/SQL之包的创建和应用 一 引言 包是一组相关**过程、函数、变量、常量和游标**等 PL/SQL 程序设计元素的**组合** ，它具有面向对象程序设计语言的特点，是对这些 PL/SQL 程序 设计元素的封装。 **包类似于 C&#43;&#43; 和 JAVA 语言中的类，其中变量相当于类中的成员变量，过程和函数相当于类方法** 。把相关的模块归类成为包， 可使开发人员利用面向对象的方法进行存储过程的开发，从而提高系统性能 。 与类相同， 包中的程序元素也分为**公用元素和私用元素**两种 ，这两种元素的区别是他们允许访问的程序范围不同，即它们的作用域不同。 公用元素 不仅可以被包中的函数、过程所调用，也可以被包外的 PL/SQL程序访问，而 私有元素 只能被包内的函数和过程序所访问。 在 PL/SQL 程序设计中，使用包不仅可以使程序设计模块化，对外隐藏 包内所使用的信息（通过使用私用变量），而 且 可以提高程序的执行效率。因为，当程序首次调用包内函数或过程时， ORACLE 将整个包调入内存，当再次访问包内元素时， ORACLE 直接从内存中读取，而不需要进行磁盘 I/O 操作，从而使程序执行效率得到提高。 一个包由两个分开的部分组成
包定义 （PACKAGE ）：包定义部分声明包内数据类型、变量、常量、游标、子程序和异常错误处理等元素，这些元素为包的公有元素。
包主体 （PACKAGE BODY ）：包主体则是包定义部分的具体实现，它定义了包定义部分 所声明的游标和子程序，在包主体中还可以声明包的私有元素。
包定义和包主体分开编译 ，并作为两部分分开的对象存放在数据库字典中，详见数据字典 user_source,all_source, dba_source.
二 包的定义 1 语法
(1) 创建包定义
CREATE [OR REPLACE ] PACKAGE package_name [AUTHID {CURRENT_USER | DEFINER}] {IS | AS} [公有数据类型定义 公有数据类型定义] [公有游标声明 公有游标 声明] [公有变量、常量声明 公有变量、常量声明] [公有子程序声明 公有子程序声明] END [package_name] （2）创建包主体">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-03-19T15:59:45+08:00">
    <meta property="article:modified_time" content="2021-03-19T15:59:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PL/SQL之包的创建和应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="PLSQL_0"></a>PL/SQL之包的创建和应用</h3> 
<h4><a id="__1"></a>一 引言</h4> 
<pre><code>包是一组相关**过程、函数、变量、常量和游标**等 PL/SQL 程序设计元素的**组合** ，它具有面向对象程序设计语言的特点，是对这些 PL/SQL 程序 设计元素的封装。 **包类似于 C++ 和 JAVA 语言中的类，其中变量相当于类中的成员变量，过程和函数相当于类方法** 。把相关的模块归类成为包， 可使开发人员利用面向对象的方法进行存储过程的开发，从而提高系统性能 。
与类相同， 包中的程序元素也分为**公用元素和私用元素**两种 ，这两种元素的区别是他们允许访问的程序范围不同，即它们的作用域不同。 公用元素 不仅可以被包中的函数、过程所调用，也可以被包外的 PL/SQL程序访问，而 私有元素 只能被包内的函数和过程序所访问。
在 PL/SQL 程序设计中，使用包不仅可以使程序设计模块化，对外隐藏 包内所使用的信息（通过使用私用变量），而 且 可以提高程序的执行效率。因为，当程序首次调用包内函数或过程时， ORACLE 将整个包调入内存，当再次访问包内元素时， ORACLE 直接从内存中读取，而不需要进行磁盘 I/O 操作，从而使程序执行效率得到提高。
</code></pre> 
<p>一个包由两个分开的部分组成<br> <strong>包定义</strong> （PACKAGE ）：包定义部分声明包内<strong>数据类型、变量、常量、游标、子程序和异常错误处理</strong>等元素，这些元素为包的<strong>公有元素。</strong><br> <strong>包主体</strong> （PACKAGE BODY ）：包主体则是<strong>包定义部分的具体实现</strong>，它定义了包定义部分 所声明的游标和子程序，在包主体中还可以声明包的<strong>私有元素</strong>。<br> 包定义和包主体分开编译 ，并作为两部分分开的对象存放在数据库字典中，详见数据字典 user_source,all_source, dba_source.</p> 
<h4><a id="__9"></a>二 包的定义</h4> 
<p>1 语法<br> (1) 创建包定义</p> 
<pre><code class="prism language-java">CREATE <span class="token punctuation">[</span>OR REPLACE <span class="token punctuation">]</span> PACKAGE package_name
	<span class="token punctuation">[</span>AUTHID <span class="token punctuation">{<!-- --></span>CURRENT_USER <span class="token operator">|</span> DEFINER<span class="token punctuation">}</span><span class="token punctuation">]</span>
	<span class="token punctuation">{<!-- --></span>IS <span class="token operator">|</span> AS<span class="token punctuation">}</span>
	<span class="token punctuation">[</span>公有数据类型定义 公有数据类型定义<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>公有游标声明 公有游标 声明<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>公有变量、常量声明 公有变量、常量声明<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>公有子程序声明 公有子程序声明<span class="token punctuation">]</span>
END <span class="token punctuation">[</span>package_name<span class="token punctuation">]</span>
</code></pre> 
<p>（2）创建包主体<br> 语法</p> 
<pre><code class="prism language-java">CREATE <span class="token punctuation">[</span>OR REPLACE <span class="token punctuation">]</span> PACKAGE BODY package_name
	<span class="token punctuation">{<!-- --></span>IS <span class="token operator">|</span> AS<span class="token punctuation">}</span>
	<span class="token punctuation">[</span>私有数据类型定义 私 有数据类型定义<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>私有变量、常量声明 私有变量、常量声明<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>私有子程序声明和定义 私有子程序声明和定义<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>公有游标定义 公有游标定义<span class="token punctuation">]</span>
	<span class="token punctuation">[</span>公有子程序定义 公有子程序定义<span class="token punctuation">]</span>
BEGIN
	PL<span class="token operator">/</span>SQL语句
END <span class="token punctuation">[</span>package_name<span class="token punctuation">]</span>
注意：其中：在包主体定义公有程序时，它们必须与<span class="token operator">*</span><span class="token operator">*</span>包定义中所声明子程序的格式完全一致<span class="token operator">*</span><span class="token operator">*</span> 。
</code></pre> 
<h4><a id="__38"></a>三 包的开发步骤</h4> 
<p>与开发存储过程类似，包的开发需要几个步骤<br> 1． 将每个存储过程调式正确；<br> 2． 用文本编辑软件将各个存储过程和函数集成在一起；<br> 3． 按照包的定义 要求将集成的文本的前面加上包定义；<br> 4． 按照包的定义要求将集成的文本的前面加上包主体；<br> 5． 使用 SQLPLUS 或开发工具进行调式。</p> 
<h4><a id="__45"></a>四 案例</h4> 
<p>1 创建的包为 demo_pack, 该包中包含一个记录变量 DeptRec 、两个函数和一个过程。</p> 
<pre><code class="prism language-java">CREATE OR REPLACE PACKAGE demo_pack
	IS
	DeptRec dept<span class="token operator">%</span>ROWTYPE<span class="token punctuation">;</span>
	FUNCTION <span class="token function">add_dept</span><span class="token punctuation">(</span>
		dept_no NUMBER<span class="token punctuation">,</span> dept_name VARCHAR2<span class="token punctuation">,</span> location VARCHAR2<span class="token punctuation">)</span>
		RETURN NUMBER<span class="token punctuation">;</span>
	FUNCTION <span class="token function">remove_dept</span><span class="token punctuation">(</span>dept_no NUMBER<span class="token punctuation">)</span>
		RETURN NUMBER<span class="token punctuation">;</span>
	PROCEDURE <span class="token function">query_dept</span><span class="token punctuation">(</span>dept_no IN NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span>
END demo_pack<span class="token punctuation">;</span>
</code></pre> 
<p>包主体的创建方法，它实现上面所声明的包定义</p> 
<pre><code class="prism language-java">CREATE OR REPLACE PACKAGE BODY demo_pack
	IS
	FUNCTION <span class="token function">add_dept</span><span class="token punctuation">(</span>
		dept_no NUMBER<span class="token punctuation">,</span> dept_name VARCHAR2<span class="token punctuation">,</span> location VARCHAR2<span class="token punctuation">)</span>
			RETURN NUMBER
 	IS
	empno_remaining EXCEPTION<span class="token punctuation">;</span>
	PRAGMA <span class="token function">EXCEPTION_INIT</span><span class="token punctuation">(</span>empno_remaining<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 1 是违反唯一约束条件的错误代码*/</span>
BEGIN
	INSERT INTO dept <span class="token function">VALUES</span><span class="token punctuation">(</span>dept_no<span class="token punctuation">,</span> dept_name<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
	IF SQL<span class="token operator">%</span>FOUND THEN
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
EXCEPTION
	WHEN empno_remaining THEN
		RETURN <span class="token number">0</span><span class="token punctuation">;</span>
	WHEN OTHERS THEN
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
END add_dept<span class="token punctuation">;</span>

FUNCTION <span class="token function">remove_dept</span><span class="token punctuation">(</span>dept_no NUMBER<span class="token punctuation">)</span>
	RETURN NUMBER
	IS
BEGIN
	DELETE FROM dept WHERE deptno<span class="token operator">=</span>dept_no<span class="token punctuation">;</span>
	IF SQL<span class="token operator">%</span>FOUND THEN
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
	ELSE
	RETURN <span class="token number">0</span><span class="token punctuation">;</span>
END IF<span class="token punctuation">;</span>
EXCEPTION
	WHEN OTHERS THEN
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
END remove_dept<span class="token punctuation">;</span>

PROCEDURE <span class="token function">query_dept</span><span class="token punctuation">(</span>dept_no IN NUMBER<span class="token punctuation">)</span>
	IS
BEGIN
	SELECT <span class="token operator">*</span> INTO DeptRec FROM dept WHERE deptno<span class="token operator">=</span>dept_no<span class="token punctuation">;</span>
EXCEPTION
	WHEN NO_DATA_FOUND THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 数据库中没有编码为 '</span><span class="token operator">||</span>dept_ 的部门'<span class="token punctuation">)</span>
	WHEN TOO_MANY_ROWS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 程序运行错误 请使用游标'</span><span class="token punctuation">)</span>
	WHEN OTHERS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>SQLCODE<span class="token operator">||</span>’<span class="token operator">--</span><span class="token operator">-</span>' SQLCODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
END query_dept<span class="token punctuation">;</span>
BEGIN
	Null<span class="token punctuation">;</span>
END demo_pack<span class="token punctuation">;</span>
</code></pre> 
<p>对包内共有元素的调用格式为：包名元素名称调用demo_pack 包内函数对 dept 表进行插入、查询和修改操 作，并通过 demo_pack 包中的记录变量 DeptRec显示所查询到的数据库信息：</p> 
<pre><code class="prism language-java">DECLARE
	Var NUMBER<span class="token punctuation">;</span>
BEGIN
	Var <span class="token operator">:</span><span class="token operator">=</span> demo_pack<span class="token punctuation">.</span><span class="token function">add_dept</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span>’Administration’<span class="token punctuation">,</span> ‘Beijing’<span class="token punctuation">)</span><span class="token punctuation">;</span>
	IF var <span class="token operator">=</span> <span class="token number">1</span> THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>SQLCODE<span class="token operator">||</span>’<span class="token operator">--</span><span class="token operator">-</span>' SQLCODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ELSIF var <span class="token operator">=</span><span class="token number">0</span> THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>‘ 该部门记录已经存在！'<span class="token punctuation">)</span>
	ELSE
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>‘ 添加记录成功！'<span class="token punctuation">)</span>
		Demo_pack<span class="token punctuation">.</span><span class="token function">query_dept</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>demo_pack<span class="token punctuation">.</span>DeptRec<span class="token punctuation">.</span>deptno<span class="token operator">||</span>’<span class="token operator">--</span><span class="token operator">-</span>’<span class="token operator">||</span>
			demo_pack<span class="token punctuation">.</span>DeptRec<span class="token punctuation">.</span>dname<span class="token operator">||</span>’<span class="token operator">--</span><span class="token operator">-</span>‘<span class="token operator">||</span>demo_pack<span class="token punctuation">.</span>DeptRec<span class="token punctuation">.</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		var <span class="token operator">:</span><span class="token operator">=</span> demo_pack<span class="token punctuation">.</span><span class="token function">remove_dept</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		IF var <span class="token operator">=</span> <span class="token number">1</span> THEN
			DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE <span class="token punctuation">(</span> SQLCODE<span class="token operator">||</span>’<span class="token operator">--</span><span class="token operator">-</span>‘<span class="token operator">||</span>SQLERRM<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ELSIF var<span class="token operator">=</span><span class="token number">0</span> THEN
			DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>‘ 该部门记录不存在！'<span class="token punctuation">)</span>
		ELSE
			DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>‘ 删除记录成功！'<span class="token punctuation">)</span>
		END IF<span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
END<span class="token punctuation">;</span>
</code></pre> 
<p>2 创建包emp_mgmt;</p> 
<pre><code class="prism language-java">创建序列
CREATE SEQUENCE empseq
	START WITH <span class="token number">1000</span>
	INCREMENT BY <span class="token number">1</span>
	ORDER NOCYCLE<span class="token punctuation">;</span>
	
CREATE SEQUENCE deptseq
	START WITH <span class="token number">50</span>
	INCREMENT BY <span class="token number">10</span>
	ORDER NOCYCLE<span class="token punctuation">;</span>
创建包
CREATE OR REPLACE PACKAGE emp_mgmt
	AS
	FUNCTION <span class="token function">hire</span><span class="token punctuation">(</span>
		ename VARCHAR2<span class="token punctuation">,</span> job VARCHAR2<span class="token punctuation">,</span> mgr NUMBER<span class="token punctuation">,</span> salNUMBER<span class="token punctuation">,</span>
		comm NUMBER<span class="token punctuation">,</span> deptno NUMBER<span class="token punctuation">)</span>
		RETURN NUMBER<span class="token punctuation">;</span>
	FUNCTION <span class="token function">create_dept</span><span class="token punctuation">(</span>dname VARCHAR2<span class="token punctuation">,</span> loc VARCHAR2<span class="token punctuation">)</span>
		RETURN NUMBER<span class="token punctuation">;</span>
	PROCEDURE <span class="token function">remove_emp</span><span class="token punctuation">(</span>empno NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span>
	PROCEDURE <span class="token function">remove_dept</span><span class="token punctuation">(</span>deptno NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span>
	PROCEDURE <span class="token function">increase_sal</span><span class="token punctuation">(</span>empno NUMBER<span class="token punctuation">,</span> sal_incr NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span>
	PROCEDURE <span class="token function">increase_comm</span><span class="token punctuation">(</span>empno NUMBER<span class="token punctuation">,</span> comm_incr NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span>
END emp_mgmt<span class="token punctuation">;</span>
创建包主体
CREATE OR REPLACE PACKAGE BODY emp_mgmt
	AS
	tot_emps NUMBER<span class="token punctuation">;</span><span class="token operator">--</span>记录emps的总记录数
	tot_depts N UMBER<span class="token punctuation">;</span><span class="token operator">--</span>记录depts的总记录数
	no_sal EXCEPTION<span class="token punctuation">;</span>
	no_comm EXCEPTION<span class="token punctuation">;</span>
	FUNCTION <span class="token function">hire</span><span class="token punctuation">(</span>ename VARCHAR2<span class="token punctuation">,</span> job VARCHAR2<span class="token punctuation">,</span> mgr NUMBER<span class="token punctuation">,</span>
		sal NUMBER<span class="token punctuation">,</span> comm NUMBER<span class="token punctuation">,</span> deptno NUMBER<span class="token punctuation">)</span>
		RETURN NUMBER IS
	new_empno <span class="token function">NUMBER</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BEGIN
	SELECT empseq<span class="token punctuation">.</span>NEXTVAL INTO new_empno FROM dual<span class="token punctuation">;</span>
INSERT INTO emp
	VALUES <span class="token punctuation">(</span>new_empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> job<span class="token punctuation">,</span> mgr<span class="token punctuation">,</span> sysdate<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> comm<span class="token punctuation">,</span>deptno<span class="token punctuation">)</span><span class="token punctuation">;</span>
tot_emps<span class="token operator">:</span><span class="token operator">=</span>tot_emps<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">RETURN</span><span class="token punctuation">(</span>new_empno<span class="token punctuation">)</span><span class="token punctuation">;</span>
EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 发生其它错误!'</span>）<span class="token punctuation">;</span>
END hire<span class="token punctuation">;</span>

FUNCTION <span class="token function">create_dept</span><span class="token punctuation">(</span>dname VARCHAR2<span class="token punctuation">,</span> loc VARCHAR2<span class="token punctuation">)</span>
	RETURN NUMBER IS
	new_deptno <span class="token function">NUMBER</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BEGIN
	SELECT deptseq<span class="token punctuation">.</span>NEXTVAL INTO new_deptno FROM dual<span class="token punctuation">;</span>
	INSERT INTO dept VALUES <span class="token punctuation">(</span>new_deptno<span class="token punctuation">,</span> dname<span class="token punctuation">,</span> loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	Tot_depts<span class="token operator">:</span><span class="token operator">=</span>tot_depts<span class="token punctuation">;</span>
		<span class="token function">RETURN</span><span class="token punctuation">(</span>new_deptno<span class="token punctuation">)</span><span class="token punctuation">;</span>
EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 发生其它错误'</span><span class="token punctuation">)</span>
END create_dept<span class="token punctuation">;</span>

PROCEDURE <span class="token function">remove_emp</span><span class="token punctuation">(</span>empno NUMBER<span class="token punctuation">)</span> IS
	No_result EXCEPTION<span class="token punctuation">;</span>
BEGIN
DELETE FROM emp WHERE emp<span class="token punctuation">.</span>empno<span class="token operator">=</span>remove_emp<span class="token punctuation">.</span>empno<span class="token punctuation">;</span>
	IF SQL<span class="token operator">%</span>NOTFOUND THEN
		RAISE no_result<span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
	tot_emps<span class="token operator">:</span><span class="token operator">=</span>tot_emps <span class="token number">1</span><span class="token punctuation">;</span>
EXCEPTION
	WHEN no_result THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 你需要的数据不存在'</span><span class="token punctuation">)</span>
	WHEN OTHERS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 发生其它错误'</span><span class="token punctuation">)</span>
END remove_emp<span class="token punctuation">;</span>

PROCEDURE <span class="token function">remove_dept</span><span class="token punctuation">(</span>deptno NUMBER<span class="token punctuation">)</span> IS
	No_result EXCEPTION<span class="token punctuation">;</span>
	e_deptno_remaining EXCEPTION<span class="token punctuation">;</span>
	PRAGMA <span class="token function">EXCEPTION_INIT</span><span class="token punctuation">(</span>e_deptno_remaining<span class="token punctuation">,</span> <span class="token number">2292</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 2292 是违反一 致性约束的错误代码*/</span>
BEGIN
	DELETE FROM dept WHERE dept<span class="token punctuation">.</span>deptno<span class="token operator">=</span>remove_dept<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
	IF SQL<span class="token operator">%</span>NOTFOUND THEN
		RAISE no_result<span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
	Tot_depts<span class="token operator">:</span><span class="token operator">=</span>tot_depts<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
EXCEPTION
	WHEN no_result THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 你需要的数据不存在'</span><span class="token punctuation">)</span>
	WHEN e_deptno_remaining TH EN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 违反数据完整性约束'</span><span class="token punctuation">)</span>
	WHEN OTHERS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 发生其它错误'</span><span class="token punctuation">)</span>
END remove_dept<span class="token punctuation">;</span>

PROCEDURE <span class="token function">increase_sal</span><span class="token punctuation">(</span>empno NUMBER<span class="token punctuation">,</span> sal_incr NUMBER<span class="token punctuation">)</span> IS
	curr_sal <span class="token function">NUMBER</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BEGIN
	SELECT sal INTO curr_sal FROM emp WHERE 
		emp<span class="token punctuation">.</span>e 	mpno<span class="token operator">=</span>increase_sal<span class="token punctuation">.</span>empno<span class="token punctuation">;</span>
	IF curr_sal IS NULL THEN
		RAISE no_sal<span class="token punctuation">;</span>
	ELSE
		UPDATE emp SET sal<span class="token operator">=</span>sal<span class="token operator">+</span>increase_sal<span class="token punctuation">.</span>sal_incr
			WHERE emp<span class="token punctuation">.</span>empno<span class="token operator">=</span>increase_sal<span class="token punctuation">.</span>empno<span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
EXCEPTION
	WHEN NO_DATA_FOUND THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 你需要的数据不存在'</span><span class="token punctuation">)</span>
	WHEN no_ sal THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 此员工的工资不存在'</span><span class="token punctuation">)</span>
	WHEN OTHERS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 发生其它错误'</span><span class="token punctuation">)</span>
END increase_sal<span class="token punctuation">;</span>

PROCEDURE <span class="token function">increase_comm</span><span class="token punctuation">(</span>empno NUMBER<span class="token punctuation">,</span> comm_incr NUMBER<span class="token punctuation">)</span> IS
	curr_comm <span class="token function">NUMBER</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BEGIN
	SELECT comm INTO curr_comm 
		FROM emp WHERE emp<span class="token punctuation">.</span>empno<span class="token operator">=</span>increase_comm<span class="token punctuation">.</span>empno<span class="token punctuation">;</span>
	IF curr_comm IS NULL THEN
		RAISE no_comm<span class="token punctuation">;</span>
	ELSE
		UPDATE emp SET comm<span class="token operator">=</span>comm<span class="token operator">+</span>increase_comm<span class="token punctuation">.</span>comm_incr
			WHERE emp<span class="token punctuation">.</span>empno<span class="token operator">=</span>increase_comm<span class="token punctuation">.</span>empno<span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
EXCEPTION
	WHEN NO_DATA_FOUND THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 你需要的 数据不存在'</span><span class="token punctuation">)</span>
	WHEN no_comm THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 此员工的奖金不存在'</span><span class="token punctuation">)</span>
	WHEN OTHERS THEN
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span><span class="token string">' 发生其它错误'</span><span class="token punctuation">)</span>
END increase_comm<span class="token punctuation">;</span>
END EMP_MGMT<span class="token punctuation">;</span>
</code></pre> 
<p>3 利用游标变量创建包 Curvarpack 。由于游标变量指是一个指针，其状态是不确定的，因此它不能随同包存储在数据库中，既不能在 PL/SQL 包中声明游标变量。但在包中可以创 建游标变量参照类型，并可向包<br> 中的子程序传递游标变量参数。</p> 
<pre><code class="prism language-java">CREATE OR REPLACE PACKAGE CurVarPack AS
	TYPE DeptCurType IS REF CURSOR RETURN dept<span class="token operator">%</span>ROWTYPE<span class="token punctuation">;</span><span class="token operator">--</span>强类型定义
	TYPE CurType IS REF CURSOR<span class="token punctuation">;</span> <span class="token operator">--</span>弱类型定义
	PROCEDURE <span class="token function">OpenDeptVar</span><span class="token punctuation">(</span>
		Cv IN OUT DeptCurType<span class="token punctuation">,</span>
		Choice INTEGER DEFAULT <span class="token number">0</span><span class="token punctuation">,</span>
		Dept_no N UMBER DEFAULT <span class="token number">50</span><span class="token punctuation">,</span>
		Dept_name VARCHAR DEFAULT ‘<span class="token operator">%</span>’<span class="token punctuation">)</span><span class="token punctuation">;</span>
END<span class="token punctuation">;</span>

CREATE OR REPLACE PACKAGE BODY CurVarPack AS
	PROCEDURE <span class="token function">OpenDeptvar</span><span class="token punctuation">(</span>
		Cv IN OUT DeptCurType<span class="token punctuation">,</span>
		Choice INTEGER DEFAULT <span class="token number">0</span><span class="token punctuation">,</span>
		Dept_no NUMBER DEFAULT <span class="token number">50</span><span class="token punctuation">,</span>
	Dept_name VARCHAR DEFAULT ‘<span class="token operator">%</span>’<span class="token punctuation">)</span>
	IS
BEGIN
	IF choice <span class="token operator">=</span><span class="token number">1</span> THEN
		OPEN cv FOR SELECT <span class="token operator">*</span> FROM dept WHERE deptno <span class="token operator">&lt;=</span> dept_no<span class="token punctuation">;</span>
	ELSIF choice <span class="token operator">=</span> <span class="token number">2</span> THEN
		OPEN cv FOR SELECT <span class="token operator">*</span> FROM dept WHERE dname LIKE dept_name<span class="token punctuation">;</span>
	ELSE
		OPEN cv FOR SELECT <span class="token operator">*</span> FROM dept<span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
END OpenDeptvar<span class="token punctuation">;</span>
END CurVarPack<span class="token punctuation">;</span>

<span class="token operator">--</span>定义一个 过程
CREATE OR REPLACE PROCEDURE <span class="token function">OpenCurType</span><span class="token punctuation">(</span>
	Cv IN OUT CurVarPack<span class="token punctuation">.</span>CurType<span class="token punctuation">,</span>
	Tab CHAR<span class="token punctuation">)</span>
	AS
BEGIN
<span class="token operator">--</span>由于 CurVarPack<span class="token punctuation">.</span>CurType 采用弱类型定义
<span class="token operator">--</span>所以可以使用它定义的游标变量打开不同类型的查询语句
	IF tab <span class="token operator">=</span> ‘D’ THEN
		OPEN cv FOR SELECT <span class="token operator">*</span> FROM dept<span class="token punctuation">;</span>
	ELSE
		OPEN cv FOR SELECT <span class="token operator">*</span> FROM emp<span class="token punctuation">;</span>
	END IF<span class="token punctuation">;</span>
END OpenCurType<span class="token punctuation">;</span>

<span class="token operator">--</span>定义一个应用
DECLARE
	DeptRec Dept<span class="token operator">%</span>ROWTYPE<span class="token punctuation">;</span>
	EmpRec Emp<span class="token operator">%</span>ROWTYPE<span class="token punctuation">;</span>
	Cv1 Curvarpack<span class="token punctuation">.</span>deptcurtype<span class="token punctuation">;</span>
	Cv2 Curvarpack<span class="token punctuation">.</span>curtype<span class="token punctuation">;</span>
BEGIN
	DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>’ 游标变量强类型定义应用'<span class="token punctuation">)</span>
	Curvarpack<span class="token punctuation">.</span><span class="token function">OpenDeptVar</span><span class="token punctuation">(</span>cv1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	FETCH cv1 INTO DeptRec<span class="token punctuation">;</span>
	WHILE cv1<span class="token operator">%</span>FOUND LOOP
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>DeptRec<span class="token punctuation">.</span>deptno<span class="token operator">||</span>’<span class="token operator">:</span>’<span class="token operator">||</span>DeptRec<span class="token punctuation">.</span>dname<span class="token punctuation">)</span><span class="token punctuation">;</span>
	FETCH cv1 INTO DeptRec<span class="token punctuation">;</span>
	END LOOP<span class="token punctuation">;</span>
	CLOSE cv1<span class="token punctuation">;</span>
	DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>’ 游标变量弱类型定义应用'<span class="token punctuation">)</span>
	CurVarPack<span class="token punctuation">.</span><span class="token function">OpenDeptvar</span><span class="token punctuation">(</span>cv2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> dept_name <span class="token operator">=</span><span class="token operator">&gt;</span> ‘A<span class="token operator">%</span>’<span class="token punctuation">)</span><span class="token punctuation">;</span>
	FETCH cv2 INTO DeptRec<span class="token punctuation">;</span>
	WHILE cv2<span class="token operator">%</span>FOUND LOOP
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>DeptRec<span class="token punctuation">.</span>deptno<span class="token operator">||</span>’<span class="token operator">:</span>’<span class="token operator">||</span>DeptRec<span class="token punctuation">.</span>dname<span class="token punctuation">)</span><span class="token punctuation">;</span>
		FETCH cv2 INTO DeptRec<span class="token punctuation">;</span>
	END LOOP<span class="token punctuation">;</span>
	
	DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>’ 游标变量弱类型定义应用 dept 表'<span class="token punctuation">)</span>
	<span class="token function">OpenCurtype</span><span class="token punctuation">(</span>cv2<span class="token punctuation">,</span> ‘D’<span class="token punctuation">)</span><span class="token punctuation">;</span>
	FETCH cv2 INTO DeptRec<span class="token punctuation">;</span>
	WHILE cv2<span class="token operator">%</span>FOUND LOOP
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>deptrec<span class="token punctuation">.</span>deptno<span class="token operator">||</span>’<span class="token operator">:</span>’<span class="token operator">||</span>de ptrec<span class="token punctuation">.</span>dname<span class="token punctuation">)</span><span class="token punctuation">;</span>
		FETCH cv2 INTO deptrec<span class="token punctuation">;</span>
	END LOOP<span class="token punctuation">;</span>
	
	DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>’ 游标变量弱类型定义应用 emp 表
	<span class="token function">OpenCurtype</span><span class="token punctuation">(</span>cv2<span class="token punctuation">,</span> ‘E’<span class="token punctuation">)</span><span class="token punctuation">;</span>
	FETCH cv2 INTO EmpRec<span class="token punctuation">;</span>
	WHILE cv2<span class="token operator">%</span>FOUND LOOP
		DBMS_OUTPUT<span class="token punctuation">.</span><span class="token function">PUT_LINE</span><span class="token punctuation">(</span>emprec<span class="token punctuation">.</span>empno<span class="token operator">||</span>’<span class="token operator">:</span>’<span class="token operator">||</span>emprec<span class="token punctuation">.</span>ename<span class="token punctuation">)</span><span class="token punctuation">;</span>
		FETCH cv2 INTO emprec<span class="token punctuation">;</span>
	END LOOP
	CLOSE cv2<span class="token punctuation">;</span>
END<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="__368"></a>五 子程序重载</h4> 
<p>PL/SQL允许对包内子程序和本地子程序进行重载 。所谓重载时指**两个或多个子程序有相同的名称，但拥有不同的参数变量、参数顺序或参数数据类型。</p> 
<pre><code class="prism language-java">CREATE OR REPLACE PACKAGE demo_pack1
	IS
	DeptRec dept<span class="token operator">%</span>ROWTYPE<span class="token punctuation">;</span>
	V_sqlcode NUMBER<span class="token punctuation">;</span>
	V_sqlerr <span class="token function">VARCHAR2</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	FUNCTION <span class="token function">query_dept</span><span class="token punctuation">(</span>dept_no IN NUMBER<span class="token punctuation">)</span>
		RETURN INTEGER<span class="token punctuation">;</span>
	FUNCTION <span class="token function">query_dept</span><span class="token punctuation">(</span>dept_no IN VARCHAR2<span class="token punctuation">)</span>
		RETURN INTEGER<span class="token punctuation">;</span>
END demo_pack1<span class="token punctuation">;</span>
CREATE OR REPLACE PACKAGE BODY demo_pack1
	IS
	FUNCTION <span class="token function">check_dept</span><span class="token punctuation">(</span>dept_no NUMBER<span class="token punctuation">)</span>
		RETURN INTEGER
	IS
		Flag INTEGER<span class="token punctuation">;</span>
BEGIN
	SELECT <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> INTO flag FROM dept WHER E deptno<span class="token operator">=</span>dept_no<span class="token punctuation">;</span>
	IF flag <span class="token operator">&gt;</span> <span class="token number">0</span> THEN
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
	ELSE
		RETURN <span class="token number">0</span><span class="token punctuation">;</span>
END IF<span class="token punctuation">;</span>
END check_dept<span class="token punctuation">;</span>

FUNCTION <span class="token function">check_dept</span><span class="token punctuation">(</span>dept_no VARCHAR2<span class="token punctuation">)</span>
	RETURN INTEGER
IS
	Flag INTEGER<span class="token punctuation">;</span>
BEGIN
	SELECT <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> INTO flag FROM dept WHERE deptno<span class="token operator">=</span>dept_no<span class="token punctuation">;</span>
	IF flag <span class="token operator">&gt;</span> <span class="token number">0</span> THEN
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
	ELSE
		RETURN <span class="token number">0</span><span class="token punctuation">;</span>
END IF<span class="token punctuation">;</span>
END check_dept<span class="token punctuation">;</span>

FUNCTION <span class="token function">query_dept</span><span class="token punctuation">(</span>dept_no IN NUMBER<span class="token punctuation">)</span>
	RETURN INTEGER
	IS
BEGIN
	IF <span class="token function">check_dept</span><span class="token punctuation">(</span>dept_no<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token number">1</span> THEN
		SELECT <span class="token operator">*</span> INTO DeptRec FROM dept WHERE deptno<span class="token operator">=</span>dept_no<span class="token punctuation">;</span>
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
	ELSE
		RETURN <span class="token number">0</span><span class="token punctuation">;</span>
END IF<span class="token punctuation">;</span>
END query_dept<span class="token punctuation">;</span>

FUNCTION <span class="token function">query_dept</span><span class="token punctuation">(</span>dept_no IN VARCHAR2<span class="token punctuation">)</span>
	RETURN INTEGER
	IS
BEGIN
	IF <span class="token function">check_dept</span><span class="token punctuation">(</span>dept_no<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token number">1</span> THEN
		SELECT <span class="token operator">*</span> INTO DeptRec FROM dept WHERE deptno<span class="token operator">=</span>dept_no<span class="token punctuation">;</span>
		RETURN <span class="token number">1</span><span class="token punctuation">;</span>
	ELSE
		RETURN <span class="token number">0</span><span class="token punctuation">;</span>
END IF<span class="token punctuation">;</span>
END query_dept<span class="token punctuation">;</span>
END demo_pack1<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="__435"></a>六 删除包</h4> 
<p>可以使用DROP PACKAGE 命令对 不需要的包进行删除，语法如下：</p> 
<pre><code class="prism language-java">DROP PACKAGE <span class="token punctuation">[</span>BODY<span class="token punctuation">]</span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span><span class="token punctuation">]</span>package_name<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="__441"></a>七 包的管理</h4> 
<p>DBA_SOURCE, USER_SOURCE, USER_ERRORS, DBAOBJECTS</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a5adefcf6bd96e1645206d30fd42ab9e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">学习IPFS&#43;区块链(前奏) — ubuntu安装ipfs</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c9fed907d984441c5ddf4cadf8fe2220/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Idea的Git如何回退到上一个版本</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>