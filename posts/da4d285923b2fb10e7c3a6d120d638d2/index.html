<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>应用日志集成到ElasticSearch - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/da4d285923b2fb10e7c3a6d120d638d2/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="应用日志集成到ElasticSearch">
  <meta property="og:description" content="1、阿里云sls平台集成日志 阿里sls集成日志步骤
2、filebeat 收集到指定es 安装docker容器
Docker安装
拉取镜像：
docker pull elastic/filebeat:7.5.1 启动：
docker run -d --name=filebeat elastic/filebeat:7.5.1 拷贝容器中的数据文件到宿主机：
mkdir -p /data/elk7 docker cp filebeat:/usr/share/filebeat /data/elk7/ 设置权限
chmod 777 -R /data/elk7/filebeat #go-w: 这个命令表示去掉文件的“组”和“其他用户”的写权限。其中， #g 代表组权限，o 代表其他用户权限，-w 表示去掉写权限。 chmod go-w /data/elk7/filebeat/filebeat.yml 配置filebeat
vim /data/elk7/filebeat/filebeat.yml 修改样例如下：
filebeat.inputs: - type: log enabled: true paths: - /var/log/*.log fields: AppId: &#34;springbootadmin&#34; ENV: &#34;DEV&#34; fields_under_root: true tags: [&#34;服务ip地址自定义其他&#34;, &#34;boot&#34;] json.keys_under_root: true - type: log enabled: true paths: - /java/*.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-22T17:02:50+08:00">
    <meta property="article:modified_time" content="2024-03-22T17:02:50+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">应用日志集成到ElasticSearch</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1sls_0"></a>1、阿里云sls平台集成日志</h3> 
<p><a href="https://blog.csdn.net/manwufeilong/article/details/125781421?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_utm_term~default-1-125781421-blog-118608703.235%5Ev43%5Epc_blog_bottom_relevance_base3&amp;spm=1001.2101.3001.4242.2&amp;utm_relevant_index=4">阿里sls集成日志步骤</a></p> 
<h3><a id="2filebeat_es_2"></a>2、filebeat 收集到指定es</h3> 
<p>安装docker容器</p> 
<p><a href="https://blog.csdn.net/FLGBgo/article/details/136835530">Docker安装</a></p> 
<p><strong>拉取镜像：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull elastic/filebeat:7.5.1
</code></pre> 
<p><strong>启动：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>filebeat elastic/filebeat:7.5.1
</code></pre> 
<p><strong>拷贝容器中的数据文件到宿主机：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/elk7
<span class="token function">docker</span> <span class="token function">cp</span> filebeat:/usr/share/filebeat /data/elk7/
</code></pre> 
<p><strong>设置权限</strong></p> 
<pre><code class="prism language-bash"><span class="token function">chmod</span> <span class="token number">777</span> <span class="token parameter variable">-R</span> /data/elk7/filebeat
<span class="token comment">#go-w: 这个命令表示去掉文件的“组”和“其他用户”的写权限。其中，</span>
<span class="token comment">#g 代表组权限，o 代表其他用户权限，-w 表示去掉写权限。</span>
<span class="token function">chmod</span> go-w /data/elk7/filebeat/filebeat.yml
</code></pre> 
<p><strong>配置filebeat</strong></p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /data/elk7/filebeat/filebeat.yml
</code></pre> 
<p>修改样例如下：</p> 
<pre><code class="prism language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /var/log/*.log
    fields:
      AppId: <span class="token string">"springbootadmin"</span>
      ENV: <span class="token string">"DEV"</span>
    fields_under_root: <span class="token boolean">true</span>
    tags: <span class="token punctuation">[</span><span class="token string">"服务ip地址自定义其他"</span>, <span class="token string">"boot"</span><span class="token punctuation">]</span>
    json.keys_under_root: <span class="token boolean">true</span>

  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /java/*.log
    fields:
      AppId: <span class="token string">"live-admin"</span>
      ENV: <span class="token string">"DEV"</span>
    fields_under_root: <span class="token boolean">true</span>
    tags: <span class="token punctuation">[</span><span class="token string">"服务ip地址自定义其他"</span>, <span class="token string">"live"</span><span class="token punctuation">]</span>
    json.keys_under_root: <span class="token boolean">true</span>

processors:
  - timestamp:
      field: <span class="token string">"time"</span>
      timezone: <span class="token string">"Asia/Shanghai"</span>
      layouts:
        - <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span>

output.elasticsearch:
  hosts: <span class="token string">'es:9200'</span>
  username: <span class="token string">"elastic"</span>
  password: <span class="token string">"elastic"</span>
  indices:
  
    - index: <span class="token string">"spring-boot-admin-%{+yyyy.MM}"</span>
      when.contains:
        tags: <span class="token string">"boot"</span>
    - index: <span class="token string">"live-admin-%{+yyyy.MM}"</span>
      when.contains:
        tags: <span class="token string">"live"</span>

setup.template.settings:
  index.number_of_shards: <span class="token number">3</span>
  index.number_of_replicas: <span class="token number">0</span>
</code></pre> 
<p><strong>日志输入源</strong>：</p> 
<ul><li>使用 filebeat.inputs<br> 部分定义了两个日志输入源。每个输入源监视不同路径下的日志文件，并根据路径指定的类型和字段进行处理。其中，第一个输入源监视<br> /var/log/<em>.log 路径下的日志文件，用于收集 Spring Boot Admin 应用的日志；第二个输入源监视<br> /java/</em>.log 路径下的日志文件，用于收集 Live Admin 应用的日志。</li></ul> 
<p><strong>日志标签：</strong></p> 
<ul><li>在每个输入源的 tags<br> 配置中，使用了一组自定义的标签。这些标签通常用于标识日志的来源或类型。在这个配置中，每个输入源都定义了自己的标签，以便后续根据标签将日志发送到不同的索引中。</li></ul> 
<p><strong>Elasticsearch 输出</strong>：</p> 
<ul><li>在 output.elasticsearch 部分指定了 Elasticsearch<br> 的地址和认证信息，并配置了索引的模板。根据不同的标签，将日志发送到不同的索引中。在这个配置中，根据标签 “boot” 将 Spring<br> Boot Admin 的日志发送到名为 spring-boot-admin-%{+yyyy.MM} 的索引中，根据标签 “live” 将<br> Live Admin 的日志发送到名为 live-admin-%{+yyyy.MM} 的索引中。</li></ul> 
<p><strong>Elasticsearch 索引设置</strong>：</p> 
<ul><li>在 setup.template.settings 部分配置了 Elasticsearch<br> 索引的一些设置，包括分片数和副本数。这些设置可以优化 Elasticsearch 索引的性能和可用性。</li></ul> 
<p><strong>删除之前的容器：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> filebeat
</code></pre> 
<p><strong>再重启启动：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run   <span class="token parameter variable">--name</span><span class="token operator">=</span>filebeat <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span>
 <span class="token parameter variable">-v</span> /data/elk7/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /var/log/springboot/:/var/log/springboot/ <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/log/live-admin/logs/:/var/log/live-admin/logs/ <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span>  elastic/filebeat:7.5.1
</code></pre> 
<p><strong>排查问题命令</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> logs filebeat
</code></pre> 
<p><strong>进入容器：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> filebeat /bin/bash

<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> filebeat /bin/sh
</code></pre> 
<p><strong>nginx的日志采集</strong></p> 
<p>如果要采集nginx的日志的话需要设置nginx日志格式</p> 
<pre><code class="prism language-bash"><span class="token comment">#修改nginx.conf，在http 、https中设置日志格式</span>
<span class="token comment">#添加 log_format  main </span>
user  nginx<span class="token punctuation">;</span>
worker_processes  auto<span class="token punctuation">;</span>

error_log  /var/log/nginx/error.log notice<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

worker_rlimit_nofile <span class="token number">10240</span><span class="token punctuation">;</span>
events <span class="token punctuation">{<!-- --></span>
    worker_connections  <span class="token number">10240</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


http <span class="token punctuation">{<!-- --></span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>
    server_tokens off<span class="token punctuation">;</span>
	
	proxy_hide_header X-Powered-By<span class="token punctuation">;</span>
   	proxy_hide_header Server<span class="token punctuation">;</span>

	log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    proxy_connect_timeout     <span class="token number">30000</span><span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">30000</span><span class="token punctuation">;</span>
    client_max_body_size 100m<span class="token punctuation">;</span>
	client_header_buffer_size 512k<span class="token punctuation">;</span>
	large_client_header_buffers <span class="token number">4</span> 512k<span class="token punctuation">;</span>


    <span class="token comment">#gzip  on;</span>

    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>在**filebeat.inputs:**新增一个log</p> 
<pre><code class="prism language-bash">- type: log
  enabled: <span class="token boolean">true</span>
  paths:
    - /var/log/nginx/access.log
  fields:
    AppId: <span class="token string">"nginx"</span>
    ENV: <span class="token string">"DEV"</span>
  fields_under_root: <span class="token boolean">true</span>
  tags: <span class="token punctuation">[</span><span class="token string">"ip"</span>,<span class="token string">"nginx"</span><span class="token punctuation">]</span>
  json.keys_under_root: <span class="token boolean">true</span>
</code></pre> 
<p>在**indices:**下新增一个index</p> 
<pre><code class="prism language-bash"> - index: <span class="token string">"nginx-%{+yyyy.MM}"</span>
      when.contains:
        tags: <span class="token string">"nginx"</span>
</code></pre> 
<p>设置命令行中执行 Nginx 相关的命令时不输入完整路径</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/sbin:/usr/local/nginx/sbin:<span class="token environment constant">$PATH</span>
</code></pre> 
<ul><li>/usr/sbin 目录通常包含系统管理和维护的命令，例如一些系统管理工具和服务程序的启动脚本等。</li><li>/usr/local/nginx/sbin 目录包含了 Nginx 服务器的可执行文件，包括启动 Nginx 的命令 nginx。</li></ul> 
<p>通过将这两个目录添加到 PATH 中，可以方便地在命令行中直接执行 nginx 命令来启动或管理 Nginx 服务器，而不必输入完整的路径。</p> 
<p><strong>再次删除容器重新启动，把nginx日志也挂在上去</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run  <span class="token parameter variable">--name</span><span class="token operator">=</span>filebeat <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/elk7/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /var/log/springboot/:/var/log/springboot/ <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/log/live-admin/logs/:/var/log/live-admin/logs/ <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /var/log/nginx/:/var/log/nginx/ <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span>  elastic/filebeat:7.5.1
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/98937db07a9f71d8436fe406fd3db52e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">看了一篇开源作者文章我沉默了良久还是发一篇心情文章</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6d3a86e73362f471c4fb97ea6b901074/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">kingbaseESV8常用ksql命令</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>