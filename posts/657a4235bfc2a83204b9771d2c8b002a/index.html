<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CAS单点登录(二)——搭建基础服务 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/657a4235bfc2a83204b9771d2c8b002a/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="CAS单点登录(二)——搭建基础服务">
  <meta property="og:description" content="前一篇文章中，我们对CAS及SSO（单点登录）有了大致的了解，今天我们开始讲解如何搭建一个简单的CAS服务认证中心，如果你对CAS中单点登录的概念忘记了，可以先去复习一下先前的文章——CAS单点登录(一)——初识SSO，再开始接下来的内容。
一、搭建CAS基础服务 1、准备 首先CAS官方文档地址：https://apereo.github.io/cas/5.3.x/index.html，在后面我们可能随时会用到。
然后我们从Geting Started开始，在文档里面告诉我们部署CAS，推荐我们使用WAR Overlay method的方法，利用覆盖机制来组合CAS原始工件和本地自定义方法来达到自定义CAS的要求。
It is recommended to build and deploy CAS locally using the WAR Overlay method. This approach does not require the adopter to explicitly download any version of CAS, but rather utilizes the overlay mechanism to combine CAS original artifacts and local customizations to further ease future upgrades and maintenance. 官方给了两种编译方式，一种是Maven、另一种是Gradle，这里使用Maven安装部署。
具体的详情可以参考：https://apereo.github.io/cas/5.3.x/installation/Maven-Overlay-Installation.html
在开始之前，我们需要配置好电脑环境，笔者当前的环境为：
JDK 1.8Maven 3.5.3Tomcat 8.5（官方推荐Tomcat至少要8版本以上） 2、下载代码打包 我们需要下载打包成WAR的代码架子，地址为： https://github.com/apereo/cas-overlay-template。
这里我们使用的CAS当前最新版本5.3.x，然后我们进入代码根目录下打开pom.xml文件，添加国内的maven镜像源地址，加快下载包的速度，因为CAS需要的包有点多，并且很大，如果为原来的地址，速度非常慢。
&amp;lt;repositories&amp;gt; &amp;lt;repository&amp;gt; &amp;lt;id&amp;gt;sonatype-releases&amp;lt;/id&amp;gt; &amp;lt;url&amp;gt;http://oss.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-07-14T18:33:35+08:00">
    <meta property="article:modified_time" content="2018-07-14T18:33:35+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CAS单点登录(二)——搭建基础服务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>前一篇文章中，我们对CAS及SSO（单点登录）有了大致的了解，今天我们开始讲解如何搭建一个简单的CAS服务认证中心，如果你对CAS中单点登录的概念忘记了，可以先去复习一下先前的文章——<a href="https://blog.csdn.net/anumbrella/article/details/80821486">CAS单点登录(一)——初识SSO</a>，再开始接下来的内容。</p> 
<h3 id="一搭建cas基础服务">一、搭建CAS基础服务</h3> 
<h4 id="1准备">1、准备</h4> 
<p>首先CAS官方文档地址：<a href="https://apereo.github.io/cas/5.3.x/index.html" rel="nofollow">https://apereo.github.io/cas/5.3.x/index.html</a>，在后面我们可能随时会用到。</p> 
<p>然后我们从<a href="https://apereo.github.io/cas/5.3.x/planning/Getting-Started.html" rel="nofollow">Geting Started</a>开始，在文档里面告诉我们部署CAS，推荐我们使用WAR Overlay method的方法，利用覆盖机制来组合CAS原始工件和本地自定义方法来达到自定义CAS的要求。</p> 
<pre class="prettyprint"><code class=" hljs livecodeserver">It is recommended <span class="hljs-built_in">to</span> build <span class="hljs-operator">and</span> deploy CAS locally <span class="hljs-keyword">using</span> <span class="hljs-operator">the</span> WAR Overlay method. 
This approach does <span class="hljs-operator">not</span> <span class="hljs-built_in">require</span> <span class="hljs-operator">the</span> adopter <span class="hljs-built_in">to</span> explicitly download <span class="hljs-keyword">any</span> <span class="hljs-built_in">version</span> <span class="hljs-operator">of</span> CAS, 
but rather utilizes <span class="hljs-operator">the</span> overlay mechanism <span class="hljs-built_in">to</span> <span class="hljs-built_in">combine</span> CAS original artifacts <span class="hljs-operator">and</span> <span class="hljs-built_in">local</span> 
customizations <span class="hljs-built_in">to</span> further ease future upgrades <span class="hljs-operator">and</span> maintenance.</code></pre> 
<p>官方给了两种编译方式，一种是Maven、另一种是Gradle，这里使用Maven安装部署。</p> 
<p><img src="https://images2.imgbox.com/45/08/5IKvmvyp_o.png" alt="WAR Overlay method" title=""></p> 
<p>具体的详情可以参考：<a href="https://apereo.github.io/cas/5.3.x/installation/Maven-Overlay-Installation.html" rel="nofollow">https://apereo.github.io/cas/5.3.x/installation/Maven-Overlay-Installation.html</a></p> 
<p>在开始之前，我们需要配置好电脑环境，笔者当前的环境为：</p> 
<ul><li>JDK 1.8</li><li>Maven 3.5.3</li><li>Tomcat 8.5（官方推荐Tomcat至少要8版本以上）</li></ul> 
<p><img src="https://images2.imgbox.com/2a/45/47miemlo_o.png" alt="tomcat" title=""></p> 
<h4 id="2下载代码打包">2、下载代码打包</h4> 
<p>我们需要下载打包成WAR的代码架子，地址为： <a href="https://github.com/apereo/cas-overlay-template">https://github.com/apereo/cas-overlay-template</a>。</p> 
<p>这里我们使用的CAS当前最新版本5.3.x，然后我们进入代码根目录下打开pom.xml文件，添加国内的maven镜像源地址，加快下载包的速度，因为CAS需要的包有点多，并且很大，如果为原来的地址，速度非常慢。</p> 
<pre class="prettyprint"><code class=" hljs xml">     <span class="hljs-tag">&lt;<span class="hljs-title">repositories</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">id</span>&gt;</span>sonatype-releases<span class="hljs-tag">&lt;/<span class="hljs-title">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">url</span>&gt;</span>http://oss.sonatype.org/content/repositories/releases/<span class="hljs-tag">&lt;/<span class="hljs-title">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-title">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">snapshots</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">releases</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-title">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">releases</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">id</span>&gt;</span>sonatype-snapshots<span class="hljs-tag">&lt;/<span class="hljs-title">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">url</span>&gt;</span>https://oss.sonatype.org/content/repositories/snapshots/<span class="hljs-tag">&lt;/<span class="hljs-title">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-title">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">snapshots</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">releases</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-title">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">releases</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">id</span>&gt;</span>shibboleth-releases<span class="hljs-tag">&lt;/<span class="hljs-title">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">url</span>&gt;</span>https://build.shibboleth.net/nexus/content/repositories/releases<span class="hljs-tag">&lt;/<span class="hljs-title">url</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">repository</span>&gt;</span>

        <span class="hljs-comment">&lt;!--添加国内镜像源地址--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">id</span>&gt;</span>maven-ali<span class="hljs-tag">&lt;/<span class="hljs-title">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public//<span class="hljs-tag">&lt;/<span class="hljs-title">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">releases</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-title">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-title">enabled</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">updatePolicy</span>&gt;</span>always<span class="hljs-tag">&lt;/<span class="hljs-title">updatePolicy</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">checksumPolicy</span>&gt;</span>fail<span class="hljs-tag">&lt;/<span class="hljs-title">checksumPolicy</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">snapshots</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">repositories</span>&gt;</span></code></pre> 
<p>更改pom.xml文件后，我们到项目的跟目录下，执行<code>mvn clean package</code>命令，接着就会去下载相应的jar包。</p> 
<p><img src="https://images2.imgbox.com/d2/f0/hjlL9dCf_o.png" alt="mvn clean package" title=""></p> 
<p>当执行完毕后，我们便可在项目根目录下的target目录下发现生成的cas.war包。然后我们将其放入Tomcat目录下的webapps下面。接着在浏览器里访问<a href="http://localhost:8080/cas/login" rel="nofollow">http://localhost:8080/cas/login</a>，可以发现CAS出现登录界面。</p> 
<p><img src="https://images2.imgbox.com/57/2c/voRNtmKH_o.png" alt="cas login" title=""></p> 
<p>默认账号：casuser 默认密码：Mellon 目前的配置仅有这一个用户。输入用户名和密码，登录成功！</p> 
<p><img src="https://images2.imgbox.com/54/26/G1noALen_o.png" alt="sucess" title=""></p> 
<p>这样我们就完成了CAS的登录过程，基本的CAS服务搭建就实现了。</p> 
<p>我们在登录界面可以发现，弹出了两个提示框，如下图红框所圈：</p> 
<p><img src="https://images2.imgbox.com/ce/fe/JJJAj9mI_o.png" alt="tip" title=""></p> 
<p>我们仔细阅读可以发现，这里主要说了：</p> 
<pre><code>一、我们的登录不是安全的，并没有使用HTTPS协议，这里我们使用了HTTP。

二、提示我们这里用户验证方式是静态文件写死的，指定就是我们的用户名和密码（casuser/Mellon）,这个只适合demo使用。
</code></pre> 
<p>接下来我们就主要围绕这两点来解决问题。</p> 
<h3 id="二配置证书">二、配置证书</h3> 
<h4 id="1生成证书">1、生成证书</h4> 
<p>接下来我们便开始解决这两个问题，首先是HTTPS，我们知道使用HTTPS是需要证书的，所以接下来我们便制作一个证书。</p> 
<p>使用JDK自带的工具keytool</p> 
<pre class="prettyprint"><code class=" hljs lasso">keytool <span class="hljs-attribute">-genkey</span> <span class="hljs-attribute">-alias</span> caskeystore <span class="hljs-attribute">-keypass</span> <span class="hljs-number">123456</span> <span class="hljs-attribute">-keyalg</span> RSA <span class="hljs-attribute">-keystore</span> thekeystore</code></pre> 
<p>首先输入密钥库口令，然后在输入名字与姓氏时为为具体路由地址，就是待会CAS认证服务器的地址（这里以sso.anumbrella.net为例），而其余的根据具体情况填写即可，然后就会在当前目录下生成证书。</p> 
<p><img src="https://images2.imgbox.com/b8/69/xcO46rnP_o.png" alt="keystore" title=""></p> 
<h4 id="2导出数字证书">2、导出数字证书</h4> 
<pre class="prettyprint"><code class=" hljs lasso">keytool <span class="hljs-attribute">-export</span> <span class="hljs-attribute">-alias</span> caskeystore <span class="hljs-attribute">-keystore</span> thekeystore <span class="hljs-attribute">-rfc</span> <span class="hljs-attribute">-file</span> cas<span class="hljs-built_in">.</span>crt</code></pre> 
<p>输入先前的密钥库口令，然后在当前目录下生成具体的cas.crt数字证书。</p> 
<p><img src="https://images2.imgbox.com/c8/9b/V18iDX3A_o.png" alt="export" title=""></p> 
<h4 id="3将数字证书导入jdk下的jre里">3、将数字证书导入jdk下的jre里</h4> 
<p>windows:</p> 
<pre class="prettyprint"><code class=" hljs lasso">keytool <span class="hljs-attribute">-import</span> <span class="hljs-attribute">-alias</span> caskeystore <span class="hljs-attribute">-keystore</span> <span class="hljs-subst">%</span>JAVA_HOME<span class="hljs-subst">%\</span>jre<span class="hljs-subst">\</span>lib<span class="hljs-subst">\</span>security<span class="hljs-subst">\</span>cacerts <span class="hljs-attribute">-file</span> cas<span class="hljs-built_in">.</span>crt <span class="hljs-attribute">-trustcacerts</span> <span class="hljs-attribute">-storepass</span> changeit</code></pre> 
<p>Unix:</p> 
<pre class="prettyprint"><code class=" hljs lasso">sudo keytool <span class="hljs-attribute">-import</span> <span class="hljs-attribute">-alias</span> caskeystore <span class="hljs-attribute">-keystore</span> <span class="hljs-variable">$JAVA_HOME</span>/jre/lib/security/cacerts <span class="hljs-attribute">-file</span> cas<span class="hljs-built_in">.</span>crt <span class="hljs-attribute">-trustcacerts</span> <span class="hljs-attribute">-storepass</span> changeit</code></pre> 
<p>这里导入JDK时需要默认密码changeit，在命令中已经配置好了。如果没有该密码，则会报java.io.IOException: Keystore was tampered with, or password was incorrect错误。</p> 
<p><img src="https://images2.imgbox.com/53/e2/2MzCX0O1_o.png" alt="import" title=""></p> 
<h4 id="4配置dns">4、配置DNS</h4> 
<p>这里我的CAS服务端是部署在本地的，所以需要做一个本地映射。</p> 
<p>我的系统为Mac OS， 所以用管理员权限打开/private/etc/hosts文件</p> 
<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">sudo</span> vim /private/etc/hosts</code></pre> 
<p>添加映射地址：</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>       sso<span class="hljs-preprocessor">.anumbrella</span><span class="hljs-preprocessor">.net</span></code></pre> 
<p>如果是Windows，则用管理员身份修改C:\Windows\System32\drivers\etc\hosts文件。</p> 
<h4 id="5配置tomcat">5、配置Tomcat</h4> 
<p>编辑Tomcat目录Conf下的server.xml文件。</p> 
<p>将8443的端口配置文件打开，配置如下（添加前面刚刚生成的keystore的地址和密匙）：</p> 
<pre class="prettyprint"><code class=" hljs xml">    <span class="hljs-tag">&lt;<span class="hljs-title">Connector</span> <span class="hljs-attribute">port</span>=<span class="hljs-value">"8443"</span> <span class="hljs-attribute">protocol</span>=<span class="hljs-value">"org.apache.coyote.http11.Http11NioProtocol"</span>
               <span class="hljs-attribute">maxThreads</span>=<span class="hljs-value">"150"</span> <span class="hljs-attribute">SSLEnabled</span>=<span class="hljs-value">"true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">SSLHostConfig</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">Certificate</span> <span class="hljs-attribute">certificateKeystoreFile</span>=<span class="hljs-value">"/Users/anumbrella/keystore/thekeystore"</span>
                         <span class="hljs-attribute">type</span>=<span class="hljs-value">"RSA"</span> <span class="hljs-attribute">certificateKeystoreType</span>=<span class="hljs-value">"JKS"</span> <span class="hljs-attribute">certificateKeystorePassword</span>=<span class="hljs-value">"123456"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">SSLHostConfig</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">Connector</span>&gt;</span>
</code></pre> 
<p>重启Tomcat服务器，接着我们访问<a href="https://sso.anumbrella.net:8443/cas/login" rel="nofollow">https://sso.anumbrella.net:8443/cas/login</a>，可以发现先前的情况一的提示没有了。</p> 
<p><img src="https://images2.imgbox.com/55/97/qBLmtIj5_o.png" alt="tip1" title=""></p> 
<h3 id="三-更改配置">三、 更改配置</h3> 
<p>我们知道cas-overlay-template是采用配置覆盖的策略来进行自定义的，因此我们可以通过覆盖或者继承某些类重写某些方法实现自定义的需求。将我们先前的cas.war解压，或者直接去Tomcat下webapps目录下面，打开WEB-INF目录下的classes里面的application.properties文件。</p> 
<p><img src="https://images2.imgbox.com/8c/b3/RtqQB8WD_o.png" alt="application.properties" title=""></p> 
<p>可以看到该文件就是对CAS认证服务器的配置，我们现在要自定义，打开我们的项目，新建<code>src/main/resources</code>文件夹，同时将刚才的application.properties文件复制到该目录下。</p> 
<p><img src="https://images2.imgbox.com/10/09/95nvgqgz_o.png" alt="resources" title=""></p> 
<p>现在我们就可以通过配置application.properties文件来实现对CAS服务器的自定义。</p> 
<p>除了上面我们刚刚在Tomcat里面配置证书，我们还可以直接将证书配置到CAS服务信息里面，打开application.properties文件，我们可以发现在开头有配置信息如下：</p> 
<p><img src="https://images2.imgbox.com/e9/ca/RGi0GESq_o.png" alt="SSL配置" title=""></p> 
<p>我们将信息更改如下：</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-preprocessor">#SSL配置</span>
server<span class="hljs-preprocessor">.ssl</span><span class="hljs-preprocessor">.enabled</span>=true
server<span class="hljs-preprocessor">.ssl</span><span class="hljs-preprocessor">.key</span>-store=file:/etc/cas/thekeystore
server<span class="hljs-preprocessor">.ssl</span><span class="hljs-preprocessor">.key</span>-store-password=<span class="hljs-number">123456</span>
server<span class="hljs-preprocessor">.ssl</span><span class="hljs-preprocessor">.key</span>-password=changeit
server<span class="hljs-preprocessor">.ssl</span><span class="hljs-preprocessor">.keyAlias</span>=caskeystore</code></pre> 
<p>然后将刚才上面生成的thekeystore放入到电脑目录/etc/cas/目录下面（这里你需要指定为自己具体的目录）。</p> 
<p>现在我们启动项目就可以直接使用/etc/cas/下面的证书了。</p> 
<p>除此之外，我们还可以将证书放在resources包下面，每次打包就可以直接使用该证书了。</p> 
<pre class="prettyprint"><code class=" hljs avrasm">server<span class="hljs-preprocessor">.ssl</span><span class="hljs-preprocessor">.key</span>-store=classpath:thekeystore</code></pre> 
<p>注意：<code>server.ssl.keyAlias</code>是生成证书填写的别名，不是随便填写的，可以通过<code>keytool -list -keystore thekeystore</code>命令查看。</p> 
<p><img src="https://images2.imgbox.com/b5/ea/3j2TElPZ_o.png" alt="keyAlias" title=""></p> 
<p>这里配置使用的是CAS自带的Tomcat，所以我们需要通过命令启动（与前面使用电脑自带Tomcat不同）。</p> 
<p>Windows：</p> 
<p>运行命令：</p> 
<pre class="prettyprint"><code class=" hljs avrasm">build<span class="hljs-preprocessor">.cmd</span> run</code></pre> 
<p>打包命令：</p> 
<pre class="prettyprint"><code class=" hljs lua">build.cmd <span class="hljs-built_in">package</span></code></pre> 
<p>Unix:</p> 
<p>运行命令：</p> 
<pre class="prettyprint"><code class=" hljs avrasm">build<span class="hljs-preprocessor">.sh</span> run</code></pre> 
<p>打包命令：</p> 
<pre class="prettyprint"><code class=" hljs lua">build.sh <span class="hljs-built_in">package</span></code></pre> 
<p>当然你还可以使用<code>java -jar cas.war</code> 直接运行已经打包好的cas.war来运行CAS。</p> 
<p><img src="https://images2.imgbox.com/5f/ac/7KvUCTnT_o.png" alt="cas" title=""></p> 
<p>接着我们在配置文件的最后我们发现了CAS的认证配置，这里就是CAS默认用户名和密码配置的地方，我们现在对其进行更改。</p> 
<p><img src="https://images2.imgbox.com/d1/a5/ZzeQGjxl_o.png" alt="user config" title=""></p> 
<p>默认的认证方式为静态文件认证，现在我们更改为JDBC认证方式，同时添加相关数据库驱动。</p> 
<pre class="prettyprint"><code class=" hljs xml">    <span class="hljs-tag">&lt;<span class="hljs-title">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!--新增支持jdbc验证--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.apereo.cas<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>cas-server-support-jdbc<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>${cas.version}<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--若不想找驱动可以直接写下面的依赖即可，其中包括HSQLDB、Oracle、MYSQL、PostgreSQL、MariaDB、Microsoft SQL Server--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.apereo.cas<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>cas-server-support-jdbc-drivers<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>${cas.version}<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-title">dependencies</span>&gt;</span></code></pre> 
<p>笔者这里直接使用了CAS提供的综合驱动库，这里不推荐这个用法，具体使用什么数据库引入具体的相关驱动即可，因为引入综合包，同时也引入了太多不必要的包。</p> 
<p>现在我们更改application.properties配置，同时注释静态用户配置，具体更改如下：</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-preprocessor">##</span>
<span class="hljs-preprocessor"># CAS Authentication Credentials</span>
<span class="hljs-preprocessor">#</span>
<span class="hljs-preprocessor">#cas.authn.accept.users=casuser::Mellon</span>

<span class="hljs-preprocessor">#查询账号密码SQL，必须包含密码字段</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.sql</span>=select * from user where username=?

<span class="hljs-preprocessor">#指定上面的SQL查询字段名（必须）</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.fieldPassword</span>=password

<span class="hljs-preprocessor">#指定过期字段，1为过期，若过期不可用</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.fieldExpired</span>=expired

<span class="hljs-preprocessor">#为不可用字段段，1为不可用，需要修改密码</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.fieldDisabled</span>=disabled

<span class="hljs-preprocessor">#数据库连接</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.url</span>=jdbc:mysql://<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">3306</span>/cas?useUnicode=true&amp;characterEncoding=UTF-<span class="hljs-number">8</span>&amp;autoReconnect=true&amp;useSSL=false

<span class="hljs-preprocessor">#数据库dialect配置</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.dialect</span>=org<span class="hljs-preprocessor">.hibernate</span><span class="hljs-preprocessor">.dialect</span><span class="hljs-preprocessor">.MySQLDialect</span>

<span class="hljs-preprocessor">#数据库用户名</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.user</span>=root

<span class="hljs-preprocessor">#数据库用户密码</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.password</span>=<span class="hljs-number">123</span>

<span class="hljs-preprocessor">#数据库事务自动提交</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.autocommit</span>=false

<span class="hljs-preprocessor">#数据库驱动</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.driverClass</span>=<span class="hljs-keyword">com</span><span class="hljs-preprocessor">.mysql</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.Driver</span>

<span class="hljs-preprocessor">#超时配置</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.idleTimeout</span>=<span class="hljs-number">5000</span>

<span class="hljs-preprocessor">#默认加密策略，通过encodingAlgorithm来指定算法，默认NONE不加密</span>
cas<span class="hljs-preprocessor">.authn</span><span class="hljs-preprocessor">.jdbc</span><span class="hljs-preprocessor">.query</span>[<span class="hljs-number">0</span>]<span class="hljs-preprocessor">.passwordEncoder</span><span class="hljs-preprocessor">.type</span>=NONE
<span class="hljs-preprocessor">#cas.authn.jdbc.query[0].passwordEncoder.characterEncoding=UTF-8</span>
<span class="hljs-preprocessor">#cas.authn.jdbc.query[0].passwordEncoder.encodingAlgorithm=MD5</span></code></pre> 
<p>因为这里使用到了数据库，所以我在本地新建了一个数据库cas，然后新建用户表user，添加id、username、password、expired、disabled字段，同时添加用户名和密码，并给expired，disabled字段赋值为0。重新执行打包命令，<code>mvn clean package</code>，替换掉Tomcat下webapps下的cas.war包，并删除cas目录，重启Tomcat。</p> 
<p><img src="https://images2.imgbox.com/fb/06/lIziPOdM_o.png" alt="user" title=""></p> 
<p>访问<a href="https://sso.anumbrella.net:8443/cas/login" rel="nofollow">https://sso.anumbrella.net:8443/cas/login</a>，我们可以发现，情况二的提示也没有出现了，因为我们的认证方式更改了。</p> 
<p>接着我们输入anumbrella/anumbrella，就是刚才创建的用户名和密码，结果成功登陆。</p> 
<p><img src="https://images2.imgbox.com/59/2e/ssDyR6Go_o.png" alt="cas login2" title=""></p> 
<p><img src="https://images2.imgbox.com/08/8f/1gQk6Qx5_o.png" alt="success2" title=""></p> 
<p>到此，CAS基础服务搭建就介绍完毕了。如果有疑问，欢迎留言！！</p> 
<p>代码实例：<a href="https://github.com/Shuyun123/CAS/tree/master/Chapter1">Chapter1</a></p> 
<h3 id="参考">参考</h3> 
<ul><li><a href="https://blog.csdn.net/u010475041/article/details/77943965">CAS单点登录-自定义认证之JDBC（五）</a></li><li><a href="https://blog.csdn.net/yelllowcong/article/details/78805420">CAS之5.2x版本单点登录服务安装</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a08826d8bd0621204c97c0823a6ca08/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CMU15 445/645课程-Tree Based Indexes笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ffcdedc6b3dc5452cd187faaf2d5e361/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">玩大数据，没有这34个工具怎么行！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>