<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>A value is trying to be set on a copy of a slice from a DataFrame. Try using .loc[row_indexer,col_in - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/c94ac7cde57c50581a0fb3cdc1fe8329/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="A value is trying to be set on a copy of a slice from a DataFrame. Try using .loc[row_indexer,col_in">
  <meta property="og:description" content="某日在捣鼓pandas时发生了warning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead
意思是一个值正被赋给来自于DataFrame类型的切片的拷贝，使用.loc方法来赋值。
遂研究了下，感觉很奇怪
In [233]: import pandas as pd In [234]: A = pd.DataFrame([[1,2,3], [7,8,9],[14,15,16]], columns = [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]) In [235]: A Out[235]: a b c 0 1 2 3 1 7 8 9 2 14 15 16 把A的第一列赋值给B，B是Series对象，修改B的某一个数发现A也被修改了
In [236]: B = A[&#39;a&#39;] In [237]: B Out[237]: 0 1 1 7 2 14 Name: a, dtype: int64 In [238]: type(B) Out[238]: pandas.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-08-06T16:22:31+08:00">
    <meta property="article:modified_time" content="2018-08-06T16:22:31+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">A value is trying to be set on a copy of a slice from a DataFrame. Try using .loc[row_indexer,col_in</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>某日在捣鼓pandas时发生了warning:</p> 
<blockquote> 
 <p>A value is trying to be set on a copy of a slice from a DataFrame.<br> Try using .loc[row_indexer,col_indexer] = value instead</p> 
</blockquote> 
<p>意思是一个值正被赋给来自于DataFrame类型的切片的拷贝，使用.loc方法来赋值。</p> 
<p>遂研究了下，感觉很奇怪</p> 
<pre class="has"><code class="language-python">In [233]: import pandas as pd

In [234]: A = pd.DataFrame([[1,2,3], [7,8,9],[14,15,16]], columns = ['a', 'b', 'c'])

In [235]: A
Out[235]:
    a   b   c
0   1   2   3
1   7   8   9
2  14  15  16</code></pre> 
<p>把A的第一列赋值给B，B是Series对象，修改B的某一个数发现A也被修改了</p> 
<pre class="has"><code class="language-python">In [236]: B = A['a']

In [237]: B
Out[237]:
0     1
1     7
2    14
Name: a, dtype: int64

In [238]: type(B)
Out[238]: pandas.core.series.Series

In [239]: B[0] = 3

In [240]: B
Out[240]:
0     3
1     7
2    14
Name: a, dtype: int64

In [241]: A
Out[241]:
    a   b   c
0   3   2   3
1   7   8   9
2  14  15  16</code></pre> 
<p>然后把A的第一列和第二列赋值给C，C是A的切片的拷贝？，C是DataFrame类型，修改C的第一行第一列，发生了警告，C被修改，A未被修改</p> 
<pre class="has"><code class="language-python">In [243]: C = A[['a', 'b']]

In [244]: C
Out[244]:
    a   b
0   3   2
1   7   8
2  14  15

In [245]: type(C)
Out[245]: pandas.core.frame.DataFrame

In [246]: C['a'][0]
Out[246]: 3

In [247]: C['a'][0] =5
c:\program files\python36\lib\site-packages\IPython\core\interactiveshell.py:2910: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
  exec(code_obj, self.user_global_ns, self.user_ns)

In [248]: C
Out[248]:
    a   b
0   5   2
1   7   8
2  14  15

In [249]: A
Out[249]:
    a   b   c
0   3   2   3
1   7   8   9
2  14  15  16</code></pre> 
<p>利用A的loc方法生成D，D和C一样，再进行同样的操作，没有发生警告<br>  </p> 
<pre class="has"><code class="language-python">In [250]: D = A.loc[:, ['a','b']]

In [251]: D
Out[251]:
    a   b
0   3   2
1   7   8
2  14  15

In [252]: type(D)
Out[252]: pandas.core.frame.DataFrame

In [253]: D['a'][0]
Out[253]: 3

In [254]: D['a'][0] = 5

In [255]: D
Out[255]:
    a   b
0   5   2
1   7   8
2  14  15

In [256]: A
Out[256]:
    a   b   c
0   3   2   3
1   7   8   9
2  14  15  16</code></pre> 
<p>C和D有什么区别？我尝试了一下C规避警告的办法，可使用</p> 
<pre class="has"><code class="language-python">C = C.copy()</code></pre> 
<p>再进行修改数值操作，就不会发生警告了。</p> 
<p>看了一下官方文档：<a href="http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy" rel="nofollow">http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy</a></p> 
<p>大意是这样的：</p> 
<pre class="has"><code class="language-python">In [339]: dfmi = pd.DataFrame([list('abcd'),
   .....:                      list('efgh'),
   .....:                      list('ijkl'),
   .....:                      list('mnop')],
   .....:                     columns=pd.MultiIndex.from_product([['one','two'],
   .....:                                                         ['first','second']]))
   .....: 

In [340]: dfmi
Out[340]: 
    one          two       
  first second first second
0     a      b     c      d
1     e      f     g      h
2     i      j     k      l
3     m      n     o      p</code></pre> 
<p>如果你使用loc方法，</p> 
<pre class="has"><code class="language-python">dfmi.loc[:,('one','second')] = value
</code></pre> 
<p>在pandas里会被视为（等价于）调用了loc的__setitem__方法</p> 
<pre class="has"><code class="language-python"># becomes
dfmi.loc.__setitem__((slice(None), ('one', 'second')), value)</code></pre> 
<p>如果你使用下面的方式赋值</p> 
<pre class="has"><code class="language-python">dfmi['one']['second'] = value</code></pre> 
<p>pandas内部等价于如下</p> 
<pre class="has"><code class="language-python"># becomes
dfmi.__getitem__('one').__setitem__('second', value)</code></pre> 
<p>即首先调用了__getitem__方法，返回了一个DataFrame对象，再对这个对象调用__setitem__方法，也就是说，调用了两次，称为链式索引（chained indexing），时间上会比loc更慢。</p> 
<p>但通常，pandas不会因为你多花了一些时间就给你报错，而是因为pandas无法保证第一次返回的DataFrame对象是view还是copy，取决于数组的布局（layout of array），如果返回的是view，那么皆大欢喜，没有问题。如果返回的是copy，那我给一个copy赋值后，它的原变量没有发生改变。pandas无法保证__setitem__是会修改dfmi还是修改一个马上被扔掉的临时对象，所以最好使用loc方法。</p> 
<blockquote> 
 <p>What’s up with the <code>SettingWithCopy</code> warning? We don’t <strong>usually</strong> throw warnings around when you do something that might cost a few extra milliseconds!But it turns out that assigning to the product of chained indexing has inherently unpredictable results.</p> 
 <p>Outside of simple cases, it’s very hard to predict whether it will return a view or a copy (it depends on the memory layout of the array, about which pandas makes no guarantees), and therefore whether the <code>__setitem__</code> will modify <code>dfmi</code> or a temporary object that gets thrown out immediately afterward. <strong>That’s</strong> what <code>SettingWithCopy</code> is warning you about!</p> 
</blockquote> 
<p> </p> 
<p>回到我自己的问题，从上面代码执行的情况来看，C是A的slice的copy,因为改变了C对A没有影响。那为什么还会警告？我猜是因为pandas内部认为，C是上面提到的“马上要被扔掉的临时对象”，而B是A的slice的view，所以没有被警告。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7c1e283b88322305e8661bda909fbf5b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">RabbitMQ学习(六)——消息确认机制(Confirm模式)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dcfaca4097d2d71a4db7a1eba4dc4d45/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">cloudera-manager.repo https问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>