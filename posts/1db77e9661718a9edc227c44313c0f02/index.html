<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CAN总线学习-1 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/1db77e9661718a9edc227c44313c0f02/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="CAN总线学习-1">
  <meta property="og:description" content="CAN总线学习-1 最近开始学习CAN，希望每天能够做些笔记，有所积累。本文基于weixin_40528417博主的内容。
1 位定时
1.1 位速率
-位速率:又叫做比特率（bit rata）、信息传输率，表示的是单位时间内，总线上传输的信息量，即每秒能够传输的二进制位的数量，单位是bit per second。
1.2 位时间
1.2.1 位时间定义
-位时间：表示的是一个二进制位在总线上传输时所需要的时间。
位速率=1/位时间 首先先了解两个时钟的概念：晶振时钟周期和CAN时钟周期
晶振时钟周期：由振荡器的晶振频率决定的，是振荡器每震荡一次所消耗的时间，也是整个系统中最小的时间单位。
CAN时钟周期：CAN时钟是由系统时钟分频而来的一个时间值，实际上就是一个Tq。可以按照下面的公式计算
CAN时钟周期=2×晶振时钟周期×BRP(baudrate prescaler)
下面图片SS&#43;PS&#43;PBS1&#43;PBS2 = tBit
1.2.2 位时间分布
如上面所述：一个CAN的最小的时间单位是Tq。
位时间主要分成4段：同步段，传播段，相位缓冲段1，相位缓冲段2，总共8-25个Tq。
1）同步段（Synchronization Segment）：
长度固定，1个时间量子Tq；
一个位的传输从同步段开始；
同步段用于同步总线上的各个节点，一个位的跳边沿在此时间段内。
2）传播段（Propagation Segment）：
传播段用于补偿报文在总线和节点上传输时所产生的时间延迟；
传播段时长 ≥ 2 × 报文在总线和节点上传输时产生的时间延迟 ；
传播段时长可编程（1~8个时间量子Tq）。
3）相位缓冲段1（Phase Buffer Segment1）：
用于补偿节点间的晶振误差；
允许通过重同步对该段加长；
在这个时间段的末端进行总线状态的采样；
长度可编程（1~8Tq）
4）相位缓冲段2（Phase Buffer Segment2）：
用于补偿节点间的晶振误差；
允许通过重同步对该段缩短；
长度可编程（1~8个时间量子Tq）
5） 采样点（Sample Point）
采样点一般位于相位缓冲段1之后，采样点是读取总线电平，并解释各位的值的一个时间点，采样点对CAN总线来说也非常重要，尤其在组网的时候，多个节点尽量保持同一个采样点，且最好在但不超过7/8位时间点上。
2. CAN的同步机制
在CAN通信中，有两种同步机制：硬同步与重同步
2.1 同步的规则
一个位时间内只允许一种同步方式，要么硬同步要么重同步；
任何一个从“隐性”到“显性”的下降沿 都可以用于同步；
硬同步发生在报文的SOF位（ SOF指帧起始：数据帧开始的段），所有接收节点调整各自当前位的同步段，使其位于发送的SOF位内；">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-03-22T16:55:29+08:00">
    <meta property="article:modified_time" content="2020-03-22T16:55:29+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CAN总线学习-1</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="CAN1_0"></a>CAN总线学习-1</h3> 
<blockquote> 
 <p>最近开始学习CAN，希望每天能够做些笔记，有所积累。本文基于weixin_40528417博主的内容。</p> 
</blockquote> 
<p><strong>1 位定时</strong><br> <strong>1.1 位速率</strong><br> -位速率:又叫做比特率（bit rata）、信息传输率，表示的是单位时间内，总线上传输的信息量，即每秒能够传输的二进制位的数量，单位是bit per second。<br> <strong>1.2 位时间<br> 1.2.1 位时间定义</strong><br> -<strong>位时间：表示的是一个二进制位在总线上传输时所需要的时间。</strong></p> 
<pre><code class="prism language-c"> 位速率<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span>位时间
</code></pre> 
<p>首先先了解两个时钟的概念：<strong>晶振时钟周期</strong>和<strong>CAN时钟周期</strong></p> 
<ul><li> <p><strong>晶振时钟周期</strong>：由振荡器的晶振频率决定的，是振荡器每震荡一次所消耗的时间，也是整个系统中最小的时间单位。</p> </li><li> <p><strong>CAN时钟周期</strong>：CAN时钟是由系统时钟分频而来的一个时间值，实际上就是一个Tq。可以按照下面的公式计算<br> <code>CAN时钟周期=2×晶振时钟周期×BRP(baudrate prescaler)</code></p> </li><li> <p>下面图片SS+PS+PBS1+PBS2 = tBit</p> </li></ul> 
<p><img src="https://images2.imgbox.com/df/05/DSnOthzD_o.png" alt=""><br> <strong>1.2.2 位时间分布</strong><br> 如上面所述：一个CAN的最小的时间单位是<strong>Tq</strong>。<br> 位时间主要分成4段：<em><strong>同步段，传播段，相位缓冲段1，相位缓冲段2</strong></em>，总共8-25个Tq。<br> <img src="https://images2.imgbox.com/d6/4f/xlT9QI5O_o.png" alt="在这里插入图片描述"></p> 
<ul><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> 1）<strong>同步段</strong>（Synchronization Segment）：</p> </li><li> <p>长度固定，1个时间量子Tq；</p> </li><li> <p>一个位的传输从同步段开始；</p> </li><li> <p>同步段用于同步总线上的各个节点，一个位的跳边沿在此时间段内。</p> </li><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> 2）<strong>传播段</strong>（Propagation Segment）：</p> </li><li> <p>传播段用于补偿报文在总线和节点上传输时所产生的时间延迟；</p> </li><li> <p>传播段时长 ≥ 2 × 报文在总线和节点上传输时产生的时间延迟 ；</p> </li><li> <p>传播段时长可编程（1~8个时间量子Tq）。</p> </li><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> 3）<strong>相位缓冲段1</strong>（Phase Buffer Segment1）：</p> </li><li> <p>用于补偿节点间的晶振误差；</p> </li><li> <p>允许通过重同步对该段加长；</p> </li><li> <p>在这个时间段的末端进行总线状态的采样；</p> </li><li> <p>长度可编程（1~8Tq）</p> </li><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> 4）<strong>相位缓冲段2</strong>（Phase Buffer Segment2）：</p> </li><li> <p>用于补偿节点间的晶振误差；</p> </li><li> <p>允许通过重同步对该段缩短；</p> </li><li> <p>长度可编程（1~8个时间量子Tq）</p> </li><li class="task-list-item"> <p><input type="checkbox" class="task-list-item-checkbox" disabled> 5） <strong>采样点</strong>（Sample Point）</p> </li><li> <p>采样点一般位于相位缓冲段1之后，采样点是读取总线电平，并解释各位的值的一个时间点，采样点对CAN总线来说也非常重要，尤其在组网的时候，多个节点尽量保持同一个采样点，且最好在但不超过7/8位时间点上。</p> </li></ul> 
<p><strong>2. CAN的同步机制</strong><br> 在CAN通信中，有两种同步机制：硬同步与重同步<br> <strong>2.1 同步的规则</strong></p> 
<ul><li> <p>一个位时间内只允许一种同步方式，要么硬同步要么重同步；</p> </li><li> <p>任何一个从“隐性”到“显性”的下降沿 都可以用于同步；</p> </li><li> <p>硬同步发生在报文的SOF位（ SOF指帧起始：数据帧开始的段），所有接收节点调整各自当前位的同步段，使其位于发送的SOF位内；</p> </li><li> <p>重同步发生在一个报文SOF位之外的其它段，当下降沿落在了同步段之外时发生重同步；</p> </li><li> <p>在SOF到仲裁场发送的时间段内，如果有多个节点同时发送报文，那么这些发送节点对跳变沿不进行重同步<br> <strong>2.2 硬同步</strong><br> 硬同步发生在<strong>SOF位</strong>，所有接收节点调整各自当前位的同步段，调整宽度不限<br> <img src="https://images2.imgbox.com/eb/0c/I8WIwWce_o.png" alt="在这里插入图片描述"><br> （1）发送节点Node_A在发送SOF位时，SOF位的下降沿在SS段；<br> （2）这个时候接收节点Node_B发现自己当前位的SS段和发送节点SOF位的SS段不同步。也就是说当Node_A产生SOF位SS段时，Node_B的当前位的SS段已经在5个Tq之前产生了；<br> （3）于是接收节点Node_B强行将自己当前位的SS段拉到与SOF位的SS段同步。<br> <strong>2.3 重同步</strong><br> 重同步发生在一个报文SOF位之外的其它位场内，当接收节点Node_B当前位的下降沿落在了发送节点Node_A当前位的同步段之外时发生重同步。<br> 重同步会导致<strong>相位缓冲段1</strong>的延长或者<strong>相位缓冲段2</strong>的缩短，从而保证采样点的准确。<br> <img src="https://images2.imgbox.com/cd/f7/XlA4pS6u_o.png" alt="在这里插入图片描述"><br> 如上图所示：<br> （1）发送节点Node_A比接收节点Node_B的时间慢了，也就是说Node_A当前位的ss段产生的时候，Node_B 当前位的ss段已经在2个Tq之前产生了；<br> （2）所以这个时候接收节点Node_B就将PBS1延长2个Tq的时间；<br> （3）于是这个时候Node_A当前位的采样点就和Node_B的采样点同步了。<br> <strong>2.3.2 PBS2缩短</strong><br> 发的早（快），收的晚（慢），导致PBS2缩短。<br> <img src="https://images2.imgbox.com/47/39/zlJg4BR3_o.png" alt="在这里插入图片描述"><br> 如上图所示：<br> （1）发送节点Node_A当前位的SS段诞生2Tq时长之后，接收节点Node_B的当前位才产生SS段；<br> （2）于是，接收节点Node_B当前位的PBS2段缩短，<br> （3）这样就会导致接收节点Node_B的下一位能够提前2个Tq，从而Node_B的下一位采样点和Node_A下一位的采样点能够同步。<br> <strong>2.3.3 同步跳转宽度</strong><br> 在重同步时，有个<strong>同步跳转宽度</strong>（SJW，Synchro Jump Width）的概念，表示的是PBS1和PBS2重同步时允许跳转的最大宽度。<br> 同步跳转宽度必须满足以下几个条件：</p> </li><li> <p>SJW必须小于PBS1和PBS2的最小值</p> </li><li> <p>SJW最大值不能超过4<br> <strong>3. 例子</strong><br> 以下面的例子来讲述位定时参数的确定方法：<br> <em><strong>MCU晶振16MHz，位速率1Mbps，总线长度20m，单位总线延迟5ns/m，物理接口的发送接收延迟150ns</strong></em></p> </li><li> <p>晶振时钟周期：T=1s/16MHz = 62.5ns</p> </li><li> <p>位时间 ：tBit = 1/1Mbps = 1000ns</p> </li><li> <p>BPR和NBT：考虑到 T = 125ns，tBit = 1000ns，所以BPR(预分频值)只能取值为1，才能满足NBT∈[8,25],于是预分频数BPR=1（62.5<em>2</em>8=1000）；</p> </li><li> <p>CAN时钟周期Tq = 2 × 62.5 × 1 = 125ns（通过2×晶振时钟周期×BRP）</p> </li><li> <p>NBT = 8(NBT 表示的是一个位时间tBit内包含Tq的个数)</p> </li></ul> 
<p>所以NBT=8个Tq的长度中需要有4个Tq用于补偿传播延迟，于是还剩下4个Tq，<br> SS同步段长度固定占据1个Tq，还剩3个Tq，于是PBS1分配一个Tq，PBS2分配2个Tq。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fec6d56e1fb9ac6b9848cf687b17066d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu怎样打开命令行终端（5种方法）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/28cde0499ad669536d6b55d7b7804f3c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MATLAB 求任意一个数的所有因子</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>