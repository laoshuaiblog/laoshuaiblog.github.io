<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>（k8s中）docker netty OOM问题记录 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/bea30b4a7e7cd732245d828411e6dffe/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="（k8s中）docker netty OOM问题记录">
  <meta property="og:description" content="1、首先查看docker的内存占用情况： docker top 容器名 -u 查看内存cpu占用率（容器名来自kubectl describe pod xxx或者docker ps）
可以看出内存一直增长，作为IO代理这是不正常的。
2、修改启动参数和配置文件 需要注意的是为了安全考虑，docker默认是不能使用一些调试手段的，需要修改启动参数和yaml
docker file中增加启动参数（yaml中应该也可以）：
ENTRYPOINT [&#34;java&#34;, &#34;-jar&#34;, &#34;/usr/local/bin/access-1.0-SNAPSHOT.jar&#34;, &#34;-XX:NativeMemoryTracking=detail&#34;] yaml增加：
apiVersion: apps/v1 kind: Deployment ....... spec: ........ template: ........ spec: containers: - name: access ......... securityContext: capabilities: add: [&#34;SYS_PTRACE&#34;] 3、查看具体内存占用 各类内存增长情况：
#建立内存基线 jcmd 1 VM.native_memory baseline #与基线对比 jcmd 1 VM.native_memory summary.diff 其中1是pid，可以通过jps查看
查看当前内存具体申请源：
jcmd 1 VM.native_memory detail scale=MB 查看结果是Other的内存增长比较明显：
[0x00007f76b2143b77] Unsafe_AllocateMemory0&#43;0x87 [0x00007f769577c4ba] (malloc=732MB type=Other #228) Unsafe_AllocateMemory0一般是ByteBuf申请的内存，jvm不管理，也就是不会gc，需要自己关注申请和释放
4、自己申请的ByteBuf 自己申请的ByteBuf要么往下传递（通过ctx write或者fire read）由后面的pipe节点释放，要么自己通过release释放。">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-07T15:08:12+08:00">
    <meta property="article:modified_time" content="2024-03-07T15:08:12+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">（k8s中）docker netty OOM问题记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1docker_0"></a>1、首先查看docker的内存占用情况：</h2> 
<p>docker top 容器名 -u 查看内存cpu占用率（容器名来自kubectl describe pod xxx或者docker ps）<br> <img src="https://images2.imgbox.com/fa/f8/pdUHaCMw_o.png" alt="在这里插入图片描述"><br> 可以看出内存一直增长，作为IO代理这是不正常的。</p> 
<h2><a id="2_5"></a>2、修改启动参数和配置文件</h2> 
<p>需要注意的是为了安全考虑，docker默认是不能使用一些调试手段的，需要修改启动参数和yaml<br> docker file中增加启动参数（yaml中应该也可以）：</p> 
<pre><code class="prism language-c">ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span><span class="token punctuation">,</span> <span class="token string">"-jar"</span><span class="token punctuation">,</span> <span class="token string">"/usr/local/bin/access-1.0-SNAPSHOT.jar"</span><span class="token punctuation">,</span> <span class="token string">"-XX:NativeMemoryTracking=detail"</span><span class="token punctuation">]</span>
</code></pre> 
<p>yaml增加：</p> 
<pre><code class="prism language-c">apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> Deployment
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec<span class="token operator">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  template<span class="token operator">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    spec<span class="token operator">:</span>      
      containers<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> access
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          
          securityContext<span class="token operator">:</span>
              capabilities<span class="token operator">:</span>
                add<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SYS_PTRACE"</span><span class="token punctuation">]</span>
</code></pre> 
<h2><a id="3_31"></a>3、查看具体内存占用</h2> 
<p>各类内存增长情况：</p> 
<pre><code class="prism language-c">#建立内存基线
jcmd <span class="token number">1</span> VM<span class="token punctuation">.</span>native_memory baseline
#与基线对比
jcmd <span class="token number">1</span> VM<span class="token punctuation">.</span>native_memory summary<span class="token punctuation">.</span>diff
</code></pre> 
<p>其中1是pid，可以通过jps查看</p> 
<p>查看当前内存具体申请源：</p> 
<pre><code class="prism language-c">jcmd <span class="token number">1</span> VM<span class="token punctuation">.</span>native_memory detail scale<span class="token operator">=</span>MB  
</code></pre> 
<p>查看结果是Other的内存增长比较明显：</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span><span class="token number">0x00007f76b2143b77</span><span class="token punctuation">]</span> Unsafe_AllocateMemory0<span class="token operator">+</span><span class="token number">0x87</span>
<span class="token punctuation">[</span><span class="token number">0x00007f769577c4ba</span><span class="token punctuation">]</span>
                             <span class="token punctuation">(</span>malloc<span class="token operator">=</span><span class="token number">732</span>MB type<span class="token operator">=</span>Other #<span class="token number">228</span><span class="token punctuation">)</span>
</code></pre> 
<p>Unsafe_AllocateMemory0一般是ByteBuf申请的内存，jvm不管理，也就是不会gc，需要自己关注申请和释放</p> 
<h2><a id="4ByteBuf_57"></a>4、自己申请的ByteBuf</h2> 
<p>自己申请的ByteBuf要么往下传递（通过ctx write或者fire read）由后面的pipe节点释放，要么自己通过release释放。<br> 如果是写入服务器response中的content，通过ctx.writeAndFlush往下传递，由netty去管就行了。</p> 
<h2><a id="5pipehandlemsg_61"></a>5、在pipe的handle中收到的msg</h2> 
<p>比如服务器上收到的request，如果不是最后一个节点，则必须显式传递：ctx.fireChannelRead(msg);<br> 如果是最后一个节点则自己手动释放，可以content.release也可以ReferenceCountUtil.release(msg);<br> 也可以继承SimpleChannelInboundHandler，SimpleChannelInboundHandler中会释放，不用自己释放了。<br> 如果是服务器处理一个请求回复一个响应，一般是作为最后一个节点，可以继承SimpleChannelInboundHandler。</p> 
<h2><a id="6nettyByteBuf_67"></a>6、netty的ByteBuf泄漏检测</h2> 
<p>在intellij中测试，先增加vm参数-Dio.netty.leakDetection.level=paranoid -Dio.netty.leakDetection.samplingInterval=128（需要再Modify options中选择才会出现，注意不是Program arguments）：<br> <img src="https://images2.imgbox.com/90/c4/OiimGdW9_o.png" alt="在这里插入图片描述"><br> 测试代码：</p> 
<pre><code class="prism language-c">  public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ByteBuf buf <span class="token operator">=</span> PooledByteBufAllocator<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf <span class="token operator">=</span> null<span class="token punctuation">;</span>
    System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    try <span class="token punctuation">{<!-- --></span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 再申请一次，此时会检测到泄漏并报告</span>
    PooledByteBufAllocator<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行后会报告泄露：<br> <img src="https://images2.imgbox.com/02/33/Qul7sUmI_o.png" alt="在这里插入图片描述"><br> 对于ServerHandler未回收的情况，如：</p> 
<pre><code class="prism language-c">public class NettyServerHandler extends ChannelInboundHandlerAdapter <span class="token punctuation">{<!-- --></span>  
    @Override
    public <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> Object msg<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg instanceof HttpRequest req<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                       
                    String respMsg <span class="token operator">=</span> <span class="token string">"Test Message Echo"</span><span class="token punctuation">;</span>
                    ByteBuf content <span class="token operator">=</span> Unpooled<span class="token punctuation">.</span><span class="token function">wrappedBuffer</span><span class="token punctuation">(</span>respMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>CharsetUtil<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    FullHttpResponse resp <span class="token operator">=</span> new <span class="token function">DefaultFullHttpResponse</span><span class="token punctuation">(</span>HttpVersion<span class="token punctuation">.</span>HTTP_1_1<span class="token punctuation">,</span> HttpResponseStatus<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    resp<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>HttpHeaderNames<span class="token punctuation">.</span>CONTENT_LENGTH<span class="token punctuation">,</span> content<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//在返回前msg没有显式回收，也没有交给下一个channel</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行两次请求后会报告内存泄漏：<br> <img src="https://images2.imgbox.com/d8/be/UwZnd9xF_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/04c26953bd02d97c6cbdfbd12fb75c9f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构-＞链表分类与oj（题），带你提升代码好感</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0a31e69ac88ed841c933a99c301cefd9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySql、Oracle数据库批量删除多个表</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>