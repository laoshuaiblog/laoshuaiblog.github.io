<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>clickhouse-数据导入导出方案 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/bf71ba0b238f7025c6f8290d5266eb8f/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="clickhouse-数据导入导出方案">
  <meta property="og:description" content="一、简介 clickhouse有多种数据的导入导出方式，可以灵活使用，下面对这些方式分别做些介绍，导入导出的写法与格式和格式设置有关。
二、导入 1.从s3导入 详情可查看官网，也可以在这里获取数据集
-- 建库建表 CREATE DATABASE git; CREATE TABLE git.commits ( hash String, author LowCardinality(String), time DateTime, message String, files_added UInt32, files_deleted UInt32, files_renamed UInt32, files_modified UInt32, lines_added UInt32, lines_deleted UInt32, hunks_added UInt32, hunks_removed UInt32, hunks_changed UInt32 ) ENGINE = MergeTree ORDER BY time; -- 导入数据 INSERT INTO git.commits SELECT * FROM s3(&#39;https://datasets-documentation.s3.amazonaws.com/github/commits/clickhouse/commits.tsv.xz&#39;, &#39;TSV&#39;, &#39;hash String,author LowCardinality(String), time DateTime, message String, files_added UInt32, files_deleted UInt32, files_renamed UInt32, files_modified UInt32, lines_added UInt32, lines_deleted UInt32, hunks_added UInt32, hunks_removed UInt32, hunks_changed UInt32&#39;) 0 rows in set.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-08-17T14:55:20+08:00">
    <meta property="article:modified_time" content="2023-08-17T14:55:20+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">clickhouse-数据导入导出方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一、简介</h2> 
<p>clickhouse有多种数据的导入导出方式，可以灵活使用，下面对这些方式分别做些介绍，导入导出的写法与<a href="https://clickhouse.com/docs/en/interfaces/formats" rel="nofollow">格式</a>和<a href="https://clickhouse.com/docs/en/operations/settings/formats" rel="nofollow">格式设置</a>有关。</p> 
<h2><a id="_5"></a>二、导入</h2> 
<h3><a id="1s3_7"></a>1.从s3导入</h3> 
<p>详情可查看<a href="https://clickhouse.com/docs/en/integrations/s3" rel="nofollow">官网</a>，也可以在这里获取<a href="https://clickhouse.com/docs/en/getting-started/example-datasets/github" rel="nofollow">数据集</a></p> 
<pre><code class="prism language-sql"><span class="token comment">-- 建库建表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> git<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> git<span class="token punctuation">.</span>commits
<span class="token punctuation">(</span>
    <span class="token keyword">hash</span> String<span class="token punctuation">,</span>
    author LowCardinality<span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">time</span> <span class="token keyword">DateTime</span><span class="token punctuation">,</span>
    message String<span class="token punctuation">,</span>
    files_added UInt32<span class="token punctuation">,</span>
    files_deleted UInt32<span class="token punctuation">,</span>
    files_renamed UInt32<span class="token punctuation">,</span>
    files_modified UInt32<span class="token punctuation">,</span>
    lines_added UInt32<span class="token punctuation">,</span>
    lines_deleted UInt32<span class="token punctuation">,</span>
    hunks_added UInt32<span class="token punctuation">,</span>
    hunks_removed UInt32<span class="token punctuation">,</span>
    hunks_changed UInt32
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">time</span><span class="token punctuation">;</span>

<span class="token comment">-- 导入数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> git<span class="token punctuation">.</span>commits <span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> s3<span class="token punctuation">(</span><span class="token string">'https://datasets-documentation.s3.amazonaws.com/github/commits/clickhouse/commits.tsv.xz'</span><span class="token punctuation">,</span> <span class="token string">'TSV'</span><span class="token punctuation">,</span> <span class="token string">'hash String,author LowCardinality(String), time DateTime, message String, files_added UInt32, files_deleted UInt32, files_renamed UInt32, files_modified UInt32, lines_added UInt32, lines_deleted UInt32, hunks_added UInt32, hunks_removed UInt32, hunks_changed UInt32'</span><span class="token punctuation">)</span>

<span class="token number">0</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">.</span> Elapsed: <span class="token number">1.826</span> sec<span class="token punctuation">.</span> Processed <span class="token number">62.78</span> thousand <span class="token keyword">rows</span><span class="token punctuation">,</span> <span class="token number">8.50</span> MB <span class="token punctuation">(</span><span class="token number">34.39</span> thousand <span class="token keyword">rows</span><span class="token operator">/</span>s<span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4.66</span> MB<span class="token operator">/</span>s<span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> 
<p>s3的表达式如下</p> 
<pre><code class="prism language-powershell">s3<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token namespace">[aws_access_key_id, aws_secret_access_key,]</span> <span class="token namespace">[format, [structure, [compression]]]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>path — 包含文件路径的存储桶 URL。 这在只读模式下支持以下通配符：*、?、{abc,def} 和 {N…M}，其中 N、M 是数字，‘abc’、‘def’ 是字符串。 有关更多信息，请参阅有关在路径中使用通配符的文档。</li><li>format — 文件的格式。</li><li>structure — 表的结构。 格式为“column1_name、column1_type、column2_name、column2_type，…”。</li><li>compression — 参数是可选的。 支持的值：none、gzip/gz、brotli/br、xz/LZMA、zstd/zst。 默认情况下，它将按文件扩展名自动检测压缩。</li></ul> 
<p>所以我们可以看出来上面的insert语句中，第一个参数是s3的url,第二个参数是说明文件为TSV文件，第三个参数把表的结构写下来了，这里没有给第四个参数，因为默认检测了扩展名为xz，所以不需要提供</p> 
<h3><a id="2_52"></a>2.从本地导入</h3> 
<p>这里可以通过<a href="https://clickhouse.com/docs/en/integrations/data-formats/sql" rel="nofollow">官网</a>获取更详细的内容</p> 
<h4><a id="21__55"></a>2.1 从本地其他文件导入</h4> 
<pre><code class="prism language-sql"><span class="token comment"># 写法一：</span>
clickhouse<span class="token operator">-</span>client <span class="token operator">-</span>q <span class="token string">"INSERT INTO git.com FORMAT CSV"</span> <span class="token operator">&lt;</span> <span class="token keyword">out</span><span class="token punctuation">.</span>csv
<span class="token comment"># 写法二：</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> com
<span class="token keyword">FROM</span> <span class="token keyword">INFILE</span> <span class="token string">'/data/tools/out.csv'</span>
FORMAT CSV
<span class="token comment"># 写法三：</span>
cat <span class="token keyword">out</span><span class="token punctuation">.</span>csv<span class="token operator">|</span>clickhouse<span class="token operator">-</span>client <span class="token operator">-</span>q <span class="token string">"INSERT INTO git.com FORMAT CSV"</span>
</code></pre> 
<h4><a id="22_sql_69"></a>2.2 从本地sql文件导入</h4> 
<p>ddl语句将被跳过</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> com
<span class="token keyword">FROM</span> <span class="token keyword">INFILE</span> <span class="token string">'/data/tools/dump.sql'</span> FORMAT MySQLDump
</code></pre> 
<p><strong>ps:</strong> 也可以直接通过文件读取数据,但是要注意读取文件的位置要在这个配置里面：user_files_path，不然会没有权限</p> 
<pre><code class="prism language-sql"> <span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> <span class="token keyword">file</span><span class="token punctuation">(</span><span class="token string">'dump.sql'</span><span class="token punctuation">,</span> MySQLDump<span class="token punctuation">)</span>
<span class="token keyword">LIMIT</span> <span class="token number">5</span>
</code></pre> 
<h4><a id="23__84"></a>2.3 二进制文件</h4> 
<p>详细内容可以在<a href="https://clickhouse.com/docs/en/integrations/data-formats/binary-native" rel="nofollow">官网</a>中查看</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> com
<span class="token keyword">FROM</span> <span class="token keyword">INFILE</span> <span class="token string">'/data/tools/data.clickhouse'</span> FORMAT Native

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> com
<span class="token keyword">FROM</span> <span class="token keyword">INFILE</span> <span class="token string">'/data/tools/data.clickhouse'</span> COMPRESSION <span class="token string">'lz4'</span> FORMAT Native

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> com
<span class="token keyword">FROM</span> <span class="token keyword">INFILE</span> <span class="token string">'/data/tools/data.binary'</span> FORMAT RowBinary

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> com
<span class="token keyword">FROM</span> <span class="token keyword">INFILE</span> <span class="token string">'/data/tools/data.msgpk'</span> FORMAT MsgPack


</code></pre> 
<p><strong>ps:</strong> 导入之前可以用以下语句查看下文件内容，不过也有同样的限制，文件的位置要在user_files_path配置里</p> 
<pre><code class="prism language-sql"><span class="token keyword">DESCRIBE</span> <span class="token keyword">file</span><span class="token punctuation">(</span><span class="token string">'data.clickhouse'</span><span class="token punctuation">,</span> Native<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_109"></a>三、导出</h2> 
<h3><a id="1s3_111"></a>1.导出数据到s3</h3> 
<h4><a id="11_s3_113"></a>1.1 从s3中查询数据</h4> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> s3<span class="token punctuation">(</span><span class="token string">'https://datasets-documentation.s3.eu-west-3.amazonaws.com/nyc-taxi/trips_*.gz'</span><span class="token punctuation">,</span> <span class="token string">'TabSeparatedWithNames'</span><span class="token punctuation">)</span>
<span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span>  _path<span class="token punctuation">,</span> _file<span class="token punctuation">,</span> trip_id
<span class="token keyword">FROM</span> s3<span class="token punctuation">(</span><span class="token string">'https://datasets-documentation.s3.eu-west-3.amazonaws.com/nyc-taxi/trips_0.gz'</span><span class="token punctuation">,</span> <span class="token string">'TabSeparatedWithNames'</span><span class="token punctuation">)</span>
<span class="token keyword">LIMIT</span> <span class="token number">5</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>注意：</strong> 我们不需要列出列，因为 TabSeparatedWithNames 格式对第一行中的列名称进行编码。 其他格式（例如 CSV 或 TSV）将为此查询返回自动生成的列，例如 c1、c2、c3 等。<br> 查询还支持虚拟列 _path 和 _file，它们分别提供有关存储桶路径和文件名的信息。</p> 
<h4><a id="12_s3_127"></a>1.2 导出数据到s3</h4> 
<pre><code class="prism language-sql"><span class="token comment"># 导出数据到s3的单个文件中</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">FUNCTION</span>
   s3<span class="token punctuation">(</span>
       <span class="token string">'https://datasets-documentation.s3.eu-west-3.amazonaws.com/csv/trips.csv.lz4'</span><span class="token punctuation">,</span>
       <span class="token string">'s3_key'</span><span class="token punctuation">,</span>
       <span class="token string">'s3_secret'</span><span class="token punctuation">,</span>
       <span class="token string">'CSV'</span>
    <span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> trips
<span class="token keyword">LIMIT</span> <span class="token number">10000</span><span class="token punctuation">;</span>
<span class="token comment"># 导出数据到s3的多个文件中</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">FUNCTION</span>
   s3<span class="token punctuation">(</span>
       <span class="token string">'https://datasets-documentation.s3.eu-west-3.amazonaws.com/csv/trips_{_partition_id}.csv.lz4'</span><span class="token punctuation">,</span>
       <span class="token string">'s3_key'</span><span class="token punctuation">,</span>
       <span class="token string">'s3_secret'</span><span class="token punctuation">,</span>
       <span class="token string">'CSV'</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> trips
<span class="token keyword">LIMIT</span> <span class="token number">100000</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>ps:</strong> clickhouse还有更多和s3联动的高级方式，这里先不做说明，后续讲解</p> 
<h3><a id="2_156"></a>2.导出到本地</h3> 
<h4><a id="21_158"></a>2.1其他文件</h4> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> com
<span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/data/tools/out.csv'</span>
FORMAT CSVWithNames
</code></pre> 
<h4><a id="22_sql_166"></a>2.2 sql文件</h4> 
<p>涉及到的相关参数：</p> 
<ul><li>output_format_sql_insert_table_name： 指定导出表的名称，默认值为table</li><li>output_format_sql_insert_include_column_names：指定在插入查询中是否包含列，默认包含，设置为0则不包含</li><li>output_format_sql_insert_max_batch_size：一个insert语句中的最大行数，默认为65505</li><li>output_format_sql_insert_quote_names ：是否用反引号包含字段</li><li>output_format_sql_insert_use_replace：使用replace语句而不是用insert语句，默认值为false</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> commits <span class="token keyword">limit</span> <span class="token number">100</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">'/data/tools/dump.sql'</span> <span class="token keyword">truncate</span> format SQLInsert<span class="token punctuation">;</span>
<span class="token keyword">SET</span> output_format_sql_insert_table_name <span class="token operator">=</span> <span class="token string">'out_table'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> table1 <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">'/data/tools/dump.sql'</span> <span class="token punctuation">[</span>append<span class="token operator">|</span><span class="token keyword">truncate</span><span class="token punctuation">]</span> format SQLInsert<span class="token punctuation">;</span>
<span class="token comment"># 可以看到/data/tools/dump.sql的文件内容如下，sql的名字变成了out_table</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> out_table <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>column1<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="23__183"></a>2.3 二进制文件</h4> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> com
<span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/data/tools/data.clickhouse'</span> FORMAT Native

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> com
<span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/data/tools/data.clickhouse'</span> COMPRESSION <span class="token string">'lz4'</span> FORMAT Native

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> com
<span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/data/tools/data.binary'</span> FORMAT RowBinary

<span class="token comment"># 这里必须要用limit1,多导出的话文件格式就不对了，jpg图片无法正常打开</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> com <span class="token keyword">limit</span> <span class="token number">1</span>
<span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/data/tools/data.jpg'</span>FORMAT RawBLOB

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> com
<span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/data/tools/data.msgpk'</span>FORMAT MsgPack
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0c8d5ed1fb30290892ad2670e39a63fa/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">介绍一些编程语言— Perl 语言</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d6dee52624c0c5ab8477e094ff48d0ca/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">首页模块丨前端uniapp微信小程序项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>