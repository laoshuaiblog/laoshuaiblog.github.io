<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>利用python实现本地文件上传到sftp - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/a5d1f35f05e18f3a2861fdb7a0a55ec2/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="利用python实现本地文件上传到sftp">
  <meta property="og:description" content="实现功能： 利用python自动连接sftp，并实现本地文件（文件夹）自动上传到远程sftp服务中指定路径下，且保持本地目录结构
系统环境：centos7
python版本：python3
使用模块包：paramiko ，若未安装，可使用 pip install paramiko 进行安装
难点分析：
（1）sftp.put(localfile,remotefile) 函数必须是两个文件名，且sftp远端的文件路径要存在，因此需要提前创建好目录
（2）sftp.mkdir() 函数只能创建一级目录，不能循环创建多级目录，本文通过一级一级获取本地路径，然后判断远程路径是否存在，若不存在就创建好，由此来保证上传的文件能够在sftp远端找到对应的目录
（3）用到的重点函数有 sftp.mkdir 、sftp.stat，更多函数可参见帮助文档：https://docs.paramiko.org/en/stable/api/sftp.html
（4）关于sftp文件下载的方法，参考博文：https://blog.csdn.net/d1240673769/article/details/106295184
（5）关于sftp文件上传和下载，另一种最简单的方法就是利用 shell脚本，lftp工具，详情参考：https://blog.csdn.net/d1240673769/article/details/106307421
实现代码：
# -*- coding: utf-8 -*- import paramiko import os import stat # 判断sftp服务端中文件路径是否存在，若不存在则创建 def create_dir(sftp,remoteDir): try: if stat.S_ISDIR(sftp.stat(remoteDir).st_mode): # 如果remoteDir存在且为目录，则返回True pass except Exception as e: sftp.mkdir(remoteDir) print(&#34;在远程sftp上创建目录：{}&#34;.format(remoteDir)) # 上传 def sftp_upload(sftp,localDir,remoteDir): if os.path.isdir(localDir): # 判断本地localDir是否为目录 for file in os.listdir(localDir): remoteDirTmp=os.path.join(remoteDir,file) localDirTmp=os.path.join(localDir,file) if os.path.isdir(localDirTmp): # 如果本地localDirTmp为目录，则对远程sftp服务器进行判断 create_dir(sftp,remoteDirTmp) # 判断sftp服务端文件目录是否存在,若不存在则创建 sftp_upload(sftp,localDirTmp,remoteDirTmp) else: print(&#34;">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-10-26T19:10:53+08:00">
    <meta property="article:modified_time" content="2021-10-26T19:10:53+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">利用python实现本地文件上传到sftp</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>实现功能</strong>： 利用python自动连接sftp，并实现本地文件（文件夹）自动上传到远程sftp服务中指定路径下，且保持本地目录结构<br> <strong>系统环境</strong>：centos7<br> <strong>python版本</strong>：python3<br> <strong>使用模块包</strong>：paramiko ，若未安装，可使用 pip install paramiko 进行安装</p> 
<p><strong>难点分析：</strong><br> （1）<strong>sftp.put(localfile,remotefile)</strong> 函数必须是两个文件名，且sftp远端的文件路径要存在，因此需要提前创建好目录<br> （2）<strong>sftp.mkdir()</strong> 函数只能创建一级目录，不能循环创建多级目录，本文通过一级一级获取本地路径，然后判断远程路径是否存在，若不存在就创建好，由此来保证上传的文件能够在sftp远端找到对应的目录<br> （3）用到的重点函数有 <strong>sftp.mkdir</strong> 、<strong>sftp.stat</strong>，更多函数可参见帮助文档：<a href="https://docs.paramiko.org/en/stable/api/sftp.html" rel="nofollow">https://docs.paramiko.org/en/stable/api/sftp.html</a><br> （4）关于sftp文件下载的方法，参考博文：<a href="https://blog.csdn.net/d1240673769/article/details/106295184">https://blog.csdn.net/d1240673769/article/details/106295184</a><br> （5）关于sftp文件上传和下载，另一种最简单的方法就是利用 shell脚本，lftp工具，详情参考：<a href="https://blog.csdn.net/d1240673769/article/details/106307421">https://blog.csdn.net/d1240673769/article/details/106307421</a></p> 
<p><strong>实现代码：</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> paramiko
<span class="token keyword">import</span> os
<span class="token keyword">import</span> stat

<span class="token comment"># 判断sftp服务端中文件路径是否存在，若不存在则创建</span>
<span class="token keyword">def</span> <span class="token function">create_dir</span><span class="token punctuation">(</span>sftp<span class="token punctuation">,</span>remoteDir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> stat<span class="token punctuation">.</span>S_ISDIR<span class="token punctuation">(</span>sftp<span class="token punctuation">.</span>stat<span class="token punctuation">(</span>remoteDir<span class="token punctuation">)</span><span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 如果remoteDir存在且为目录，则返回True</span>
            <span class="token keyword">pass</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        sftp<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>remoteDir<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"在远程sftp上创建目录：{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>remoteDir<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 上传</span>
<span class="token keyword">def</span> <span class="token function">sftp_upload</span><span class="token punctuation">(</span>sftp<span class="token punctuation">,</span>localDir<span class="token punctuation">,</span>remoteDir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>localDir<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 判断本地localDir是否为目录</span>
        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>localDir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            remoteDirTmp<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>remoteDir<span class="token punctuation">,</span><span class="token builtin">file</span><span class="token punctuation">)</span>
            localDirTmp<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>localDir<span class="token punctuation">,</span><span class="token builtin">file</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>localDirTmp<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 如果本地localDirTmp为目录，则对远程sftp服务器进行判断</span>
                create_dir<span class="token punctuation">(</span>sftp<span class="token punctuation">,</span>remoteDirTmp<span class="token punctuation">)</span> <span class="token comment"># 判断sftp服务端文件目录是否存在,若不存在则创建</span>
            sftp_upload<span class="token punctuation">(</span>sftp<span class="token punctuation">,</span>localDirTmp<span class="token punctuation">,</span>remoteDirTmp<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"upload file:"</span><span class="token punctuation">,</span>localDir<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            sftp<span class="token punctuation">.</span>put<span class="token punctuation">(</span>localDir<span class="token punctuation">,</span>remoteDir<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'upload error:'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>
    
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    host <span class="token operator">=</span> <span class="token string">'192.168.149.153'</span><span class="token comment">#sftp主机 </span>
    port <span class="token operator">=</span> <span class="token number">22</span> <span class="token comment">#端口</span>
    username <span class="token operator">=</span> <span class="token string">'sftpuser'</span> <span class="token comment">#sftp用户名</span>
    password <span class="token operator">=</span> <span class="token string">'passwd'</span>  <span class="token comment"># 密码</span>
    localDir <span class="token operator">=</span> <span class="token string">'/test/sftp'</span><span class="token comment">#本地文件或目录</span>
    remoteDir <span class="token operator">=</span> <span class="token string">'/sftp'</span><span class="token comment">#远程文件或目录（注意远程路径要存在）</span>
    sf <span class="token operator">=</span> paramiko<span class="token punctuation">.</span>Transport<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sf<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>username <span class="token operator">=</span> username<span class="token punctuation">,</span>password <span class="token operator">=</span> password<span class="token punctuation">)</span>
    sftp <span class="token operator">=</span> paramiko<span class="token punctuation">.</span>SFTPClient<span class="token punctuation">.</span>from_transport<span class="token punctuation">(</span>sf<span class="token punctuation">)</span>
    sftp_upload<span class="token punctuation">(</span>sftp<span class="token punctuation">,</span>localDir<span class="token punctuation">,</span>remoteDir<span class="token punctuation">)</span>
    sf<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5887657392960a6c43fe67e14080d7a9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于ForkJoin框架的一点小坑</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d02e566c48d261ca8d3548334f39420/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">阿里云对象存储OSS简介和使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>