<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ClickHouse安装配置 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/7b5a51a12ee88a1d084f43c9cb2b7139/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="ClickHouse安装配置">
  <meta property="og:description" content="一.安装官网介绍安装 https://clickhouse.com/#quick-start
sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://packages.clickhouse.com/rpm/clickhouse.repo sudo yum install -y clickhouse-server clickhouse-client sudo /etc/init.d/clickhouse-server start clickhouse-client # or &#34;clickhouse-client --password&#34; if you set up a password. 记得需要修改用户组
[root@Linux121 clickhouse-server]# chown -R clickhouse: &#39;/var/run/clickhouse-server/&#39; 集群方式配置
修改配置文件/etc/clickhouse-server/config.xml &amp;lt;listen_host&amp;gt;::&amp;lt;/listen_host&amp;gt; &amp;lt;zookeeper&amp;gt; &amp;lt;node&amp;gt; &amp;lt;host&amp;gt;Linux121&amp;lt;/host&amp;gt; &amp;lt;port&amp;gt;2181&amp;lt;/port&amp;gt; &amp;lt;/node&amp;gt; &amp;lt;node&amp;gt; &amp;lt;host&amp;gt;Linux122&amp;lt;/host&amp;gt; &amp;lt;port&amp;gt;2181&amp;lt;/port&amp;gt; &amp;lt;/node&amp;gt; &amp;lt;node&amp;gt; &amp;lt;host&amp;gt;Linux123&amp;lt;/host&amp;gt; &amp;lt;port&amp;gt;2181&amp;lt;/port&amp;gt; &amp;lt;/node&amp;gt; &amp;lt;/zookeeper&amp;gt; &amp;lt;macros&amp;gt; &amp;lt;shard&amp;gt;01&amp;lt;/shard&amp;gt; &amp;lt;replica&amp;gt;Linux121&amp;lt;/replica&amp;gt; &amp;lt;/macros&amp;gt; &amp;lt;perftest_3shards_1replicas&amp;gt; &amp;lt;shard&amp;gt; &amp;lt;internal_replication&amp;gt;true&amp;lt;/internal_replication&amp;gt; &amp;lt;replica&amp;gt; &amp;lt;host&amp;gt;Linux121&amp;lt;/host&amp;gt; &amp;lt;port&amp;gt;9000&amp;lt;/port&amp;gt; &amp;lt;/replica&amp;gt; &amp;lt;/shard&amp;gt; &amp;lt;shard&amp;gt; &amp;lt;internal_replication&amp;gt;true&amp;lt;/internal_replication&amp;gt; &amp;lt;replica&amp;gt; &amp;lt;host&amp;gt;Linux122&amp;lt;/host&amp;gt; &amp;lt;port&amp;gt;9000&amp;lt;/port&amp;gt; &amp;lt;/replica&amp;gt; &amp;lt;/shard&amp;gt; &amp;lt;shard&amp;gt; &amp;lt;internal_replication&amp;gt;true&amp;lt;/internal_replication&amp;gt; &amp;lt;replica&amp;gt; &amp;lt;host&amp;gt;Linux123&amp;lt;/host&amp;gt; &amp;lt;port&amp;gt;9000&amp;lt;/port&amp;gt; &amp;lt;/replica&amp;gt; &amp;lt;/shard&amp;gt; &amp;lt;/perftest_3shards_1replicas&amp;gt; 启动服务">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-04-21T14:46:45+08:00">
    <meta property="article:modified_time" content="2022-04-21T14:46:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ClickHouse安装配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一.安装官网介绍安装</h2> 
<p><a href="https://clickhouse.com/#quick-start" rel="nofollow"><em>https://clickhouse.com/#quick-start</em></a></p> 
<pre><code class="prism language-java">sudo yum install <span class="token operator">-</span>y yum<span class="token operator">-</span>utils
sudo yum<span class="token operator">-</span>config<span class="token operator">-</span>manager <span class="token operator">--</span>add<span class="token operator">-</span>repo https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>packages<span class="token punctuation">.</span>clickhouse<span class="token punctuation">.</span>com<span class="token operator">/</span>rpm<span class="token operator">/</span>clickhouse<span class="token punctuation">.</span>repo
sudo yum install <span class="token operator">-</span>y clickhouse<span class="token operator">-</span>server clickhouse<span class="token operator">-</span>client

sudo <span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server start
clickhouse<span class="token operator">-</span>client # or <span class="token string">"clickhouse-client --password"</span> <span class="token keyword">if</span> you set up a password<span class="token punctuation">.</span>
</code></pre> 
<p>记得需要修改用户组</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>root<span class="token annotation punctuation">@Linux121</span> clickhouse<span class="token operator">-</span>server<span class="token punctuation">]</span># chown <span class="token operator">-</span><span class="token class-name">R</span> clickhouse<span class="token operator">:</span> '<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server<span class="token operator">/</span>'
</code></pre> 
<p><strong>集群方式配置</strong></p> 
<pre><code class="prism language-java">修改配置文件<span class="token operator">/</span>etc<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server<span class="token operator">/</span>config<span class="token punctuation">.</span>xml
    <span class="token generics"><span class="token punctuation">&lt;</span>listen_host<span class="token punctuation">&gt;</span></span><span class="token operator">::</span><span class="token operator">&lt;</span><span class="token operator">/</span>listen_host<span class="token operator">&gt;</span>
     <span class="token generics"><span class="token punctuation">&lt;</span>zookeeper<span class="token punctuation">&gt;</span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>node<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux121</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">2181</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>node<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>node<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux122</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">2181</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>node<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>node<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux123</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">2181</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>node<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>zookeeper<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>macros<span class="token punctuation">&gt;</span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span><span class="token number">01</span><span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux121</span><span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>macros<span class="token operator">&gt;</span>



<span class="token generics"><span class="token punctuation">&lt;</span>perftest_3shards_1replicas<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span>
                <span class="token generics"><span class="token punctuation">&lt;</span>internal_replication<span class="token punctuation">&gt;</span></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>internal_replication<span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux121</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">9000</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span>
                <span class="token generics"><span class="token punctuation">&lt;</span>internal_replication<span class="token punctuation">&gt;</span></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>internal_replication<span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux122</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">9000</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span>
                <span class="token generics"><span class="token punctuation">&lt;</span>internal_replication<span class="token punctuation">&gt;</span></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>internal_replication<span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux123</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">9000</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>perftest_3shards_1replicas<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>启动服务</strong></p> 
<pre><code class="prism language-java">sudo <span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server start
</code></pre> 
<p><strong>登录客户端</strong><br> clickhouse-client</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>root<span class="token annotation punctuation">@Linux121</span> <span class="token keyword">default</span><span class="token punctuation">]</span># clickhouse<span class="token operator">-</span>client <span class="token operator">-</span>m
<span class="token class-name">ClickHouse</span> client version <span class="token number">22.3</span><span class="token number">.3</span><span class="token number">.44</span> <span class="token punctuation">(</span>official build<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token class-name">Connecting</span> <span class="token keyword">to</span> <span class="token namespace">localhost</span><span class="token operator">:</span><span class="token number">9000</span> as user <span class="token class-name"><span class="token namespace">default<span class="token punctuation">.</span></span>
Connected</span> <span class="token keyword">to</span> <span class="token class-name">ClickHouse</span> server version <span class="token number">22.3</span><span class="token number">.3</span> revision <span class="token number">54455.</span>

<span class="token class-name">Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> 
简单使用同sql
<span class="token class-name">Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> show databases<span class="token punctuation">;</span>

SHOW DATABASES

<span class="token class-name">Query</span> id<span class="token operator">:</span> ba56b55d<span class="token operator">-</span><span class="token number">914d</span><span class="token operator">-</span><span class="token number">4e2d</span><span class="token operator">-</span>aabc<span class="token operator">-</span>b9202f5123b0

┌─name───────────────┐
│ INFORMATION_SCHEMA │
│ <span class="token keyword">default</span>            │
│ information_schema │
│ system             │
└────────────────────┘

<span class="token number">4</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.003</span> <span class="token class-name"><span class="token namespace">sec<span class="token punctuation">.</span></span> 

Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> use <span class="token keyword">default</span><span class="token punctuation">;</span>

USE <span class="token keyword">default</span>

<span class="token class-name">Query</span> id<span class="token operator">:</span> <span class="token number">50</span>a692c7<span class="token operator">-</span><span class="token number">2173</span><span class="token operator">-</span><span class="token number">478e-9</span>bb6<span class="token operator">-</span><span class="token number">7f</span><span class="token number">17</span>a5db2fe9

<span class="token class-name">Ok</span><span class="token punctuation">.</span>

<span class="token number">0</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.003</span> <span class="token class-name"><span class="token namespace">sec<span class="token punctuation">.</span></span> 

Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> show tables<span class="token punctuation">;</span>

SHOW TABLES

<span class="token class-name">Query</span> id<span class="token operator">:</span> <span class="token number">23711594</span><span class="token operator">-</span><span class="token number">34</span>b4<span class="token operator">-</span><span class="token number">4</span>aea<span class="token operator">-</span><span class="token number">974e-0</span>b9625b7418f

<span class="token class-name">Ok</span><span class="token punctuation">.</span>

<span class="token number">0</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.005</span> <span class="token class-name"><span class="token namespace">sec<span class="token punctuation">.</span></span> 

Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> use system
            <span class="token punctuation">;</span>

USE system

<span class="token class-name">Query</span> id<span class="token operator">:</span> af13d001<span class="token operator">-</span><span class="token number">195</span>a<span class="token operator">-</span><span class="token number">4349</span><span class="token operator">-</span><span class="token number">8</span>abd<span class="token operator">-</span>f07f3fbca779

<span class="token class-name">Ok</span><span class="token punctuation">.</span>

<span class="token number">0</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.001</span> <span class="token class-name"><span class="token namespace">sec<span class="token punctuation">.</span></span> 

Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> show tables<span class="token punctuation">;</span>

SHOW TABLES

<span class="token class-name">Query</span> id<span class="token operator">:</span> <span class="token number">5211</span>c6cd<span class="token operator">-</span>a7c8<span class="token operator">-</span><span class="token number">4</span>c8a<span class="token operator">-</span><span class="token number">88</span>a7<span class="token operator">-</span><span class="token number">84316916f</span><span class="token number">742</span>

┌─name───────────────────────────┐
│ aggregate_function_combinators │
│ asynchronous_inserts           │
│ asynchronous_metric_log        │
│ asynchronous_metrics           │
│ build_options                  │
│ clusters                       │
│ collations                     │
│ columns                        │
│ contributors                   │
│ current_roles                  │
│ data_skipping_indices          │
│ data_type_families             │
│ databases                      │
│ detached_parts                 │
│ dictionaries                   │
│ disks                          │
│ distributed_ddl_queue          │
│ distribution_queue             │
│ enabled_roles                  │
│ errors                         │
│ events                         │
│ formats                        │
│ functions                      │
│ grants                         │
│ graphite_retentions            │
│ licenses                       │
│ macros                         │
│ merge_tree_settings            │
│ merges                         │
│ metric_log                     │
│ metrics                        │
│ models                         │
│ mutations                      │
│ numbers                        │
│ numbers_mt                     │
│ one                            │
│ part_moves_between_shards      │
│ parts                          │
│ parts_columns                  │
│ privileges                     │
│ processes                      │
│ projection_parts               │
│ projection_parts_columns       │
│ query_log                      │
│ query_thread_log               │
│ quota_limits                   │
│ quota_usage                    │
│ quotas                         │
│ quotas_usage                   │
│ replicas                       │
│ replicated_fetches             │
│ replicated_merge_tree_settings │
│ replication_queue              │
│ rocksdb                        │
│ role_grants                    │
│ roles                          │
│ row_policies                   │
│ session_log                    │
│ settings                       │
│ settings_profile_elements      │
│ settings_profiles              │
│ stack_trace                    │
│ storage_policies               │
│ table_engines                  │
│ table_functions                │
│ tables                         │
│ time_zones                     │
│ trace_log                      │
│ user_directories               │
│ users                          │
│ warnings                       │
│ zeros                          │
│ zeros_mt                       │
│ zookeeper                      │
└────────────────────────────────┘

<span class="token number">74</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.004</span> <span class="token class-name"><span class="token namespace">sec<span class="token punctuation">.</span></span> 

Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> 
通过查询系统表可以知道目前是以集群方式运行
<span class="token class-name">Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> select <span class="token operator">*</span> from system<span class="token punctuation">.</span>clusters<span class="token punctuation">;</span>

SELECT <span class="token operator">*</span>
FROM system<span class="token punctuation">.</span>clusters

<span class="token class-name">Query</span> id<span class="token operator">:</span> <span class="token number">15f</span>b5c2d<span class="token operator">-</span>fde3<span class="token operator">-</span><span class="token number">4</span>b1f<span class="token operator">-</span>a01c<span class="token operator">-</span><span class="token number">9958</span>ed7822cb

┌─cluster────────────────────┬─shard_num─┬─shard_weight─┬─replica_num─┬─host_name─┬─host_address───┬─port─┬─is_local─┬─user────┬─default_database─┬─errors_count─┬─slowdowns_count─┬─estimated_recovery_time─┐
│ perftest_3shards_1replicas │         <span class="token number">1</span> │            <span class="token number">1</span> │           <span class="token number">1</span> │ <span class="token class-name">Linux121</span>  │ <span class="token number">172.16</span><span class="token number">.131</span><span class="token number">.129</span> │ <span class="token number">9000</span> │        <span class="token number">1</span> │ <span class="token keyword">default</span> │                  │            <span class="token number">0</span> │               <span class="token number">0</span> │                       <span class="token number">0</span> │
│ perftest_3shards_1replicas │         <span class="token number">2</span> │            <span class="token number">1</span> │           <span class="token number">1</span> │ <span class="token class-name">Linux122</span>  │ <span class="token number">172.16</span><span class="token number">.131</span><span class="token number">.130</span> │ <span class="token number">9000</span> │        <span class="token number">0</span> │ <span class="token keyword">default</span> │                  │            <span class="token number">0</span> │               <span class="token number">0</span> │                       <span class="token number">0</span> │
│ perftest_3shards_1replicas │         <span class="token number">3</span> │            <span class="token number">1</span> │           <span class="token number">1</span> │ <span class="token class-name">Linux123</span>  │ <span class="token number">172.16</span><span class="token number">.131</span><span class="token number">.131</span> │ <span class="token number">9000</span> │        <span class="token number">0</span> │ <span class="token keyword">default</span> │                  │            <span class="token number">0</span> │               <span class="token number">0</span> │                       <span class="token number">0</span> │
└────────────────────────────┴───────────┴──────────────┴─────────────┴───────────┴────────────────┴──────┴──────────┴─────────┴──────────────────┴──────────────┴─────────────────┴─────────────────────────┘

<span class="token number">3</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.003</span> sec<span class="token punctuation">.</span>
</code></pre> 
<h2><a id="ReplicatedMergeTree_234"></a>二.ReplicatedMergeTree表引擎</h2> 
<p><strong>实现副本机制的配置</strong></p> 
<pre><code class="prism language-java">配置路径<span class="token operator">/</span>etc<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server<span class="token operator">/</span>config<span class="token punctuation">.</span>xml
 <span class="token generics"><span class="token punctuation">&lt;</span>zookeeper<span class="token punctuation">&gt;</span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>node<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux121</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">2181</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>node<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>node<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux122</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">2181</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>node<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>node<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux123</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">2181</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>node<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>zookeeper<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>副本机制案例</strong><br> 创建该引擎相关的表</p> 
<pre><code class="prism language-java"><span class="token class-name">Linux121</span>节点创建
create table <span class="token function">a1</span><span class="token punctuation">(</span>
            id <span class="token class-name">String</span><span class="token punctuation">,</span>
            price <span class="token class-name">Float64</span><span class="token punctuation">,</span>
            create_time <span class="token class-name">DateTime</span><span class="token punctuation">)</span>
            engine<span class="token operator">=</span><span class="token class-name">ReplicatedMergeTree</span><span class="token punctuation">(</span>'<span class="token operator">/</span>clickhouse<span class="token operator">/</span>tables<span class="token operator">/</span><span class="token number">01</span><span class="token operator">/</span>a1<span class="token char">','</span><span class="token class-name">Linux121</span>'<span class="token punctuation">)</span>
            partition by <span class="token function">toYYYYMM</span><span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
            order by id<span class="token punctuation">;</span>
<span class="token class-name">Linux122</span>节点创建
create table <span class="token function">a1</span><span class="token punctuation">(</span>
            id <span class="token class-name">String</span><span class="token punctuation">,</span>
            price <span class="token class-name">Float64</span><span class="token punctuation">,</span>
            create_time <span class="token class-name">DateTime</span><span class="token punctuation">)</span>
            engine<span class="token operator">=</span><span class="token class-name">ReplicatedMergeTree</span><span class="token punctuation">(</span>'<span class="token operator">/</span>clickhouse<span class="token operator">/</span>tables<span class="token operator">/</span><span class="token number">01</span><span class="token operator">/</span>a1<span class="token char">','</span><span class="token class-name">Linux122</span>'<span class="token punctuation">)</span>
            partition by <span class="token function">toYYYYMM</span><span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
            order by id<span class="token punctuation">;</span>
</code></pre> 
<p>向Linux121该表插入一条数据</p> 
<pre><code class="prism language-java">insert into table a1 <span class="token function">values</span><span class="token punctuation">(</span><span class="token char">'A001'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span>'<span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们发现Linux122节点也同时插入了该条数据</p> 
<h2><a id="_285"></a>三.分片</h2> 
<pre><code class="prism language-java">配置路径<span class="token operator">/</span>etc<span class="token operator">/</span>clickhouse<span class="token operator">-</span>server<span class="token operator">/</span>config<span class="token punctuation">.</span>xml
配置节点
    <span class="token generics"><span class="token punctuation">&lt;</span>remote_servers<span class="token punctuation">&gt;</span></span>
     <span class="token generics"><span class="token punctuation">&lt;</span>perftest_3shards_1replicas<span class="token punctuation">&gt;</span></span><span class="token comment">//集群名字</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span>
                <span class="token generics"><span class="token punctuation">&lt;</span>internal_replication<span class="token punctuation">&gt;</span></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>internal_replication<span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux121</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">9000</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span>
                <span class="token generics"><span class="token punctuation">&lt;</span>internal_replication<span class="token punctuation">&gt;</span></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>internal_replication<span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux122</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">9000</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span>
                <span class="token generics"><span class="token punctuation">&lt;</span>internal_replication<span class="token punctuation">&gt;</span></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>internal_replication<span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>host<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux123</span><span class="token operator">&lt;</span><span class="token operator">/</span>host<span class="token operator">&gt;</span>
                    <span class="token generics"><span class="token punctuation">&lt;</span>port<span class="token punctuation">&gt;</span></span><span class="token number">9000</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>perftest_3shards_1replicas<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>remote_servers<span class="token operator">&gt;</span>
</code></pre> 
<p><em><strong>对应每个节点下指明当前分片信息</strong></em></p> 
<pre><code class="prism language-java">比如<span class="token class-name">Linux121</span>节点
 <span class="token generics"><span class="token punctuation">&lt;</span>macros<span class="token punctuation">&gt;</span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span><span class="token number">01</span><span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux121</span><span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>macros<span class="token operator">&gt;</span>
比如<span class="token class-name">Linux122</span>节点
 <span class="token generics"><span class="token punctuation">&lt;</span>macros<span class="token punctuation">&gt;</span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>shard<span class="token punctuation">&gt;</span></span><span class="token number">02</span><span class="token operator">&lt;</span><span class="token operator">/</span>shard<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>replica<span class="token punctuation">&gt;</span></span><span class="token class-name">Linux122</span><span class="token operator">&lt;</span><span class="token operator">/</span>replica<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>macros<span class="token operator">&gt;</span>
其他类似
</code></pre> 
<p><strong>配置后不需要重启server</strong><br> 通过查询系统表可以看出当前节点分片信息</p> 
<pre><code class="prism language-java"><span class="token class-name">Linux122</span> <span class="token operator">:</span><span class="token punctuation">)</span> select <span class="token operator">*</span> from system<span class="token punctuation">.</span>macros<span class="token punctuation">;</span>

SELECT <span class="token operator">*</span>
FROM system<span class="token punctuation">.</span>macros

<span class="token class-name">Query</span> id<span class="token operator">:</span> <span class="token number">91d</span><span class="token number">1e00</span>c<span class="token operator">-</span>f915<span class="token operator">-</span><span class="token number">4003</span><span class="token operator">-</span><span class="token number">81</span>bc<span class="token operator">-</span><span class="token number">3</span>cfe52db734f

<span class="token class-name">Connecting</span> <span class="token keyword">to</span> <span class="token namespace">localhost</span><span class="token operator">:</span><span class="token number">9000</span> as user <span class="token class-name"><span class="token namespace">default<span class="token punctuation">.</span></span>
Connected</span> <span class="token keyword">to</span> <span class="token class-name">ClickHouse</span> server version <span class="token number">22.3</span><span class="token number">.3</span> revision <span class="token number">54455.</span>

┌─macro───┬─substitution─┐
│ replica │ <span class="token class-name">Linux122</span>     │
│ shard   │ <span class="token number">02</span>           │
└─────────┴──────────────┘

<span class="token number">2</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.166</span> <span class="token class-name"><span class="token namespace">sec<span class="token punctuation">.</span></span> 

Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> select <span class="token operator">*</span> from system<span class="token punctuation">.</span>macros<span class="token punctuation">;</span>

SELECT <span class="token operator">*</span>
FROM system<span class="token punctuation">.</span>macros

<span class="token class-name">Query</span> id<span class="token operator">:</span> <span class="token number">10</span>b1a06f<span class="token operator">-</span><span class="token number">73f</span>a<span class="token operator">-</span><span class="token number">4</span>ac2<span class="token operator">-</span><span class="token number">9</span>b27<span class="token operator">-</span><span class="token number">8797f</span>d0fee5b

┌─macro───┬─substitution─┐
│ replica │ <span class="token class-name">Linux121</span>     │
│ shard   │ <span class="token number">01</span>           │
└─────────┴──────────────┘

<span class="token number">2</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.069</span> sec<span class="token punctuation">.</span> 
</code></pre> 
<p>另一种查询方式</p> 
<pre><code class="prism language-java"><span class="token class-name">Linux122</span> <span class="token operator">:</span><span class="token punctuation">)</span> select <span class="token operator">*</span> from <span class="token function">remote</span><span class="token punctuation">(</span>'<span class="token class-name">Linux122</span><span class="token operator">:</span><span class="token number">9000</span><span class="token char">','</span>system<span class="token char">','</span>macros<span class="token char">','</span><span class="token keyword">default</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>

SELECT <span class="token operator">*</span>
<span class="token class-name">FROM</span> <span class="token function">remote</span><span class="token punctuation">(</span>'<span class="token class-name">Linux122</span><span class="token operator">:</span><span class="token number">9000</span><span class="token char">', '</span>system<span class="token char">', '</span>macros<span class="token char">', '</span><span class="token keyword">default</span>'<span class="token punctuation">)</span>

<span class="token class-name">Query</span> id<span class="token operator">:</span> <span class="token number">0895f</span><span class="token number">290</span><span class="token operator">-</span>a21c<span class="token operator">-</span><span class="token number">4193</span><span class="token operator">-</span><span class="token number">8</span>c97<span class="token operator">-</span><span class="token number">943606f</span><span class="token number">9</span>b6a7

┌─macro───┬─substitution─┐
│ replica │ <span class="token class-name">Linux122</span>     │
│ shard   │ <span class="token number">02</span>           │
└─────────┴──────────────┘

<span class="token number">2</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.624</span> sec<span class="token punctuation">.</span> 
</code></pre> 
<p><strong>创建分布式表案例</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">Linux121</span> <span class="token operator">:</span><span class="token punctuation">)</span> create table clustertable on cluster perftest_3shards_1replicas <span class="token punctuation">(</span>id <span class="token class-name">UInt32</span><span class="token punctuation">)</span> engine<span class="token operator">=</span><span class="token class-name">ReplicatedMergeTree</span><span class="token punctuation">(</span>'<span class="token operator">/</span>clickhouse<span class="token operator">/</span>tables<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>shard<span class="token punctuation">}</span><span class="token operator">/</span>clustertable<span class="token char">','</span><span class="token punctuation">{<!-- --></span>replica<span class="token punctuation">}</span>'<span class="token punctuation">)</span> order by id<span class="token punctuation">;</span>

CREATE TABLE clustertable ON <span class="token class-name">CLUSTER</span> perftest_3shards_1replicas
<span class="token punctuation">(</span>
    `id` <span class="token class-name">UInt32</span>
<span class="token punctuation">)</span>
ENGINE <span class="token operator">=</span> <span class="token class-name">ReplicatedMergeTree</span><span class="token punctuation">(</span>'<span class="token operator">/</span>clickhouse<span class="token operator">/</span>tables<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>shard<span class="token punctuation">}</span><span class="token operator">/</span>clustertable<span class="token char">', '</span><span class="token punctuation">{<!-- --></span>replica<span class="token punctuation">}</span>'<span class="token punctuation">)</span>
ORDER BY id

<span class="token class-name">Query</span> id<span class="token operator">:</span> bc24c0c7<span class="token operator">-</span><span class="token number">2f</span><span class="token number">24</span><span class="token operator">-</span><span class="token number">472</span>c<span class="token operator">-</span>a82b<span class="token operator">-</span><span class="token number">99f</span>f1e2ca7b5

┌─host─────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ <span class="token class-name">Linux123</span> │ <span class="token number">9000</span> │      <span class="token number">0</span> │       │                   <span class="token number">2</span> │                <span class="token number">0</span> │
│ <span class="token class-name">Linux121</span> │ <span class="token number">9000</span> │      <span class="token number">0</span> │       │                   <span class="token number">1</span> │                <span class="token number">0</span> │
│ <span class="token class-name">Linux122</span> │ <span class="token number">9000</span> │      <span class="token number">0</span> │       │                   <span class="token number">0</span> │                <span class="token number">0</span> │
└──────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

<span class="token number">3</span> rows in <span class="token class-name"><span class="token namespace">set<span class="token punctuation">.</span></span> Elapsed</span><span class="token operator">:</span> <span class="token number">0.563</span> sec<span class="token punctuation">.</span> 
</code></pre> 
<p>我们发现在每个节点对应数据库下有同样表被创建</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/81922b894984da735dbe1631b8d9d188/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">树形结构和普通list数据的互换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80f0526b5b6af0cdb16d5a6fc119b8d9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NCCL error in: /pytorch/torch/lib/c10d/ProcessGroupNCCL ,unhandled cuda error, NCCLversion 2.7.8</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>