<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MCU】用stm32的UID给固件加密(重点在加密) - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/cf35c672754fd84419c07153608792d4/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="【MCU】用stm32的UID给固件加密(重点在加密)">
  <meta property="og:description" content="1、聊一聊
演员这首歌大家应该再熟悉不过了，其中印象最为深刻的歌词是:&#34;简单点，说话的方式简单点......&#34;,说话真的是一门技术，同时也是门艺术！
今天跟大家带来的知识不算难，现在非常多MCU都有全球唯一标识码这个东西，可能大家都了解过，不过具体怎么用并没有实际设计过！下面重点对其加密方面的应用跟大家理一理。
2、stm32的标识码UID
对于目前大部分MCU都会存在一个唯一标识码供用户使用，同样stm32也是一样，通过查找对应的数据手册便可以得到该唯一标识码的具体信息。
这里以stm32F103为例，其他型号的stm32性能也可能不存在该唯一标识，具体需要根据对应的数据手册进行查阅，如果存在可能基地址稍有不同。如下图所示:
分析一下：
1 ) stm32的标识码放在了唯一设备ID寄存器里面，一共96个bit也就是12个字节且只能读取。
2 ) 通过手册上的说明可以大致了解到该唯一标识码的应用场景。
3）一般的量产产品都会有一个设备的条码，那么这个唯一的标识码便可以作为条码的一部分来供查找。
4 ) 在通信协议中该唯一标识码可以作为一种标识序列号来进行设备的加载和区分。
5 ) 当然最后就是把其作为一个安全密钥，然后与软件加密算法结合起来以降低固件被恶意复制的风险。
2、读取UID
对于该唯一标识ID，bug菌这里谈两点注意的:
1、唯一标识ID只是stm32里面一种ID，其实一款芯片内部还有很多其他ID，比如设备ID和其他内部组件的ID等；
2、UID一共是96位具有唯一性，而截取中间的几位不一定具有唯一性。
3、对于UID的读取非常简单，上面的手册截图也说明了，可以通过字节、半字和字来进行读取，也就是说可以用8位、16位、32位来读取。
参考Demo：
1uint32_t Unique[3] = {0}; 2uint8_t unique[12] = {0}; 3 4 int main(void) 5 { 6 uint8_t i; 7 8 Unique[0] = *(uint32_t*)(0x1FFFF7E8); 9 Unique[1] = *(uint32_t*)(0x1FFFF7E8 &#43; 4); 10 Unique[2] = *(uint32_t*)(0x1FFFF7E8 &#43; 8); 11 12 printf(&#34;以uint32_t读:\r\n&#34;);//插入换行 13 printf(&#34;ID 0-31 :%x\r\n&#34;,Unique[0]);//插入换行 14 printf(&#34;ID 32-63 :%x\r\n&#34;">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-09-14T22:43:00+08:00">
    <meta property="article:modified_time" content="2020-09-14T22:43:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MCU】用stm32的UID给固件加密(重点在加密)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/0f/2a/g20GXIIj_o.png"></p> 
 <p><strong>1、聊一聊</strong></p> 
 <p>    演员这首歌大家应该再熟悉不过了，其中印象最为深刻的歌词是:"简单点，说话的方式简单点......",说话真的是一门技术，同时也是门艺术！</p> 
 <p>    今天跟大家带来的知识不算难，现在非常多MCU都有全球唯一标识码这个东西，可能大家都了解过，不过具体怎么用并没有实际设计过！下面重点对其加密方面的应用跟大家理一理。</p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/58/48/iyYJEAdW_o.png"></p> 
 <p><strong>2、stm32的标识码UID</strong></p> 
 <p>    对于目前大部分MCU都会存在一个唯一标识码供用户使用，同样stm32也是一样，通过查找对应的数据手册便可以得到该唯一标识码的具体信息。</p> 
 <p>    这里以stm32F103为例，<strong>其他型号的stm32性能也可能不存在该唯一标识</strong>，具体需要根据对应的数据手册进行查阅，如果存在可能基地址稍有不同。如下图所示:</p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/88/fe/bY5DmgWe_o.png"></p> 
 <blockquote> 
  <p><strong>分析一下：</strong></p> 
 </blockquote> 
 <ul><li><p>1 ) stm32的标识码放在了唯一设备ID寄存器里面，一共96个bit也就是12个字节且只能读取。</p></li><li><p>2 ) 通过手册上的说明可以大致了解到该唯一标识码的应用场景。</p></li><li><p>3）一般的量产产品都会有一个设备的条码，那么这个唯一的标识码便可以作为条码的一部分来供查找。</p></li><li><p>4 ) 在通信协议中该唯一标识码可以作为一种标识序列号来进行设备的加载和区分。</p></li><li><p>5 ) 当然最后就是把其作为一个安全密钥，然后与软件加密算法结合起来以降低固件被恶意复制的风险。</p></li></ul> 
 <p><strong>2、读取UID</strong></p> 
 <p>    对于该唯一标识ID，bug菌这里谈两点注意的:</p> 
 <p>    1、唯一标识ID只是stm32里面一种ID，其实一款芯片内部还有很多其他ID，比如设备ID和其他内部组件的ID等；</p> 
 <p>     2、UID一共是96位具有唯一性，而截取中间的几位不一定具有唯一性。</p> 
 <p>     3、对于UID的读取非常简单，上面的手册截图也说明了，可以通过字节、半字和字来进行读取，也就是说可以用8位、16位、32位来读取。</p> 
 <blockquote> 
  <p><strong>参考Demo：</strong></p> 
 </blockquote> 
 <pre class="has"><code class="language-go"> 1uint32_t  Unique[3] = {0};
 2uint8_t   unique[12] = {0};
 3
 4 int main(void)
 5 {        
 6     uint8_t i;
 7
 8     Unique[0] = *(uint32_t*)(0x1FFFF7E8);
 9     Unique[1] = *(uint32_t*)(0x1FFFF7E8 + 4);
10     Unique[2] = *(uint32_t*)(0x1FFFF7E8 + 8);
11
12     printf("以uint32_t读:\r\n");//插入换行
13     printf("ID  0-31 :%x\r\n",Unique[0]);//插入换行
14     printf("ID 32-63 :%x\r\n",Unique[1]);//插入换行
15     printf("ID 64-95 :%x\r\n",Unique[2]);//插入换行
16
17     for(i = 0 ;i &lt; 12;i++)
18     {
19         unique[i] = *(uint8_t*)(0x1FFFF7E8 + i);
20     }
21
22     printf("以uint8_t读:\r\n");//插入换行
23
24     for(i = 0;i&lt;12;i++)
25     { 
26         printf("ID byte%d :%x   ",i,unique[i]);//插入换行
27         if(i%4 == 3) printf("\r\n");//插入换行 
28     }
29
30     printf("\r\n公众号:最后一个bug\r\n");//插入换行</code></pre> 
 <blockquote> 
  <p><strong>输出结果：</strong></p> 
 </blockquote> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/8a/ac/nnLSsYyy_o.png"></p> 
 <p><strong>3、UID加密简易版</strong></p> 
 <p>    之前bug菌整理过一篇单片机解密的文章&lt;<a href="http://mp.weixin.qq.com/s?__biz=MzAwNjYwMjYyOA%3D%3D&amp;chksm=9b0ba25fac7c2b495c514d57c3a7ae1f1adf116c37c592038a4b1851352e2729d3c3483bb1f3&amp;idx=1&amp;mid=2247485620&amp;scene=21&amp;sn=e09b580885837450a6d2a5002c3caafd#wechat_redirect" rel="nofollow">【整理】一文带你了解"单片机解密"技术</a>&gt;，对于解密的办法可以说是无比的残忍，其实芯片的加密与解密跟网络安全的攻防是一样的。</p> 
 <p>    所谓:"道高一尺魔高一丈"，只有不断的更新加密技术以增加解密成本或许在一定程度上能够遏制不正规解密行为在，下面就先介绍一下UID的一种简易加密方案，为什么说简易呢？可以说修改部分固件实现一个跳转功能就解密了，不过对于一般的小型产品还是能够在一定程度上起到保密效果的。</p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/24/5c/TpMPWYxe_o.png"></p> 
 <blockquote> 
  <p><strong>解释两句：</strong></p> 
 </blockquote> 
 <ul><li><p>1 )左边是在芯片外部实现的，可以通过编写一个上位机来自动生成密钥并保存到芯片中的存储介质中。</p></li><li><p>2 )上面所说的UID与密钥的<strong>隐式获取</strong>是指 : 其读取过程中的地址等信息不要显式的暴露在固件中，比如上面提到的UID的地址或许是密钥的地址，可以通过数据变换、运算等等进行隐藏。</p></li><li><p>3 )最后一步如果密钥不一致进行自动清除固件，该思想有点类似于我们平时密码输入，如果输入次数较多就会锁定无法解锁，这样对解密过程造成阻碍。</p></li></ul> 
 <p><strong>4、加强版本</strong></p> 
 <p>    对于上面的加密方法其关卡点就一个位置，如果在固件空白区域安插一些跳转指令跳转到正常运行的位置，你的固件就解密了。</p> 
 <p>    所以目前比较常用的是对<strong>整个固件进行完整性标识序列与UID组合</strong>进行加密的办法。</p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/49/b2/TthMtyZV_o.png"></p> 
 <p style="text-align: center"><img src="https://images2.imgbox.com/eb/a8/kDc1dAKg_o.png"></p> 
 <p>     所以对于未使用的<strong>存储区域最好是都填充完</strong>，避免被解密者利用。</p> 
 <p><strong>4、另类版本</strong></p> 
 <p>     出于关卡点过于单一的问题考虑，我们需要进行<strong>多处的关卡点处理</strong>，同样各个关卡点的复杂度也会给解密者带来困难，每一处关卡点都带有解密信息，相当于每次都会需要判断机密，从而让跳转这种办法失效。</p> 
 <p>     最简单的处理办法就是定义一些宏处理，比如:</p> 
 <pre class="has"><code class="language-go">1#define Sect_TURE  (UIDCODE - SAVECODE  + 1)
2#define Sect_FALSE (UIDCODE - SAVECODE)
3
4#define Sect_NUM_1 (UIDCODE - SAVECODE  + 1)
5#define Sect_NUM_2 (UIDCODE - SAVECODE  + 2)
6......
</code></pre> 
 <p><br>    当然不仅仅只有上面的处理，我们还可以<strong>通过替换为其他变量来隐藏一些处理办法</strong>，从而达到迷惑解密着的目的。这样我们就可以把加密分布到程序的各个角落，加强了固件的安全性。</p> 
 <p>    不过这样的办法如果放在访问较为频繁的位置，势必会影响系统的性能，如果所使用的芯片性能一般，可以选择部分关键关卡点处理。</p> 
 <p>    好吧，所以一切安全的前提是唯一标识码UID无法被修改，否则也是徒劳，不过既然芯片都是人造的，那肯定就有办法进行解密，只是成本问题。</p> 
 <p><strong>5、最后小结</strong><br></p> 
 <p>     本文到这里就结束了，对于MCU的加密和解密是一个永恒的话题，同样对于一个成熟的产品加密也是必须要考虑的技术问题，看看大家还有什么好的MCU加密办法，欢迎大家分享留言讨论！</p> 
 <p>    好了，这里是公众号:<strong>“最后一个bug”</strong>，一个为大家打造的技术知识提升基地。</p> 
 <p>推荐好文  点击蓝色字体即可跳转<br></p> 
 <p style="text-align: left">☞<a href="http://mp.weixin.qq.com/s?__biz=MzAwNjYwMjYyOA%3D%3D&amp;chksm=9b0ba2f0ac7c2be6596c0942591c2a23b8e0337baf6fa6c4ed941587c267ade3c5948381206b&amp;idx=1&amp;mid=2247485467&amp;scene=21&amp;sn=892e0d95133ba378bee39a71218c6781#wechat_redirect" rel="nofollow">【收藏】</a><a href="http://mp.weixin.qq.com/s?__biz=MzAwNjYwMjYyOA%3D%3D&amp;chksm=9b0ba3c2ac7c2ad4a6cee95174a9c4ee57e3bfddf66223b22b872d27fbdddacdbb9561ad4389&amp;idx=1&amp;mid=2247485737&amp;scene=21&amp;sn=60afaea8f8bfec9799a8f66c9b2570e9#wechat_redirect" rel="nofollow">【看门狗软件设计】"喂狗"真那么简单吗?</a><img src="https://images2.imgbox.com/6e/76/kKESPjUX_o.png"></p> 
 <p style="text-align: left">☞<a href="http://mp.weixin.qq.com/s?__biz=MzAwNjYwMjYyOA%3D%3D&amp;chksm=9b0ba3a6ac7c2ab0a57780523455f23eab5df7e86d23a100dd9e7897b87867fa95f4671c27e1&amp;idx=1&amp;mid=2247485773&amp;scene=21&amp;sn=780096a68931e2b875ada18ae3ab34ef#wechat_redirect" rel="nofollow">【经验】bug菌谈单片机编程"十层功力"，你练到了第几层？</a><img src="https://images2.imgbox.com/9a/2b/sGBL1LV2_o.png"></p> 
 <p style="text-align: left">☞<a href="http://mp.weixin.qq.com/s?__biz=MzAwNjYwMjYyOA%3D%3D&amp;chksm=9b0ba392ac7c2a849e2c6c01bbbd97e8ece7c554c1cb0a147945ee003c7f5f01e38fb73d3472&amp;idx=2&amp;mid=2247485817&amp;scene=21&amp;sn=a1d996fcb39c29dd5dbeca3e63b8c390#wechat_redirect" rel="nofollow">【C进阶】一不小心就被"strlen"给坑了!</a></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d027945852f1f29271117c169fb1401f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">kubectl  log 报 connection refused 记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/437738ba68c0f78101b822b3421fa11e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于springboot的websocket服务端和客户端demo（简单易上手）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>