<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>BerkeleyDB同名key值（Duplicate Key）的使用 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/55a7c3f3bd5c887d8a2bedd175fbc029/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="BerkeleyDB同名key值（Duplicate Key）的使用">
  <meta property="og:description" content="首先，我们要知道一个概念：duplicate keys,也就是说：在同一个库中多条记录共享一个key。在建库的过程中，如果存在多条同名的记录对应不同data时，就要用到这个东东了。例如某公司职工数据库里，以员工的名字作为记录的key，同时有好几个名叫Jackey的员工，这时就要用到同名key值的概念了。 注意：duplicate keys只能在二进制树以及hash表格式的库中。 启用duplicates应该在建立数据库的时候用DB-&amp;gt;set_flags()来设置。有DB_DUP及DB_DUPSORT两种标志。前者不 使数据库duplicate keys自动排列,而后者利用DB-&amp;gt;set_dup_compare()指定排列函数后，支持自动排列功能，该排列函数的格式为： int (*function)(DB *db, const DBT *key1, const DBT *key2); ` 看一个代码片段： DB *dbp; DBC *cursor; DBT key, data; db_create(&amp;amp;dbp, NULL, 0); dbp-&amp;gt;set_flags(dbp, DB_DUP);//或者DB_DUPSORT dbp-&amp;gt;open(dbp, NULL, file_name, NULL, DB_BTREE, DB_CREATE, 0); 这样，新键的数据库就有对duplicate keys的支持。 支持duplicate key的库的写入与一般的库没有什么区别，用DB-&amp;gt;put写入时，记录会被排在库的最后； dbp-&amp;gt;put(dbp, NULL, &amp;amp;key, &amp;amp;value, 0);//flag不可为DB_NOOVERWRITE 当用DBC-&amp;gt;put()写入时，可以用到下面几个用于加入duplicate记录的标志宏： DB_BEFORE；DB_AFTER //当前加入记录的key与游标当前指向的记录的key一致。直接将该记录作为duplicate记录加到当前记录的前\后面。当库的标志为DB_DUPSORT时，该标志无用。 DB_KEYFIRST;DB_KEYLAST //如果该记录的key值在库中已经存在，且库的定义为DB_DUP(即不自动分类)时,该记录被加到所属key的duplicate列表的最前\后面。 需要说明的是，带duplicate keys支持的库，当你用普通的DB-&amp;gt;get()来读取记录的时候，取得的是指定key值对应的第一个data，要取得后面一些data的时候，需要用到游标DBC-&amp;gt;c_get。请看下面的代码片段： DB *dbp; DBC *cursor; DBT key, data; db_create(&amp;amp;dbp, NULL, 0); dbp-&amp;gt;open(dbp, NULL, file_one, NULL, DB_HASH, DB_CREATE, 0); dbp-&amp;gt;cursor(dbp, NULL, &amp;amp;cursor, 0); /***对key与value进行初始化空间***/ cursor-&amp;gt;c_get(cursor, &amp;amp;key, &amp;amp;value, DB_SET); //游标指到第一个符合key值的记录。 cursor-&amp;gt;c_get(cursorp, &amp;amp;key, &amp;amp;data, DB_NEXT_DUP); //查找下一个该key对应的记录。 这里有几个c_get常用的flag: DB_SET; //游标指向第一个符合key的记录。 DB_SET_RANGE; //支持模糊查找，游标指向第一个大于等于key值的value DB_NEXT; DB_PREV; //下\上一条记录（将duplicate记录也作为记录看待） DB_GET_BOTH；//前者游标指向key、value值都匹配的记录； DB_GET_BOTH_RANGE; //后者支持模糊查找，游标指向与key、value值最接近的第一条记录。 DB_NEXT_NODUP; DB_PREV_NODUP; //下\上一条记录（将duplicate排除在外） DB_NEXT_DUP；//下一条duplicate记录。 删除duplicate key记录: 当你用普通的DB-&amp;gt;del()来删除某条记录的时候,如果该库是带duplicate key支持的,并且你在函数中指定的key值又恰好对应着多个data(即duplicate组),那么你这个操作将把这个duplicate组中所有记录全部删除.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2014-03-06T09:43:20+08:00">
    <meta property="article:modified_time" content="2014-03-06T09:43:20+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">BerkeleyDB同名key值（Duplicate Key）的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="content-head clearfix"> 
 <h3 class="title content-title"><br> </h3> 
</div> 
<div id="content" class="content mod-cs-content text-content clearfix">
      首先，我们要知道一个概念：duplicate keys,也就是说：在同一个库中多条记录共享一个key。在建库的过程中，如果存在多条同名的记录对应不同data时，就要用到这个东东了。例如某公司职工数据库里，以员工的名字作为记录的key，同时有好几个名叫Jackey的员工，这时就要用到同名key值的概念了。 
 <br>    注意：duplicate keys只能在二进制树以及hash表格式的库中。 
 <br>    启用duplicates应该在建立数据库的时候用DB-&gt;set_flags()来设置。有DB_DUP及DB_DUPSORT两种标志。前者不 使数据库duplicate keys自动排列,而后者利用DB-&gt;set_dup_compare()指定排列函数后，支持自动排列功能，该排列函数的格式为：        int (*function)(DB *db, const DBT *key1, const DBT *key2); ` 
 <br>    看一个代码片段： 
 <br>    DB *dbp; 
 <br>    DBC *cursor; 
 <br>    DBT key, data; 
 <br> 
 <br>    db_create(&amp;dbp, NULL, 0); 
 <br>    dbp-&gt;set_flags(dbp, DB_DUP);//或者DB_DUPSORT 
 <br>    dbp-&gt;open(dbp, NULL, file_name, NULL, DB_BTREE, DB_CREATE, 0);        
 <br>    这样，新键的数据库就有对duplicate keys的支持。 
 <br> 
 <br>    支持duplicate key的库的写入与一般的库没有什么区别，用DB-&gt;put写入时，记录会被排在库的最后； 
 <br>    dbp-&gt;put(dbp, NULL, &amp;key, &amp;value, 0);//flag不可为DB_NOOVERWRITE 
 <br>    当用DBC-&gt;put()写入时，可以用到下面几个用于加入duplicate记录的标志宏： 
 <br>    DB_BEFORE；DB_AFTER //当前加入记录的key与游标当前指向的记录的key一致。直接将该记录作为duplicate记录加到当前记录的前\后面。当库的标志为DB_DUPSORT时，该标志无用。 
 <br>    DB_KEYFIRST;DB_KEYLAST //如果该记录的key值在库中已经存在，且库的定义为DB_DUP(即不自动分类)时,该记录被加到所属key的duplicate列表的最前\后面。 
 <br>        
 <br>    需要说明的是，带duplicate keys支持的库，当你用普通的DB-&gt;get()来读取记录的时候，取得的是指定key值对应的第一个data，要取得后面一些data的时候，需要用到游标DBC-&gt;c_get。请看下面的代码片段： 
 <br>    DB *dbp; 
 <br>    DBC *cursor; 
 <br>    DBT key, data; 
 <br> 
 <br>    db_create(&amp;dbp, NULL, 0); 
 <br>    dbp-&gt;open(dbp, NULL, file_one, NULL, DB_HASH, DB_CREATE, 0); 
 <br>    dbp-&gt;cursor(dbp, NULL, &amp;cursor, 0); 
 <br>    /***对key与value进行初始化空间***/    
 <br>    cursor-&gt;c_get(cursor, &amp;key, &amp;value, DB_SET);   //游标指到第一个符合key值的记录。 
 <br>    cursor-&gt;c_get(cursorp, &amp;key, &amp;data, DB_NEXT_DUP); //查找下一个该key对应的记录。 
 <br>    这里有几个c_get常用的flag: 
 <br>    DB_SET; //游标指向第一个符合key的记录。 
 <br>    DB_SET_RANGE; //支持模糊查找，游标指向第一个大于等于key值的value 
 <br>    DB_NEXT; DB_PREV; //下\上一条记录（将duplicate记录也作为记录看待） 
 <br>    DB_GET_BOTH；//前者游标指向key、value值都匹配的记录； 
 <br>    DB_GET_BOTH_RANGE; //后者支持模糊查找，游标指向与key、value值最接近的第一条记录。 
 <br>    DB_NEXT_NODUP; DB_PREV_NODUP; //下\上一条记录（将duplicate排除在外） 
 <br>    DB_NEXT_DUP；//下一条duplicate记录。 
 <br> 
 <br>    删除duplicate key记录: 
 <br>    当你用普通的DB-&gt;del()来删除某条记录的时候,如果该库是带duplicate key支持的,并且你在函数中指定的key值又恰好对应着多个data(即duplicate组),那么你这个操作将把这个duplicate组中所有记录全部删除. 
 <br>    如果这种结果不是你真正想要的,那为了避免这种情况,你必须使用游标的方法才能指向该key值对应的duplicate组中的其它记录,然后进行删除.e.g: 
 <br>    DBC *cursor; 
 <br>    DB *dbp; 
 <br>    DBT *key, *value; 
 <br> 
 <br>    /*****打开\设置库语句省略号*******/ 
 <br>    dbp-&gt;set_flags(dbp, DB_DUP); 
 <br>    key.data = “xxx”; 
 <br>    key.size = strlen(“xxx”); 
 <br>    value.data = “yyy”; 
 <br>    value.size = strlen(“yyy”); 
 <br> 
 <br>    cursor-&gt;c_get(cursor, &amp;key, &amp;value, DB_GET_BOTH); 
 <br>    cursor-&gt;c_del(cursor, 0); 
 <br>       
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5cfaedcccaaa1ad1ee2aef0c876cc01f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[转]session listener的配置和使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0a4f75ac24d748e6612719ec8ff4f97b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SplitContainer容器控件左右Panel大小调整</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>