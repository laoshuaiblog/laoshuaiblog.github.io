<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>长安链Docker Java智能合约引擎的架构、应用与规划 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/9e3ceccf8832ef4417ed17672eb99aa4/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="长安链Docker Java智能合约引擎的架构、应用与规划">
  <meta property="og:description" content="#功能发布
长安链3.0正式版发布了多个重点功能，包括共识算法切换、支持java智能合约引擎、支持后量子密码、web3生态兼容等。我们接下来为大家详细介绍新功能的设计、应用与规划。
在《2022年度长安链开源社区开发者调研报告》中，对Java合约语言支持是开发者更为普遍的需求；《2023年中国开发者调研报告》显示，熟悉Java语言的开发者占到40%以上，尤其在传统行业应用中为应对使用区块链技术进行数字化转型的需求，支持java语言合约将使区块链技术更快的渗透到各行各业。
Docker Go上线以来，因其良好的可移植性，可扩展性和安全性获得较多使用，更因其支持使用原生的Go语言编写合约，有更好的易用性。
在企业客户的使用中Java语言的使用更为广泛，因此在长安链v3.0.0正式版中新增Docker Java合约引擎，支持使用原生Java语言编写合约。
1. 整体架构 Docker Java合约引擎的设计复用了Docker Go的架构。依然是采用抢占式任务调度和多个合约进程并发，单个合约进程串行执行交易的形式运行。更详细的设计可以参考长安链 VM Engine架构设计深度解读。
Docker Java 和 Docker Go 合约引擎互不冲突，可以同时启用。部署和连接方式如下图所示：
2. 编写Java合约 2.1 版本和工具 当前合约执行环境为JDK 11，推荐使用JDK 11编写合约；推荐使用 IDEA 或 Vscode等IDE编写和编译Java合约。
2.2 引用合约sdk 2.2.1 添加依赖包 在gradle项目中使用SDK 在build.gradle 中添加dependencies：
implementation group:&#39;org.chainmaker&#39;, name:&#39;contracts-sdk-java&#39;, version:&#39;1.0&#39;
在Maven项目中使用SDK 在pom.xml 中添加dependencies：
&amp;lt;dependency&amp;gt;
&amp;lt;groupId&amp;gt;org.chainmaker&amp;lt;/groupId&amp;gt;
&amp;lt;artifactId&amp;gt;contracts-sdk-java&amp;lt;/artifactId&amp;gt;
&amp;lt;version&amp;gt;1.0&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
2.2.2 本地编译包 将项目引入到本地并编译安装到本地maven库：
git clone -b v3.0.0 https://git.chainmaker.org.cn/chainmaker/contract-sdk-java.git
cd contract-sdk-javamvn clean install &#39;-Dmaven.test.skip=true&#39;
然后通过添加依赖包引入到合约开发项目。
2.3 合约编写规则 2.3.1 合约必须实现接口 IContract 合约必须需要实现合约初始化方法（initContract） 和合约升级方法（upgradeContract）。">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-19T09:29:27+08:00">
    <meta property="article:modified_time" content="2024-03-19T09:29:27+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">长安链Docker Java智能合约引擎的架构、应用与规划</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>#功能发布</strong></p> 
<p></p> 
<p></p> 
<p>长安链3.0正式版发布了多个重点功能，包括共识算法切换、支持java智能合约引擎、支持后量子密码、web3生态兼容等。我们接下来为大家详细介绍新功能的设计、应用与规划。</p> 
<p></p> 
<p></p> 
<p>在《2022年度长安链开源社区开发者调研报告》中，对Java合约语言支持是开发者更为普遍的需求；《2023年中国开发者调研报告》显示，熟悉Java语言的开发者占到40%以上，尤其在传统行业应用中为应对使用区块链技术进行数字化转型的需求，支持java语言合约将使区块链技术更快的渗透到各行各业。</p> 
<p>Docker Go上线以来，因其良好的可移植性，可扩展性和安全性获得较多使用，更因其支持使用原生的Go语言编写合约，有更好的易用性。</p> 
<p>在企业客户的使用中Java语言的使用更为广泛，因此在长安链v3.0.0正式版中新增Docker Java合约引擎，支持使用原生Java语言编写合约。</p> 
<h2> 1. 整体架构 </h2> 
<p>Docker Java合约引擎的设计复用了Docker Go的架构。依然是采用抢占式任务调度和多个合约进程并发，单个合约进程串行执行交易的形式运行。更详细的设计可以参考<a href="https://mp.weixin.qq.com/s?__biz=Mzg4NzU2NjYwMA==&amp;mid=2247486987&amp;idx=1&amp;sn=0cc36699bfff8b2ca284d308614e23df&amp;scene=21#wechat_redirect" rel="nofollow" title="长安链 VM Engine架构设计深度解读。">长安链 VM Engine架构设计深度解读。</a></p> 
<p></p> 
<p>Docker Java 和 Docker Go 合约引擎互不冲突，可以同时启用。部署和连接方式如下图所示：</p> 
<p></p> 
<p class="img-center"><img alt="图片" height="576" src="https://images2.imgbox.com/f0/60/4T0kG2bs_o.png" width="733"></p> 
<h4></h4> 
<h2> 2. 编写Java合约 </h2> 
<h3>2.1 版本和工具</h3> 
<p>当前合约执行环境为JDK 11，推荐使用JDK 11编写合约；推荐使用 IDEA 或 Vscode等IDE编写和编译Java合约。</p> 
<h4></h4> 
<h3>2.2 引用合约sdk</h3> 
<h5>2.2.1 添加依赖包</h5> 
<h6>在gradle项目中使用SDK</h6> 
<p>在build.gradle 中添加dependencies：</p> 
<p>implementation group:'org.chainmaker', name:'contracts-sdk-java', version:'1.0'</p> 
<h6>在Maven项目中使用SDK</h6> 
<p>在pom.xml 中添加dependencies：</p> 
<p>&lt;dependency&gt;</p> 
<p>    &lt;groupId&gt;org.chainmaker&lt;/groupId&gt;</p> 
<p>    &lt;artifactId&gt;contracts-sdk-java&lt;/artifactId&gt;</p> 
<p>    &lt;version&gt;1.0&lt;/version&gt;</p> 
<p>&lt;/dependency&gt;</p> 
<h5>2.2.2 本地编译包</h5> 
<p>将项目引入到本地并编译安装到本地maven库：</p> 
<p>git clone -b v3.0.0 https://git.chainmaker.org.cn/chainmaker/contract-sdk-java.git</p> 
<p>cd contract-sdk-javamvn clean install  </p> 
<p>'-Dmaven.test.skip=true'</p> 
<p>然后通过添加依赖包引入到合约开发项目。</p> 
<h4></h4> 
<h3>2.3 合约编写规则 </h3> 
<h5>2.3.1 合约必须实现接口 IContract</h5> 
<p>合约必须需要实现合约初始化方法（initContract） 和合约升级方法（upgradeContract）。</p> 
<p>IContract 中定义了默认的 initContract 和 upgradeContract 的接口。默认这两个接口只返回成功的message。</p> 
<p>合约可以根据需求自行实现这两个接口。</p> 
<h5>2.3.2 代码的执行入口</h5> 
<p>在合约类定义的main方法中，需要将合约实例作为参数传给sanbox.serve：</p> 
<p>publicclass fact implementsIContract{<!-- --></p> 
<p>    // ... </p> 
<p>   publicstaticvoidmain(String[] args){<!-- --></p> 
<p>        Sandbox.serve(args,newfact());</p> 
<p>    }</p> 
<p>}</p> 
<h5>2.3.3 定义合约方法</h5> 
<p>在合约类中定义合约方法，方法权限必须是public，返回值为Response，并且使用@ContractMethod注解标识。在链上调用中，指定的合约方法名与定义的方法名同名（区分大小写）：</p> 
<p> @ContractMethod</p> 
<p>    publicResponsesave()throwsIOException,</p> 
<p>ContractException{<!-- --></p> 
<p>SDK.putState("key1","field1", </p> 
<p>SDK.getParam("value"));</p> 
<p>        return SDK.success("store success");</p> 
<p>   }</p> 
<h5>2.3.4 获取合约的调用参数</h5> 
<p>（1）使用SDK.getArgs()获取参数map</p> 
<p>// 获取参数map</p> 
<p>Map&lt;String, ByteString&gt; args = SDK.getArgs();</p> 
<p>// 获取参数 key的值, 如果不存在则报错</p> 
<p>ByteString getKey = args.get("key");</p> 
<p>if(getKey ==null){<!-- --></p> 
<p>   return SDK.error("key not exist");</p> 
<p>}</p> 
<p>String key = getKey.toStringUtf8();</p> 
<p>// 获取参数 value 的值, 如果不存在使用空字符串</p> 
<p>ByteString getField = args.get("field");</p> 
<p>String field = getField ==null?"": getField.toStringUtf8();</p> 
<p>（2）使用SDK.getParam() 和 SDK.getParamBytes()</p> 
<p>注意：getParam 和 getParamBytes 不做null值的判断，假如参数值没有传递，则分别返回空字符串和空字节数组：</p> 
<p>String key = SDK.getParam("key");</p> 
<p>byte[] value = SDK.getParamBytes("value");</p> 
<h5>2.3.5 错误捕获</h5> 
<p>合约报错中ContractException中包含了正常逻辑的报错，主要包括参数的合法性检查（比如key 和field），和链上接口访问遇到的报错（比如访问的value不存在等）。因此在合约逻辑中，建议捕获ContractException，并在合约里做相应的处理。</p> 
<h3>2.4 合约编译</h3> 
<p>合约需要编译成可独立运行的jar包（包含运行所需的依赖，也叫fat jar 或uber jar）。由于包含了所有依赖，因此合约体积也较大，大概30MB左右。</p> 
<h5>2.4.1 gradle 打包方式</h5> 
<p>配置示例如下，执行./gradlew uberJar，默认生成的jar包在build/libs目录下，文件名以-uber.jar为结尾。</p> 
<p>&lt;plugin&gt;</p> 
<p>    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</p> 
<p>    &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</p> 
<p>    &lt;version&gt;3.4.0&lt;/version&gt;</p> 
<p>    &lt;executions&gt;</p> 
<p>        &lt;execution&gt;</p> 
<p>            &lt;phase&gt;package&lt;/phase&gt;</p> 
<p>            &lt;goals&gt;</p> 
<p>                &lt;goal&gt;shade&lt;/goal&gt;</p> 
<p>            &lt;/goals&gt;</p> 
<p>            &lt;configuration&gt;</p> 
<p>                &lt;filters&gt;</p> 
<p>                    &lt;filter&gt;</p> 
<p>                        &lt;artifact&gt;*:*&lt;/artifact&gt;</p> 
<p>                        &lt;excludes&gt;</p> 
<p>                            &lt;exclude&gt;META-INF/*.SF&lt;/exclude&gt;</p> 
<p>                            &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;</p> 
<p>                            &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;</p> 
<p>                        &lt;/excludes&gt;</p> 
<p>                    &lt;/filter&gt;</p> 
<p>                &lt;/filters&gt;</p> 
<p></p> 
<p>                &lt;transformers&gt;</p> 
<p>                    &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/&gt;</p> 
<p>                    &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;</p> 
<p>                        </p> 
<p>                      &lt;mainClass&gt;org.chainmaker.examples.demo&lt;/mainClass&gt;</p> 
<p>                    &lt;/transformer&gt;</p> 
<p>                &lt;/transformers&gt;</p> 
<p>            &lt;/configuration&gt;</p> 
<p>        &lt;/execution&gt;</p> 
<p>    &lt;/executions&gt;</p> 
<p>&lt;/plugin&gt;</p> 
<h5>2.4.2 maven 打包方式</h5> 
<p>使用maven-shade-plugin。配置示例如下。</p> 
<p>执行 mvn package，默认生成的jar包在target目录下：</p> 
<p>&lt;plugin&gt;</p> 
<p>    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</p> 
<p>    &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</p> 
<p>    &lt;version&gt;3.4.0&lt;/version&gt;</p> 
<p>    &lt;executions&gt;</p> 
<p>        &lt;execution&gt;</p> 
<p>            &lt;phase&gt;package&lt;/phase&gt;</p> 
<p>            &lt;goals&gt;</p> 
<p>                &lt;goal&gt;shade&lt;/goal&gt;</p> 
<p>            &lt;/goals&gt;</p> 
<p>            &lt;configuration&gt;</p> 
<p>                &lt;filters&gt;</p> 
<p>                    &lt;filter&gt;</p> 
<p>                        &lt;artifact&gt;*:*&lt;/artifact&gt;</p> 
<p>                        &lt;excludes&gt;</p> 
<p>                            &lt;exclude&gt;META-INF/*.SF&lt;/exclude&gt;</p> 
<p>                            &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;</p> 
<p>                            &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;</p> 
<p>                        &lt;/excludes&gt;</p> 
<p>                    &lt;/filter&gt;</p> 
<p>                &lt;/filters&gt;</p> 
<p>                &lt;transformers&gt; </p> 
<p>                  &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/&gt;</p> 
<p>                    &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;</p> 
<p>                        </p> 
<p>                      &lt;mainClass&gt;org.chainmaker.examples.demo&lt;/mainClass&gt;</p> 
<p>                    &lt;/transformer&gt;</p> 
<p>                &lt;/transformers&gt;</p> 
<p>            &lt;/configuration&gt;</p> 
<p>        &lt;/execution&gt;</p> 
<p>    &lt;/executions&gt;</p> 
<p>&lt;/plugin&gt;</p> 
<h3>示例合约 </h3> 
<p>示例合约可以直接查看仓库的样例contracts-sdk-java（链接地址：https://git.chainmaker.org.cn/chainmaker/contract-sdk-java/-/tree/v3.0.0/src/main/java/org/chainmaker/examples）。</p> 
<p>一个完整的简单存证合约可以如下：</p> 
<p>packageorg.chainmaker.examples;</p> 
<p>importcom.google.protobuf.ByteString;</p> 
<p>importorg.chainmaker.contracts.docker.java.pb.proto.Response;</p> 
<p>importorg.chainmaker.contracts.docker.java.sandbox.IContract;</p> 
<p>importorg.chainmaker.contracts.docker.java.sandbox.ContractException;</p> 
<p>importorg.chainmaker.contracts.docker.java.sandbox.SDK;</p> 
<p>importorg.chainmaker.contracts.docker.java.sandbox.Sandbox;</p> 
<p>importorg.chainmaker.contracts.docker.java.sandbox.annotaion.ContractMethod;</p> 
<p></p> 
<p>importjava.io.IOException;</p> 
<p></p> 
<p>// 实现智能合约接口 IContract</p> 
<p>publicclass fact implementsIContract{<!-- --></p> 
<p></p> 
<p>   // 使用@ContractMethod注解定义合约方法：save</p> 
<p>   @ContractMethod</p> 
<p>   publicResponsesave()throwsIOException,ContractException{<!-- --></p> 
<p>       // 获取参数：key</p> 
<p>       String key = SDK.getParam("key");</p> 
<p>       // 获取参数：value</p> 
<p>       byte[] value = SDK.getParamBytes("value");</p> 
<p></p> 
<p>       // 将键值对存储到链上</p> 
<p>        SDK.putState(key, value);</p> 
<p></p> 
<p>       // 返回成功信息</p> 
<p>       return SDK.success("store success");</p> 
<p>   }</p> 
<p></p> 
<p>   // 定义合约方法：get</p> 
<p>   @ContractMethod</p> 
<p>   publicResponseget()throwsIOException,InterruptedException,ContractException{<!-- --></p> 
<p>       // 获取参数：key</p> 
<p>       String key = SDK.getParam("key");</p> 
<p>       // 从链上获取对应的值并返回</p> 
<p>       return SDK.success(SDK.getState(key));</p> 
<p>   }</p> 
<p></p> 
<p>   // 主函数，启动智能合约</p> 
<p>   publicstaticvoidmain(String[] args){<!-- --></p> 
<p>       Sandbox.serve(args,newfact());</p> 
<p>   }</p> 
<p>}</p> 
<h4></h4> 
<h2> 接口支持 </h2> 
<p>目前提供了与Docker Go接口功能一致的所有接口。但是为了遵循Java语言的风格，与Docker Go接口略有不同：</p> 
<p>1. 支持函数重载，因此没有Go接口中略显冗余的GetState，GetStateByte，GetStateFromKey，GetStateFromKeyByte等接口，而是函数名统一使用getState。</p> 
<p>2. 2. 函数名首字母使用小写。</p> 
<p></p> 
<p>具体接口列表可以查看文档链接：https://docs.chainmaker.org.cn/v3.0.0/html/instructions/%E4%BD%BF%E7%94%A8Java%E8%BF%9B%E8%A1%8C%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91.html#id15</p> 
<h2> 下一步规划 </h2> 
<p>目前对于Docker Java下一步的主要规划是：</p> 
<p>1. 优化合约创建效率。因Docker Java的合约体积较大，未来会选择支持源码安装的合约创建方案，以降低创建合约对其他交易产生的性能影响；</p> 
<p>2. 优化Docker Java交易执行效率。因JVM的启动相对较慢，以进程方式做调度对Docker Java的交易执行效率影响较大。</p> 
<p>如果您对Docker Java有更多建议，欢迎提交issue或在社群联系我们。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cc36ca1d59aa1a3464dbe91b0e20e4ed/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">直播回顾 | 2024年长安链技术路线规划</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2483d86a997e08808052846327e78059/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">博思医疗行业电子票据管理系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>