<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Zipkin介绍与在SpringCloud alibaba中的使用 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/5b5d0ab548b356ff0a4fb8f604f2bf30/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Zipkin介绍与在SpringCloud alibaba中的使用">
  <meta property="og:description" content="Zipkin 在微服务（分布式系统）等多个服务组成的系统中，一个请求是跨多个服务处理的，这样就很难理解整个请求处理流程（可追溯性）。当故障和请求延迟因可追溯性降低而加剧时，这也使得更难找到哪个服务有问题。通过可视化服务间依赖和调用的系统称为分布式跟踪系统，它的作用就是帮助去解决此类问题。
介绍 官网地址：https://zipkin.io/
Zipkin是一个分布式跟踪系统，它能聚集来自各个异构系统的实时监控数据。类似的分布式跟踪系统还有其他比较成熟的实现，例如：Naver的Pinpoint、Apache的HTrace、阿里的鹰眼Tracing、京东的Hydra、新浪的Watchman，美团点评的CAT，skywalking等。
构成 Reporter Reporter 负责将日志从您的应用程序转发到 Zipkin 服务器，有三种主要的传输方式:HTTP、Kafka和Scribe。
Collector 跟踪数据到达Zipkin收集器守护进程后，Zipkin收集器将对其进行验证、存储和索引，以便进行查找。
Storage 负责存储的持久化，最初是为了在Cassandra上存储数据而构建的，因为Cassandra是灵活且可扩展的，并且在Twitter中被大量使用。=除了Cassandra，Zipkin原生支持ElasticSearch和MySQL。
API API 提供以各种方式从存储中提取数据的功能。
UI 它是一个 UI，可将存储在浏览器中的日志数据可视化。
部署与使用 docker docker run -d -p 9411:9411 openzipkin/zipkin Java(&amp;gt;1.8) curl -sSL https://zipkin.io/quickstart.sh | bash -s java -jar zipkin.jar 源码 # get the latest source git clone https://github.com/openzipkin/zipkin cd zipkin # Build the server and also make its dependencies ./mvnw -DskipTests --also-make -pl zipkin-server clean install # Run the server java -jar .">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-20T21:21:28+08:00">
    <meta property="article:modified_time" content="2023-04-20T21:21:28+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Zipkin介绍与在SpringCloud alibaba中的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Zipkin_1"></a>Zipkin</h2> 
<p>在微服务（分布式系统）等多个服务组成的系统中，一个请求是跨多个服务处理的，这样就很难理解整个请求处理流程（可追溯性）。当故障和请求延迟因可追溯性降低而加剧时，这也使得更难找到哪个服务有问题。通过可视化服务间依赖和调用的系统称为分布式跟踪系统，它的作用就是帮助去解决此类问题。</p> 
<h3><a id="_3"></a>介绍</h3> 
<p>官网地址：https://zipkin.io/<br> Zipkin是一个分布式跟踪系统，它能聚集来自各个异构系统的实时监控数据。类似的分布式跟踪系统还有其他比较成熟的实现，例如：Naver的Pinpoint、Apache的HTrace、阿里的鹰眼Tracing、京东的Hydra、新浪的Watchman，美团点评的CAT，skywalking等。</p> 
<h3><a id="_6"></a>构成</h3> 
<p><img src="https://images2.imgbox.com/db/e4/ihihiErS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Reporter_8"></a>Reporter</h4> 
<p>Reporter 负责将日志从您的应用程序转发到 Zipkin 服务器，有三种主要的传输方式:HTTP、Kafka和Scribe。</p> 
<h4><a id="Collector_10"></a>Collector</h4> 
<p>跟踪数据到达Zipkin收集器守护进程后，Zipkin收集器将对其进行验证、存储和索引，以便进行查找。</p> 
<h4><a id="Storage_12"></a>Storage</h4> 
<p>负责存储的持久化，最初是为了在Cassandra上存储数据而构建的，因为Cassandra是灵活且可扩展的，并且在Twitter中被大量使用。=除了Cassandra，Zipkin原生支持ElasticSearch和MySQL。</p> 
<h4><a id="API_14"></a>API</h4> 
<p>API 提供以各种方式从存储中提取数据的功能。</p> 
<h4><a id="UI_16"></a>UI</h4> 
<p>它是一个 UI，可将存储在浏览器中的日志数据可视化。</p> 
<h3><a id="_18"></a>部署与使用</h3> 
<h4><a id="docker_19"></a>docker</h4> 
<pre><code>docker run -d -p 9411:9411 openzipkin/zipkin
</code></pre> 
<h4><a id="Java18_23"></a>Java(&gt;1.8)</h4> 
<pre><code>curl -sSL https://zipkin.io/quickstart.sh | bash -s
java -jar zipkin.jar
</code></pre> 
<h4><a id="_28"></a>源码</h4> 
<pre><code># get the latest source
git clone https://github.com/openzipkin/zipkin
cd zipkin
# Build the server and also make its dependencies
./mvnw -DskipTests --also-make -pl zipkin-server clean install
# Run the server
java -jar ./zipkin-server/target/zipkin-server-*exec.jar
</code></pre> 
<p>启动后，访问 http://127.0.0.1:9411 可以看到效果：<br> <img src="https://images2.imgbox.com/35/7a/gVOCvHc1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_40"></a>项目演示</h3> 
<h4><a id="mysqlzipkin_42"></a>利用mysql启动zipkin</h4> 
<p>使用java -jar运行，zipkin默认会把信息存储到内存中，这样重启后就会丢失，这里我们利用mysql作为存储介质。<br> DDL如下：</p> 
<pre><code>
CREATE TABLE IF NOT EXISTS zipkin_spans (
  `trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT 'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit',
  `trace_id` BIGINT NOT NULL,
  `id` BIGINT NOT NULL,
  `name` VARCHAR(255) NOT NULL,
  `remote_service_name` VARCHAR(255),
  `parent_id` BIGINT,
  `debug` BIT(1),
  `start_ts` BIGINT COMMENT 'Span.timestamp(): epoch micros used for endTs query and to implement TTL',
  `duration` BIGINT COMMENT 'Span.duration(): micros used for minDuration and maxDuration query',
  PRIMARY KEY (`trace_id_high`, `trace_id`, `id`)
) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;

ALTER TABLE zipkin_spans ADD INDEX(`trace_id_high`, `trace_id`) COMMENT 'for getTracesByIds';
ALTER TABLE zipkin_spans ADD INDEX(`name`) COMMENT 'for getTraces and getSpanNames';
ALTER TABLE zipkin_spans ADD INDEX(`remote_service_name`) COMMENT 'for getTraces and getRemoteServiceNames';
ALTER TABLE zipkin_spans ADD INDEX(`start_ts`) COMMENT 'for getTraces ordering and range';

CREATE TABLE IF NOT EXISTS zipkin_annotations (
  `trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT 'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit',
  `trace_id` BIGINT NOT NULL COMMENT 'coincides with zipkin_spans.trace_id',
  `span_id` BIGINT NOT NULL COMMENT 'coincides with zipkin_spans.id',
  `a_key` VARCHAR(255) NOT NULL COMMENT 'BinaryAnnotation.key or Annotation.value if type == -1',
  `a_value` BLOB COMMENT 'BinaryAnnotation.value(), which must be smaller than 64KB',
  `a_type` INT NOT NULL COMMENT 'BinaryAnnotation.type() or -1 if Annotation',
  `a_timestamp` BIGINT COMMENT 'Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp',
  `endpoint_ipv4` INT COMMENT 'Null when Binary/Annotation.endpoint is null',
  `endpoint_ipv6` BINARY(16) COMMENT 'Null when Binary/Annotation.endpoint is null, or no IPv6 address',
  `endpoint_port` SMALLINT COMMENT 'Null when Binary/Annotation.endpoint is null',
  `endpoint_service_name` VARCHAR(255) COMMENT 'Null when Binary/Annotation.endpoint is null'
) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;

ALTER TABLE zipkin_annotations ADD UNIQUE KEY(`trace_id_high`, `trace_id`, `span_id`, `a_key`, `a_timestamp`) COMMENT 'Ignore insert on duplicate';
ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`, `span_id`) COMMENT 'for joining with zipkin_spans';
ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`) COMMENT 'for getTraces/ByIds';
ALTER TABLE zipkin_annotations ADD INDEX(`endpoint_service_name`) COMMENT 'for getTraces and getServiceNames';
ALTER TABLE zipkin_annotations ADD INDEX(`a_type`) COMMENT 'for getTraces and autocomplete values';
ALTER TABLE zipkin_annotations ADD INDEX(`a_key`) COMMENT 'for getTraces and autocomplete values';
ALTER TABLE zipkin_annotations ADD INDEX(`trace_id`, `span_id`, `a_key`) COMMENT 'for dependencies job';

CREATE TABLE IF NOT EXISTS zipkin_dependencies (
  `day` DATE NOT NULL,
  `parent` VARCHAR(255) NOT NULL,
  `child` VARCHAR(255) NOT NULL,
  `call_count` BIGINT,
  `error_count` BIGINT,
  PRIMARY KEY (`day`, `parent`, `child`)
) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;
</code></pre> 
<p>运行jar包命令：</p> 
<pre><code>java -jar zipkin-server-2.24.0-exec.jar --STORAGE_TYPE=mysql --MYSQL_HOST=127.0.0.1 --MYSQL_TCP_PORT=3306 --MYSQL_DB=zipkin --MYSQL_USER=root --MYSQL_PASS=123456
</code></pre> 
<p>这里博主的jar包版本为 zipkin-server-2.24.0-exec</p> 
<h4><a id="springcloud_alibaba_102"></a>项目依赖调用演示（springcloud alibaba）</h4> 
<p>新建项目server1和server2，并利用Feign调用从server1向server2发起一个http调用<br> 观察zipkin</p> 
<h5><a id="_106"></a>准备工作</h5> 
<ol><li>到https://github.com/alibaba/nacos/releases下下载nacos 项目<br> 到nacos项目下 nacos-server-1.1.4\nacos\bin 启动cmd脚本<br> 双击startup.cmd<br> 启动成功后访问 http://localhost:8848/nacos/</li><li>本地启动zipkin<br> 启动后访问 http://127.0.0.1:9411/</li></ol> 
<h5><a id="springbootserver1_113"></a>新建springboot项目server1</h5> 
<p>完整pom文件为：</p> 
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;server1&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;server1&lt;/name&gt;
    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--Nacos 客户端 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
            &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--服务间通信组件OpenFeign --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
            &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--添加Sleuth依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;
            &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--Zipkin 客户端--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
            &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;spring-milestones&lt;/id&gt;
            &lt;name&gt;Spring Milestones&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/snapshots&gt;
        &lt;/repository&gt;
        &lt;repository&gt;
            &lt;id&gt;spring-snapshots&lt;/id&gt;
            &lt;name&gt;Spring Snapshots&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;
            &lt;releases&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/releases&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;
    &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
            &lt;id&gt;spring-milestones&lt;/id&gt;
            &lt;name&gt;Spring Milestones&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/snapshots&gt;
        &lt;/pluginRepository&gt;
        &lt;pluginRepository&gt;
            &lt;id&gt;spring-snapshots&lt;/id&gt;
            &lt;name&gt;Spring Snapshots&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;
            &lt;releases&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/releases&gt;
        &lt;/pluginRepository&gt;
    &lt;/pluginRepositories&gt;

&lt;/project&gt;

</code></pre> 
<p>主类：</p> 
<pre><code>@SpringBootApplication
@EnableDiscoveryClient//开启服务注册发现功能
@EnableFeignClients//启动Feign功能
public class Server1Application {

    public static void main(String[] args) {
        SpringApplication.run(Server1Application.class, args);
    }

}
</code></pre> 
<p>controller</p> 
<pre><code>@RestController
public class SampleController {
    @Resource
    private BServiceFeignClient bService;

    @GetMapping("/a")
    public String methodA(){
        String result = bService.methodB();
        result = "-&gt; Service A" + result;
        return result;
    }
}
</code></pre> 
<p>client</p> 
<pre><code>@FeignClient("b-service")
public interface BServiceFeignClient {
    @GetMapping("/b")
    public String methodB();
}

</code></pre> 
<p>yml</p> 
<pre><code>server:
  port: 7001
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        username: nacos
        password: nacos
  application:
    name: a-service
  sleuth:
    sampler: #采样器
      probability: 1.0 #采样率，采样率是采集Trace的比率，默认0.1
      rate: 10000 #每秒数据采集量，最多n条/秒Trace
    web: #Spring Cloud Sleuth 针对 Web 组件的配置项，例如说 SpringMVC
      enabled: true
  zipkin: #设置zipkin服务端地址
      base-url: http://127.0.0.1:9411
</code></pre> 
<h5><a id="springbootserver2_284"></a>新建springboot项目server2</h5> 
<p>pom文件和主类和server1相同</p> 
<p>controller</p> 
<pre><code>@RestController
public class SampleController {


    @GetMapping("/b")
    public String methodA(){
        String result = "";
        result = "-&gt; Service B" + result;
        return result;
    }
}
</code></pre> 
<p>yml</p> 
<pre><code>server:
  port: 7002
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        username: nacos
        password: nacos
  application:
    name: b-service
  sleuth:
    sampler: #采样器
      probability: 1.0 #采样率，采样率是采集Trace的比率，默认0.1
      rate: 10000 #每秒数据采集量，最多n条/秒Trace
    web: #Spring Cloud Sleuth 针对 Web 组件的配置项，例如说 SpringMVC
      enabled: true
  zipkin: #设置zipkin服务端地址
    base-url: http://127.0.0.1:9411
</code></pre> 
<h5><a id="_323"></a>测试</h5> 
<p>启动两个项目，访问 http://127.0.0.1:7001/a 页面输出 Service A-&gt; Service B<br> 观察Zipkin<br> <img src="https://images2.imgbox.com/41/06/NklHVnER_o.png" alt="在这里插入图片描述"><br> 点击 show 按钮查看详情<br> <img src="https://images2.imgbox.com/85/d7/T4EREnA5_o.png" alt="在这里插入图片描述"><br> 点击依赖可以查看应用间的依赖调用关系<br> <img src="https://images2.imgbox.com/02/88/9f9hbz57_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/15/50/UthDg0b0_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e7f522037ab9469cb4e3041daa9d5116/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">资料资源大全（地学资料，语言教程，地图土里利用，shp矢量数据，年鉴） (待审核)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8e2dffbaa271d36455ca89c1f3dc2e20/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MultipartFile 和 file 的区别在于：</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>