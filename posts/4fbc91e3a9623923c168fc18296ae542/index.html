<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Visual Basic串口通讯调试方法 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/4fbc91e3a9623923c168fc18296ae542/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Visual Basic串口通讯调试方法">
  <meta property="og:description" content="现有电子秤一台，使用串口与计算机进行通讯。编写VB程序来访问串口，达到读取电子秤上显示的数据。该电子秤为BE01型仪表，输出为RS-232C标准接口，波特率为300-9600、偶校验、7个数据位、2个停止位。所有字符均发送11位ASCII码，一个起始位。在VB中与串口通讯需要引入控件MSComm串口通讯控件（在Microsoft Comm Control 6.0中）。具体程序如下：控件简称：MSC Dim Out(12) As Byte &#39;接收var中的值 Dim var As Variant &#39;接收MSC.input中的数值 Dim nRece As Integer &#39;计算MSC.inputbuffer的个数 Dim i As Integer, j As Integer &#39;随即变量，计算循环 **************************************************************************** Private Sub Form_Load() ClearText With MSC .CommPort = 1 &#39;设置Com1为通信端口 .Settings = &#34;9600,E,7,2&#34; &#39;设置通信端口参数 9600赫兹、偶校验、7个数据位、1个停止位.（这里需要进一步说明的是：.Setting=”BBBB,P,D,S”。 含义是：B：Baud Rate（波特率）；P：Parity（奇偶）；D：Data Bit；S：Stop Bit） .InBufferSize = 40 &#39;设置缓冲区接收数据为40字节 .InputLen = 1 &#39;设置Input一次从接收缓冲读取字节数为1 .RThreshold = 1 &#39;设置接收一个字节就产生OnComm事件 End With End Sub **************************************************************************** Private Sub ClearText() Text3.Text = &#34;">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2005-03-23T20:25:00+08:00">
    <meta property="article:modified_time" content="2005-03-23T20:25:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Visual Basic串口通讯调试方法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    现有电子秤一台，使用串口与计算机进行通讯。编写VB程序来访问串口，达到读取电子秤上显示的数据。该电子秤为BE01型仪表，输出为RS-232C标准接口，波特率为300-9600、偶校验、7个数据位、2个停止位。所有字符均发送11位ASCII码，一个起始位。在VB中与串口通讯需要引入控件MSComm串口通讯控件（在Microsoft Comm Control 6.0中）。具体程序如下：控件简称：MSC 
<br> 
<br>Dim Out(12) As Byte '接收var中的值 
<br>Dim var As Variant '接收MSC.input中的数值 
<br>Dim nRece As Integer '计算MSC.inputbuffer的个数 
<br>Dim i As Integer, j As Integer '随即变量，计算循环 
<br> 
<br>**************************************************************************** 
<br> 
<br>Private Sub Form_Load() 
<br>　ClearText 
<br>　With MSC 
<br>　　.CommPort = 1 '设置Com1为通信端口 
<br>　　.Settings = "9600,E,7,2" '设置通信端口参数 9600赫兹、偶校验、7个数据位、1个停止位.（这里需要进一步说明的是：.Setting=”BBBB,P,D,S”。 
<br>　　含义是：B：Baud Rate（波特率）；P：Parity（奇偶）；D：Data Bit；S：Stop Bit） 
<br> 
<br>　　.InBufferSize = 40 '设置缓冲区接收数据为40字节 
<br>　　.InputLen = 1 '设置Input一次从接收缓冲读取字节数为1 
<br>　　.RThreshold = 1 '设置接收一个字节就产生OnComm事件 
<br> 
<br>　End With 
<br> 
<br>End Sub 
<br> 
<br>**************************************************************************** 
<br> 
<br>Private Sub ClearText() 
<br>　Text3.Text = "" 
<br>　Text2.Text = "5" 
<br>　Text1.Text = "" 
<br>End Sub 
<br> 
<br>Private Sub Command1_Click() 
<br>　ClearText 
<br>　' nRece = 0 '计数器清零 
<br>　With MSC 
<br>　　.InputMode = comInputModeBinary '设置数据接收模式为二进制形式 
<br>　　.InBufferCount = 0 '清除接收缓冲区 
<br>　　If Not .PortOpen Then 
<br>　　　.PortOpen = True '打开通信端口 
<br>　　End If 
<br>　End With 
<br>End Sub 
<br> 
<br>Private Sub MSC_OnComm() 
<br>　DelayTime ‘用来延续时间 
<br>　ClearText 
<br>　With MSC 
<br>　　Select Case .CommEvent '判断通信事件 
<br>　　Case comEvReceive: '收到Rthreshold个字节产生的接收事件 
<br>　　　SwichVar 1 
<br>　　　If Out(1) = 2 Then '判断是否为数据的开始标志 
<br>　　　　.RThreshold = 0 '关闭OnComm事件接收 
<br>　　　End If 
<br>　　　Do 
<br>　　　　DoEvents 
<br>　　　Loop Until .InBufferCount &gt;= 3 '循环等待接收缓冲区&gt;=3个字节 
<br>　　　' nRece = nRece + 1 
<br>　　　For i = 2 To 12 
<br>　　　　SwichVar i 
<br>　　　　Text1.Text = Text1.Text &amp; Chr(Out(i)) 
<br>　　　Next 
<br>　　　Text1.Text = LTrim(Text1.Text) 
<br>　　　Text2.Text = Text2.Text &amp; CStr(nRece) 
<br>　　　.RThreshold = 1 '打开MSComm事件接收 
<br>　　Case Else 
<br>　　　' .PortOpen = False 
<br>　　End Select 
<br>　End With 
<br> 
<br>End Sub 
<br> 
<br>**************************************************************************** 
<br> 
<br>Private Sub DelayTime() 
<br> 
<br>　Dim bDT As Boolean 
<br>　Dim sPrevious As Single, sLast As Single 
<br> 
<br>　bDT = True 
<br> 
<br>　sPrevious = Timer (Timer可以计算从子夜到现在所经过的秒数，在Microsoft Windows中，Timer函数可以返回一秒的小数部分) 
<br> 
<br>　Do While bDT 
<br>　　If Timer - sPrevious &gt;= 0.3 Then bDT = False 
<br>　Loop 
<br>　bDT = True 
<br> 
<br>End Sub 
<br> 
<br>（通信传输速率为9600bps，则最快速度1.04ms发送一个字节，仪表每秒发送50帧数据，每帧数据有4个字节，即每秒发送200个字节，平均5.0ms 发送一个字节，连续读取串口数据时要在程序中添加循环等待程序） 
<br> 
<br>Private Sub SwichVar(ByVal nNum As Integer) 
<br> 
<br>　DelayTime 
<br>　var = Null 
<br>　var = MSC.Input 
<br>　Out(nNum) = var(0) 
<br> 
<br>End Sub 
<br> 
<br>（设置接收数据模式采用二进制形式，即 InputMode=comInputModeBinary，但用Input属性读取数据时，不能直接赋值给 Byte 类型变量，只能通过先赋值给一个 Variant 类型变量，返回一个二进制数据的数组，再转换保存到Byte类型数变量中。） 
<br> 
<br>Private Sub Text1_Change() 
<br> 
<br>　Text3.Text = CText(Text1.Text) - CText(Text2.Text) 
<br> 
<br>End Sub 
<br> 
<br>**************************************************************************** 
<br> 
<br>Private Function CText(ByVal str As String) As Currency 
<br> 
<br>　If str &lt;&gt; "" Then 
<br>　　CText = CCur(Val(str)) 
<br>　Else 
<br>　　CText = 0 
<br>　End If 
<br> 
<br>End Function 
<br> 
<br>　　（仪表每秒发送50帧数据，微机收到一帧完整数据至少需要20 ms时间，然后再进行数据处理。如果微机在下一帧数据接收前即20ms内能将数据计算处理完毕，则接收缓冲区内只会保存有一帧数据，不会存有两帧以上数据，接收缓冲区的大小不会影响实时监测效果（接收缓冲区&gt;4字节），这时完全可以实现实时监测或实时控制；如果微机在20ms内不能将数据计算处理完毕，接收缓冲区设置得又很大，在数据计算处理完毕前，接收缓冲区内就会保存有两帧以上数据，而且一次工作时间越长，缓冲区内滞留数据帧就越多，数据采集和数据处理之间产生逐渐增大的额外时间差，当接收缓冲区充满后，时间差不再增大，固定在某一值，部分数据因不能及时采集到接收缓冲区中，数据产生丢失现象，真实工作情况就会和微机处理结果产生较大的时间差，对实时监测和实时控制很不利，这种情况下接收缓冲区的大小就会影响实时监测效果，所以接收缓冲区设置不能过大，以保证数据处理的实时性。） 小结：本文所用的仪表为梅特勒公司出产的BE01型电子秤，其输出的每个编码均为标准的ASCII码。其他的仪表存在发射的编码中含有BCD压缩码，而且分为高低位，需要接收后对其进行解码换算，之后还要将高位和低位数字进行相加，即可以将其BCD码换算成实数。另还存在误差的可能：判断最大值，仪表在刚开始工作时有干扰，会传导一些乱码，位移传感器有参数偏差，最大值一般都略大于50毫米，所以取51为极限最大值，取－51为极限最小值。暂时先写这些，当然其他的情况可以依此类推！
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e49a537efd2c50167a40da4d9d5f9d06/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第一章 Borland的诞生和发展</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>