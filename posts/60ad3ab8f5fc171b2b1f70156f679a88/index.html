<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用RecyclerView开发TabView - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/60ad3ab8f5fc171b2b1f70156f679a88/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="使用RecyclerView开发TabView">
  <meta property="og:description" content="github链接
demo代码
效果图
这个功能是使用RecyclerView开发的，需要解决下面这些问题
单个item滚动的问题：左边的view需要固定、手指松开之后，惯性的处理滑动布局子View事件分发冲突的解决多个item联合滚动滚动header解决itemView与RecyclerView滑动冲突的问题横向滚动时，显示和隐藏滚动条 带着上面想到的问题，逐一写demo，最后再把编写的代码糅合在一起，完成tab view。
第1个问题还是比较复杂的，也是核心问题，所以必须最先解决。
由于我以前写过左滑显示删除按钮的功能，所以滑动部分马上就想到在LinearLayout的基础上开发。而固定的功能反而是最简单的，直接在外部套一个LinearLayout，然后写一个View在最左边就行。
简单提了一下思路，接下来是功能的开发。
单个滑动布局
先实现滑动的功能，这个是最简单的，先看一下图片。
代码：
这里10个TextView的代码我就不提供了，没什么好说的，直接提供GestureLayout的代码。
class GestureLayout @JvmOverloads constructor(context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0) : LinearLayout(context, attrs, defStyleAttr), View.OnTouchListener { private var scrollState = SCROLL_STATE_IDLE private var lastTouchX = 0 // 当前滑动的距离 private var scrollOffset = 0f // 最大可滑动的距离 private var maxScrollOffset = 0f // 大于这个值才可以滑动 private var touchSlop = 16 init { orientation = HORIZONTAL setOnTouchListener(this) } override fun onAttachedToWindow() { super.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-18T18:00:00+08:00">
    <meta property="article:modified_time" content="2023-04-18T18:00:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用RecyclerView开发TabView</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="https://github.com/nanjolnoSat/PersonalProject/tree/master/tableview/src/main/java/com/mishaki/tableview">github链接</a><br> <a href="https://github.com/nanjolnoSat/PersonalProject/tree/master/app/src/main/java/com/mishaki/personalproject/tableview">demo代码</a><br> 效果图<br> <img src="https://images2.imgbox.com/93/02/yBw0gBTh_o.gif" alt="在这里插入图片描述"><br> 这个功能是使用RecyclerView开发的，需要解决下面这些问题</p> 
<ol><li>单个item滚动的问题：左边的view需要固定、手指松开之后，惯性的处理</li><li>滑动布局子View事件分发冲突的解决</li><li>多个item联合滚动滚动</li><li>header</li><li>解决itemView与RecyclerView滑动冲突的问题</li><li>横向滚动时，显示和隐藏滚动条</li></ol> 
<p>带着上面想到的问题，逐一写demo，最后再把编写的代码糅合在一起，完成tab view。</p> 
<p>第1个问题还是比较复杂的，也是核心问题，所以必须最先解决。<br> 由于我以前写过左滑显示删除按钮的功能，所以滑动部分马上就想到在LinearLayout的基础上开发。而固定的功能反而是最简单的，直接在外部套一个LinearLayout，然后写一个View在最左边就行。<br> 简单提了一下思路，接下来是功能的开发。<br></p> 
<p><b>单个滑动布局</b><br> 先实现滑动的功能，这个是最简单的，先看一下图片。<br><br> <img src="https://images2.imgbox.com/e3/ba/xkL3QGrK_o.gif" alt="在这里插入图片描述"><br> 代码：<br> 这里10个TextView的代码我就不提供了，没什么好说的，直接提供GestureLayout的代码。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> GestureLayout <span class="token annotation builtin">@JvmOverloads</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> defStyleAttr<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">LinearLayout</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span><span class="token punctuation">,</span> View<span class="token punctuation">.</span><span class="token function">OnTouchListener</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollState <span class="token operator">=</span> SCROLL_STATE_IDLE

    <span class="token keyword">private</span> <span class="token keyword">var</span> lastTouchX <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 当前滑动的距离</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollOffset <span class="token operator">=</span> <span class="token number">0f</span>
    <span class="token comment">// 最大可滑动的距离</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> maxScrollOffset <span class="token operator">=</span> <span class="token number">0f</span>
    <span class="token comment">// 大于这个值才可以滑动</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> touchSlop <span class="token operator">=</span> <span class="token number">16</span>

    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        orientation <span class="token operator">=</span> HORIZONTAL
        <span class="token function">setOnTouchListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> onGlobalLayoutListener <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ViewTreeObserver<span class="token punctuation">.</span><span class="token function">OnGlobalLayoutListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onGlobalLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                viewTreeObserver<span class="token punctuation">.</span><span class="token function">removeOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
                <span class="token comment">// 计算最大宽度</span>
                <span class="token keyword">var</span> totalChildWith <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until childCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    totalChildWith <span class="token operator">+=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>measuredWidth
                <span class="token punctuation">}</span>
                <span class="token comment">// 可滑动的距离 = 最大宽度 - 当前View的宽度</span>
                maxScrollOffset <span class="token operator">=</span> <span class="token punctuation">(</span>totalChildWith <span class="token operator">-</span> width<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        viewTreeObserver<span class="token punctuation">.</span><span class="token function">addOnGlobalLayoutListener</span><span class="token punctuation">(</span>onGlobalLayoutListener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">,</span> ev<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                lastTouchX <span class="token operator">=</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            MotionEvent<span class="token punctuation">.</span>ACTION_MOVE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> dx <span class="token operator">=</span> lastTouchX <span class="token operator">-</span> x
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollState <span class="token operator">!=</span> SCROLL_STATE_DRAGGING <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>dx<span class="token punctuation">)</span> <span class="token operator">&gt;</span> touchSlop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scrollState <span class="token operator">=</span> SCROLL_STATE_DRAGGING
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollState <span class="token operator">==</span> SCROLL_STATE_DRAGGING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lastTouchX <span class="token operator">=</span> x
                    <span class="token comment">// 更新offset</span>
                    <span class="token function">updateScrollOffset</span><span class="token punctuation">(</span>scrollOffset <span class="token operator">+</span> dx<span class="token punctuation">)</span>
                    <span class="token function">scrollTo</span><span class="token punctuation">(</span>scrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            MotionEvent<span class="token punctuation">.</span>ACTION_UP <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 回收资源</span>
                <span class="token function">recycler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">recycler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        scrollState <span class="token operator">=</span> SCROLL_STATE_IDLE
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateScrollOffset</span><span class="token punctuation">(</span>scrollOffset<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scrollOffset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxScrollOffset<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0f</span><span class="token punctuation">,</span> scrollOffset<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 这段代码可能有点绕，看下面这段代码就懂了</span>
<span class="token comment">//        if (scrollOffset &lt; 0f){<!-- --></span>
<span class="token comment">//            this.scrollOffset = 0f</span>
<span class="token comment">//        }else if (scrollOffset &gt; maxScrollOffset){<!-- --></span>
<span class="token comment">//            this.scrollOffset = scrollOffset</span>
<span class="token comment">//        }else{<!-- --></span>
<span class="token comment">//            this.scrollOffset = scrollOffset</span>
<span class="token comment">//        }</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> SCROLL_STATE_IDLE <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> SCROLL_STATE_DRAGGING <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>基础代码就是上面这些。可以看到，其实是很简单的，只需调用scrollTo，就可以了。该写的注释都已经写了，没啥好说的。<br> 但很显然，简单的滑动是不够的，还需要做松开手指之后的惯性功能，这个就有点麻烦了。<br><br> 在说如何实现这个功能之前，先来介绍2个需要用到的类。<br> <b>VelocityTracker：</b>顾名思义，速度追踪器，用来追踪速度的工具类。有3个在这里需要用到的方法：</p> 
<ul><li>addMovement：记录触摸事件，用于计算出up时的xVeloctiy和yVelocity。</li><li>computeCurrentVelocity(int, float)：在调用getXVelocity之前，需要调用该方法进行计算。</li><li>getXVelocity：ACTION_UP时调用获取，再将该值传递给Scroller的fling方法，让Scroller计算出实际需要滚动的距离。</li></ul> 
<p><b>OverScroller：</b>上面提到的Scroller，就是第2个类。而在OverScroller里面，有这样一句注释。<br><br> <code>This class is a drop-in replacement for Scroller in most cases.</code><br><br> 大多数情况下，可以直接使用OverScroller代替Scroller。所以这里直接使用OverScroller。<br> OverScroller的作用就是：是一个用于模拟滑动的工具类，用它来实现平滑移动时非常有用。<b>注意，这个类只能辅助实现，不是直接实现。</b><br> 几个需要用到的方法：</p> 
<ul><li>fling(startX, startY, veloctiyX, velocityY, minX, maxX, minY, maxY, overX, overY)：用于惯性的处理。将起始的x/y值、滑动速度、x/y最小最大值传递给它之后，Scroller会计算出实际的x/y值，再让View滑动起来。</li><li>computeScrollOffset：用来计算当前的滑动位置。如果返回true，表示当前计算还没有完成，此时调用getCurrX/getCurrY可以获取到滑动的值。如果返回false则说明滑动已经完成，无需继续处理。该方法需要在View的computeScroll方法里面调用。</li><li>getCurrX/getCurrY：在调用computeScrollOffset之后，需要通过该方法获取实际滚动的值，再调用View的scrollTo/scrollBy方法，实现滚动。</li><li>abortAnimation：用来阻止Scroller滚动，一般在ACTION_DOWN中使用。</li></ul> 
<p>除了上面这两个类，还有2个View自带的方法需要解释。</p> 
<ul><li>invalidate/postInvalidate/postInvalidateOnAnimation：这3个方法都是刷新方法，都会让View调用draw方法，最后会调用computeScroll方法。这里的刷新我使用的是postInvalidateOnAnimation，因为这个方法刷新的次数更少，相对另外两个方法，性能更好。而这里对刷新的要求也不高，所以够用了。</li><li>computeScroll：在调用刷新方法之后，就会调用这个方法。在这个方法里面，需要调用Scroller的computeScrollOffset，如果返回true，就调用scrollTo/scrollBy方法滚动，再调用刷新方法，直到computeScrollOffset返回false。</li></ul> 
<p>总结一下流程：ACTION_UP -&gt; VelocityTracker.addMovement -&gt; VelocityTracker.computeCurrentVelocity -&gt; VelocityTracker.getXVelocity -&gt; Scroller.fling -&gt;postInvalidateOnAnimation -&gt; computeScroll -&gt;Scroller.computeScrollOffset -&gt;Scroller.getCurrX-&gt; scrollTo -&gt; postInvalidateOnAnimation<br> 调用链路有点长，接下来看看代码实现吧，刚才已经写过的大部分代码不会写在下面。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">var</span> touchSlop <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">private</span> <span class="token keyword">val</span> scroller <span class="token operator">=</span> <span class="token function">OverScroller</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">var</span> velocityTracker<span class="token operator">:</span> VelocityTracker<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">private</span> <span class="token keyword">var</span> minimumFlingVelocity <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">private</span> <span class="token keyword">var</span> maximumFlingVelocity <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">init</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 借助ViewConfiguration获取下面这3个值</span>
    <span class="token keyword">val</span> vc <span class="token operator">=</span> ViewConfiguration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    minimumFlingVelocity <span class="token operator">=</span> vc<span class="token punctuation">.</span>scaledMinimumFlingVelocity
    maximumFlingVelocity <span class="token operator">=</span> vc<span class="token punctuation">.</span>scaledMaximumFlingVelocity
    touchSlop <span class="token operator">=</span> vc<span class="token punctuation">.</span>scaledTouchSlop
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">,</span> ev<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化VelocityTracker</span>
    <span class="token function">initVelocityTrackerIfNoExits</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 每次都将event交给VelocityTracker分析</span>
    velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addMovement</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 中断Scroller的滑动</span>
            scroller<span class="token punctuation">.</span><span class="token function">abortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            lastTouchX <span class="token operator">=</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ACTION_MOVE的代码和上面的一样，就不贴出来了</span>
        MotionEvent<span class="token punctuation">.</span>ACTION_UP <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollState <span class="token operator">==</span> SCROLL_STATE_DRAGGING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> velocityTracker <span class="token operator">=</span> velocityTracker
                <span class="token comment">// 让VelocityTacker开始计算速度</span>
                velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">computeCurrentVelocity</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> maximumFlingVelocity<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 获取x的速度</span>
                <span class="token keyword">val</span> xVelocity <span class="token operator">=</span> velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span>xVelocity <span class="token operator">?:</span> <span class="token number">0f</span>
                <span class="token comment">// 如果速度大于最小的速度，就开始fling</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>xVelocity<span class="token punctuation">)</span> <span class="token operator">&gt;</span> minimumFlingVelocity<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scroller<span class="token punctuation">.</span><span class="token function">fling</span><span class="token punctuation">(</span>scrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>xVelocity<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>    maxScrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token function">postInvalidateOnAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">recycler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">recycler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">recycleVelocityTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    scrollState <span class="token operator">=</span> SCROLL_STATE_IDLE
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">computeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// super是空实现，想去掉也可以</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">computeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 判断是否还在计算offset</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scroller<span class="token punctuation">.</span><span class="token function">computeScrollOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> curX <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>scroller<span class="token punctuation">.</span>currX<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxScrollOffset<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curX <span class="token operator">!=</span> scrollOffset<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            scrollOffset <span class="token operator">=</span> curX
        <span class="token punctuation">}</span>
        <span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollOffset <span class="token operator">==</span> <span class="token number">0f</span> <span class="token operator">||</span> scrollOffset <span class="token operator">==</span> maxScrollOffset<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            scroller<span class="token punctuation">.</span><span class="token function">abortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initVelocityTrackerIfNoExits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>velocityTracker <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        velocityTracker <span class="token operator">=</span> VelocityTracker<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">recycleVelocityTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    velocityTracker <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">scrollTo</span><span class="token punctuation">(</span>scrollOffset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">postInvalidateOnAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>效果图：<br> <img src="https://images2.imgbox.com/66/79/kkiC8mJW_o.gif" alt="在这里插入图片描述"><br> <br><br> 接下来先在左边加一个TextView实现左边固定的功能</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50dp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_width<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/black<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stick<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_text_size<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GestureLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@layout/merge_table_layout<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GestureLayout</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>效果我就不贴出来了，一看就知道怎么回事。至于10个TextView使用include，这是因为后面的Header需要使用同一个layout，所以这样做可以避免编写重复代码。<br><br> 接下来是子View事件分发的处理。这个View是一个ViewGroup，所以需要处理好touch事件。一些可以传递给子View的事件，就传递给子View，不能传递给子View的，就自己处理。<br> 先来一个反例</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50dp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_width<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/black<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stick<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_text_size<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GestureLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/click_area<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@layout/merge_table_layout<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GestureLayout</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>java代码我就不贴了，只是给click_area设置了一个onClick，弹出toast，看一下效果图<br> <img src="https://images2.imgbox.com/21/ce/6UP7mcpR_o.gif" alt="在这里插入图片描述"><br> 可以看到，鼠标明明滑动了，但View却没有滑动，反而是触发了onClick，说明必须对某些事件进行处理。<br> 而即使去掉onClick，也会出现问题。因为在onAttch方法里面，只是计算当前ViewGroup所有子View的width。此时，只有一个，计算出来的width是不正确的，导致maxScrollWidth不正确，最后没办法滑动。想要解决这个问题，就需要修改一点点代码。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">calculateMaxScrollOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">calculateMaxScrollOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 用于计算的ViewGroup，可能是当前View，也可能是第一个子View</span>
    <span class="token keyword">val</span> calculateViewGroup<span class="token operator">:</span> ViewGroup
    <span class="token comment">// 如果childCount等于0，只会返回null，不用担心越界异常</span>
    <span class="token keyword">val</span> firstChild <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果只有一个child，并且是ViewGroup才使用该View</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childCount <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> firstChild <span class="token keyword">as</span><span class="token operator">?</span> ViewGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        calculateViewGroup <span class="token operator">=</span> firstChild
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        calculateViewGroup <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> onGlobalLayoutListener <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ViewTreeObserver<span class="token punctuation">.</span><span class="token function">OnGlobalLayoutListener</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onGlobalLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            calculateViewGroup<span class="token punctuation">.</span>viewTreeObserver<span class="token punctuation">.</span><span class="token function">removeOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token keyword">var</span> totalChildWith <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until calculateViewGroup<span class="token punctuation">.</span>childCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                totalChildWith <span class="token operator">+=</span> calculateViewGroup<span class="token punctuation">.</span><span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>measuredWidth
            <span class="token punctuation">}</span>
            maxScrollOffset <span class="token operator">=</span> <span class="token punctuation">(</span>totalChildWith <span class="token operator">-</span> width<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 只有有子Layout时，才需要重新设置当前layout和子layout的宽度</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>calculateViewGroup <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token label symbol">@GestureLayout</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">layout</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> left <span class="token operator">+</span> totalChildWith<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span>
                calculateViewGroup<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span>calculateViewGroup<span class="token punctuation">.</span>left<span class="token punctuation">,</span> calculateViewGroup<span class="token punctuation">.</span>top<span class="token punctuation">,</span> calculateViewGroup<span class="token punctuation">.</span>left <span class="token operator">+</span> totalChildWith<span class="token punctuation">,</span> calculateViewGroup<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    calculateViewGroup<span class="token punctuation">.</span>viewTreeObserver<span class="token punctuation">.</span><span class="token function">addOnGlobalLayoutListener</span><span class="token punctuation">(</span>onGlobalLayoutListener<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过上述的代码，就不用担心其他人在这个Layout下面，再加其他的Layout了。不过如果非要加几个layout，那就没办法了。<br> <b>但我泼一下冷水，上面的代码看起来好像很好，但在RecyclerView里面使用，还是有问题，最后是使用其他方式解决这个问题。</b><br> 这个问题就不再讨论了，开始着手解决事件分发的问题。因为不管有几个子View，都需要解决事件分发的问题。<br> 先思考为什么设置了onClick就会使滑动失效？原因也很简单，设置了onClick，所以子View消费了所有事件，导致事件没办法传递到GestureLayout。解决方式也很简单，重写onInterceptTouchEvent方法，如果从ACTION_DOWN到ACTION_MOVE时，x坐标变化了，而且大于touchSlop，就认为滑动生效。此时，将scrollState设置为DRAGGING并返回true。这样就子View就会拿到ACTION_CANCEL，并且还会将move事件传递给GestureLayout的dispatchTouchEvent，最后传递到onTouch方法。只要到了onTouch方法，那代码就可以正常执行下去。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">var</span> initialTouchX<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>


<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>ev<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">when</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            initialTouchX <span class="token operator">=</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            lastTouchX <span class="token operator">=</span> initialTouchX
            <span class="token function">initOrResetVelocityTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addMovement</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        MotionEvent<span class="token punctuation">.</span>ACTION_MOVE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> dx <span class="token operator">=</span> x <span class="token operator">-</span> initialTouchX
            lastTouchX <span class="token operator">=</span> x
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>dx<span class="token punctuation">)</span> <span class="token operator">&gt;</span> touchSlop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">initVelocityTrackerIfNoExits</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addMovement</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span>
                scrollState <span class="token operator">=</span> SCROLL_STATE_DRAGGING
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        MotionEvent<span class="token punctuation">.</span>ACTION_UP<span class="token punctuation">,</span> MotionEvent<span class="token punctuation">.</span>ACTION_CANCEL <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            scrollState <span class="token operator">=</span> SCROLL_STATE_IDLE
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> scrollState <span class="token operator">==</span> SCROLL_STATE_DRAGGING
<span class="token punctuation">}</span>
</code></pre> 
<p>添加了这些代码之后，就可以正常滑动了，图片我就不提供了，自己试一下就知道了。<br><br> 接下来是多个item联合滚动和header功能，由于功能类似，所以放在一起。<br> 先确定一下思路。首先，想要多个联动滚动，肯定需要一个Manager来管理。能不能直接在Adapter里面的onBindViewHolder方法将View add到Manager里面，这样肯定不行，因为这样只有add没有remove，而且同一个item可能还会onBindViewHolder多次。然后我就想到了Adapter里面的onViewAttachedToWindow方法和onDetachedFromRecyclerView方法。分别对应View显示到界面和View从界面消失。最后经测试，这种方式确实可行，但每个Adapter都写同样的代码，有点烦，所以就尝试将代码放到View层的attch方法和detach方法，发现也可以，下面是简单的代码</p> 
<pre><code>override fun onAttachedToWindow() {
    super.onAttachedToWindow()
    scrollManager?.also {
        it.addCandidate(this)}
    }
}
override fun onDetachedFromWindow() {
    super.onDetachedFromWindow()
    scrollManager?.also {
        it.removeCandidate(this)
    }
}
</code></pre> 
<p>接下来是设计ScrollManager。ScrollManager的作用是，统一管理所有的item。当某个item touch之后，将数据传递给Manager，让Manager统一调动所有的item。<br> 首先，需要添加接口，通过接口将touch行为传递给ScrollManager。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">interface</span> OnScrolledChangedListener <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在onInterceptTouchEvent里面调用，借助Scroller判断是否正在滚动，如果是，就返回true</span>
    <span class="token keyword">fun</span> <span class="token function">isScrollerFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean
    <span class="token comment">// 如果在onInteceptTouchEvent的ACTION_DOWN拦截了，就在onTouch组织Scroller滚动</span>
    <span class="token keyword">fun</span> <span class="token function">checkAndAbortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ACTION_MOVE和ACTION_UP调用，更新offset</span>
    <span class="token keyword">fun</span> <span class="token function">onScrollChange</span><span class="token punctuation">(</span>distanceX<span class="token operator">:</span> Float<span class="token punctuation">)</span>
    <span class="token comment">// ACTION_UP调用，让ScrollManager调用Scroller的fling</span>
    <span class="token keyword">fun</span> <span class="token function">onFling</span><span class="token punctuation">(</span>velocityX<span class="token operator">:</span> Int<span class="token punctuation">)</span>
    <span class="token comment">// header的computeScroll调用。需要明确的是，不能让item去调用，因为这样做的话，会让Scroller同时调用computeScrollOffset，这样做是不合理的，也是会出问题的</span>
    <span class="token keyword">fun</span> <span class="token function">onComputeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ACTION_UP和ACTION_CANCEL调用，做一些收尾的工作</span>
    <span class="token keyword">fun</span> <span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>    
</code></pre> 
<p>添加这个interface之后，就需要在GestureLayout里面添加相应的字段，让并在相应的时机调用对应的方法</p> 
<pre><code class="prism language-kotlin"><span class="token comment">// 注意，这里加了open。提供相应字段之后，再由子类自己去实现，所以改为可以继承</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> GestureLayout <span class="token annotation builtin">@JvmOverloads</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> defStyleAttr<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">LinearLayout</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span><span class="token punctuation">,</span> View<span class="token punctuation">.</span><span class="token function">OnTouchListener</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">var</span> onScrolledChangeListener<span class="token operator">:</span> OnScrolledChangedListener<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    
    <span class="token comment">// 此时，onAttachedToWindow的calculateMaxScrollOffset代码去去掉，暂时别考虑clickArea的问题</span>
    <span class="token comment">// 这个方法直接去掉就行，不用重写，放在这里只做提醒</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>ev<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">..</span><span class="token punctuation">.</span>
                scrollState <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onScrolledChangeListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">isScrollerFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span>
                <span class="token punctuation">)</span> SCROLL_STATE_DRAGGING <span class="token keyword">else</span> SCROLL_STATE_IDLE
            <span class="token punctuation">}</span>
            MotionEvent<span class="token punctuation">.</span>ACTION_UP<span class="token punctuation">,</span> MotionEvent<span class="token punctuation">.</span>ACTION_UP <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                scrollState <span class="token operator">=</span> SCROLL_STATE_IDLE
                onScrolledChangeListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">,</span> ev<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 注意，上面的onInterceptTouchEvent，有一句lastTouchX，这里可以去掉，因为已经放在onInterceptTouchEvent里面了</span>
                onScrolledChangeListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">checkAndAbortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            MotionEvent<span class="token punctuation">.</span>ACTION_MOVE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">..</span><span class="token punctuation">.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollState <span class="token operator">==</span> SCROLL_STATE_DRAGGING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lastTouchX <span class="token operator">=</span> x
                    <span class="token comment">// 这里的scrollTo必须去掉，放在ScrollerManager里买实现</span>
                    onScrolledChangeListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onScrollChange</span><span class="token punctuation">(</span>dx<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            MotionEvent<span class="token punctuation">.</span>ACTION_UP <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// ACTION_UP的部分代码也更新了</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollState <span class="token operator">==</span> SCROLL_STATE_DRAGGING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">val</span> velocityTracker <span class="token operator">=</span> velocityTracker
                    velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">computeCurrentVelocity</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> maximumFlingVelocity<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">val</span> initialVelocity <span class="token operator">=</span> velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span>xVelocity<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token number">0</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>initialVelocity<span class="token punctuation">)</span> <span class="token operator">&gt;</span> minimumFlingVelocity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        onScrolledChangeListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onFling</span><span class="token punctuation">(</span><span class="token operator">-</span>initialVelocity<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">postInvalidateOnAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">recycler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">recycler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollState <span class="token operator">=</span> SCROLL_STATE_IDLE
        onScrolledChangeListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">recycleVelocityTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">computeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childCount <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            onScrolledChangeListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onComputeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样，GestureLayout就改造完成，接下来编写ScrollManager。然后再分别新增item能用的和header能用的两个Layout。这个Layout设置为open，就是为了这个。<br> <strong>ScrollManager</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">ScrollManager</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> minimumScrollOffset <span class="token operator">=</span> <span class="token number">0.0f</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> maximumScrollOffset <span class="token operator">=</span> Float<span class="token punctuation">.</span>MAX_VALUE
    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollOffset <span class="token operator">=</span> minimumScrollOffset
    <span class="token keyword">private</span> <span class="token keyword">var</span> scroller <span class="token operator">=</span> <span class="token function">OverScroller</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token comment">// 存储要scroll的View</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> scrollCandidateList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>View<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 这两个是滚动条要用的，现在不做开发，但留出相应的接口，最后会讲怎么实现滚动条</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollBar<span class="token operator">:</span> HorizontalScrollBar<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollBarOffset<span class="token operator">:</span> Float <span class="token operator">=</span> <span class="token number">0f</span>

    <span class="token comment">// 记录是否正在fling，阻断一些不必要的代码</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> isFling <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token keyword">fun</span> <span class="token function">addCandidate</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollCandidateList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollCandidateList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span>
            view<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span>scrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">removeCandidate</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollCandidateList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置最大可滚动的距离，让header统一计算，然后调用该方法设置，不要让item去计算，否则就会设置很多次</span>
    <span class="token keyword">fun</span> <span class="token function">setMaxScrollOffset</span><span class="token punctuation">(</span>maxOffset<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        maximumScrollOffset <span class="token operator">=</span> maxOffset
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">scrollSpecialView</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        view<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span>scrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">clearViews</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollCandidateList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">clearScrollBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setScrollBar</span><span class="token punctuation">(</span>bar<span class="token operator">:</span> HorizontalScrollBar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollBar <span class="token operator">=</span> bar
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">clearScrollBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollBar <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// OnScrolledChangedListener.isScrollerFinished</span>
    <span class="token keyword">fun</span> <span class="token function">isScrollerFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> scroller<span class="token punctuation">.</span>isFinished
    <span class="token punctuation">}</span>

    <span class="token comment">// OnScrolledChangedListener.checkAndAbortAnimation</span>
    <span class="token keyword">fun</span> <span class="token function">checkAndAbortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scroller<span class="token punctuation">.</span>isFinished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scroller<span class="token punctuation">.</span><span class="token function">abortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// OnScrolledChangedListener.onScrollChange会掉孔这个方法计算offset，再调用下面的updateScroll滚动所有的View</span>
    <span class="token keyword">fun</span> <span class="token function">safeUpdateScrollPosition</span><span class="token punctuation">(</span>distanceX<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollOffset <span class="token operator">+=</span> distanceX
        scrollOffset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>scrollOffset<span class="token punctuation">,</span> minimumScrollOffset<span class="token punctuation">)</span><span class="token punctuation">,</span> maximumScrollOffset<span class="token punctuation">)</span>
        scrollBarOffset <span class="token operator">=</span> <span class="token function">calculateScrollBarOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">updateScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollCandidateList<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span>
            it<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span>scrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            it<span class="token punctuation">.</span><span class="token function">postInvalidateOnAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        scrollBar<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">updateScrollWeight</span><span class="token punctuation">(</span>scrollBarOffset<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// OnScrolledChangedListener.onFling</span>
    <span class="token keyword">fun</span> <span class="token function">fling</span><span class="token punctuation">(</span>velocityX<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        isFling <span class="token operator">=</span> <span class="token boolean">true</span>
        scroller<span class="token punctuation">.</span><span class="token function">fling</span><span class="token punctuation">(</span>
            scrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> velocityX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> maximumScrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token punctuation">)</span>
        <span class="token function">updateScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// OnScrolledChangedListener.onComputeScroll</span>
    <span class="token keyword">fun</span> <span class="token function">updateScrollForScroller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 返回true表示还在计算</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scroller<span class="token punctuation">.</span><span class="token function">computeScrollOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> curX <span class="token operator">=</span> <span class="token function">getSafeUpdatePosition</span><span class="token punctuation">(</span>scroller<span class="token punctuation">.</span>currX<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curX <span class="token operator">!=</span> scrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scrollOffset <span class="token operator">=</span> curX<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                scrollBarOffset <span class="token operator">=</span> <span class="token function">calculateScrollBarOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">updateScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 到了屏幕边缘，也可以结束fling，所以做收尾操作</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollOffset <span class="token operator">==</span> minimumScrollOffset <span class="token operator">||</span> scrollOffset <span class="token operator">==</span> maximumScrollOffset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scroller<span class="token punctuation">.</span><span class="token function">abortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                isFling <span class="token operator">=</span> <span class="token boolean">false</span>
                scrollBar<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">startCountToHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回false表示计算完成，fling已经结束</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isFling<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                isFling <span class="token operator">=</span> <span class="token boolean">false</span>
                scrollBar<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">startCountToHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// OnScrolledChangedListener.draggingEnd</span>
    <span class="token keyword">fun</span> <span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这个方法是UP或CANCEL时调用的</span>
        <span class="token comment">// 此时，可能还在fling，所以不能隐藏。而如果没有再fling，就可以隐藏</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFling<span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            scrollBar<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">startCountToHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">getSafeUpdatePosition</span><span class="token punctuation">(</span>curX<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>curX<span class="token punctuation">,</span> minimumScrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maximumScrollOffset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">calculateScrollBarOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Float <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> scrollOffset <span class="token operator">/</span> <span class="token punctuation">(</span>maximumScrollOffset <span class="token operator">-</span> minimumScrollOffset<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">interface</span> HorizontalScrollBar <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 更新滚动的位置</span>
        <span class="token keyword">fun</span> <span class="token function">updateScrollWeight</span><span class="token punctuation">(</span>wieght<span class="token operator">:</span> Float<span class="token punctuation">)</span>
        <span class="token comment">// 滚动完成，隐藏滚动条</span>
        <span class="token keyword">fun</span> <span class="token function">startCountToHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后是item的GestureLayout，ItemGestureLayout</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> ItemGestureLayout <span class="token annotation builtin">@JvmOverloads</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> defStyleAttr<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">GestureLayout</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollManager<span class="token operator">:</span> ScrollManager<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addCandidate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDetachedFromWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDetachedFromWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">removeCandidate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">fun</span> <span class="token function">setScrollManager</span><span class="token punctuation">(</span>scrollManager<span class="token operator">:</span> ScrollManager<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scrollManager <span class="token operator">=</span> scrollManager
        onScrolleChangedListener <span class="token operator">=</span> <span class="token function">ItemGestureLayoutOnScrollChangedListener</span><span class="token punctuation">(</span>scrollManager<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token function">ItemGestureLayoutOnScrollChangedListener</span><span class="token punctuation">(</span>scrollManager<span class="token operator">:</span> ScrollManager<span class="token punctuation">)</span><span class="token operator">:</span> OnScrolledChangedListener<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> scrollManagerWeakRef <span class="token operator">=</span> <span class="token function">WeakReference</span><span class="token punctuation">(</span>scrollManager<span class="token punctuation">)</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isScrollerFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">isScrollerFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">checkAndAbortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">checkAndAbortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onScrollChange</span><span class="token punctuation">(</span>distanceX<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">safeUpdateScrollPosition</span><span class="token punctuation">(</span>distanceX<span class="token punctuation">)</span>
                <span class="token function">updateScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onFling</span><span class="token punctuation">(</span>velocityX<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">fling</span><span class="token punctuation">(</span>velocityX<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// item空实现</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onComputeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后是header的GestureLayout，BaseHeaderGestureLayout</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">abstract</span> <span class="token keyword">class</span> BaseHeaderGestureLayout <span class="token annotation builtin">@JvmOverloads</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> defStyleAttr<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">FrameLayout</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> inflated <span class="token operator">=</span> <span class="token function">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollManager<span class="token operator">:</span> ScrollManager<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inflated<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">inflate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">getLayoutId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span><span class="token punctuation">(</span><span class="token operator">::</span>initLayout<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> scrollLayout <span class="token operator">=</span> <span class="token function">getScrollLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span><span class="token keyword">return</span>
        scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
            it<span class="token punctuation">.</span><span class="token function">addCandidate</span><span class="token punctuation">(</span>scrollLayout<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        scrollLayout<span class="token punctuation">.</span>onScrolleChangedListener <span class="token operator">=</span> <span class="token function">HeaderGestureLayoutOnScrollChangedListener</span><span class="token punctuation">(</span>scrollManager<span class="token punctuation">)</span>
        <span class="token keyword">val</span> globalLayoutListener <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ViewTreeObserver<span class="token punctuation">.</span><span class="token function">OnGlobalLayoutListener</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onGlobalLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scrollLayout<span class="token punctuation">.</span>viewTreeObserver<span class="token punctuation">.</span><span class="token function">removeOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

                scrollLayout<span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">var</span> measureParent<span class="token operator">:</span> ViewGroup <span class="token operator">=</span> <span class="token keyword">this</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>childCount <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">is</span> ViewGroup<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        measureParent <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ViewGroup
                    <span class="token punctuation">}</span>
                    <span class="token keyword">var</span> sChildWidth <span class="token operator">=</span> <span class="token number">0</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until measureParent<span class="token punctuation">.</span>childCount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        sChildWidth <span class="token operator">+=</span> measureParent<span class="token punctuation">.</span><span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>measuredWidth
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 在header里面计算最大滚动offset</span>
                    scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setMaxScrollOffset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sChildWidth <span class="token operator">-</span> measureParent<span class="token punctuation">.</span>measuredWidth<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        scrollLayout<span class="token punctuation">.</span>viewTreeObserver<span class="token punctuation">.</span><span class="token function">addOnGlobalLayoutListener</span><span class="token punctuation">(</span>globalLayoutListener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDetachedFromWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDetachedFromWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">clearScrollLayoutAndManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setScrollManager</span><span class="token punctuation">(</span>scrollManager<span class="token operator">:</span> ScrollManager<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scrollManager <span class="token operator">=</span> scrollManager
        <span class="token function">getScrollLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>onScrolleChangedListener <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                it<span class="token punctuation">.</span>onScrolleChangedListener <span class="token operator">=</span> <span class="token function">HeaderGestureLayoutOnScrollChangedListener</span><span class="token punctuation">(</span>scrollManager<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">clearScrollLayoutAndManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">getScrollLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>onScrolleChangedListener <span class="token operator">=</span> <span class="token keyword">null</span>
        scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
            it<span class="token punctuation">.</span><span class="token function">removeCandidate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            scrollManager <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">getLayoutId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">initLayout</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">getScrollLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> GestureLayout<span class="token operator">?</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token function">HeaderGestureLayoutOnScrollChangedListener</span><span class="token punctuation">(</span>scrollManager<span class="token operator">:</span> ScrollManager<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> GestureLayout<span class="token punctuation">.</span><span class="token function">OnScrolledChangedListener</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> scrollManagerWeakRef <span class="token operator">=</span> <span class="token function">WeakReference</span><span class="token punctuation">(</span>scrollManager<span class="token punctuation">)</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isScrollerFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">isScrollerFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">checkAndAbortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">checkAndAbortAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onScrollChange</span><span class="token punctuation">(</span>distanceX<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">safeUpdateScrollPosition</span><span class="token punctuation">(</span>distanceX<span class="token punctuation">)</span>
                <span class="token function">updateScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onFling</span><span class="token punctuation">(</span>velocityX<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">fling</span><span class="token punctuation">(</span>velocityX<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onComputeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// compute统一在这里做，不要让item去做</span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">updateScrollForScroller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scrollManagerWeakRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">draggingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为什么item是直接继承GestureLayout，而Header继承FrameLayout并提供一个layoutId？因为考虑到item是用在RecyclerView里面，担心需要频繁调用inflate方法，而Header是直接放到layout文件里面，稳定性比较高，一般不会出什么问题。<br> 此时，有人会想到，scroll的那些item和header完全一样，这个要怎么办？考虑到这个问题，我建议在开发时，这些view用一个layout文件编写。最外部的layout使用merge标签，这样就不会额外增加布局。然后分别在item和header的layout里面，通过include使用这个layout文件。从我上面提供的xml代码也可以看到，我在项目中，就是这样做的。这样就可以保证scrollView的一致性和可维护性。<br> <strong>TabAdapter</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> TableAdapter <span class="token operator">:</span>RecyclerView<span class="token punctuation">.</span>Adapter<span class="token operator">&lt;</span>TableAdapter<span class="token punctuation">.</span>ViewHolder<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> scrollManager<span class="token operator">:</span> ScrollManager<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreateViewHolder</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> ViewGroup<span class="token punctuation">,</span> viewType<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> ViewHolder <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">ViewHolder</span><span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>table_item_test<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span><span class="token punctuation">{<!-- --></span>vh <span class="token operator">-&gt;</span>
            scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
                vh<span class="token punctuation">.</span>scrollLayout<span class="token punctuation">.</span><span class="token function">setScrollManager</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">100</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> ViewHolder<span class="token punctuation">,</span> position<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        holder<span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">scrollSpecialView</span><span class="token punctuation">(</span>scrollLayout<span class="token punctuation">)</span>
            stickItemTv<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"stickItem</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">position</span></span><span class="token string">"</span></span>
            item1Tv<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"item</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">position</span></span><span class="token string">-1"</span></span>
            item2Tv<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"item</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">position</span></span><span class="token string">-2"</span></span>
            <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token function">ViewHolder</span><span class="token punctuation">(</span>itemView<span class="token operator">:</span> View<span class="token punctuation">)</span><span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span><span class="token function">ViewHolder</span><span class="token punctuation">(</span>itemView<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> scrollLayout<span class="token operator">:</span> ItemGestureLayout <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>scroll_layout<span class="token punctuation">)</span>
        <span class="token keyword">val</span> stickItemTv<span class="token operator">:</span> TextView <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>stick_item_tv<span class="token punctuation">)</span>
        <span class="token keyword">val</span> item1Tv<span class="token operator">:</span> TextView <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>data1_tv<span class="token punctuation">)</span>
        <span class="token keyword">val</span> item2Tv<span class="token operator">:</span> TextView <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>data2_tv<span class="token punctuation">)</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>table_item_test</strong></p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_height<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/white<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/stick_item_tv<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_width<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/black<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_text_size<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>View</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#cccccc<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGestureLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/scroll_layout<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@layout/merge_table_layout<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGestureLayout</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>HeaderLayout</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> HeaderLayout <span class="token annotation builtin">@JvmOverloads</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> defStyleAttr<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">BaseHeaderGestureLayout</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollLayout<span class="token operator">:</span> GestureLayout<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getLayoutId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token operator">=</span> R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>table_header_test

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">initLayout</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollLayout <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>scroll_layout<span class="token punctuation">)</span>
        <span class="token keyword">val</span> stickView<span class="token operator">:</span> TextView <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>stick_item_tv<span class="token punctuation">)</span>
        <span class="token keyword">val</span> data1View<span class="token operator">:</span> TextView <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>data1_tv<span class="token punctuation">)</span>
        <span class="token keyword">val</span> data2View<span class="token operator">:</span> TextView <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>data2_tv<span class="token punctuation">)</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>

        stickView<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"stick"</span></span>
        data1View<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"header1"</span></span>
        data2View<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"header2"</span></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getScrollLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> GestureLayout<span class="token operator">?</span> <span class="token operator">=</span> scrollLayout

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>table_header_test</strong></p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_height<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/white<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/stick_item_tv<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_width<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/black<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@dimen/table_item_text_size<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>View</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#cccccc<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GestureLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/scroll_layout<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@layout/merge_table_layout<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GestureLayout</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>Activity</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
    <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> scrollManager <span class="token operator">=</span> <span class="token function">ScrollManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    header_layout<span class="token punctuation">.</span><span class="token function">setScrollManager</span><span class="token punctuation">(</span>scrollManager<span class="token punctuation">)</span>
    <span class="token keyword">val</span> adapter <span class="token operator">=</span> <span class="token function">TableAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    adapter<span class="token punctuation">.</span>scrollManager <span class="token operator">=</span> scrollManager
    recycler<span class="token punctuation">.</span>adapter <span class="token operator">=</span> adapter
    recycler<span class="token punctuation">.</span>layoutManager <span class="token operator">=</span> <span class="token function">LinearLayoutManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>LinearLayoutManager<span class="token punctuation">.</span>VERTICAL<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>activity_layout</strong></p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HeaderLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/header_layout<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.recyclerview.widget.RecyclerView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/recycler<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>效果图<br> <img src="https://images2.imgbox.com/fd/27/qlLwBuhr_o.gif" alt="在这里插入图片描述"></p> 
<p>接下来解决滑动冲突的问题。为什么这个问题要憋到这里才说这么解决？因为只有将GestureLayout放到RecyclerView里面，这个问题才会特别明显，明显到影响正常使用。如果在上面编写GestureLayout就顺便加入解决的代码，那就对这个问题没什么感知。<br> 先看一看有问题的效果图<br> <img src="https://images2.imgbox.com/52/77/JrAjL0yj_o.gif" alt="在这里插入图片描述"><br> 可以看到，每次水平滑动时，只要有垂直滑动，就会打断水平滑动，体验起来非常糟心。解决方式也很简单，只要在GestureLayout加上requestDisallowInterceptTouchEvent就行，让RecyclerView不要拦截滑动事件。<br> <strong>GestureLayout</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>ev<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">when</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        MotionEvent<span class="token punctuation">.</span>ACTION_MOVE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> dx <span class="token operator">=</span> x <span class="token operator">-</span> initialTouchX
            lastTouchX <span class="token operator">=</span> x
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>dx<span class="token punctuation">)</span> <span class="token operator">&gt;</span> touchSlop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">initVelocityTrackerIfNoExits</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                velocityTracker<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addMovement</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span>
                scrollState <span class="token operator">=</span> SCROLL_STATE_DRAGGING
                <span class="token comment">// 新增的代码</span>
                parent<span class="token punctuation">.</span><span class="token function">requestDisallowInterceptTouchEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">,</span> ev<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">when</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        MotionEvent<span class="token punctuation">.</span>ACTION_MOVE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> dx <span class="token operator">=</span> lastTouchX <span class="token operator">-</span> x
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollState <span class="token operator">!=</span> SCROLL_STATE_DRAGGING <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>dx<span class="token punctuation">)</span> <span class="token operator">&gt;</span> touchSlop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scrollState <span class="token operator">=</span> SCROLL_STATE_DRAGGING
                <span class="token comment">// 新增的代码</span>
                parent<span class="token punctuation">.</span><span class="token function">requestDisallowInterceptTouchEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollState <span class="token operator">==</span> SCROLL_STATE_DRAGGING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                lastTouchX <span class="token operator">=</span> x
                onScrolleChangedListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onScrollChange</span><span class="token punctuation">(</span>dx<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
       <span class="token operator">..</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>也就加了2行代码，所以我就不贴图了，自己试一下就知道了。<br> 接下来解决一下clickArea的问题，不然这个View没办法做点击时间，所有事件都被onTouch方法消费了。而如果在onTouch里面处理onClick，又会让这个方法的代码变得比较复杂。<br> <strong>ItemGestureLayout</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">var</span> clickArea<span class="token operator">:</span> View<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token comment">// 为什么这里要判断clickArea为空才add，因为如果click不为空，add的是clickArea，不是当前View</span>
<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clickArea <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addCandidate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDetachedFromWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDetachedFromWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clickArea <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">removeCandidate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// setScrollManager方法可以删掉了，换成下面这个</span>
<span class="token keyword">fun</span> <span class="token function">setScrollManagerAndClickArea</span><span class="token punctuation">(</span>scrollManager<span class="token operator">:</span> ScrollManager<span class="token punctuation">,</span> clickArea<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scrollManager <span class="token operator">=</span> scrollManager
    <span class="token keyword">this</span><span class="token punctuation">.</span>clickArea <span class="token operator">=</span> clickArea
    onScrolleChangedListener <span class="token operator">=</span> <span class="token function">ItemGestureLayoutOnScrollChangedListener</span><span class="token punctuation">(</span>scrollManager<span class="token punctuation">)</span>
    clickArea<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addOnAttachStateChangeListener</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> View<span class="token punctuation">.</span><span class="token function">OnAttachStateChangeListener</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onViewAttachedToWindow</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 当clickArea attach时，add到ScrollManager</span>
            scrollManager<span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
                it<span class="token punctuation">.</span><span class="token function">addCandidate</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onViewDetachedFromWindow</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 当clickArea detach时，从ScrollManager remove</span>
            scrollManager<span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
                it<span class="token punctuation">.</span><span class="token function">removeCandidate</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>table_header_test的include代码外面，再套上一个LinearLayout，代码我就不提供了，看看adapter的代码。<br> <strong>TabAdapter</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> TableAdapter <span class="token operator">:</span>RecyclerView<span class="token punctuation">.</span>Adapter<span class="token operator">&lt;</span>TableAdapter<span class="token punctuation">.</span>ViewHolder<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreateViewHolder</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> ViewGroup<span class="token punctuation">,</span> viewType<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> ViewHolder <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">ViewHolder</span><span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>table_item_test<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span><span class="token punctuation">{<!-- --></span>vh <span class="token operator">-&gt;</span>
        scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 第2个参数传入clickArea</span>
            vh<span class="token punctuation">.</span>scrollLayout<span class="token punctuation">.</span><span class="token function">setScrollManagerAndClickArea</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> vh<span class="token punctuation">.</span>clickArea<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> ViewHolder<span class="token punctuation">,</span> position<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        holder<span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这里记得改为clickArea，不要使用scrollLayout</span>
            scrollManager<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">scrollSpecialView</span><span class="token punctuation">(</span>clickArea<span class="token punctuation">)</span>
            clickArea<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>itemView<span class="token punctuation">.</span>context<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"toast"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token function">ViewHolder</span><span class="token punctuation">(</span>itemView<span class="token operator">:</span> View<span class="token punctuation">)</span><span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span><span class="token function">ViewHolder</span><span class="token punctuation">(</span>itemView<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token keyword">val</span> clickArea<span class="token operator">:</span> View <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>click_area<span class="token punctuation">)</span>
        <span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>好了，剩下滚动条，上面在编写ScrollManager时，我就留出了相应的接口，所以只要实现接口的功能就可以了。<br> 滚动条我是使用RecyclerView的ItemDecoration实现，使用ItemDecoration的drawOver方法，就可以将滚动条绘制在RecyclerView的上面。<br> <strong>TabScrollBar</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">TabScrollBar</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> recyclerView<span class="token operator">:</span> RecyclerView<span class="token punctuation">)</span> <span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span><span class="token function">ItemDecoration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ScrollManager<span class="token punctuation">.</span><span class="token function">HorizontalScrollBar</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> barWidth <span class="token operator">=</span> <span class="token number">150f</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> barHeight <span class="token operator">=</span> <span class="token number">10f</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> barMarginHorizontal <span class="token operator">=</span> <span class="token number">20f</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> barMarginBottom <span class="token operator">=</span> <span class="token number">20f</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> barMarginFirstColumn <span class="token operator">=</span> TypedValue<span class="token punctuation">.</span><span class="token function">applyDimension</span><span class="token punctuation">(</span>TypedValue<span class="token punctuation">.</span>COMPLEX_UNIT_DIP<span class="token punctuation">,</span> <span class="token number">100f</span><span class="token punctuation">,</span> recyclerView<span class="token punctuation">.</span>context<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>displayMetrics<span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> scrollPosition <span class="token operator">=</span> <span class="token number">0f</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> isShowing <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> barShowingTime <span class="token operator">=</span> <span class="token number">500L</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> rect <span class="token operator">=</span> <span class="token function">RectF</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> paint <span class="token operator">=</span> <span class="token function">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
        it<span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
        it<span class="token punctuation">.</span>style <span class="token operator">=</span> Paint<span class="token punctuation">.</span>Style<span class="token punctuation">.</span>FILL
        it<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token number">0xffcccccc</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> handler <span class="token operator">=</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> dismissAction <span class="token operator">=</span> Runnable <span class="token punctuation">{<!-- --></span>
        isShowing <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// 必须通过RecyclerView的invalidate方法才能隐藏ScrollBar</span>
        <span class="token comment">// 原因是：ItemDecoration是在RecyclerView的draw方法绘制的，需要让RecyclerView刷新一次界面，才不会将不想出现的内容绘制出来</span>
        recyclerView<span class="token punctuation">.</span><span class="token function">postInvalidateOnAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDrawOver</span><span class="token punctuation">(</span>c<span class="token operator">:</span> Canvas<span class="token punctuation">,</span> parent<span class="token operator">:</span> RecyclerView<span class="token punctuation">,</span> state<span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span>State<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDrawOver</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
        <span class="token comment">// 如果不是showing，就return</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isShowing<span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> width <span class="token operator">=</span> parent<span class="token punctuation">.</span>width
        <span class="token keyword">val</span> height <span class="token operator">=</span> parent<span class="token punctuation">.</span>height
        <span class="token keyword">val</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> barMarginHorizontal <span class="token operator">-</span> barMarginFirstColumn<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> barWidth<span class="token punctuation">)</span> <span class="token operator">*</span> scrollPosition

        <span class="token keyword">val</span> left <span class="token operator">=</span> barMarginHorizontal <span class="token operator">+</span> barMarginFirstColumn<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> right <span class="token operator">=</span> left <span class="token operator">+</span> barWidth
        <span class="token keyword">val</span> bottom <span class="token operator">=</span> height <span class="token operator">-</span> barMarginBottom
        <span class="token keyword">val</span> top <span class="token operator">=</span> bottom <span class="token operator">-</span> barHeight

        rect<span class="token punctuation">.</span>left <span class="token operator">=</span> left
        rect<span class="token punctuation">.</span>top <span class="token operator">=</span> top
        rect<span class="token punctuation">.</span>right <span class="token operator">=</span> right
        rect<span class="token punctuation">.</span>bottom <span class="token operator">=</span> bottom

        <span class="token keyword">val</span> rx <span class="token operator">=</span> barHeight <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token keyword">val</span> ry <span class="token operator">=</span> barHeight <span class="token operator">/</span> <span class="token number">2</span>

        c<span class="token punctuation">.</span><span class="token function">drawRoundRect</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> rx<span class="token punctuation">,</span> ry<span class="token punctuation">,</span> paint<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">updateScrollWeight</span><span class="token punctuation">(</span>wieght<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        scrollPosition <span class="token operator">=</span> wieght
        isShowing <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token comment">// 这个invalidate是我自己写的，最终是调用RecyclerView.invalidateItemDecorations刷新ItemDecoration</span>
        <span class="token comment">// 通过这个方法，就可以实时更新scrollPosition</span>
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">startCountToHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        handler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>dismissAction<span class="token punctuation">)</span>
        handler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>dismissAction<span class="token punctuation">,</span> barShowingTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setBarWidth</span><span class="token punctuation">(</span>barWidth<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>barWidth <span class="token operator">==</span> barWidth<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>barWidth <span class="token operator">=</span> barWidth
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setBarHeight</span><span class="token punctuation">(</span>barHeight<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>barHeight <span class="token operator">==</span> barHeight<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight <span class="token operator">=</span> barHeight
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setBarMarginHorizontal</span><span class="token punctuation">(</span>barMarginHorizontal<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>barMarginHorizontal <span class="token operator">==</span> barMarginHorizontal<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>barMarginHorizontal <span class="token operator">=</span> barMarginHorizontal
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setBarMarginBottom</span><span class="token punctuation">(</span>barMarginBottom<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>barMarginBottom <span class="token operator">==</span> barMarginBottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>barMarginBottom <span class="token operator">=</span> barMarginBottom
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setBarMarginFirstColum</span><span class="token punctuation">(</span>barMarginFirstColumn<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>barMarginFirstColumn <span class="token operator">==</span> barMarginFirstColumn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>barMarginFirstColumn <span class="token operator">=</span> barMarginFirstColumn
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setBarShowingTime</span><span class="token punctuation">(</span>barShowingTime<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>barShowingTime <span class="token operator">=</span> barShowingTime
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setBarColor</span><span class="token punctuation">(</span>color<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>paint<span class="token punctuation">.</span>color <span class="token operator">==</span> color<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        paint<span class="token punctuation">.</span>color <span class="token operator">=</span> color
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        recyclerView<span class="token punctuation">.</span><span class="token function">invalidateItemDecorations</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>Activity</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">val</span> scrollBar <span class="token operator">=</span> <span class="token function">TabScrollBar</span><span class="token punctuation">(</span>recycler<span class="token punctuation">)</span>
recycler<span class="token punctuation">.</span><span class="token function">addItemDecoration</span><span class="token punctuation">(</span>scrollBar<span class="token punctuation">)</span>
scrollManager<span class="token punctuation">.</span><span class="token function">setScrollBar</span><span class="token punctuation">(</span>scrollBar<span class="token punctuation">)</span>
</code></pre> 
<p>效果图：<br> <img src="https://images2.imgbox.com/04/31/qwzSsdN2_o.gif" alt="在这里插入图片描述"><br> 可以看到，效果已经和最上面的图片一样了，实现方式还是比较简单的。<br><br> 好了通过上面这么多代码，就做出TabView。再提一下我在实际开发中关于TabView的开发规范吧。<br> <b>Adapter layout文件命名：</b>我这边使用的是table_item_xxx，这样别人一看，就知道这是一个和tab item有关的layout<br> <b>header文件命名：</b>table_header_xxx，和上面一样。<br> 而item和header的layout文件里面，stick的TextView用一个名称的textSize和textColor等参数，这样就可以保证UI改了，我们这边修改比较方便。而GestureLayout里面，使用include标签引入layout文件。item和header使用同一个layout文件，这样就可以降低维护成本。而这个layout文件的顶级标签是merge，所以在明明时，我用的是：merge_table_xxx。这样别人看到之后，就知道这是一个和table有关的merge layout。当然了，table_merge_xxx也可以，看个人或团队的具体情况。<br><br> 最后再总结一下：<br> <b>GestureLaout：</b>借助VelocityTacker和Scroller实现松开手指后惯性滑动的功能。Scroller本身不具备滑动的功能，最终实现还是需要用到View的scrollTo/ScrollBy方法。在这个过程中，需要借助View的computeScroll方法来一直调用scrollTo/scrollBy方法让View滚动起来。<br> <b>ScrollManager：</b>到了RecyclerView层面，就需要用一个Manager来控制所有item。所以GestureLayout就通过interface将touch操作暴露出去，让ScrollManager来统一调用所有的item进行滚动。而ScrollManager是怎么添加和移除item？是使用View的attch方法和detach方法。当View attch时，添加到Manager里面。detach时，从Manager移除。这样就保证了Manager里面不会存在多余的item。<br> <b>header：</b>直接在RecylerView上面放一个header layout，header layout里面，使用的也是GestureLayout，并add到Manager统一管理。这样当item滚动时，也能带着header一起滚动。<br> <b>拦截RecyclerView的事件：</b>如果不对RecyclerView的事件进行拦截，在水平滑动时，进行垂直滑动就会打断item滑动的功能。这种体验是非常糟糕的， 因为在实际使用时，很容易就触发这个。不过解决方式也很简单，只需要滑动时，调用requestDisallowInterceptTouchEvent方法让RecyclerView不要拦截touch事件即可。<br> <b>滚动条：</b>使用RecyclerView.ItemDecoration的drawOver方法，在RecyclerView上面绘制内容即可。如果需要更新滚动条的位置，就使用RecyclerView.invalidateItemDecorations方法，还是比较方便的。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/743092d0a0ef66755f093849ab5e1f98/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何将GIS地图和可视化结合使用实现更好的数据呈现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a9a68dfd7957e73e16bc46ab9d9c30fa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux内核：进程管理——进程挂起管理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>