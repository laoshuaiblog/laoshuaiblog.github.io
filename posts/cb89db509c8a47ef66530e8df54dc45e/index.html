<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Stable Diffusion训练图片时，简陋的数据处理 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/cb89db509c8a47ef66530e8df54dc45e/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Stable Diffusion训练图片时，简陋的数据处理">
  <meta property="og:description" content="0 图片从命名 如果有强迫症，看到似乎乱码的命名会不舒服，那么就批量从命名
import os def rename_files_in_directory(directory, key_word, new_suffix): i = 1 for filename in os.listdir(directory): new_file = key_word &#43; str(i).zfill(3) &#43; new_suffix source = os.path.join(directory, filename) destination = os.path.join(directory, new_file) os.rename(source, destination) i &#43;= 1 # 使用方法 # rename_files_in_directory(&#39;/path/to/directory&#39;, &#39;.new_suffix&#39;) # D:\SdTrainerGUI\lora-scripts-v1.7.3\train\XiboBird\5_zkz 1 批量缩小图片分辨率 如果是用同一个相机拍的，分辨率都是一样的，只不过分辨率太大了8K以上的分辨率显卡受不了
from PIL import Image import os def resize_image(image_path, output_path, scale_factor): # 打开图片 img = Image.open(image_path) # 获取图片的宽度和高度 width, height = img.size # 计算新的宽度和高度 new_width = width // scale_factor new_height = height // scale_factor # 使用ANTIALIAS滤镜来缩小图片 # new_img = img.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-20T15:25:26+08:00">
    <meta property="article:modified_time" content="2024-03-20T15:25:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Stable Diffusion训练图片时，简陋的数据处理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>0 图片从命名</h3> 
<p></p> 
<p>如果有强迫症，看到似乎乱码的命名会不舒服，那么就批量从命名</p> 
<p></p> 
<pre><code class="language-python">import os


def rename_files_in_directory(directory, key_word, new_suffix):
    i = 1
    for filename in os.listdir(directory):
        new_file = key_word + str(i).zfill(3) + new_suffix
        source = os.path.join(directory, filename)
        destination = os.path.join(directory, new_file)
        os.rename(source, destination)
        i += 1
# 使用方法
# rename_files_in_directory('/path/to/directory', '.new_suffix')
# D:\SdTrainerGUI\lora-scripts-v1.7.3\train\XiboBird\5_zkz</code></pre> 
<p></p> 
<h3>1 批量缩小图片分辨率</h3> 
<p></p> 
<p>如果是用同一个相机拍的，分辨率都是一样的，只不过分辨率太大了8K以上的分辨率显卡受不了</p> 
<p></p> 
<pre><code class="language-python">from PIL import Image
import os


def resize_image(image_path, output_path, scale_factor):
    # 打开图片
    img = Image.open(image_path)

    # 获取图片的宽度和高度
    width, height = img.size

    # 计算新的宽度和高度
    new_width = width // scale_factor
    new_height = height // scale_factor

    # 使用ANTIALIAS滤镜来缩小图片
    # new_img = img.resize((new_width, new_height), Image.ANTIALIAS)
    new_img = img.resize((new_width, new_height), Image.ANTIALIAS)

    # 保存新图片
    new_img.save(output_path)


def get_all_image(path, file_extension=".jpg"):
    return [os.path.join(path, f) for f in os.listdir(path) if f.endswith(file_extension)]


def process_images(catalog_of_original_images, file_extension, scale_factor):
    # 获取原始图像目录的上一级目录
    parent_directory = os.path.dirname(catalog_of_original_images)

    # 设置输出目录
    output_catalog = os.path.join(parent_directory, "output")

    # 创建输出目录
    if not os.path.exists(output_catalog):
        os.makedirs(output_catalog)

    image_list = get_all_image(catalog_of_original_images, file_extension)

    for image in image_list:
        # 获取图片的文件名
        image_name = os.path.basename(image)
        # 设置输出图片的路径
        output_image_path = os.path.join(output_catalog, image_name)
        # 缩小图片并保存
        resize_image(image, output_image_path, scale_factor)


if __name__ == '__main__':
    process_images(r"E:\Dwk\Photos\祥春鸟", ".jpg", 10)
</code></pre> 
<p></p> 
<h3>2 图片数据集增强</h3> 
<p></p> 
<p>最简易的增强是图片镜像，就是左右颠倒各一张，图片数据集数量直接翻倍</p> 
<p></p> 
<pre><code class="language-python">import os
from PIL import Image, ImageOps


def data_enhancement(image_catalog, file_extension=".jpg"):
    image_list = [os.path.join(image_catalog, f) for f in os.listdir(image_catalog) if f.endswith(file_extension)]
    for image in image_list:
        # 打开图片
        img = Image.open(image)
        # 创建镜像图片
        mirror_img = ImageOps.mirror(img)
        # 获取图片的文件名（不包括后缀）
        image_name = os.path.splitext(os.path.basename(image))[0]
        # 设置镜像图片的文件名
        mirror_image_name = image_name + "_mirror" + file_extension
        # 设置镜像图片的路径
        mirror_image_path = os.path.join(image_catalog, mirror_image_name)
        # 保存镜像图片
        mirror_img.save(mirror_image_path)


if __name__ == '__main__':
    data_enhancement(r"E:\Dwk\Photos\output", ".jpg")
</code></pre> 
<p></p> 
<h3>3 tag内容批量修改（这里是只替换）</h3> 
<p></p> 
<p>避免一个个文件打开逐个tag修改</p> 
<p></p> 
<pre><code class="language-python">import os


def replace_words_in_files(directory, old_word, new_word):
    # 获取指定目录下的所有文件
    files = os.listdir(directory)

    # 遍历所有文件
    for file in files:
        # 检查文件是否为.txt文件
        if file.endswith('.txt'):
            # 构建完整的文件路径
            file_path = os.path.join(directory, file)

            # 打开文件
            with open(file_path, 'r') as f:
                content = f.read()

            # 替换内容
            content = content.replace(old_word, new_word)

            # 写回文件
            with open(file_path, 'w') as f:
                f.write(content)


if __name__ == '__main__':
    replace_words_in_files(r'D:\SdTrainerGUI\lora-scripts-v1.7.3\train\PreprocessingOutput','girl','boy')</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ece8a2a1a2532ff5af60301018a3a2b9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">“未等待完成”在异步操作还没有完成时，就进行下一次操作，可能导致数据不一致或逻辑错误。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d9c979c9ed7a88b84732f947b94081e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue动态获取本地图片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>