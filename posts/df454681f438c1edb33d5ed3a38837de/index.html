<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python矩阵运算库效率_python - 布尔矩阵运算的最快方法_performance_酷徒编程知识库... - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/df454681f438c1edb33d5ed3a38837de/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="python矩阵运算库效率_python - 布尔矩阵运算的最快方法_performance_酷徒编程知识库...">
  <meta property="og:description" content="只需在compute中进行一些小的更改：def compute(m, n):
m = np.asarray(m)
n = np.asarray(n)
# Apply mask N in advance
m2 = m &amp;amp; n
# Pack booleans into uint8 for more efficient bitwise operations
# Also transpose for better caching (maybe?)
mb = np.packbits(m2.T, axis=1)
# Table with number of ones in each uint8
num_bits = (np.arange(256)[:, np.newaxis] &amp;amp; (1 &amp;lt;&amp;lt; np.arange(8))).astype(bool).sum(1)
# Allocate output array
out = np.zeros((m2.shape[1], m2.shape[1]), np.int32)
# Do the counting with Numba">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-02-10T21:25:41+08:00">
    <meta property="article:modified_time" content="2021-02-10T21:25:41+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python矩阵运算库效率_python - 布尔矩阵运算的最快方法_performance_酷徒编程知识库...</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>只需在compute中进行一些小的更改：def compute(m, n):</p> 
 <p>m = np.asarray(m)</p> 
 <p>n = np.asarray(n)</p> 
 <p># Apply mask N in advance</p> 
 <p>m2 = m &amp; n</p> 
 <p># Pack booleans into uint8 for more efficient bitwise operations</p> 
 <p># Also transpose for better caching (maybe?)</p> 
 <p>mb = np.packbits(m2.T, axis=1)</p> 
 <p># Table with number of ones in each uint8</p> 
 <p>num_bits = (np.arange(256)[:, np.newaxis] &amp; (1 &lt;&lt; np.arange(8))).astype(bool).sum(1)</p> 
 <p># Allocate output array</p> 
 <p>out = np.zeros((m2.shape[1], m2.shape[1]), np.int32)</p> 
 <p># Do the counting with Numba</p> 
 <p>_compute_nb(mb, num_bits, out)</p> 
 <p># Make output symmetric</p> 
 <p>out = out + out.T</p> 
 <p># Add values in diagonal</p> 
 <p>out[np.diag_indices_from(out)] = m2.sum(0)</p> 
 <p># Scale by number of ones in n</p> 
 <p>return out</p> 
 <p>我会使用一些Numba技巧。首先，您只能执行按列操作的一半，因为另一半是重复的。第三，可以使用多进程并行处理，总的来说，你可以这样做：import numpy as np</p> 
 <p>import numba as nb</p> 
 <p>def compute(m, n):</p> 
 <p>m = np.asarray(m)</p> 
 <p>n = np.asarray(n)</p> 
 <p># Pack booleans into uint8 for more efficient bitwise operations</p> 
 <p># Also transpose for better caching (maybe?)</p> 
 <p>mb = np.packbits(m.T, axis=1)</p> 
 <p># Table with number of ones in each uint8</p> 
 <p>num_bits = (np.arange(256)[:, np.newaxis] &amp; (1 &lt;&lt; np.arange(8))).astype(bool).sum(1)</p> 
 <p># Allocate output array</p> 
 <p>out = np.zeros((m.shape[1], m.shape[1]), np.int32)</p> 
 <p># Do the counting with Numba</p> 
 <p>_compute_nb(mb, num_bits, out)</p> 
 <p># Make output symmetric</p> 
 <p>out = out + out.T</p> 
 <p># Add values in diagonal</p> 
 <p>out[np.diag_indices_from(out)] = m.sum(0)</p> 
 <p># Scale by number of ones in n</p> 
 <p>out *= n.sum()</p> 
 <p>return out</p> 
 <p>@nb.njit(parallel=True)</p> 
 <p>def _compute_nb(mb, num_bits, out):</p> 
 <p># Go through each pair of columns without repetitions</p> 
 <p>for i in nb.prange(mb.shape[0] - 1):</p> 
 <p>for j in nb.prange(1, mb.shape[0]):</p> 
 <p># Count common bits</p> 
 <p>v = 0</p> 
 <p>for k in range(mb.shape[1]):</p> 
 <p>v += num_bits[mb[i, k] &amp; mb[j, k]]</p> 
 <p>out[i, j] = v</p> 
 <p># Test</p> 
 <p>m = np.array([[ True, True, False, True],</p> 
 <p>[False, True, True, True],</p> 
 <p>[False, False, False, False],</p> 
 <p>[False, True, False, False],</p> 
 <p>[ True, True, False, False]])</p> 
 <p>n = np.array([[ True],</p> 
 <p>[False],</p> 
 <p>[ True],</p> 
 <p>[ True],</p> 
 <p>[ True]])</p> 
 <p>out = compute(m, n)</p> 
 <p>print(out)</p> 
 <p># [[ 8 8 0 4]</p> 
 <p># [ 8 16 4 8]</p> 
 <p># [ 0 4 4 4]</p> 
 <p># [ 4 8 4 8]]</p> 
 <p>快速比较，这是针对原始循环和仅NumPy的方法的一个小型基准:import numpy as np</p> 
 <p># Original loop</p> 
 <p>def compute_loop(m, n):</p> 
 <p>out = np.zeros((m.shape[1], m.shape[1]), np.int32)</p> 
 <p>for i in range(m.shape[1]):</p> 
 <p>for j in range(m.shape[1]):</p> 
 <p>result = m[:, i] &amp; m[:, j]</p> 
 <p>out[i, j] = np.sum(result &amp; n)</p> 
 <p>return out</p> 
 <p># Divakar methods</p> 
 <p>def compute2(m, n):</p> 
 <p>return np.einsum('ij,ik,lm-&gt;jk', m, m.astype(int), n)</p> 
 <p>def compute3(m, n):</p> 
 <p>return np.einsum('ij,ik-&gt;jk',m, m.astype(int)) * n.sum()</p> 
 <p>def compute4(m, n):</p> 
 <p>return np.tensordot(m, m.astype(int),axes=((0,0))) * n.sum()</p> 
 <p>def compute5(m, n):</p> 
 <p>return m.T.dot(m.astype(int))*n.sum()</p> 
 <p># Make random data</p> 
 <p>np.random.seed(0)</p> 
 <p>m = np.random.rand(1000, 100) &gt; .5</p> 
 <p>n = np.random.rand(1000, 1) &gt; .5</p> 
 <p>print(compute(m, n).shape)</p> 
 <p># (100, 100)</p> 
 <p>%timeit compute(m, n)</p> 
 <p># 768 µs ± 17.5 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)</p> 
 <p>%timeit compute_loop(m, n)</p> 
 <p># 11 s ± 1.23 s per loop (mean ± std. dev. of 7 runs, 1 loop each)</p> 
 <p>%timeit compute2(m, n)</p> 
 <p># 7.65 s ± 1.06 s per loop (mean ± std. dev. of 7 runs, 1 loop each)</p> 
 <p>%timeit compute3(m, n)</p> 
 <p># 23.5 ms ± 1.53 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</p> 
 <p>%timeit compute4(m, n)</p> 
 <p># 8.96 ms ± 194 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</p> 
 <p>%timeit compute5(m, n)</p> 
 <p># 8.35 ms ± 266 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f652c6cf428a502048f2f49d0d06e84d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">我的西皮优学习笔记（五）-＞二进制及其表示法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ae8b2a551a1604acfd674e1875544db9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java 引用被回收_Java 中的四种引用及垃圾回收策略</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>