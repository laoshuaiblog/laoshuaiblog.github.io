<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CAS流程简析 服务端校验Ticket - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/f7173477dfe53e38c589f3c87ec937ce/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="CAS流程简析 服务端校验Ticket">
  <meta property="og:description" content="相关阅读 CAS基础组件 简介CAS流程简析 服务端处理未携带Service登录请求CAS流程简析 服务端处理携带Service登录请求CAS基础组件 客户端过滤器 简介 用户访问客户端的请求若携带Ticket信息，经过客户端配置的过滤器Cas30ProxyReceivingTicketValidationFilter时，该过滤器会将请求中携带的Ticket信息发送到服务端进行校验，若校验通过，才返回鉴权结果；
简析 Cas30ProxyReceivingTicketValidationFilter发送到服务端的请求路径为：/p3/serviceValidate，对应服务端的处理器为V3ServiceValidateController，核心代码如下：
@Component(&#34;v3ServiceValidateController&#34;) @Controller public class V3ServiceValidateController extends AbstractServiceValidateController { /** * Handle model and view. * * @param request the request * @param response the response * @return the model and view * @throws Exception the exception */ @RequestMapping(path=&#34;/p3/serviceValidate&#34;, method = RequestMethod.GET) protected ModelAndView handle(final HttpServletRequest request, final HttpServletResponse response) throws Exception { return super.handleRequestInternal(request, response); } @Override @Autowired public void setValidationSpecificationClass(@Value(&#34;">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-02-07T23:07:31+08:00">
    <meta property="article:modified_time" content="2022-02-07T23:07:31+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CAS流程简析 服务端校验Ticket</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>相关阅读</h2> 
<ul><li><a href="https://blog.csdn.net/xing_hung/article/details/122753234">CAS基础组件 简介</a></li><li><a href="https://blog.csdn.net/xing_hung/article/details/122753271">CAS流程简析 服务端处理未携带Service登录请求</a></li><li><a href="https://blog.csdn.net/xing_hung/article/details/122753284">CAS流程简析 服务端处理携带Service登录请求</a></li><li><a href="https://blog.csdn.net/xing_hung/article/details/122753256">CAS基础组件 客户端过滤器</a></li></ul> 
<h2><a id="_6"></a>简介</h2> 
<p>用户访问客户端的请求若携带Ticket信息，经过客户端配置的过滤器<code>Cas30ProxyReceivingTicketValidationFilter</code>时，该过滤器会将请求中携带的<code>Ticket</code>信息发送到服务端进行校验，若校验通过，才返回鉴权结果；</p> 
<h2><a id="_9"></a>简析</h2> 
<p><code>Cas30ProxyReceivingTicketValidationFilter</code>发送到服务端的请求路径为：<code>/p3/serviceValidate</code>，对应服务端的处理器为<code>V3ServiceValidateController</code>，核心代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"v3ServiceValidateController"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">V3ServiceValidateController</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractServiceValidateController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * Handle model and view.
     *
     * @param request the request
     * @param response the response
     * @return the model and view
     * @throws Exception the exception
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">"/p3/serviceValidate"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token class-name">ModelAndView</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleRequestInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValidationSpecificationClass</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"org.jasig.cas.validation.Cas20WithoutProxyingValidationSpecification"</span><span class="token punctuation">)</span>
                                                <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> validationSpecificationClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setValidationSpecificationClass</span><span class="token punctuation">(</span>validationSpecificationClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFailureView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"cas3ServiceFailureView"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">String</span> failureView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setFailureView</span><span class="token punctuation">(</span>failureView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSuccessView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"cas3ServiceSuccessView"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">String</span> successView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setSuccessView</span><span class="token punctuation">(</span>successView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProxyHandler</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"proxy20Handler"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">ProxyHandler</span> proxyHandler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setProxyHandler</span><span class="token punctuation">(</span>proxyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>V3ServiceValidateController</code>校验<code>Ticket</code>方法来源于父类<code>AbstractServiceValidateController</code>的<code>handleRequestInternal</code>方法，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">ModelAndView</span> <span class="token function">handleRequestInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从请求中获取Service信息</span>
    <span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> service <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentExtractor<span class="token punctuation">.</span><span class="token function">extractService</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取ST ID</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> serviceTicketId <span class="token operator">=</span> service <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> service<span class="token punctuation">.</span><span class="token function">getArtifactId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 校验Service和ST ID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> serviceTicketId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Could not identify service and/or service ticket for service: [{}]"</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_REQUEST<span class="token punctuation">,</span>
                <span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_REQUEST<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取pgtUrl的鉴权结果</span>
        <span class="token comment">// 代理模式涉及，本例不涉及</span>
        <span class="token class-name">TicketGrantingTicket</span> proxyGrantingTicketId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Credential</span> serviceCredential <span class="token operator">=</span> <span class="token function">getServiceCredentialsFromRequest</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceCredential <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            proxyGrantingTicketId <span class="token operator">=</span> <span class="token function">handleProxyGrantingTicketDelivery</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">,</span> serviceCredential<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyGrantingTicketId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_PROXY_CALLBACK<span class="token punctuation">,</span>
                        <span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_PROXY_CALLBACK<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>serviceCredential<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 校验ST ID</span>
        <span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centralAuthenticationService<span class="token punctuation">.</span><span class="token function">validateServiceTicket</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 校验认证结果</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">validateAssertion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> serviceTicketId<span class="token punctuation">,</span> assertion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_TICKET<span class="token punctuation">,</span>
                    <span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_TICKET<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取proxyIou</span>
        <span class="token comment">// 代理模式涉及，本例不涉及</span>
        <span class="token class-name">String</span> proxyIou <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceCredential <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>proxyHandler<span class="token punctuation">.</span><span class="token function">canHandle</span><span class="token punctuation">(</span>serviceCredential<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            proxyIou <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>proxyHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>serviceCredential<span class="token punctuation">,</span> proxyGrantingTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>proxyIou<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_PROXY_CALLBACK<span class="token punctuation">,</span>
                        <span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>ERROR_CODE_INVALID_PROXY_CALLBACK<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>serviceCredential<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 校验成功时处理</span>
        <span class="token function">onSuccessfulValidation</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">,</span> assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Successfully validated service ticket {} for service [{}]"</span><span class="token punctuation">,</span> serviceTicketId<span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建成功视图</span>
        <span class="token keyword">return</span> <span class="token function">generateSuccessView</span><span class="token punctuation">(</span>assertion<span class="token punctuation">,</span> proxyIou<span class="token punctuation">,</span> service<span class="token punctuation">,</span> proxyGrantingTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractTicketValidationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> code <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> code<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>serviceTicketId<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getOriginalService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractTicketException</span> te<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span>te<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> te<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>serviceTicketId<span class="token punctuation">}</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">UnauthorizedProxyingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>service<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">UnauthorizedServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">generateErrorView</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主要逻辑如下：</p> 
<ol><li>获取并校验<code>Service</code>信息和ST ID；</li><li>获取pgtUrl；</li><li>校验ST ID；</li><li>校验认证结果；</li><li>获取proxyIou；</li><li>创建视图；</li></ol> 
<h3><a id="1_ServiceST_ID_134"></a>1 获取并校验Service信息和ST ID</h3> 
<p>首先分析从request中如何获取<code>Service</code>和ST ID，代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"defaultArgumentExtractor"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">ArgumentExtractor</span> argumentExtractor<span class="token punctuation">;</span>

<span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> service <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentExtractor<span class="token punctuation">.</span><span class="token function">extractService</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> serviceTicketId <span class="token operator">=</span> service <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> service<span class="token punctuation">.</span><span class="token function">getArtifactId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>defaultArgumentExtractor</code>对应的是<code>DefaultArgumentExtractor</code>，其<code>extractService</code>继承自父类<code>AbstractArgumentExtractor</code>，<code>AbstractArgumentExtractor</code>实现了<code>extractService</code>的算法模板，提供算法细节<code>extractServiceInternal</code>由子类实现实现，还提供了<code>serviceFactoryList</code>供子类实现使用，其代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> <span class="token function">extractService</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从request中抽取Service信息</span>
    <span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> service <span class="token operator">=</span> <span class="token function">extractServiceInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// log</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Extractor did not generate service."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Extractor generated service for: {}"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> service<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">WebApplicationService</span> <span class="token function">extractServiceInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"serviceFactoryList"</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">WebApplicationService</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> serviceFactoryList<span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">WebApplicationService</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServiceFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> serviceFactoryList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>serviceFactoryList</code>的配置如下：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- services-context.xml --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">util:</span>list</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>serviceFactoryList<span class="token punctuation">"</span></span> <span class="token attr-name">value-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.jasig.cas.authentication.principal.ServiceFactory<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webApplicationServiceFactory<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">util:</span>list</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><code>DefaultArgumentExtractor</code>实现了算法细节<code>extractServiceInternal</code>，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">WebApplicationService</span> <span class="token function">extractServiceInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ServiceFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">WebApplicationService</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">:</span> <span class="token function">getServiceFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> service <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createService</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建成功则直接返回</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Created {} based on {}"</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> service<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"No service could be extracted based on the given request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>webApplicationServiceFactory</code>对应的是<code>WebApplicationServiceFactory</code>，其<code>createService</code>方法代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">WebApplicationService</span> <span class="token function">createService</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> targetService <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>PARAMETER_TARGET_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> service <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>PARAMETER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> serviceAttribute <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>PARAMETER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>PARAMETER_METHOD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> format <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>PARAMETER_FORMAT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">String</span> serviceToUse<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>targetService<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 优先使用targetService</span>
        serviceToUse <span class="token operator">=</span> targetService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 其次使用请求参数中的service </span>
        serviceToUse <span class="token operator">=</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 最后使用请求属性中的service</span>
        serviceToUse <span class="token operator">=</span> serviceAttribute<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 校验service信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>serviceToUse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 去除jsession信息</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> id <span class="token operator">=</span> <span class="token class-name">AbstractServiceFactory</span><span class="token punctuation">.</span><span class="token function">cleanupUrl</span><span class="token punctuation">(</span>serviceToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取请求参数中的ticket信息，并将其作为Service的artifactId</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> artifactId <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>PARAMETER_TICKET<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">Response<span class="token punctuation">.</span>ResponseType</span> type <span class="token operator">=</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Response<span class="token punctuation">.</span>ResponseType</span><span class="token punctuation">.</span>POST
            <span class="token operator">:</span> <span class="token class-name">Response<span class="token punctuation">.</span>ResponseType</span><span class="token punctuation">.</span>REDIRECT<span class="token punctuation">;</span>

    <span class="token comment">// 创建SimpleWebApplicationServiceImpl</span>
    <span class="token keyword">final</span> <span class="token class-name">SimpleWebApplicationServiceImpl</span> webApplicationService <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">SimpleWebApplicationServiceImpl</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> serviceToUse<span class="token punctuation">,</span>
                    artifactId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WebApplicationServiceResponseBuilder</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 若请求参数中存在format信息，则设置该属性</span>
            <span class="token keyword">final</span> <span class="token class-name">ValidationResponseType</span> formatType <span class="token operator">=</span> <span class="token class-name">ValidationResponseType</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            webApplicationService<span class="token punctuation">.</span><span class="token function">setFormat</span><span class="token punctuation">(</span>formatType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Format specified in the request [{}] is not recognized"</span><span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> webApplicationService<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>WebApplicationServiceFactory</code>创建的<code>Service</code>为<code>SimpleWebApplicationServiceImpl</code>，支持单点登出；</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SimpleWebApplicationServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractWebApplicationService</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractWebApplicationService</span> <span class="token keyword">implements</span> <span class="token class-name">SingleLogoutService</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SingleLogoutService</span> <span class="token keyword">extends</span> <span class="token class-name">WebApplicationService</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WebApplicationService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span>
</code></pre> 
<h3><a id="2_pgtUrl_255"></a>2 获取pgtUrl</h3> 
<p>根据请求中的pgtUrl信息获取对应的鉴权结果，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">Credential</span> <span class="token function">getServiceCredentialsFromRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> service<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取请求中的"pgtUrl"参数</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> pgtUrl <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">CasProtocolConstants</span><span class="token punctuation">.</span>PARAMETER_PROXY_CALLBACK_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>pgtUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// pgtUrl参数存在</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取对应的已注册Service信息</span>
            <span class="token keyword">final</span> <span class="token class-name">RegisteredService</span> registeredService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servicesManager<span class="token punctuation">.</span><span class="token function">findServiceBy</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 校验已注册Service属性</span>
            <span class="token function">verifyRegisteredServiceProperties</span><span class="token punctuation">(</span>registeredService<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpBasedServiceCredential</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>pgtUrl<span class="token punctuation">)</span><span class="token punctuation">,</span> registeredService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error constructing pgtUrl"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>代理模式涉及该处理，本例不涉及；</p> 
<h3><a id="3_ST_ID_280"></a>3 校验ST ID</h3> 
<p>从request请求中获取到ST ID，需要对其进行校验，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centralAuthenticationService<span class="token punctuation">.</span><span class="token function">validateServiceTicket</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"centralAuthenticationService"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">CentralAuthenticationService</span> centralAuthenticationService<span class="token punctuation">;</span>
</code></pre> 
<p><code>centralAuthenticationService</code>对应的是<code>CentralAuthenticationServiceImpl</code>，其<code>validateServiceTicket</code>方法代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Assertion</span> <span class="token function">validateServiceTicket</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> serviceTicketId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AbstractTicketException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 根据Service信息获取已注册Service信息</span>
    <span class="token keyword">final</span> <span class="token class-name">RegisteredService</span> registeredService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servicesManager<span class="token punctuation">.</span><span class="token function">findServiceBy</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 校验已注册Service属性</span>
    <span class="token function">verifyRegisteredServiceProperties</span><span class="token punctuation">(</span>registeredService<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据ST ID获取ST</span>
    <span class="token keyword">final</span> <span class="token class-name">ServiceTicket</span> serviceTicket <span class="token operator">=</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>ticketRegistry<span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">,</span> <span class="token class-name">ServiceTicket</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 校验ST</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceTicket <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Service ticket [{}] does not exist."</span><span class="token punctuation">,</span> serviceTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTicketException</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>serviceTicket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ST是否过期</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceTicket<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"ServiceTicket [{}] has expired."</span><span class="token punctuation">,</span> serviceTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTicketException</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// ST是否支持当前Service</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceTicket<span class="token punctuation">.</span><span class="token function">isValidFor</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Service ticket [{}] with service [{}] does not match supplied service [{}]"</span><span class="token punctuation">,</span>
                        serviceTicketId<span class="token punctuation">,</span> serviceTicket<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnrecognizableServiceForServiceTicketValidationException</span><span class="token punctuation">(</span>serviceTicket<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取ST对应的TGT</span>
        <span class="token keyword">final</span> <span class="token class-name">TicketGrantingTicket</span> root <span class="token operator">=</span> serviceTicket<span class="token punctuation">.</span><span class="token function">getGrantingTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取鉴权结果</span>
        <span class="token keyword">final</span> <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token function">getAuthenticationSatisfiedByPolicy</span><span class="token punctuation">(</span>
                root<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ServiceContext</span><span class="token punctuation">(</span>serviceTicket<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registeredService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取Principal</span>
        <span class="token keyword">final</span> <span class="token class-name">Principal</span> principal <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">RegisteredServiceAttributeReleasePolicy</span> attributePolicy <span class="token operator">=</span> registeredService<span class="token punctuation">.</span><span class="token function">getAttributeReleasePolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Attribute policy [{}] is associated with service [{}]"</span><span class="token punctuation">,</span> attributePolicy<span class="token punctuation">,</span> registeredService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributesToRelease <span class="token operator">=</span> attributePolicy <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">?</span> attributePolicy<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span>EMPTY_MAP<span class="token punctuation">;</span>
        
        <span class="token keyword">final</span> <span class="token class-name">String</span> principalId <span class="token operator">=</span> registeredService<span class="token punctuation">.</span><span class="token function">getUsernameAttributeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolveUsername</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Principal</span> modifiedPrincipal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principalFactory<span class="token punctuation">.</span><span class="token function">createPrincipal</span><span class="token punctuation">(</span>principalId<span class="token punctuation">,</span> attributesToRelease<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">AuthenticationBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">DefaultAuthenticationBuilder</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">setPrincipal</span><span class="token punctuation">(</span>modifiedPrincipal<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建认证结果</span>
        <span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableAssertion</span><span class="token punctuation">(</span>
                builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                serviceTicket<span class="token punctuation">.</span><span class="token function">getGrantingTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChainedAuthentications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                serviceTicket<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                serviceTicket<span class="token punctuation">.</span><span class="token function">isFromNewLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 发布ST校验成功事件</span>
        <span class="token function">doPublishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CasServiceTicketValidatedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> serviceTicket<span class="token punctuation">,</span> assertion<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 返回认证结果</span>
        <span class="token keyword">return</span> assertion<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceTicket<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ticketRegistry<span class="token punctuation">.</span><span class="token function">deleteTicket</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主要逻辑如下：</p> 
<ol><li>根据Service信息获取已注册Service信息并校验；</li><li>根据ST ID获取ST；</li><li>校验ST；</li><li>创建认证结果；</li></ol> 
<h4><a id="31_ServiceService_368"></a>3.1 根据Service信息获取已注册Service信息并校验</h4> 
<p>代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">RegisteredService</span> registeredService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servicesManager<span class="token punctuation">.</span><span class="token function">findServiceBy</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">ServicesManager</span> servicesManager<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setServicesManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"servicesManager"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">ServicesManager</span> servicesManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>servicesManager <span class="token operator">=</span> servicesManager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>servicesManager</code>对应的是<code>DefaultServicesManagerImpl</code>，<code>findServiceBy</code>方法的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">RegisteredService</span> <span class="token function">findServiceBy</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegisteredService</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">convertToTreeSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历注册的Service</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RegisteredService</span> r <span class="token operator">:</span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 若匹配则返回该注册的Service</span>
            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegisteredService</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToTreeSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">RegisteredService</span><span class="token punctuation">&gt;</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">RegisteredService</span><span class="token punctuation">&gt;</span></span> localServices <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 借助this.serviceRegistryDao加载注册Service信息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RegisteredService</span> r <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceRegistryDao<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Adding registered service {}"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localServices<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>services <span class="token operator">=</span> localServices<span class="token punctuation">;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Loaded {} services from {}."</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceRegistryDao<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">DefaultServicesManagerImpl</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"serviceRegistryDao"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">ServiceRegistryDao</span> serviceRegistryDao<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serviceRegistryDao <span class="token operator">=</span> serviceRegistryDao<span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>ServiceRegistryDao</code>接口有多种实现，可根据实际需求，在配置文件中自行配置该接口的实现；以<code>InMemoryServiceRegistryDaoImpl</code>为例，分析<code>load</code>方法实现，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegisteredService</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registeredServices<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getAutowireCapableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token string">"inMemoryServiceRegistryDao"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果配置了"inMemoryServiceRegistryDao"</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{} is used as the active service registry dao"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 从IOC容器中找到"inMemoryRegisteredServices"的配置</span>
            <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegisteredService</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RegisteredService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"inMemoryRegisteredServices"</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Loaded {} services from the application context for {}"</span><span class="token punctuation">,</span>
                    list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>registeredServices <span class="token operator">=</span> list<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"No registered services are defined for {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>inMemoryRegisteredServices</code>配置信息举例如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">util:</span>list</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>inMemoryRegisteredServices<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.jasig.cas.services.RegexRegisteredService<span class="token punctuation">"</span></span>
          <span class="token attr-name"><span class="token namespace">p:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">p:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP and IMAP<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">p:</span>description</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Allows HTTP(S) and IMAP(S) protocols<span class="token punctuation">"</span></span>
          <span class="token attr-name"><span class="token namespace">p:</span>serviceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>^(https?|imaps?)://.*<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">p:</span>evaluationOrder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10000001<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>attributeReleasePolicy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.jasig.cas.services.ReturnAllAttributeReleasePolicy<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">util:</span>list</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>常用的<code>RegisteredService</code>接口的实现类为<code>RegexRegisteredService</code>，支持正则表达式，其<code>match</code>方法实现代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>servicePattern <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>servicePattern <span class="token operator">=</span> <span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">createPattern</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据serviceId的正则规则进行匹配</span>
    <span class="token keyword">return</span> service <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servicePattern <span class="token operator">!=</span> <span class="token keyword">null</span>
            <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servicePattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="32_ST_IDST_480"></a>3.2 根据ST ID获取ST</h4> 
<p>代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">ServiceTicket</span> serviceTicket <span class="token operator">=</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>ticketRegistry<span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span>serviceTicketId<span class="token punctuation">,</span> <span class="token class-name">ServiceTicket</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"ticketRegistry"</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token class-name">TicketRegistry</span> ticketRegistry<span class="token punctuation">;</span>
</code></pre> 
<p><code>TicketRegistry</code>由用户配置，可以看下<code>DefaultTicketRegistry</code>的实现，<code>getTicket</code>方法由<code>AbstractTicketRegistry</code>实现了算法模板，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ticket</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> ticketId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Ticket</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"clazz cannot be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">Ticket</span> ticket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span>ticketId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clazz<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>ticket<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassCastException</span><span class="token punctuation">(</span><span class="token string">"Ticket ["</span> <span class="token operator">+</span> ticket<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token string">" is of type "</span> <span class="token operator">+</span> ticket<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token string">" when we were expecting "</span> <span class="token operator">+</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> ticket<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>DefaultTicketRegistry</code>使用内存中的Map存储<code>Ticket</code>信息，其<code>getTicket</code>方法的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Ticket</span> <span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> ticketId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ticketId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Attempting to retrieve ticket [{}]"</span><span class="token punctuation">,</span> ticketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Ticket</span> ticket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Ticket [{}] found in registry."</span><span class="token punctuation">,</span> ticketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ticket<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="33_ST_528"></a>3.3 校验ST</h4> 
<h5><a id="331_ST_529"></a>3.3.1 ST是否过期</h5> 
<p><code>ServiceTicketImpl</code>的<code>isExpired</code>方法继承自父类<code>AbstractTicket</code>，<code>AbstractTicket</code>实现了<code>isExpired</code>的算法模板，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">TicketGrantingTicket</span> tgt <span class="token operator">=</span> <span class="token function">getGrantingTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expirationPolicy<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span>tgt <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> tgt<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token function">isExpiredInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">TicketGrantingTicket</span> <span class="token function">getGrantingTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticketGrantingTicket<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isExpiredInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>this.expirationPolicy</code>属性由<code>DefaultServiceTicketFactory</code>创建<code>ServiceTicketImpl</code>时传入，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">ServiceTicket</span> serviceTicket <span class="token operator">=</span> ticketGrantingTicket<span class="token punctuation">.</span><span class="token function">grantServiceTicket</span><span class="token punctuation">(</span>
        ticketId<span class="token punctuation">,</span>
        service<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceTicketExpirationPolicy<span class="token punctuation">,</span>
        credentialsProvided<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onlyTrackMostRecentSession<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"serviceTicketExpirationPolicy"</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token class-name">ExpirationPolicy</span> serviceTicketExpirationPolicy<span class="token punctuation">;</span>
</code></pre> 
<p><code>serviceTicketExpirationPolicy</code>可由用户自行配置，默认配置如下：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- deployerConfigContext.xml --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alias</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ticketGrantingTicketExpirationPolicy<span class="token punctuation">"</span></span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grantingTicketExpirationPolicy<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alias</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multiTimeUseOrTimeoutExpirationPolicy<span class="token punctuation">"</span></span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>serviceTicketExpirationPolicy<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p><code>multiTimeUseOrTimeoutExpirationPolicy</code>对应的是<code>MultiTimeUseOrTimeoutExpirationPolicy</code>，其<code>isExpired</code>方法代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// 默认超时时间为10s</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"#{${st.timeToKillInSeconds:10}*1000L}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeToKillInMilliSeconds<span class="token punctuation">;</span>

<span class="token comment">// 默认为1</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${st.numberOfUses:1}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> numberOfUses<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">TicketState</span> ticketState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ticketState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Ticket state is null for {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 校验ST的使用数</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> countUses <span class="token operator">=</span> ticketState<span class="token punctuation">.</span><span class="token function">getCountOfUses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>countUses <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfUses<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Ticket usage count {} is greater than or equal to {}"</span><span class="token punctuation">,</span> countUses<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfUses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">long</span> systemTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> lastTimeUsed <span class="token operator">=</span> ticketState<span class="token punctuation">.</span><span class="token function">getLastTimeUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> difference <span class="token operator">=</span> systemTime <span class="token operator">-</span> lastTimeUsed<span class="token punctuation">;</span>

    <span class="token comment">// 校验ST的超时时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>difference <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeToKillInMilliSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Ticket has expired because the difference between current time [{}] "</span>
            <span class="token operator">+</span> <span class="token string">"and ticket time [{}] is greater than or equal to [{}]"</span><span class="token punctuation">,</span> systemTime<span class="token punctuation">,</span> lastTimeUsed<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>timeToKillInMilliSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>st.timeToKillInSeconds</code>和<code>st.numberOfUses</code>可在<code>cas.properties</code>文件中配置；</p> 
<h5><a id="332_STService_608"></a>3.3.2 ST是否支持当前Service</h5> 
<p>代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValidFor</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Service</span> serviceToValidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 更新ST的访问记录</span>
    <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    <span class="token keyword">return</span> serviceToValidate<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// AbstractWebApplicationService.java</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> thisUrl <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> serviceUrl <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Decoded urls and comparing [{}] with [{}]"</span><span class="token punctuation">,</span> thisUrl<span class="token punctuation">,</span> serviceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> thisUrl<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>serviceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="34__636"></a>3.4 创建认证结果</h4> 
<p>ST校验通过后，根据ST找到对应的TGT，从而找到对应的鉴权结果，然后将创建认证结果；</p> 
<h3><a id="4__639"></a>4 校验认证结果</h3> 
<p>代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">validateAssertion</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> serviceTicketId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">ValidationSpecification</span> validationSpecification <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommandClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ServletRequestDataBinder</span> binder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRequestDataBinder</span><span class="token punctuation">(</span>validationSpecification<span class="token punctuation">,</span> <span class="token string">"validationSpecification"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initBinder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> binder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    binder<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 是否满足特定校验要求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationSpecification<span class="token punctuation">.</span><span class="token function">isSatisfiedBy</span><span class="token punctuation">(</span>assertion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Service ticket [{}] does not satisfy validation specification."</span><span class="token punctuation">,</span> serviceTicketId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ValidationSpecification</span> <span class="token function">getCommandClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ValidationSpecification</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>validationSpecificationClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> validationSpecificationClass <span class="token operator">=</span> <span class="token class-name">Cas20ProtocolValidationSpecification</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
</code></pre> 
<p>默认使用的是<code>Cas20ProtocolValidationSpecification</code>，其<code>isSatisfiedBy</code>方法继承自父类<code>AbstractCasProtocolValidationSpecification</code>，<code>AbstractCasProtocolValidationSpecification</code>实现了<code>isSatisfiedBy</code>的算法模板，并提供算法细节<code>isSatisfiedByInternal</code>由子类实现，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isSatisfiedBy</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">isSatisfiedByInternal</span><span class="token punctuation">(</span>assertion<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>renew <span class="token operator">||</span> assertion<span class="token punctuation">.</span><span class="token function">isFromNewLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">isSatisfiedByInternal</span><span class="token punctuation">(</span><span class="token class-name">Assertion</span> assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>Cas20ProtocolValidationSpecification</code>实现了算法细节<code>isSatisfiedByInternal</code>，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isSatisfiedByInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5_proxyIou_684"></a>5 获取proxyIou</h3> 
<p>本例不涉及；</p> 
<h3><a id="6__687"></a>6 创建视图</h3> 
<p>代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">ModelAndView</span> <span class="token function">generateSuccessView</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> proxyIou<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> service<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> <span class="token class-name">TicketGrantingTicket</span> proxyGrantingTicket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">final</span> <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token function">getModelAndView</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>

    modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token class-name">CasViewConstants</span><span class="token punctuation">.</span>MODEL_ATTRIBUTE_NAME_ASSERTION<span class="token punctuation">,</span> assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token class-name">CasViewConstants</span><span class="token punctuation">.</span>MODEL_ATTRIBUTE_NAME_SERVICE<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token class-name">CasViewConstants</span><span class="token punctuation">.</span>MODEL_ATTRIBUTE_NAME_PROXY_GRANTING_TICKET_IOU<span class="token punctuation">,</span> proxyIou<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyGrantingTicket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token class-name">CasViewConstants</span><span class="token punctuation">.</span>MODEL_ATTRIBUTE_NAME_PROXY_GRANTING_TICKET<span class="token punctuation">,</span> proxyGrantingTicket<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> augmentedModelObjects <span class="token operator">=</span> <span class="token function">augmentSuccessViewModelObjects</span><span class="token punctuation">(</span>assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>augmentedModelObjects <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addAllObjects</span><span class="token punctuation">(</span>augmentedModelObjects<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ModelAndView</span> <span class="token function">getModelAndView</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> isSuccess<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">WebApplicationService</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ValidationResponseType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span>DEFAULT_SERVICE_VIEW_NAME_JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span>isSuccess <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>successView <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failureView<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>this.successView</code>和<code>this.failureView</code>被<code>V3ServiceValidateController</code>重写，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFailureView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"cas3ServiceFailureView"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">String</span> failureView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setFailureView</span><span class="token punctuation">(</span>failureView<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSuccessView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"cas3ServiceSuccessView"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">String</span> successView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setSuccessView</span><span class="token punctuation">(</span>successView<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="61__730"></a>6.1 成功视图</h4> 
<p><code>cas3ServiceSuccessView</code>的配置如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"cas3ServiceSuccessView"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Success</span> <span class="token keyword">extends</span> <span class="token class-name">Cas30ResponseView</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * Instantiates a new Success.
     * @param view the view
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">Success</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"cas3JstlSuccessView"</span><span class="token punctuation">)</span>
                   <span class="token keyword">final</span> <span class="token class-name">AbstractUrlBasedView</span> view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setSuccessResponse</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>cas3JstlSuccessView</code>的配置如下：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- protocolViewsConfiguration.xml --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cas3JstlSuccessView<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.web.servlet.view.JstlView<span class="token punctuation">"</span></span>
      <span class="token attr-name"><span class="token namespace">c:</span>url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/WEB-INF/view/jsp/protocol/3.0/casServiceValidationSuccess.jsp<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p><code>casServiceValidationSuccess.jsp</code>文件的内容如下：</p> 
<pre><code class="prism language-jsp">&lt;%@ page session="false" contentType="application/xml; charset=UTF-8" %&gt;
&lt;%@ page import="java.util.*, java.util.Map.Entry" %&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %&gt;
&lt;cas:serviceResponse xmlns:cas='http://www.yale.edu/tp/cas'&gt;
    &lt;cas:authenticationSuccess&gt;
        &lt;cas:user&gt;${fn:escapeXml(principal.id)}&lt;/cas:user&gt;
        &lt;c:if test="${not empty pgtIou}"&gt;
            &lt;cas:proxyGrantingTicket&gt;${pgtIou}&lt;/cas:proxyGrantingTicket&gt;
        &lt;/c:if&gt;
        &lt;c:if test="${fn:length(chainedAuthentications) &gt; 0}"&gt;
            &lt;cas:proxies&gt;
                &lt;c:forEach var="proxy" items="${chainedAuthentications}" varStatus="loopStatus" begin="0"
                           end="${fn:length(chainedAuthentications)}" step="1"&gt;
                    &lt;cas:proxy&gt;${fn:escapeXml(proxy.principal.id)}&lt;/cas:proxy&gt;
                &lt;/c:forEach&gt;
            &lt;/cas:proxies&gt;
        &lt;/c:if&gt;

        &lt;c:if test="${fn:length(attributes) &gt; 0}"&gt;
            &lt;cas:attributes&gt;
                &lt;c:forEach var="attr"
                           items="${attributes}"
                           varStatus="loopStatus" begin="0"
                           end="${fn:length(attributes)}"
                           step="1"&gt;

                    &lt;c:forEach var="attrval" items="${attr.value}"&gt;
                        &lt;cas:${fn:escapeXml(attr.key)}&gt;${fn:escapeXml(attrval)}&lt;/cas:${fn:escapeXml(attr.key)}&gt;
                    &lt;/c:forEach&gt;
                &lt;/c:forEach&gt;
            &lt;/cas:attributes&gt;
        &lt;/c:if&gt;

    &lt;/cas:authenticationSuccess&gt;
&lt;/cas:serviceResponse&gt;
</code></pre> 
<p>本例中，服务端只会将principal.id信息返回给客户端；</p> 
<h4><a id="62__797"></a>6.2 失败视图</h4> 
<p><code>cas3ServiceFailureView</code>的配置如下：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- protocolViewsConfiguration.xml --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cas3ServiceFailureView<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.web.servlet.view.JstlView<span class="token punctuation">"</span></span>
      <span class="token attr-name"><span class="token namespace">c:</span>url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/WEB-INF/view/jsp/protocol/3.0/casServiceValidationFailure.jsp<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p><code>casServiceValidationFailure.jsp</code>文件的内容如下：</p> 
<pre><code class="prism language-jsp">&lt;%@ page session="false" contentType="application/xml; charset=UTF-8" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;cas:serviceResponse xmlns:cas='http://www.yale.edu/tp/cas'&gt;
    &lt;cas:authenticationFailure code='${code}'&gt;
            ${fn:escapeXml(description)}
    &lt;/cas:authenticationFailure&gt;
&lt;/cas:serviceResponse&gt;
</code></pre> 
<p>服务端将错误码和错误信息返回给客户端；</p> 
<p>至此，服务端校验<code>Ticket</code>流程结束。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/091cd750de4546bb225f9bef56228aa7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端 - 用div仿输入框，解决鼠标点击位置错乱的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/252b678fac133f6b27bd47938b64d2e7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Nginx命令stop或者quit停止服务器无效失效</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>