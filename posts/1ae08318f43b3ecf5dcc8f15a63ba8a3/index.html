<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CMDB可插拔式项目架构（一） - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/1ae08318f43b3ecf5dcc8f15a63ba8a3/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="CMDB可插拔式项目架构（一）">
  <meta property="og:description" content="目录分布 ----bin
----start.py
----conf
----setting.py （用户自定义部分）
----files
----board.text
----……………
----disk.text
（一些死数据，DEBUG模式下使用）
----lib （用于存放类库文件，常见内外部工具包）
----config
----global_settings.py （默认全局配置）
----settings.py （配置类对象）
----src （源码目录）
----plugins （插件目录，可插拔组件）
----init.py
----basic.py
----cpu.py
----disk.py
----memory.py
----nic.py
----test
—test1 （存放测试文件的目录）
start.py
from lib.config.settings import settings from src.plugins import basic,cpu,disk,memory,nic from src.plugins import PluginsManager #会自动执行__init__文件 if __name__ == &#39;__main__&#39;: pluginsManagerObj = PluginsManager() result = pluginsManagerObj.excute() print(result) setting.py
### 自定义的配置 MODE = &#39;ssh&#39; DEBUG = True #可插拔式 PLUGINS_DICT = { &#39;basic&#39;:&#39;src.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-06-25T21:10:54+08:00">
    <meta property="article:modified_time" content="2019-06-25T21:10:54+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CMDB可插拔式项目架构（一）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>目录分布</h2> 
<p>----bin<br>           ----start.py<br> ----conf<br>           ----setting.py （用户自定义部分）<br> ----files<br>           ----board.text<br>           ----……………<br>           ----disk.text<br>           （一些死数据，DEBUG模式下使用）<br> ----lib （用于存放类库文件，常见内外部工具包）<br>           ----config<br>                     ----global_settings.py （默认全局配置）<br>                     ----settings.py （配置类对象）<br> ----src （源码目录）<br>           ----plugins （插件目录，可插拔组件）<br>                     ----<strong>init</strong>.py<br>                     ----<strong>basic</strong>.py<br>                     ----<strong>cpu</strong>.py<br>                     ----<strong>disk</strong>.py<br>                     ----<strong>memory</strong>.py<br>                     ----<strong>nic</strong>.py<br> ----test<br>           —test1 （存放测试文件的目录）</p> 
<p><a href="http://start.py" rel="nofollow">start.py</a></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> lib<span class="token punctuation">.</span>config<span class="token punctuation">.</span>settings <span class="token keyword">import</span>  settings
<span class="token keyword">from</span> src<span class="token punctuation">.</span>plugins <span class="token keyword">import</span> basic<span class="token punctuation">,</span>cpu<span class="token punctuation">,</span>disk<span class="token punctuation">,</span>memory<span class="token punctuation">,</span>nic
<span class="token keyword">from</span> src<span class="token punctuation">.</span>plugins <span class="token keyword">import</span> PluginsManager <span class="token comment">#会自动执行__init__文件</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    pluginsManagerObj <span class="token operator">=</span> PluginsManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> pluginsManagerObj<span class="token punctuation">.</span>excute<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</code></pre> 
<p><a href="http://setting.py" rel="nofollow">setting.py</a></p> 
<pre><code class="prism language-python"><span class="token comment">### 自定义的配置</span>


MODE <span class="token operator">=</span> <span class="token string">'ssh'</span>

DEBUG <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token comment">#可插拔式</span>
PLUGINS_DICT <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'basic'</span><span class="token punctuation">:</span><span class="token string">'src.plugins.basic.Basic'</span><span class="token punctuation">,</span>
    <span class="token comment"># 'cpu':'src.plugins.cpu.Cpu',</span>
    <span class="token comment"># 'disk':'src.plugins.disk.Disk',</span>
    <span class="token comment"># 'memory':'src.plugins.memory.Memory',</span>
    <span class="token comment"># 'nic':'src.plugins.nic.Nic'</span>
<span class="token punctuation">}</span>

<span class="token comment">#SSH专用</span>
SSH_USER <span class="token operator">=</span> <span class="token string">'root'</span>
SSH_PWD <span class="token operator">=</span> <span class="token string">'1'</span>
SSH_PORT <span class="token operator">=</span> <span class="token number">22</span>
</code></pre> 
<p><a href="http://settings.py" rel="nofollow">settings.py</a></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> conf <span class="token keyword">import</span> setting
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> global_settings


<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment">### 集成默认配置文件中的配置</span>
        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>global_settings<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> key<span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                v <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>global_settings<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
                <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> v<span class="token punctuation">)</span>   <span class="token comment">#把符合条件的key和value绑定到self上</span>

        <span class="token comment">### 集成自定义配置文件中的配置</span>
        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> key<span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                v <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>setting<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
                <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> v<span class="token punctuation">)</span>

    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">hostname</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> setting<span class="token punctuation">.</span>MODE <span class="token operator">==</span> <span class="token string">'SSH'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>hostname <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'mypc'</span><span class="token punctuation">]</span> <span class="token comment">#TODO：这里写从API服务器获取需要远程链接的用户列表</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>hostname


settings <span class="token operator">=</span> Settings<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>__init__.py （采集配置文件中的插件）</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> lib<span class="token punctuation">.</span>config<span class="token punctuation">.</span>settings <span class="token keyword">import</span> settings  <span class="token comment">#实例化的settings配置类对象</span>
<span class="token keyword">import</span> importlib
<span class="token keyword">class</span> <span class="token class-name">PluginsManager</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>hostname<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>plugins_dict <span class="token operator">=</span> settings<span class="token punctuation">.</span>PLUGINS_DICT
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span>settings<span class="token punctuation">.</span>MODE
        self<span class="token punctuation">.</span>debug <span class="token operator">=</span> settings<span class="token punctuation">.</span>DEBUG
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'ssh'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>hostname <span class="token operator">=</span> settings<span class="token punctuation">.</span>hostname
            self<span class="token punctuation">.</span>port <span class="token operator">=</span> settings<span class="token punctuation">.</span>SSH_PORT
            self<span class="token punctuation">.</span>username <span class="token operator">=</span> settings<span class="token punctuation">.</span>SSH_USER
            self<span class="token punctuation">.</span>password <span class="token operator">=</span> settings<span class="token punctuation">.</span>SSH_PWD


    <span class="token comment">### 管理配置文件中采集的插件</span>
    <span class="token keyword">def</span> <span class="token function">excute</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#获得setting配置中用户自定义的PLUGINS_DICT,查看有哪些PLUGIN需要遍历。</span>
        <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> self<span class="token punctuation">.</span>plugins_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># print(k,v)</span>
            module_name<span class="token punctuation">,</span>class_name <span class="token operator">=</span> v<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">#以最右边的"."作分割符，做次数为1的分割。</span>
            <span class="token comment">### 将一个包以字符串形式导入</span>
            module_path <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>module_name<span class="token punctuation">)</span>
            cls <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>module_path<span class="token punctuation">,</span>class_name<span class="token punctuation">)</span> <span class="token comment">#获得 src.plugins.basic下的 Basic类对象</span>
            collect <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>process<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_cmd_run<span class="token punctuation">,</span>self<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token comment">#实例化后运行process 进行采集</span>
            self<span class="token punctuation">.</span>response<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> collect

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>response


    <span class="token keyword">def</span> <span class="token function">_cmd_run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'agent'</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> subprocess
            res <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>getoutput<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
            ipinfo <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>  <span class="token comment"># 省略切割代码</span>
            <span class="token keyword">return</span> ipinfo
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'ssh'</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> paramiko
            <span class="token comment"># 创建SSH对象</span>
            ssh <span class="token operator">=</span> paramiko<span class="token punctuation">.</span>SSHClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 允许连接不在know_hosts文件中的主机</span>
            ssh<span class="token punctuation">.</span>set_missing_host_key_policy<span class="token punctuation">(</span>paramiko<span class="token punctuation">.</span>AutoAddPolicy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 连接服务器</span>
            ssh<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>hostname<span class="token operator">=</span>self<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span> port<span class="token operator">=</span>self<span class="token punctuation">.</span>port<span class="token punctuation">,</span> username<span class="token operator">=</span>self<span class="token punctuation">.</span>username<span class="token punctuation">,</span> password<span class="token operator">=</span>self<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
            <span class="token comment"># 执行命令</span>
            stdin<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr <span class="token operator">=</span> ssh<span class="token punctuation">.</span>exec_command<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
            <span class="token comment"># 获取命令结果</span>
            result <span class="token operator">=</span> stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 关闭连接</span>
            ssh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> result
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'salt'</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> subprocess
            res <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>getoutput<span class="token punctuation">(</span><span class="token string">"salt '%s' cmd.run 'ifconfig'"</span><span class="token operator">%</span>cmd<span class="token punctuation">)</span>
            <span class="token keyword">return</span> res
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"当前仅支持模式agent、ssh、salt三种模式"</span><span class="token punctuation">)</span>

</code></pre> 
<p><a href="http://basic.py" rel="nofollow">basic.py</a></p> 
<pre><code class="prism language-python"><span class="token comment">###采集服务器基本的信息,包含&lt;平台、系统版本、主机名&gt;等</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span>Base <span class="token keyword">import</span> Base
<span class="token keyword">class</span> <span class="token class-name">Basic</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>command_func<span class="token punctuation">,</span>debug<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment">#command_func传入Linux 下的cmd命令，debug为是否为调试模式（调试模式就用死数据）</span>
        <span class="token keyword">if</span> debug<span class="token punctuation">:</span>
            output <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'os_platform'</span><span class="token punctuation">:</span><span class="token string">'Linux'</span><span class="token punctuation">,</span>
                <span class="token string">'os_version'</span><span class="token punctuation">:</span><span class="token string">'CentOS release 6.6 (Final)\n Kernel \r on an \m'</span><span class="token punctuation">,</span>
                <span class="token string">'hostname'</span><span class="token punctuation">:</span><span class="token string">'mypc'</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'os_platform'</span><span class="token punctuation">:</span>command_func<span class="token punctuation">(</span><span class="token string">'uname'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'os_version'</span><span class="token punctuation">:</span>command_func<span class="token punctuation">(</span><span class="token string">'cat /etc/issue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">'hostname'</span><span class="token punctuation">:</span>command_func<span class="token punctuation">(</span><span class="token string">'hostname'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">return</span> output
    <span class="token keyword">def</span> <span class="token function">parse_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">### 具体清洗数据</span>
        <span class="token keyword">pass</span>
</code></pre> 
<h4><a id="_188"></a>知识点总结：</h4> 
<p>该项目模仿Django写了一个可插拔式的数据采集系统，实现了以下几个功能</p> 
<ul><li>用户自定义配置，用户不定义的就执行默认的<code>global_setting</code>代码贴出的为简易版本未提供默认配置，可据此修改完善。</li><li>可自定义采集内容，如果不需要采集，在配置文件中注释即可。首先在plugins下的<code>__init__.py</code>启动文件下定义了一个 <code>PluginsManager</code>对象，把<code>settings</code>这个配置类对象的中需要的数据用<code>self.attr = settings.strr</code>的方式传入<code>PluginsManager</code>对象,然后在把配置文件下的<code>PLUGINS_DICT</code>解析成字符串后， <code>for</code>循环读取用户定义的配置，利用<code>importlib</code>模块下的<code>import_module</code>方法导入<code>src</code>–<code>plugin</code>下的类对象获得数据，具体做法是在<code>for</code>循环中执行<code>类对象.process</code>,并且传入<code>_cmd_run</code>函数以及<code>debug</code>参数，这里需要注意一下，内部函数<code>_cmd_run</code>是一个内存地址，它以实参的方式传入每个<code>plugin插件下的py文件(eg:basic.py)</code>,<code>basic.py</code>中以<code>形参()</code>执行了<code>_cmd_run</code>并把取得的数据存入response中，并且返回。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/78dcc286aa3d4f2190dab0774c0aa9d7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java 反射</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6312432f57825faa8efc418c004651da/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用sklearn中的k-means方法就行聚类，并统计每个簇内样本点的数目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>