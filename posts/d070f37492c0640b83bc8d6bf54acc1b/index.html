<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android Activity 、 Window 、 View之间的关系 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/d070f37492c0640b83bc8d6bf54acc1b/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Android Activity 、 Window 、 View之间的关系">
  <meta property="og:description" content="本想分析一下触摸事件的分发响应机制，但是发现分发事件的方法在Activity、View以及ViewGroup中各自存在 ，如图1表所示
图一
这样的话又牵扯到了三者之间的关系，那索性先理清楚Activity与另外两者的关系 ，在去分析触摸事件比较好。
什么是Activity 、View 、 Window？ Activity：是Android 四大组件之一， 是存放View对象的容器，也是我们界面的载体，可以用来展示一个界面。它有一个SetContentView（）方法 ，可以将我们定义的布局设置到界面上。
View：就是一个个视图的对象，实现了KeyEvent.Callback和Drawable.Callback。
Window：是一个抽象类，是一个顶层的窗口，它的唯一实例是PhoneWindow它提供标准的用户界面策略，如背景、标题、区域，默认按键处理等。
分析下三者之间的关系吧 View包含很多，TextView 、Imageview 、Listview 、 Button..就是一个一个展示不同图形的对象。我们可以把view通过xml布局，或者通过new View(),然后通过addview方法或动态或静态添加到Activity的布局上。我们都知道我们定义了layout布局，通过SetContentView就可以设置到Activity上，而Activity中的SetContentView()方法,又调用了Window的SetContentView方法，也就是View通过Activity最终添加到了Window上面。
那我们今天就看一下这个方法到底如何把layout布局加载进去，到底加载到哪里去了？
/** * Set the activity content from a layout resource. The resource will be * inflated, adding all top-level views to the activity. * * @param layoutResID Resource ID to be inflated. * * @see #setContentView(android.view.View) * @see #setContentView(android.view.View, android.view.ViewGroup.LayoutParams) */ public void setContentView(@LayoutRes int layoutResID) { getWindow().">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2015-10-28T13:28:39+08:00">
    <meta property="article:modified_time" content="2015-10-28T13:28:39+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android Activity 、 Window 、 View之间的关系</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="font-family:SimHei; font-size:14px">    </span><span style="font-family:SimHei; font-size:14px">本想分析一下触摸事件的分发响应机制，但是发现分发事件的方法在Activity、View以及ViewGroup中各自存在 ，如图1表所示</span></p> 
<p><strong><span style="font-family:SimHei; font-size:14px"><img src="https://images2.imgbox.com/a8/d4/oSYQltLH_o.png" width="500" height="200" alt=""><br><br></span></strong></p> 
<p><span style="font-family:SimHei; font-size:14px">                                     图一</span></p> 
<p><span style="font-family:SimHei; font-size:14px">这样的话又牵扯到了三者之间的关系，那索性先理清楚Activity与另外两者的关系 ，在去分析触摸事件比较好。</span></p> 
<h3><span style="font-family:SimHei; font-size:14px">什么是Activity 、View 、 Window？</span></h3> 
<p><span style="font-family:SimHei; font-size:14px"></span></p> 
<p><span style="font-size:14px; font-family:SimHei"><strong><span style="white-space:pre"></span>Activity：</strong></span><span style="font-family:SimHei; font-size:14px">是Android 四大组件之一， 是存放View对象的容器，也是我们界面的载体，可以用来展示一个界面。它有一个SetContentView（）方法 ，可以将我们定义的布局设置到界面上。</span></p> 
<p><span style="font-size:14px; font-family:SimHei"><strong>View：</strong></span><span style="font-family:SimHei; font-size:14px">就是一个个视图的对象，实现了KeyEvent.Callback和Drawable.Callback。</span></p> 
<p><span style="font-size:14px; font-family:SimHei"><strong><span style="white-space:pre"></span>Window：</strong></span><span style="font-family:SimHei; font-size:14px">是一个抽象类，是一个顶层的窗口，它的唯一实例是PhoneWindow它提供标准的用户界面策略，如背景、标题、区域，默认按键处理等。</span></p> 
<p><span style="white-space:pre"><span style="font-family:SimHei; font-size:14px"></span></span></p> 
<h3><span style="font-family:SimHei; font-size:14px">分析下三者之间的关系吧</span></h3> 
<p><span style="font-family:SimHei; font-size:14px">      View包含很多，TextView 、Imageview  、Listview 、 Button..<span style="white-space:pre"></span>就是一个一个展示不同图形的对象。我们可以把view通过xml布局，或者通过new View(),然后通过addview方法或动态或静态添加到Activity的布局上。我们都知道我们定义了layout布局，通过SetContentView就可以设置到Activity上，而Activity中的SetContentView()方法,又调用了Window的SetContentView方法，也就是View通过Activity最终添加到了Window上面。</span></p> 
<p><span style="font-family:SimHei; font-size:14px">那我们今天就看一下这个方法到底如何把layout布局加载进去，到底加载到哪里去了？</span></p> 
<p></p> 
<pre><code class="language-java">   /**
     * Set the activity content from a layout resource.  The resource will be
     * inflated, adding all top-level views to the activity.
     *
     * @param layoutResID Resource ID to be inflated.
     *
     * @see #setContentView(android.view.View)
     * @see #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)
     */
    public void setContentView(@LayoutRes int layoutResID) {
        getWindow().setContentView(layoutResID);
        initWindowDecorActionBar();
    }

</code></pre> 
<p></p> 
<p><span style="font-family:SimHei; font-size:14px"><br></span></p> 
<span style="font-family:SimHei; font-size:14px">上面注释写的很清楚，通过一个layout资源给Activity设置内容，资源将被添加到Activity最顶层的View上也就是调用了方法体中的getWindow().set方法，首先这里getWindow() 拿到的是一个Window的子类，PhoneWindow的实例，那么这个Window对象是在哪里 赋值的呢，我们在Activity中找到attach方法如下所示：</span> 
<p><span style="font-family:SimHei; font-size:14px"></span></p> 
<pre><code class="language-java">final void attach(Context context, ActivityThread aThread,
            Instrumentation instr, IBinder token, int ident,
            Application application, Intent intent, ActivityInfo info,
            CharSequence title, Activity parent, String id,
            NonConfigurationInstances lastNonConfigurationInstances,
            Configuration config, String referrer, IVoiceInteractor voiceInteractor) {
        attachBaseContext(context);

        mFragments.attachHost(null /*parent*/);

        mWindow = new PhoneWindow(this);
        mWindow.setCallback(this);
        mWindow.setOnWindowDismissedCallback(this);
        mWindow.getLayoutInflater().setPrivateFactory(this);
        if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) {
            mWindow.setSoftInputMode(info.softInputMode);
        }
        if (info.uiOptions != 0) {
            mWindow.setUiOptions(info.uiOptions);
        }
        mUiThread = Thread.currentThread();

        mMainThread = aThread;
        mInstrumentation = instr;
        mToken = token;
        mIdent = ident;
        mApplication = application;
        mIntent = intent;
        mReferrer = referrer;
        mComponent = intent.getComponent();
        mActivityInfo = info;
        mTitle = title;
        mParent = parent;
        mEmbeddedID = id;
        mLastNonConfigurationInstances = lastNonConfigurationInstances;
        if (voiceInteractor != null) {
            if (lastNonConfigurationInstances != null) {
                mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor;
            } else {
                mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this,
                        Looper.myLooper());
            }
        }

        mWindow.setWindowManager(
                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),
                mToken, mComponent.flattenToString(),
                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);
        if (mParent != null) {
            mWindow.setContainer(mParent.getWindow());
        }
        mWindowManager = mWindow.getWindowManager();
        mCurrentConfig = config;
    }</code></pre> 
<br> 
<span style="font-family:SimHei; font-size:14px">在第11行初始化mWindow对象，这个对象是window 接口的实现类 PhoneWindow 的实例。</span> 
<p></p> 
<p><span style="font-family:SimHei; font-size:14px">　　那我们看一下PhoneWindow方法中的SetContentView方法代码如下所示：</span></p> 
<p><span style="font-family:SimHei; font-size:14px"></span></p> 
<pre><code class="language-java"> @Override
 public void setContentView(int layoutResID) {
         // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window
        // decor, when theme attributes and the like are crystalized. Do not check the feature
        // before this happens.
         if (mContentParent == null) {
             installDecor();
        } else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) {
            mContentParent.removeAllViews();
         }
 
         if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) {
             final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,
                     getContext());
             transitionTo(newScene);
        } else {
            mLayoutInflater.inflate(layoutResID, mContentParent);
        }
       final Callback cb = getCallback();
         if (cb != null &amp;&amp; !isDestroyed()) {
             cb.onContentChanged();
         }
     }</code></pre> 
<br> 
<span style="font-family:SimHei; font-size:14px">这里我们只看下第6和第11行，首先判断mContentParent是不是 null，我们先搞明白mContentParent是什么东西？</span> 
<p></p> 
<p><span style="font-family:SimHei; font-size:14px"></span></p> 
<pre><code class="language-java"> // This is the top-level view of the window, containing the window decor.
    private DecorView mDecor;

     // This is the view in which the window contents are placed. It is either
     // mDecor itself, or a child of mDecor where the contents go.
    private ViewGroup mContentParent;</code></pre> 
<p></p> 
<p><span style="font-family:SimHei; font-size:14px"><br></span></p> 
<span style="font-family:SimHei; font-size:14px">通过查看源代码 我们这里知道mContentParent是一个ViewGroup对象  ，上面的注释我们可以明白这个Window中的内容就放置在mContentParent上面， 这个mContentParent或者是一个DecorView对象或者是一个DecorView的子类。<br><br></span> 
<p><span style="font-family:SimHei; font-size:14px">OK，搞明白了mContentParent是一个ViewGroup对象 ，那我们继续往下看</span></p> 
<p><span style="font-family:SimHei; font-size:14px">如果是installDecor()不用想我们也知道这个方法肯定是初始化了mContentParent，一起看下是不是我们想的那样吧。</span></p> 
<p><span style="font-family:SimHei; font-size:14px"></span></p> 
<pre><code class="language-java">private void installDecor() {
        if (mDecor == null) {
            mDecor = generateDecor();
            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);
            mDecor.setIsRootNamespace(true);
            if (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != 0) {
                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);
            }
        }
        if (mContentParent == null) {
            mContentParent = generateLayout(mDecor);

            // Set up decor part of UI to ignore fitsSystemWindows if appropriate.
        //.....
		//...... 省略若干代码
        }
    }</code></pre> 
<br> 
<span style="font-family:SimHei; font-size:14px">  这里先判断 mDecor是不是null，如果是，初始化mDecor，然后判断mContentParent是不是null，如果是，通过mDecor去初始化 mContentParent对象。 对吧，跟我们想的一样是去初始化。</span> 
<p></p> 
<p><span style="font-family:SimHei; font-size:14px">  OK ，这里创建出了mContentParent对象，我们接着看PhoneWindow的SetContentView方法的第11行，这里先进行了判断，具体判断 我们先不关心，我们继续往下执行在看第12行或者17行，我们就清楚了我们在Activity中设置的layoutid 在这里加载到了mContentParent 上面。也就是所有的所有的View 对象都是加载到了mContentParent对象上面，而我们前面知道mContentParent是根据DecorView而来的，这样我们就清楚了Activity与Window以及View的关系，这里用图2 表示一下他们的关系。</span></p> 
<h3><span style="font-family:SimHei; font-size:14px">看图识关系</span></h3> 
<p><span style="font-family:SimHei; font-size:14px"><img src="https://images2.imgbox.com/2e/aa/u2Bk5FNC_o.png" alt=""><br></span></p> 
<p><span style="font-family:SimHei; font-size:14px">                 图二</span></p> 
<p><span style="font-family:SimHei; font-size:14px"><br></span></p> 
<h3><span style="font-family:SimHei; font-size:14px">对着这张图，打个比喻来帮助理解。</span></h3> 
<p><span style="font-family:SimHei; font-size:14px">   Activity就像是一扇贴着窗花的窗口，Window就想上窗口上面的玻璃，而View对象就像一个个贴在玻璃上的窗花。</span></p> 
<p><span style="font-family:SimHei; font-size:14px">最后的Activity与Window View的关联在画一个图3：</span></p> 
<p><span style="font-family:SimHei; font-size:14px"><img src="https://images2.imgbox.com/d7/12/QYS4tDSk_o.png" alt=""><br></span></p> 
<p><span style="font-family:SimHei; font-size:14px">                                               图三</span></p> 
<p><span style="font-family:SimHei; font-size:14px"></span></p> 
<p style="line-height:26px"><span style="font-family:SimHei; font-size:14px">  总结起来说就是 Activity会调用PhoneWindow的setContentView()将layout布局添加到DecorView上，而此时的DecorView就是那个最底层的View。然后通过LayoutInflater.infalte()方法加载布局生成View对象并通过addView()方法添加到Window上，（一层一层的叠加到Window上）所以，Activity其实不是显示视图，Window才是真正的显示视图。</span></p> 
<p style="line-height:26px"><span style="font-family:SimHei; font-size:14px">  注：一个Activity构造的时候只能初始化一个Window(PhoneWindow)，另外这个PhoneWindow有一个View容器 mContentParent，这个<br>View容器是一个ViewGroup，是最初始的跟视图，然后通过addView方法将View一个个层叠到<span style="line-height:26px">mContentParent</span>上，这些层叠的View最终放在Window这个载体上面。</span></p> 
<p style="line-height:26px"><span style="font-family:SimHei; font-size:14px">  OK 理清了Window Activity与View 的关系，接下来我们分析触摸事件的分发也会容易理解一些。</span></p> 
<p style="line-height:26px"><span style="color:#000099"><span style="font-family:SimHei; font-size:14px">  对于本文表达不到位，或者理解不到位的地方，欢迎朋友指正，感兴趣的朋友可以继续看下一篇Touch事件的分发响应：</span><span style="font-family:SimHei; font-size:14px"> <a target="_blank" href="http://blog.csdn.net/u011733020/article/details/49452109" rel="noopener noreferrer">http://blog.csdn.net/u011733020/article/details/49452109</a>。</span></span><br></p> 
<p style="line-height:26px"><span style="color:rgb(255,0,0)"><span style="font-family:SimHei; font-size:14px">----------------欢迎爱学习的小伙伴加群<br>--------------------android交流群：230274309<br>------------------------一起分享，一起进步！需要你们<br>------------------------------期待各位爱学习的小伙伴们的到来</span></span><br></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59587c5783a2d12666f1b51215d2be4f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">5G毫米波和超宽带信号的验证和测试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e1560e547a0983289fcf607a3a32106f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">R read.table Error:appears to contain embedded nulls</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>