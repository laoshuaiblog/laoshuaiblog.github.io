<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>BatchNorm的原理和计算实例 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/5b899e6135118b130826c944c8d6749a/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="BatchNorm的原理和计算实例">
  <meta property="og:description" content=" 关于这个问题，其实很多同学都会有疑问，因为在论文中是一系列的公式展开，其实并不是很好理解。 关于BN 其实BN操作的目地是使一批feature map 进行归一化，避免数据过大而导致网络性能的不稳定。我记得网有一篇博文中对BN有较详细的介绍，大概意思就是，输入数据经过若干层的网络输出其实会让数据特征分布和初始分布不一致，降低模型的泛化性能，引入BN机制后，先将特征变为标准正态分布，然后再通过γ和β两个参数将标准正态分布适当拉回归一化前的分布，相当于在原分布和标准正态分布进行折中，以此增强模型的泛化性。
BN的运算过程 这里假设特征图的格式为 (N,C,H,W) 类型，这里假设为 (2,2,2,2)类型的，比如下图，上下为两个通道，横向为两个特征图，每个特征图为 2*2 ，经过 BN后，最终结果为 右半部份。具体计算公式为：
即最终计算的时候，是将特征图中，同一批次中，按照通道进行归一化，每个样本的不同通道间是没什么关系的，不同样本的相同通道是符合同一个正态分布的。
Pytorch中的nn模块中的BatchNormal2d函数的实验 import torch import torch.nn as nn #num_features - num_features from an expected input of size:batch_size*num_features*height*width #eps:default:1e-5 (公式中为数值稳定性加到分母上的值) #momentum:动量参数，用于running_mean and running_var计算的值，default：0.1 input=torch.randn(2, 2, 3, 4) # 生成一个三维矩阵，bitch_size=2, C=2, H=3, W=4 m=nn.BatchNorm2d(2, affine=True) # 2为输入的通道数，affine参数设为True表示weight和bias将被使用，即 gamma 和 Beta output=m(input) # 批正则化变换 print(input) print(m.weight) # gamma print(m.bias) # Beta print(output) print(output.size()) 使用计算公式计算 print(input[:,0]) firstChannelMean=torch.Tensor.mean(input[:,0])#求2个样本第一通道的平均值 firstCVar=torch.Tensor.var(input[:,0],False)#求2个样本第一个通道的方差 batchNor=((input[0][0][0][0]-firstChannelMean)/(torch.pow(firstCVar,0.5)&#43;m.eps))*m.weight[0]&#43;m.bias[0] #普通的公式 print(batchNor) # 输出该位置对应的BN结果 以上即为BN操作的具体过程，想必会对您有一定的帮助！ ">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-11-20T21:11:53+08:00">
    <meta property="article:modified_time" content="2020-11-20T21:11:53+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">BatchNorm的原理和计算实例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="_0"></a>关于这个问题，其实很多同学都会有疑问，因为在论文中是一系列的公式展开，其实并不是很好理解。</h5> 
<p><img src="https://images2.imgbox.com/f6/01/gZ9Yvf2E_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="BN_2"></a>关于BN</h5> 
<blockquote> 
 <p>其实BN操作的目地是使一批feature map 进行归一化，避免数据过大而导致网络性能的不稳定。我记得网有一篇博文中对BN有较详细的介绍，大概意思就是，输入数据经过若干层的网络输出其实会让数据特征分布和初始分布不一致，降低模型的泛化性能，引入BN机制后，先将特征变为标准正态分布，然后再通过γ和β两个参数将标准正态分布适当拉回归一化前的分布，相当于在原分布和标准正态分布进行折中，以此增强模型的泛化性。</p> 
</blockquote> 
<h6><a id="BN_5"></a>BN的运算过程</h6> 
<blockquote> 
 <p>这里假设特征图的格式为 (N,C,H,W) 类型，这里假设为 (2,2,2,2)类型的，比如下图，上下为两个通道，横向为两个特征图，每个特征图为 2*2 ，经过 BN后，最终结果为 右半部份。具体计算公式为：<br> <img src="https://images2.imgbox.com/f9/63/iXotueYd_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/78/fb/R3DsqmIX_o.png" alt="在这里插入图片描述"><br> 即最终计算的时候，是将特征图中，同一批次中，按照通道进行归一化，每个样本的不同通道间是没什么关系的，不同样本的相同通道是符合同一个正态分布的。</p> 
</blockquote> 
<h6><a id="PytorchnnBatchNormal2d_11"></a>Pytorch中的nn模块中的BatchNormal2d函数的实验</h6> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
 
<span class="token comment">#num_features - num_features from an expected input of size:batch_size*num_features*height*width</span>
<span class="token comment">#eps:default:1e-5 (公式中为数值稳定性加到分母上的值)</span>
<span class="token comment">#momentum:动量参数，用于running_mean and running_var计算的值，default：0.1</span>
 
<span class="token builtin">input</span><span class="token operator">=</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 生成一个三维矩阵，bitch_size=2, C=2, H=3, W=4 </span>
m<span class="token operator">=</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> affine<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 2为输入的通道数，affine参数设为True表示weight和bias将被使用，即 gamma 和 Beta</span>
output<span class="token operator">=</span>m<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>  <span class="token comment"># 批正则化变换</span>
 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>  <span class="token comment"># gamma</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">)</span>  <span class="token comment"># Beta</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

</code></pre> 
<p><img src="https://images2.imgbox.com/2d/54/pxg7HKPt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/63/c4/0OZaggUh_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_34"></a>使用计算公式计算</h5> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8d/95/4KKVCCJi_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">firstChannelMean<span class="token operator">=</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#求2个样本第一通道的平均值</span>
firstCVar<span class="token operator">=</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">.</span>var<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment">#求2个样本第一个通道的方差</span>
batchNor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>firstChannelMean<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>firstCVar<span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">+</span>m<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">#普通的公式</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>batchNor<span class="token punctuation">)</span> <span class="token comment"># 输出该位置对应的BN结果</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/64/RL1mTyvE_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="BN_48"></a>以上即为BN操作的具体过程，想必会对您有一定的帮助！</h6>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5a42999b924f7fcc026d5bdf15bf58ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vscode remote ssh_win10 下安装Vscode</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2f25910545c35096a4373fb332d976e3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">dataframe iloc_如何使用iloc和loc 对Pandas Dataframe进行索引和切片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>