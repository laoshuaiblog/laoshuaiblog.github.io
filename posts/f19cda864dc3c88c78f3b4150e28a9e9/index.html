<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker创建keepalived镜像实现高可用 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/f19cda864dc3c88c78f3b4150e28a9e9/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="docker创建keepalived镜像实现高可用">
  <meta property="og:description" content="必要条件：
1、在服务器中安装 centos 镜像2、进入centos_01容器安装keepalived（或者keepalived&#43;nginx），若有前端则加上nginx 环境：
前提条件 -&amp;gt; 已在 linux 中安装好docker环境。
1、在服务器中安装 centos 镜像
下载镜像：
1
docker pull centos:7.7.1908
查看镜像：
1
docker images
安装第一个centos容器：centos_01
#f1cb7c7d58b7 就是上图中的镜像ID
sudo docker run -it --name centos_01 f1cb7c7d58b7
#然后退出容器
exit;
2、进入centos_01容器安装keepalived&#43;nginx
进入容器：
#efbad978d17f 是容器ID
docker exec -it efbad978d17f /bin/bash
安装keepalived 和安装nginx
#安装依赖环境
yum install -y gcc openssl-devel popt-devel
#安装keepalived
yum install -y keepalived
#或者本地安装指定版本
wget https://www.keepalived.org/software/keepalived-1.3.4.tar.gz
#使用yum安装nginx需要包括Nginx的库，安装Nginx的库
rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
# 使用下面命令安装nginx
yum install -y nginx">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-11-01T14:02:10+08:00">
    <meta property="article:modified_time" content="2022-11-01T14:02:10+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker创建keepalived镜像实现高可用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>必要条件：</strong></p> 
<ul><li>1、在服务器中安装 centos 镜像</li><li>2、进入centos_01容器安装keepalived（或者keepalived+nginx），若有前端则加上nginx</li></ul> 
<p><strong>环境：</strong><br> 前提条件 -&gt; 已在 linux 中安装好docker环境。</p> 
<p>1、在服务器中安装 centos 镜像</p> 
<p>下载镜像：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>docker  pull  centos:7.7.1908</code></p> </td></tr></tbody></table> 
<p><br> 查看镜像：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>docker images</code></p> </td></tr></tbody></table> 
<p><br> 安装第一个centos容器：centos_01</p> 
<blockquote> 
 <p><code>#f1cb7c7d58b7  就是上图中的镜像ID</code></p> 
 <p><code>sudo docker run -it --name centos_01 f1cb7c7d58b7</code></p> 
 <p></p> 
 <p><code>#然后退出容器</code></p> 
 <p><code>exit</code><code>;</code></p> 
</blockquote> 
<p>2、进入centos_01容器安装keepalived+nginx</p> 
<p>进入容器：</p> 
<blockquote> 
 <p><code>#efbad978d17f 是容器ID</code></p> 
 <p><code>docker </code><code>exec</code> <code>-it efbad978d17f /bin/bash</code></p> 
</blockquote> 
<p></p> 
<p>安装keepalived 和安装nginx</p> 
<blockquote> 
 <p><code>#安装依赖环境</code></p> 
 <p><code>yum install -y gcc openssl-devel popt-devel</code></p> 
 <p><code>#安装keepalived</code></p> 
 <p><code>yum install -y keepalived</code></p> 
 <p></p> 
 <p><code>#或者本地安装指定版本</code></p> 
 <p><code>wget https:</code><code>//www.keepalived.org/software/keepalived-1.3.4.tar.gz</code></p> 
 <p></p> 
</blockquote> 
<blockquote> 
 <p><code>#使用yum安装nginx需要包括Nginx的库，安装Nginx的库</code></p> 
 <p><code>rpm -Uvh http:</code><code>//nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</code></p> 
 <p></p> 
 <p><code># 使用下面命令安装nginx</code></p> 
 <p><code>yum install -y nginx</code></p> 
 <p></p> 
 <p><code>#安装网络包(需要使用ifconfig和ping命令)</code></p> 
 <p><code>yum install -y net-tool</code></p> 
</blockquote> 
<p>修改/etc/keepalived/keepalived.conf文件:</p> 
<blockquote> 
 <p><code>#进入到 容器 centos_01 的根目录</code></p> 
 <p><code>cd /</code></p> 
 <p><code>#进入 keepalived 安装目录</code></p> 
 <p><code>cd /etc/keepalived</code></p> 
 <p><code># 打开配置文件</code></p> 
 <p><code>vi keepalived.conf</code></p> 
</blockquote> 
<p></p> 
<p>修改/etc/keepalived/keepalived.conf文件        </p> 
<blockquote> 
 <p><code>! Configuration File </code><code>for</code> <code>keepalived</code></p> 
 <p><code>global_defs {<!-- --></code></p> 
 <p><code>    </code><code>router_id LVS_DEVEL</code></p> 
 <p><code>}</code></p> 
 <p></p> 
 <p><code>vrrp_script chk_nginx {<!-- --></code></p> 
 <p><code>    </code><code>script </code><code>"/etc/keepalived/nginx_check.sh" #检测nginx进程是否在线</code></p> 
 <p><code>    # script "&lt;/dev/tcp/127.0.0.1/8080" 检测服务端口是否在线</code></p> 
 <p><code>     interval 2 #检查脚本的频率,单位（秒）<br>      weight -30 #端口检查失败,优先级减少30,默认减少2[注意:两台主机配置的weight相同时候必须保证weight的值大于priority差值]</code></p> 
 <p><code>}</code></p> 
 <p></p> 
 <p><code>vrrp_instance VI_1 {<!-- --></code></p> 
 <p><code>    </code><code>state MASTER </code></p> 
 <p><code>    </code><code>interface</code> <code>eth0 </code></p> 
 <p><code>    </code><code>virtual_router_id 51</code></p> 
 <p><code>    </code><code>priority 101</code></p> 
 <p><code>    </code><code>advert_int 2</code></p> 
 <p><code>    </code><code>authentication {<!-- --></code></p> 
 <p><code>        </code><code>auth_type PASS</code></p> 
 <p><code>        </code><code>auth_pass 1111</code></p> 
 <p><code>    </code><code>}</code></p> 
 <p><code>    </code><code>virtual_ipaddress {<!-- --></code></p> 
 <p><code>        </code><code>172.17.0.210 </code></p> 
 <p><code>    </code><code>}</code></p> 
 <p><code>    </code><code>track_script {<!-- --></code></p> 
 <p><code>       </code><code>chk_nginx</code></p> 
 <p><code>    </code><code>}</code></p> 
 <p><code>}</code></p> 
</blockquote> 
<p>创建 /etc/keepalived/check_nginx.sh 脚本文件</p> 
<blockquote> 
 <p><code>A=`ps -ef | grep nginx | grep -v grep | wc -l`</code></p> 
 <p><code>if</code> <code>[ </code><code>$A</code> <code>-eq 0 ];then</code></p> 
 <p><code>    </code><code>nginx</code></p> 
 <p><code>    </code><code>sleep 2</code></p> 
 <p><code>    </code><code>if</code> <code>[ `ps -ef | grep nginx | grep -v grep | wc -l` -eq 0 ];then</code></p> 
 <p><code>        </code><code>#killall keepalived</code></p> 
 <p><code>        </code><code>ps -ef|grep keepalived|grep -v grep|awk </code><code>'{print $2}'</code><code>|xargs kill -9</code></p> 
 <p><code>    </code><code>fi</code></p> 
 <p><code> </code> </p> 
 <p><code>fi</code></p> 
</blockquote> 
<p>再对check_nginx.sh赋于执行权限：</p> 
<blockquote> 
 <p><code>chmod</code> <code>+x check_nginx.sh</code></p> 
</blockquote> 
<p>注：keepalived是通过检测keepalived进程是否存在判断服务器是否宕机，如果keepalived进程在但是nginx进程不在了那么keepalived是不会做主备切换，所以我们需要写个脚本来监控nginx进程是否存在，如果nginx不存在就将keepalived进程杀掉。<br> 在主nginx上需要编写nginx进程检测脚本（check_nginx.sh），判断nginx进程是否存在，如果nginx不存在就将keepalived进程杀掉，并将vip漂移到备份机器上。</p> 
<p></p> 
<p>设置 keepalived 开机启动</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> </td><td> <p><code>#设置开机自动启动</code></p> <p><code>systemctl enable keepalived.service</code></p> </td></tr></tbody></table> 
<p>启动keepalived服务：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> </td><td> <p><code># 启动</code></p> <p><code>systemctl start keepalived.service</code></p> </td></tr></tbody></table> 
<p>安装所有需要的依赖和环境后，将容器新增的内容重新提交到镜像文件，制作成新的镜像以供使用</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> <p>3</p> <p>4</p> </td><td> <p><code>#查看容器ID</code></p> <p><code>docker ps</code></p> <p><code>#把这个容器打包为一个镜像，5d112 就是容器 centos_01 的ID</code></p> <p><code>docker commit 5d112 centos_keepalived_nginx:v1</code></p> </td></tr></tbody></table> 
<p>执行完成之后，我们用 docker images 命令看一下</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>docker images</code></p> </td></tr></tbody></table> 
<p>将镜像<code>centos_keepalived_nginx:v1</code>保存为<code>keepalived</code>.tar.gz</p> 
<blockquote> 
 <p>docker save -o <code>keepalived</code>.tar.gz <code>centos_keepalived_nginx:v1</code>    </p> 
</blockquote> 
<p><br> 这个镜像就是我们前面打包后的镜像。将<code>keepalived</code>.tar.gz放入另一台含有docker的服务器/home/docker/docker_test/images目录下，例如：192.168.2.2</p> 
<p>在192.168.2.2服务器里操作：</p> 
<blockquote> 
 <p>cd home/docker/docker_test/images</p> 
</blockquote> 
<p>从 eepalived.tar.gz 导入镜像</p> 
<blockquote> 
 <p>docker load -i keepalived.tar.gz</p> 
</blockquote> 
<p></p> 
<p>启动含有(keepalived+nginx)的容器。</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>docker run --privileged=true -tid --name  keepalived_master centos_keepalived_nginx:v1 /usr/sbin/init</code></p> </td></tr></tbody></table> 
<p>进入keepalived_master容器：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>docker </code><code>exec</code> <code>-it keepalived_master bash</code></p> </td></tr></tbody></table> 
<p>进入/usr/share/nginx/html，修改index.html文件</p> 
<p>修改标题为:</p> 
<p>Welcome to nginx Master!</p> 
<p>启动keepalived_salve容器：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> <p>3</p> <p>4</p> <p>5</p> </td><td> <p><code>#启动一个容器</code></p> <p><code>docker run --privileged=true -tid --name  keepalived_slave centos_keepalived_nginx:v1 /usr/sbin/init</code></p> <p></p> <p><code>#进入容器</code></p> <p><code>docker </code><code>exec</code> <code>-it keepalived_slave bash</code></p> </td></tr></tbody></table> 
<p>修改keepalived_salve容器中nginx index.html文件</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>vim /usr/share/nginx/html/index.html</code></p> </td></tr></tbody></table> 
<p>修改标题为:</p> 
<p>Welcome to nginx Slave!</p> 
<p>修改keepalived_salve容器中keepalived.conf文件 (master容器中，保持和镜像中设置一样即可，不需要更改)</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> <p>3</p> <p>4</p> <p>5</p> <p>6</p> <p>7</p> <p>8</p> <p>9</p> <p>10</p> <p>11</p> <p>12</p> <p>13</p> <p>14</p> <p>15</p> <p>16</p> <p>17</p> <p>18</p> <p>19</p> <p>20</p> <p>21</p> <p>22</p> <p>23</p> <p>24</p> <p>25</p> <p>26</p> <p>27</p> <p>28</p> <p>29</p> <p>30</p> <p>31</p> <p>32</p> <p>33</p> <p>34</p> <p>35</p> <p>36</p> <p>37</p> <p>38</p> </td><td> <p><code>! Configuration File </code><code>for</code> <code>keepalived</code></p> <p><code>global_defs {<!-- --></code></p> <p><code>notification_email {<!-- --></code></p> <p><code>762357658@qq.com</code></p> <p><code>}</code></p> <p><code>notification_email_from itsection@example.com</code></p> <p><code>smtp_server mail.example.com</code></p> <p><code>smtp_connect_timeout 30</code></p> <p><code>router_id LVS_DEVEL</code></p> <p><code>}</code></p> <p></p> <p><code>vrrp_script chk_nginx {<!-- --></code></p> <p><code>script </code><code>"/etc/keepalived/nginx_check.sh"</code></p> <p><code>interval 2</code></p> <p><code>weight -5</code></p> <p><code>fall 3</code></p> <p><code>rise 2</code></p> <p><code>}</code></p> <p></p> <p></p> <p><code>vrrp_instance VI_1 {<!-- --></code></p> <p><code>state BACKUP</code></p> <p><code>interface</code> <code>eth0</code></p> <p><code>virtual_router_id 2</code></p> <p><code>priority 100</code></p> <p><code>advert_int 2</code></p> <p><code>authentication {<!-- --></code></p> <p><code>auth_type PASS</code></p> <p><code>auth_pass 1111</code></p> <p><code>}</code></p> <p><code>virtual_ipaddress {<!-- --></code></p> <p><code>172.17.0.210</code></p> <p><code>}</code></p> <p><code>track_script {<!-- --></code></p> <p><code>chk_nginx</code></p> <p><code>}</code></p> <p></p> <p><code>}</code></p> </td></tr></tbody></table> 
<p>其实，由配置中可以看出，主要是state和priority两个参数的调整，其中master节点的priority值一定要比backup大才行！<br> 原理说明：<br> 1、 通过vrrp协议广播，每个keepalived vrrp都去争取master<br> 2、 以virtual_router_id为组队标识。 同为一个vip服务的keepalived的virtual_router_id要保持相同<br> 3、 以priority 为权值，同一个virtual_router_id下那个priority大那个就是master,其它为backup</p> 
<p>改完之后，重新加载</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> </td><td> <p><code>systemctl daemon-reload</code></p> <p><code>systemctl restart keepalived.service</code></p> </td></tr></tbody></table> 
<p>验证</p> 
<p>查看两个容器中keepalived服务状态，两台服务状态不一样</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>systemctl status keepalived.service</code></p> </td></tr></tbody></table> 
<p><strong>双机主备切换验证</strong></p> 
<p><br><strong> 关闭主机</strong></p> 
<p><br> 关闭主机后，备机自动出现服务ip<br> 当主机再次启动后，服务ip切换至主机</p> 
<p><strong>关闭keepalived 服务</strong></p> 
<p><br> 关闭keepalived 服务后，服务ip自动切换至备机<br> 当主机keepalived服务再次启动后，服务ip自动切换至主机</p> 
<p><strong>关闭nginx服务</strong></p> 
<p><br> 停止nginx服务后，服务ip自动切换至备机<br> 当nginx服务重新启动后，服务ip自动切换至主机<br>  </p> 
<p><strong>关闭检测的端口8080服务</strong></p> 
<p><br> 停止服务后，服务ip自动切换至备机<br> 当服务重新启动后，服务ip自动切换至主机</p> 
<p>以上是在192.168.2.2服务器进行命令操作，也可用docker-compse.yml操作</p> 
<p></p> 
<pre><code class="language-java">version: '3.9'
services:
  keepalivebase:
    image: 'centos:8'
    container_name: 'keepalivebase'
    network_mode: "host"
    restart: always
    volumes:
      - "/home/docker/volumes/xxx/_data/keepalived_data/keepalived.conf:/etc/keepalived/keepalived.conf"
      - "/etc/localtime:/etc/localtime"
      - "/etc/timezone:/etc/timezone"
    privileged: true

  portainer:
        image: portainer/portainer:latest
        container_name: portainer
        restart: always
        environment:
            TZ: Asia/Shanghai
            LANG: en_US.UTF-8
        ports:
            - "9000:9000"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - "/etc/localtime:/etc/localtime"
            - "/etc/timezone:/etc/timezone"


</code></pre> 
<pre><code class="language-java">version: '3.9'
services:  
    keepalive01:
        image: 'centos8_keepalived_nginx:v1'
        container_name: 'keepalive01'
        privileged: true
        entrypoint: "/sbin/init"
        environment:
            - TZ=Asia/Shanghai
        volumes:
            - ./keepalived_master.conf:/etc/keepalived/keepalived.conf
            - ./backup.sh:/etc/keepalived/backup.sh
            - ./fault.sh:/etc/keepalived/fault.sh
            - ./master.sh:/etc/keepalived/master.sh
            - ./index-master.html:/usr/share/nginx/html/index.html
        command: /bin/bash -c "chmod +x /etc/keepalived/*.sh &amp;&amp; chmod -x /etc/keepalived/keepalived.conf"
        ports:
            - "80:80"
        networks:
            keepalive-ha:
                ipv4_address: '172.29.0.11'
    keepalive02:
        image: 'centos8_keepalived_nginx:v1'
        container_name: 'keepalive02'
        privileged: true
        environment:
            - TZ=Asia/Shanghai
        entrypoint: "/sbin/init"
        volumes:
            - ./keepalived_buckup.conf:/etc/keepalived/keepalived.conf
            - ./backup.sh:/etc/keepalived/backup.sh
            - ./fault.sh:/etc/keepalived/fault.sh
            - ./master.sh:/etc/keepalived/master.sh
            - ./index-slave.html:/usr/share/nginx/html/index.html
        command: /bin/bash -c "chmod +x /etc/keepalived/*.sh &amp;&amp; chmod -x /etc/keepalived/keepalived.conf"
        ports:
            - "81:80"
        networks:
            keepalive-ha:
                ipv4_address: '172.29.0.12'
    cul_test:
        image: 'centos:8'
        container_name: 'cul_test'
        privileged: true
        environment:
            - TZ=Asia/Shanghai
        entrypoint: "/sbin/init"
        stdin_open: true
        tty: true
        networks:
            keepalive-ha:
                ipv4_address: '172.29.0.13'
    portainer:
        image: portainer/portainer:latest
        container_name: portainer
        restart: always
        environment:
            TZ: Asia/Shanghai
            LANG: en_US.UTF-8
        ports:
            - "9000:9000"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        networks:
            keepalive-ha:
                ipv4_address: '172.29.0.50'

networks:
    keepalive-ha:
        name: keepalive-ha
        driver: bridge
        # driver: overlay
        ipam:
            config:
                - subnet: '172.29.0.0/16'
</code></pre> 
<blockquote> 
 <p></p> 
 <p>docker load -i keepalived.tar.gz</p> 
 <p>docker-compose  -f /home/xxx/xxx/docker-compose.yml up -d </p> 
</blockquote> 
<p></p> 
<p></p> 
<p>    keepalived的主备状态与state值设置无关；<br>     主备机由priority值和vrrp_script中的weight值之和决定，大的为主；<br>     主备比较权值=priority值+weight值*标志位，当vrrp_script检测脚本为true时标志位为1，反之为0；<br>     为保证正常的主备切换，weight值应大于主备priority值之差。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3b8c40441e1cf2c230c3407b0de5fb08/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MindSpore 1.5 版本yolov4预训练权重问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d9b967b072ae6a49d34b65b41a6c250a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ShardingSphere学习（超详细）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>