<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>google protobuf (c&#43;&#43;) 学习 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/b8b8305177933cc95c459c81ee7d48ba/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="google protobuf (c&#43;&#43;) 学习">
  <meta property="og:description" content="probuf是goole推出的微型RPC框架，这里记录下安装测试。
参考文章：
Google Protocol Buffers浅析（一）
一、Ubuntu 18.04安装 C&#43;&#43; Protocol 首先参考官方README文档进行安装：
前提
sudo apt-get install autoconf automake libtool curl make g&#43;&#43; unzip 当然可以在如下网站进行源码下载离线安装。
https://github.com/protocolbuffers/protobuf/releases/latest
这里通过git直接在终端进行安装：
$ git clone https://github.com/protocolbuffers/protobuf.git $ cd protobuf $ git submodule update --init --recursive $ ./autogen.sh $ ./configure $ make $ make check $ sudo make install $ sudo ldconfig # refresh shared library cache. 默认安装在/usr/local下面，可以进行查看库文件。
pkg-config --cflags protobuf # print compiler flags pkg-config --libs protobuf # print linker flags pkg-config --cflags --libs protobuf # print both 查看安装版本：">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-06-13T19:51:41+08:00">
    <meta property="article:modified_time" content="2019-06-13T19:51:41+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">google protobuf (c&#43;&#43;) 学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>probuf是goole推出的微型RPC框架，这里记录下安装测试。<br> 参考文章：<br> <a href="https://www.cnblogs.com/royenhome/archive/2010/10/29/1864860.html" rel="nofollow">Google Protocol Buffers浅析（一）</a></p> 
</blockquote> 
<h5><a id="Ubuntu_1804_C_Protocol_6"></a>一、Ubuntu 18.04安装 C++ Protocol</h5> 
<p>首先参考<a href="https://github.com/protocolbuffers/protobuf/blob/master/src/README.md">官方README文档</a>进行安装：<br> <strong>前提</strong></p> 
<pre><code> sudo apt-get install autoconf automake libtool curl make g++ unzip
</code></pre> 
<p>当然可以在如下网站进行源码下载离线安装。<br> <a href="https://github.com/protocolbuffers/protobuf/releases/latest">https://github.com/protocolbuffers/protobuf/releases/latest</a><br> 这里通过git直接在终端进行安装：</p> 
<pre><code>$ git clone https://github.com/protocolbuffers/protobuf.git
$ cd protobuf
$ git submodule update --init --recursive
$ ./autogen.sh

$ ./configure
$ make
$ make check
$ sudo make install
$ sudo ldconfig # refresh shared library cache.
</code></pre> 
<p>默认安装在/usr/local下面，可以进行查看库文件。</p> 
<pre><code>pkg-config --cflags protobuf         # print compiler flags
pkg-config --libs protobuf           # print linker flags
pkg-config --cflags --libs protobuf  # print both
</code></pre> 
<p><img src="https://images2.imgbox.com/d6/a2/v8sPGdUQ_o.png" alt="在这里插入图片描述"><br> 查看安装版本：</p> 
<pre><code> protoc --version
</code></pre> 
<p><img src="https://images2.imgbox.com/5f/39/81oxlsp8_o.png" alt="pro"></p> 
<h5><a id="examples_42"></a>二、官方examples代码编译测试</h5> 
<p>参考<a href="https://github.com/protocolbuffers/protobuf/tree/master/examples">官方examples</a></p> 
<p>通常，编写一个protocol buffers应用需要经历如下三步：</p> 
<pre><code> 1、定义消息格式文件，最好以proto作为后缀名

 2、使用Google提供的protocol buffers编译器来生成代码文件，一般为.h和.cc文件，主要是对消息格式以特定的语言方式描述

 3、使用protocol buffers库提供的API来编写应用程序  
</code></pre> 
<p>首先编写addressbook.proto文件。</p> 
<pre><code class="prism language-c"><span class="token comment">// See README.txt for information and build instructions.</span>
<span class="token comment">//</span>
<span class="token comment">// Note: START and END tags are used in comments to define sections used in</span>
<span class="token comment">// tutorials.  They are not part of the syntax for Protocol Buffers.</span>
<span class="token comment">//</span>
<span class="token comment">// To get an in-depth walkthrough of this file and the related examples, see:</span>
<span class="token comment">// https://developers.google.com/protocol-buffers/docs/tutorials</span>

<span class="token comment">// [START declaration]</span>
syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>
package tutorial<span class="token punctuation">;</span>

import <span class="token string">"google/protobuf/timestamp.proto"</span><span class="token punctuation">;</span>
<span class="token comment">// [END declaration]</span>

<span class="token comment">// [START java_declaration]</span>
option java_package <span class="token operator">=</span> <span class="token string">"com.example.tutorial"</span><span class="token punctuation">;</span>
option java_outer_classname <span class="token operator">=</span> <span class="token string">"AddressBookProtos"</span><span class="token punctuation">;</span>
<span class="token comment">// [END java_declaration]</span>

<span class="token comment">// [START csharp_declaration]</span>
option csharp_namespace <span class="token operator">=</span> <span class="token string">"Google.Protobuf.Examples.AddressBook"</span><span class="token punctuation">;</span>
<span class="token comment">// [END csharp_declaration]</span>

<span class="token comment">// [START messages]</span>
message Person <span class="token punctuation">{<!-- --></span>
  string name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  int32 id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// Unique ID number for this person.</span>
  string email <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

  <span class="token keyword">enum</span> PhoneType <span class="token punctuation">{<!-- --></span>
    MOBILE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    HOME <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    WORK <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  message PhoneNumber <span class="token punctuation">{<!-- --></span>
    string number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    PhoneType type <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  repeated PhoneNumber phones <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

  google<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span>Timestamp last_updated <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Our address book file is just one of these.</span>
message AddressBook <span class="token punctuation">{<!-- --></span>
  repeated Person people <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// [END messages]</span>
</code></pre> 
<p>之后对其进行编译，产生对应的xxx.pb.cc和xxx.pb.h文件。</p> 
<pre><code>protoc -I=./ --cpp_out=./ addressbook.proto
</code></pre> 
<p>最后,</p> 
<ol><li>编写add_person.cc文件，该应用程序实现控制台输入person的相关信息并写入到文本文件：</li></ol> 
<pre><code class="prism language-c"><span class="token comment">// See README.txt for information and build instructions.</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;google/protobuf/util/time_util.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"addressbook.pb.h"</span></span>

using namespace std<span class="token punctuation">;</span>

using google<span class="token punctuation">:</span><span class="token punctuation">:</span>protobuf<span class="token punctuation">:</span><span class="token punctuation">:</span>util<span class="token punctuation">:</span><span class="token punctuation">:</span>TimeUtil<span class="token punctuation">;</span>

<span class="token comment">// This function fills in a Person message based on user input.</span>
<span class="token keyword">void</span> <span class="token function">PromptForAddress</span><span class="token punctuation">(</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token operator">*</span> person<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Enter person ID number: "</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> id<span class="token punctuation">;</span>
  cin <span class="token operator">&gt;&gt;</span> id<span class="token punctuation">;</span>
  person<span class="token operator">-&gt;</span><span class="token function">set_id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cin<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Enter name: "</span><span class="token punctuation">;</span>
  <span class="token function">getline</span><span class="token punctuation">(</span>cin<span class="token punctuation">,</span> <span class="token operator">*</span>person<span class="token operator">-&gt;</span><span class="token function">mutable_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Enter email address (blank for none): "</span><span class="token punctuation">;</span>
  string email<span class="token punctuation">;</span>
  <span class="token function">getline</span><span class="token punctuation">(</span>cin<span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    person<span class="token operator">-&gt;</span><span class="token function">set_email</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Enter a phone number (or leave blank to finish): "</span><span class="token punctuation">;</span>
    string number<span class="token punctuation">;</span>
    <span class="token function">getline</span><span class="token punctuation">(</span>cin<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>PhoneNumber<span class="token operator">*</span> phone_number <span class="token operator">=</span> person<span class="token operator">-&gt;</span><span class="token function">add_phones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    phone_number<span class="token operator">-&gt;</span><span class="token function">set_number</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Is this a mobile, home, or work phone? "</span><span class="token punctuation">;</span>
    string type<span class="token punctuation">;</span>
    <span class="token function">getline</span><span class="token punctuation">(</span>cin<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">"mobile"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      phone_number<span class="token operator">-&gt;</span><span class="token function">set_type</span><span class="token punctuation">(</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>MOBILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">"home"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      phone_number<span class="token operator">-&gt;</span><span class="token function">set_type</span><span class="token punctuation">(</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>HOME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">"work"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      phone_number<span class="token operator">-&gt;</span><span class="token function">set_type</span><span class="token punctuation">(</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>WORK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Unknown phone type.  Using default."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>person<span class="token operator">-&gt;</span><span class="token function">mutable_last_updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> TimeUtil<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">SecondsToTimestamp</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main function:  Reads the entire address book from a file,</span>
<span class="token comment">//   adds one person based on user input, then writes it back out to the same</span>
<span class="token comment">//   file.</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Verify that the version of the library that we linked against is</span>
  <span class="token comment">// compatible with the version of the headers we compiled against.</span>
  GOOGLE_PROTOBUF_VERIFY_VERSION<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Usage:  "</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ADDRESS_BOOK_FILE"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>AddressBook address_book<span class="token punctuation">;</span>

  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Read the existing address book.</span>
    fstream <span class="token function">input</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ios<span class="token punctuation">:</span><span class="token punctuation">:</span>in <span class="token operator">|</span> ios<span class="token punctuation">:</span><span class="token punctuation">:</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>input<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cout <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": File not found.  Creating a new file."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>address_book<span class="token punctuation">.</span><span class="token function">ParseFromIstream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to parse address book."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Add an address.</span>
  <span class="token function">PromptForAddress</span><span class="token punctuation">(</span>address_book<span class="token punctuation">.</span><span class="token function">add_people</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Write the new address book back to disk.</span>
    fstream <span class="token function">output</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ios<span class="token punctuation">:</span><span class="token punctuation">:</span>out <span class="token operator">|</span> ios<span class="token punctuation">:</span><span class="token punctuation">:</span>trunc <span class="token operator">|</span> ios<span class="token punctuation">:</span><span class="token punctuation">:</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>address_book<span class="token punctuation">.</span><span class="token function">SerializeToOstream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to write address book."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Optional:  Delete all global objects allocated by libprotobuf.</span>
  google<span class="token punctuation">:</span><span class="token punctuation">:</span>protobuf<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ShutdownProtobufLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>编写list_people.cc文件，该应用程序实现将add_person.cc写入的文本文件进行可视化读取。</li></ol> 
<pre><code class="prism language-c"><span class="token comment">// See README.txt for information and build instructions.</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;google/protobuf/util/time_util.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"addressbook.pb.h"</span></span>

using namespace std<span class="token punctuation">;</span>

using google<span class="token punctuation">:</span><span class="token punctuation">:</span>protobuf<span class="token punctuation">:</span><span class="token punctuation">:</span>util<span class="token punctuation">:</span><span class="token punctuation">:</span>TimeUtil<span class="token punctuation">;</span>

<span class="token comment">// Iterates though all people in the AddressBook and prints info about them.</span>
<span class="token keyword">void</span> <span class="token function">ListPeople</span><span class="token punctuation">(</span><span class="token keyword">const</span> tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>AddressBook<span class="token operator">&amp;</span> address_book<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> address_book<span class="token punctuation">.</span><span class="token function">people_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token operator">&amp;</span> person <span class="token operator">=</span> address_book<span class="token punctuation">.</span><span class="token function">people</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Person ID: "</span> <span class="token operator">&lt;&lt;</span> person<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"  Name: "</span> <span class="token operator">&lt;&lt;</span> person<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"  E-mail address: "</span> <span class="token operator">&lt;&lt;</span> person<span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> person<span class="token punctuation">.</span><span class="token function">phones_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>PhoneNumber<span class="token operator">&amp;</span> phone_number <span class="token operator">=</span> person<span class="token punctuation">.</span><span class="token function">phones</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">switch</span> <span class="token punctuation">(</span>phone_number<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>MOBILE<span class="token punctuation">:</span>
          cout <span class="token operator">&lt;&lt;</span> <span class="token string">"  Mobile phone #: "</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>HOME<span class="token punctuation">:</span>
          cout <span class="token operator">&lt;&lt;</span> <span class="token string">"  Home phone #: "</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person<span class="token punctuation">:</span><span class="token punctuation">:</span>WORK<span class="token punctuation">:</span>
          cout <span class="token operator">&lt;&lt;</span> <span class="token string">"  Work phone #: "</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          cout <span class="token operator">&lt;&lt;</span> <span class="token string">"  Unknown phone #: "</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      cout <span class="token operator">&lt;&lt;</span> phone_number<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">has_last_updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"  Updated: "</span> <span class="token operator">&lt;&lt;</span> TimeUtil<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ToString</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">last_updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main function:  Reads the entire address book from a file and prints all</span>
<span class="token comment">//   the information inside.</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Verify that the version of the library that we linked against is</span>
  <span class="token comment">// compatible with the version of the headers we compiled against.</span>
  GOOGLE_PROTOBUF_VERIFY_VERSION<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Usage:  "</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ADDRESS_BOOK_FILE"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>AddressBook address_book<span class="token punctuation">;</span>

  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Read the existing address book.</span>
    fstream <span class="token function">input</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ios<span class="token punctuation">:</span><span class="token punctuation">:</span>in <span class="token operator">|</span> ios<span class="token punctuation">:</span><span class="token punctuation">:</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>address_book<span class="token punctuation">.</span><span class="token function">ParseFromIstream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to parse address book."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">ListPeople</span><span class="token punctuation">(</span>address_book<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Optional:  Delete all global objects allocated by libprotobuf.</span>
  google<span class="token punctuation">:</span><span class="token punctuation">:</span>protobuf<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ShutdownProtobufLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>分别进行编译，产生对应的可执行文件</p> 
<pre><code>c++ add_person.cc addressbook.pb.cc -o add_person_cpp `pkg-config --cflags --libs protobuf`
c++ list_people.cc addressbook.pb.cc -o list_people_cpp `pkg-config --cflags --libs  protobuf`
</code></pre> 
<p>分别运行</p> 
<pre><code>./add_person_cpp address_book_file
./list_people_cpp address_book_file
</code></pre> 
<p><img src="https://images2.imgbox.com/69/de/msSpPCQV_o.png" alt="在这里插入图片描述"><br> 之后对写入的文件进行读取<br> <img src="https://images2.imgbox.com/08/0a/DHp2iv78_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="protobuf_321"></a>三、protobuf文件生成分析</h5> 
<p>参考：</p> 
<blockquote> 
 <p><a href="https://developers.google.com/protocol-buffers/docs/proto3" rel="nofollow">Language Guide (proto3)</a><br> <a href="https://developers.google.com/protocol-buffers/docs/reference/cpp-generated" rel="nofollow">C++ Generated Code</a></p> 
</blockquote> 
<p>一般每一个message对应生成一个类，枚举型对应在高级语言中仍是一个枚举型，<strong>值从0开始</strong>。<br> 对于一个类型为string的变量，主要产生如下方法：</p> 
<pre><code class="prism language-c"><span class="token comment">// string number = 1;</span>
  <span class="token keyword">void</span> <span class="token function">clear_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">&amp;</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set_number</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set_number</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">&amp;&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set_number</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set_number</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> value<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">*</span> <span class="token function">mutable_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">*</span> <span class="token function">release_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set_allocated_number</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">*</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>具体分析参考引文的博主文章：</p> 
<blockquote> 
 <p>可以看出，对于每个字段会生成一个has函数(has_number)、clear清除函数(clear_number)、set函数(set_number)、get函数(number和mutable_number)。这儿解释下get函数中的两个函数的区别，对于原型为const std::string &amp;number() const的get函数而言，返回的是常量字段，不能对其值进行修改。但是在有一些情况下，对字段进行修改是必要的，所以提供了一个mutable版的get函数，通过获取字段变量的指针，从而达到改变其值的目的。</p> 
</blockquote> 
<p>而对于字段修饰符为repeated的字段生成的函数，则稍微有一些不同，如phone字段，则编译器会为其产生如下的代码：</p> 
<pre><code class="prism language-c"><span class="token comment">// repeated .tutorial.Person.PhoneNumber phones = 4;</span>
  <span class="token keyword">int</span> <span class="token function">phones_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">clear_phones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">:</span><span class="token punctuation">:</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person_PhoneNumber<span class="token operator">*</span> <span class="token function">mutable_phones</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">:</span><span class="token punctuation">:</span>PROTOBUF_NAMESPACE_ID<span class="token punctuation">:</span><span class="token punctuation">:</span>RepeatedPtrField<span class="token operator">&lt;</span> <span class="token punctuation">:</span><span class="token punctuation">:</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person_PhoneNumber <span class="token operator">&gt;</span><span class="token operator">*</span>
      <span class="token function">mutable_phones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">:</span><span class="token punctuation">:</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person_PhoneNumber<span class="token operator">&amp;</span> <span class="token function">phones</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token punctuation">:</span><span class="token punctuation">:</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person_PhoneNumber<span class="token operator">*</span> <span class="token function">add_phones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">:</span><span class="token punctuation">:</span>PROTOBUF_NAMESPACE_ID<span class="token punctuation">:</span><span class="token punctuation">:</span>RepeatedPtrField<span class="token operator">&lt;</span> <span class="token punctuation">:</span><span class="token punctuation">:</span>tutorial<span class="token punctuation">:</span><span class="token punctuation">:</span>Person_PhoneNumber <span class="token operator">&gt;</span><span class="token operator">&amp;</span>
      <span class="token function">phones</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

</code></pre> 
<blockquote> 
 <p>可以看出，set函数变成了add函数，这个其实很好理解。上面也说过，repeated修饰的字段在高级语言中的实现可能是个<strong>数组</strong>或<strong>动态数组</strong>，所以当然通过添加的方式来加入新的字段值。而且get函数也变化很大，这个也不用多说了。</p> 
</blockquote> 
<p>另外，google protobuf提供了常用于调试输出的函数</p> 
<p>virtual void CopyFrom(const Message &amp; from); //Make this message int a copy of the given message.<br> virtual void MergeFrom(const Message &amp; from); //Merge the fields from the given message into this message.<img src="https://images2.imgbox.com/8a/85/byvELaJI_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/30dc473f57fc0360422385cb34abf2b9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux用netstat查看服务及监听端口详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/eb20c47a993873ac4ef8aaa13b5f6dd2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">服务器怎么配置SSL证书？服务器部署SSL证书流程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>