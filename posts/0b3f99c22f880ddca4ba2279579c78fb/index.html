<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>QT下的Modbus TCP 通讯 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/0b3f99c22f880ddca4ba2279579c78fb/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="QT下的Modbus TCP 通讯">
  <meta property="og:description" content="文章目录 前言一、关于Modbus二、Modbus TCP Master的实现1.封装自己的Modbus类2.Modbus 通过TCP/IP进行连接3.Modbus 通过TCP/IP读取数据（1）读取线圈数据（2）读取保持寄存器数据（3）给线圈写入数据（4）给保持寄存器写数据 总结 #已有最新文章，使用第三方C库更加方便、高效、稳定。
#已有最新文章，使用第三方C库更加方便、高效、稳定。
#已有最新文章，使用第三方C库更加方便、高效、稳定。
https://blog.csdn.net/weixin_44894312/article/details/128289001?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22128289001%22%2C%22source%22%3A%22weixin_44894312%22%7D
前言 Modbus在工业控制中的应用非常多，由于其免费使用加上一定的历史环境，Modbus在PLC上的通讯应用非常多，本文主要介绍Mosbus TCP master（主站）的实现。
一、关于Modbus Modbus是由MODICON公司开发的一种工业现场总线协议标准，随后施耐德推出了基于TCP/IP的MOdbus协议：Modbus tcp；
Modbus协议是一项应用层报文传输协议，包括ASCII、RTU、TCP三种报文类型。
标准的Modbus协议物理层接口有RS232、RS422、RS485和以太网接口，采用master/slave方式通信。
####################################################
Modbus有4种操作对象：线圈、离散输入、输入寄存器、保持寄存器
Coils、DiscreteInputs、InputRegisters、HoldingRegisters
线圈：PLC的输出位，开关量，在MOdbus中可读可写；
离散输入：PLC的输入位，开关量，在Modbus中只读；
输入寄存器：PLC中只能从模拟量输入端改变的寄存器，在MODBUS中只读
保持寄存器：PLC中用于输出模拟量信号的寄存器，在MODBUS中可读可写
由于是基于QT去实现的ModbusTCP通讯，所以对Modbus的功能码不需要做过多的掌握，了解即可。
二、Modbus TCP Master的实现 //主站的实现，一般都是上位机做主站，PLC做从站 1.封装自己的Modbus类 QT.pro文件中添加 serialbus 模块：
QT &#43;= core gui sql serialbus
让自定义类继承QObject，在头文件中添加相应的头文件 QModbusTcpClient 类 和 QModbusDataUnit 类
在自定义类中创建modbus TCP client 对象指针。
QModbusTcpClient *My_client;
2.Modbus 通过TCP/IP进行连接 自定义类的构造函数中实例化Modbus tcp对象：
My_client = new QModbusTcpClient(); Modbus TCP/IP协议进行连接的时候需要通过IP &#43; Port ；
//端口号一般用502
/******************************************** * 函数名称：Connect_to_modbus(QString IP_address,int Port) * 功能：连接到modbus设备 * 工作方式： * 参数： 参数1：modbus设备的IP地址 QString 类型 参数2：modbus设备的端口号(一般用502) int 类型 * 返回值：成功返回true，失败返回fasle。 * 备注： * 修改记录 *********************************************/ bool My_modbus_tcp::Connect_to_modbus(QString IP_address,int Port) { if(!">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-12-12T17:13:01+08:00">
    <meta property="article:modified_time" content="2022-12-12T17:13:01+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">QT下的Modbus TCP 通讯</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_14" rel="nofollow">前言</a></li><li><a href="#Modbus_19" rel="nofollow">一、关于Modbus</a></li><li><a href="#Modbus_TCP_Master_38" rel="nofollow">二、Modbus TCP Master的实现</a></li><li><ul><li><a href="#1Modbus_40" rel="nofollow">1.封装自己的Modbus类</a></li><li><a href="#2Modbus_TCPIP_53" rel="nofollow">2.Modbus 通过TCP/IP进行连接</a></li><li><a href="#3Modbus_TCPIP_144" rel="nofollow">3.Modbus 通过TCP/IP读取数据</a></li><li><ul><li><a href="#1_146" rel="nofollow">（1）读取线圈数据</a></li><li><a href="#2_239" rel="nofollow">（2）读取保持寄存器数据</a></li><li><a href="#3_313" rel="nofollow">（3）给线圈写入数据</a></li><li><a href="#4_365" rel="nofollow">（4）给保持寄存器写数据</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_426" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<p>#已有最新文章，使用第三方C库更加方便、高效、稳定。<br> #已有最新文章，使用第三方C库更加方便、高效、稳定。<br> #已有最新文章，使用第三方C库更加方便、高效、稳定。</p> 
<p>https://blog.csdn.net/weixin_44894312/article/details/128289001?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22128289001%22%2C%22source%22%3A%22weixin_44894312%22%7D</p> 
<h2><a id="_14"></a>前言</h2> 
<p><font color="#999AAA">Modbus在工业控制中的应用非常多，由于其免费使用加上一定的历史环境，Modbus在PLC上的通讯应用非常多，本文主要介绍Mosbus TCP master（主站）的实现。</font></p> 
<hr color="#000000" size='1"'> 
<h2><a id="Modbus_19"></a>一、关于Modbus</h2> 
<p>Modbus是由MODICON公司开发的一种工业现场总线协议标准，随后施耐德推出了基于TCP/IP的MOdbus协议：Modbus tcp；</p> 
<p>Modbus协议是一项应用层报文传输协议，包括ASCII、RTU、TCP三种报文类型。</p> 
<p>标准的Modbus协议物理层接口有RS232、RS422、RS485和以太网接口，采用master/slave方式通信。</p> 
<p>####################################################<br> <strong>Modbus有4种操作对象：线圈、离散输入、输入寄存器、保持寄存器</strong><br> <strong>Coils、DiscreteInputs、InputRegisters、HoldingRegisters</strong><br> <strong>线圈</strong>：PLC的输出位，开关量，在MOdbus中可读可写；<br> <strong>离散输入</strong>：PLC的输入位，开关量，在Modbus中只读；<br> <strong>输入寄存器</strong>：PLC中只能从模拟量输入端改变的寄存器，在MODBUS中只读<br> <strong>保持寄存器</strong>：PLC中用于输出模拟量信号的寄存器，在MODBUS中可读可写</p> 
<p>由于是基于QT去实现的ModbusTCP通讯，所以对Modbus的功能码不需要做过多的掌握，了解即可。</p> 
<hr> 
<h2><a id="Modbus_TCP_Master_38"></a>二、Modbus TCP Master的实现</h2> 
<pre><code>//主站的实现，一般都是上位机做主站，PLC做从站
</code></pre> 
<h3><a id="1Modbus_40"></a>1.封装自己的Modbus类</h3> 
<p>QT.pro文件中添加 serialbus 模块：<br> <font color="#999AAA">QT += core gui sql serialbus</font></p> 
<hr color="#000000" size='1"'> 让自定义类继承QObject，在头文件中添加相应的头文件 
<p><font color="#999AAA"> QModbusTcpClient 类 和 QModbusDataUnit 类</font></p> 
<hr color="#000000" size='1"'> 
<p>在自定义类中创建modbus TCP client 对象指针。<br> <font color="#999AAA"> QModbusTcpClient *My_client;</font></p> 
<hr color="#000000" size='1"'> 
<h3><a id="2Modbus_TCPIP_53"></a>2.Modbus 通过TCP/IP进行连接</h3> 
<p>自定义类的构造函数中实例化Modbus tcp对象：</p> 
<pre><code class="prism language-c">My_client <span class="token operator">=</span> new <span class="token function">QModbusTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Modbus TCP/IP协议进行连接的时候需要通过IP + Port ；<br> //端口号一般用502</p> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称：Connect_to_modbus(QString IP_address,int Port)
 * 功能：连接到modbus设备
 * 工作方式：
 * 参数：
        参数1：modbus设备的IP地址               QString 类型
        参数2：modbus设备的端口号(一般用502)     int 类型
 * 返回值：成功返回true，失败返回fasle。
 * 备注：
 * 修改记录
*********************************************/</span>
bool My_modbus_tcp<span class="token operator">::</span><span class="token function">Connect_to_modbus</span><span class="token punctuation">(</span>QString IP_address<span class="token punctuation">,</span><span class="token keyword">int</span> Port<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>My_client<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>My_client<span class="token operator">-&gt;</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> QModbusDevice<span class="token operator">::</span>ConnectedState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>       <span class="token comment">//判断当前连接状态是否为断开状态</span>

        <span class="token comment">//配置modbus tcp的连接参数 IP + Port   modbus协议的端口号为502</span>
        My_client<span class="token operator">-&gt;</span><span class="token function">setConnectionParameter</span><span class="token punctuation">(</span>QModbusDevice<span class="token operator">::</span>NetworkAddressParameter<span class="token punctuation">,</span>IP_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        My_client<span class="token operator">-&gt;</span><span class="token function">setConnectionParameter</span><span class="token punctuation">(</span>QModbusDevice<span class="token operator">::</span>NetworkPortParameter<span class="token punctuation">,</span>Port<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>My_client<span class="token operator">-&gt;</span><span class="token function">connectDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"连接modbus设备失败"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"成功连接到modbs设备"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        My_client<span class="token operator">-&gt;</span><span class="token function">disconnectDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>上述代码qDebug()&lt;&lt; "成功连接到modbs设备"不太合理，判断连接成功其实应该以Modbus的连接状态来进行判断的。<br> 连接状态参考帮助手册 enum QModbusDevice::State：<br> 有UnconnectedState、ConnectingState、ConnectedState、ClosingState4种</p> 
<p>QModbusClient 类自带了状态改变的信号：<font color="#999AAA">QModbusClient::stateChanged<br> //我在自定义类中添加了两个信号，statechange_on()和statechange_off()；用于判断当前是否连接</font></p> 
<p><font color="#999AAA">连接状态相关的代码如下：</font></p> 
<p>先在自定义类的构造函数中绑定信号（QModbusClient::stateChanged）和槽（自定义槽函数）</p> 
<pre><code class="prism language-c"><span class="token function">connect</span><span class="token punctuation">(</span>My_client<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QModbusClient<span class="token operator">::</span>stateChanged<span class="token punctuation">,</span>
              this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>My_modbus_tcp<span class="token operator">::</span>onStateChanged<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连接状态发生改变时处理函数（connect or discennect）</span>

</code></pre> 
<p>实现状态改变的槽函数，状态进行变化时发出相应的信号，可以使用该信号进行信号与槽的绑定实现状态改变时的功能。</p> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称：onStateChanged()
 * 功能：监听TCP连接的状态，若状态发生改变，发出对应的信号
 * 工作方式：
 * 参数：无参数
 * 返回值：无返回值
 * 备注：
 * 修改记录:
*********************************************/</span>
<span class="token keyword">void</span> My_modbus_tcp<span class="token operator">::</span><span class="token function">onStateChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment">//连接状态改变时的槽函数</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>My_client<span class="token operator">-&gt;</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QModbusDevice<span class="token operator">::</span>ConnectedState<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      emit <span class="token function">statechange_on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      emit <span class="token function">statechange_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr color="#000000" size='1"'> 
<h3><a id="3Modbus_TCPIP_144"></a>3.Modbus 通过TCP/IP读取数据</h3> 
<p>Modbus对象的4种数据都可以进行读取，线圈和离散输入都是位数据，结果只能是0/1;输入寄存器和保持寄存器可以实现0x00~0xFF；</p> 
<h4><a id="1_146"></a>（1）读取线圈数据</h4> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称：read_modbus_tcp_Coils(int start_add,quint16 numbers ,int Server_ID)
 * 功能：发送读取modbus设备线圈数据请求
 * 工作方式：
 * 参数：
 *      参数1：int start_add           读取的起始地址
 *      参数2：quint16 numbers         读取的个数
 *      参数3：int Server_ID           Modbus的设备ID
 * 返回值：成功返回true，失败返回fasle。
 * 备注：
 * 修改记录:
*********************************************/</span>
bool My_modbus_tcp<span class="token operator">::</span><span class="token function">read_modbus_tcp_Coils</span><span class="token punctuation">(</span><span class="token keyword">int</span> start_add<span class="token punctuation">,</span>quint16 numbers<span class="token punctuation">,</span><span class="token keyword">int</span> Server_ID<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>！My_client<span class="token operator">-&gt;</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QModbusDevice<span class="token operator">::</span>ConnectedState<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    QModbusDataUnit <span class="token function">ReadUnit</span><span class="token punctuation">(</span>QModbusDataUnit<span class="token operator">::</span>Coils<span class="token punctuation">,</span>start_add<span class="token punctuation">,</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"配置ReadUnit完成"</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">*</span>reply <span class="token operator">=</span> My_client<span class="token operator">-&gt;</span><span class="token function">sendReadRequest</span><span class="token punctuation">(</span>ReadUnit<span class="token punctuation">,</span> Server_ID<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//1是Server_ID</span>
     <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply<span class="token operator">-&gt;</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>  <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"准备进行信号与槽连接"</span><span class="token punctuation">;</span>
           QObject<span class="token operator">::</span><span class="token function">connect</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QModbusReply<span class="token operator">::</span>finished<span class="token punctuation">,</span>this<span class="token punctuation">,</span><span class="token operator">&amp;</span>My_modbus_tcp<span class="token operator">::</span>ReadReady_Coils<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"进入读取的槽函数 "</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"提前delete reply"</span><span class="token punctuation">;</span>
            delete reply<span class="token punctuation">;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

     <span class="token punctuation">}</span>

     <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"提前退出"</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> false<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称：ReadReady_Coils()
 * 功能：接收到读取请求后执行的槽函数
 * 工作方式：
 * 参数：无参数
 * 返回值：没有返回值
 * 备注：
 * 修改记录
*********************************************/</span>
<span class="token keyword">void</span> My_modbus_tcp<span class="token operator">::</span><span class="token function">ReadReady_Coils</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"开始执行槽函数"</span><span class="token punctuation">;</span>
    QModbusReply <span class="token operator">*</span>reply <span class="token operator">=</span> qobject_cast<span class="token operator">&lt;</span>QModbusReply <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"提前退出"</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QModbusDevice<span class="token operator">::</span>NoError<span class="token punctuation">)</span>
       <span class="token punctuation">{<!-- --></span>   <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"接收数据"</span><span class="token punctuation">;</span>
           <span class="token keyword">const</span> QModbusDataUnit unit <span class="token operator">=</span> reply<span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> unit<span class="token punctuation">.</span><span class="token function">valueCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  i<span class="token operator">++</span><span class="token punctuation">)</span>
           <span class="token punctuation">{<!-- --></span>
               <span class="token comment">/*
                QByteArray  AllData =unit.values();	//一次性读完
               */</span>

               <span class="token class-name">uint16_t</span> res<span class="token operator">=</span>unit<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//一个一个读</span>
               Coils_Bufer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">//读完将数据存储起来  Coils_Bufer[i] 自定的数组 用来存放数据</span>
            
           <span class="token punctuation">}</span>

       <span class="token punctuation">}</span>
       <span class="token keyword">else</span>
       <span class="token punctuation">{<!-- --></span>
       <span class="token punctuation">}</span>

       reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// delete the reply</span>
       emit <span class="token function">my_readC_finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//coils读取完成后emit 读取完成的信号；</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>读取离散变量时和读取线圈数据一样，唯一区别就是配置读取数据单元时换成<font color="#999AAA"><br> QModbusDataUnit ReadUnit(QModbusDataUnit::DiscreteInputs,start_add,numbers);</font></p> 
<p>离散变量读取完成时发出自己的信号（自定义信号）。</p> 
<h4><a id="2_239"></a>（2）读取保持寄存器数据</h4> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称：read_modbus_tcp_HoldingRegisters(int start_add,quint16 numbers ,int Server_ID)
 * 功能：发送读取modbus设备HoldingRegisters数据请求
 * 工作方式：
 * 参数
 * 		参数1：读取数据的起始地址
 * 		参数2：读取多少个数据
 * 		参数3：SerVer ID号
 * 返回值：成功返回true，失败返回fasle。
 * 备注：
 *      QModbusDataUnit ReadUnit(QModbusDataUnit::HoldingRegisters,参数1,参数2);
 *      参数1：读取modbus设备的起始地址          int 类型
        参数2：读取几个modbus数据               quint16 类型
 * 修改记录:
*********************************************/</span>
bool My_modbus_tcp<span class="token operator">::</span><span class="token function">read_modbus_tcp_HoldingRegisters</span><span class="token punctuation">(</span><span class="token keyword">int</span> start_add<span class="token punctuation">,</span>quint16 numbers <span class="token punctuation">,</span><span class="token keyword">int</span> Server_ID<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QModbusDataUnit <span class="token function">ReadUnit</span><span class="token punctuation">(</span>QModbusDataUnit<span class="token operator">::</span>HoldingRegisters<span class="token punctuation">,</span>start_add<span class="token punctuation">,</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">*</span>reply <span class="token operator">=</span> My_client<span class="token operator">-&gt;</span><span class="token function">sendReadRequest</span><span class="token punctuation">(</span>ReadUnit<span class="token punctuation">,</span> Server_ID<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//1是Server_ID</span>
     <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply<span class="token operator">-&gt;</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
           QObject<span class="token operator">::</span><span class="token function">connect</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QModbusReply<span class="token operator">::</span>finished<span class="token punctuation">,</span>this<span class="token punctuation">,</span><span class="token operator">&amp;</span>My_modbus_tcp<span class="token operator">::</span>ReadReady_InputRegisters<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            delete reply<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

     <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称：ReadReady_HoldingRegisters()
 * 功能：槽函数，发送请求成功后，接收数据将其存储在Hold_Bufer[]数组中
 * 工作方式：
 * 参数：无参数
 * 返回值：没有返回值
 * 备注：
 * 修改记录
*********************************************/</span>
<span class="token keyword">void</span> My_modbus_tcp<span class="token operator">::</span><span class="token function">ReadReady_HoldingRegisters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QModbusReply <span class="token operator">*</span>reply <span class="token operator">=</span> qobject_cast<span class="token operator">&lt;</span>QModbusReply <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token keyword">return</span> <span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QModbusDevice<span class="token operator">::</span>NoError<span class="token punctuation">)</span>
       <span class="token punctuation">{<!-- --></span>
           <span class="token keyword">const</span> QModbusDataUnit unit <span class="token operator">=</span> reply<span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> unit<span class="token punctuation">.</span><span class="token function">valueCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
           <span class="token punctuation">{<!-- --></span>
               <span class="token class-name">uint16_t</span> res<span class="token operator">=</span>unit<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
               Input_Bufer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
               i<span class="token operator">++</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
        
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span>
       <span class="token punctuation">{<!-- --></span>
       <span class="token punctuation">}</span>

       reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// delete the reply</span>
       emit <span class="token function">my_readH_finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//自定义的信号</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输入寄存器类似，换掉配置单元的数据即可。</p> 
<h4><a id="3_313"></a>（3）给线圈写入数据</h4> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称： Write_modbus_tcp_Coils(QString str1,int star_add,int number)
 * 功   能： 将想要修改的数据写入到modbus设备某个（某些）地址的Coils中。
 * 工作方式：
 * 参   数：
 *          参数1：要写入的数据（例：1 0 1 0 1 0）   QString 类型
 *          参数2：写入数据的起始地址               int 类型
 *          参数3：写入数据的个数                   quint16
 * 返回值：没有返回值
 * 备注：一次性可以写入单个或者多个数据，取决于该函数执行时参数。
 * 修改记录
*********************************************/</span>
bool My_modbus_tcp<span class="token operator">::</span><span class="token function">Write_modbus_tcp_Coils</span><span class="token punctuation">(</span>QString str1<span class="token punctuation">,</span><span class="token keyword">int</span> star_add<span class="token punctuation">,</span><span class="token keyword">int</span> number<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    quint16 number1 <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>quint16<span class="token operator">&gt;</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//C++中的数据类型转换</span>
    QModbusDataUnit <span class="token function">writeUnit</span><span class="token punctuation">(</span>QModbusDataUnit<span class="token operator">::</span>Coils<span class="token punctuation">,</span>star_add<span class="token punctuation">,</span>number1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i1 <span class="token operator">&lt;</span> writeUnit<span class="token punctuation">.</span><span class="token function">valueCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i1<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> j1 <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>i1<span class="token punctuation">;</span>
        QString stt <span class="token operator">=</span> str1<span class="token punctuation">.</span><span class="token function">mid</span> <span class="token punctuation">(</span>j1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bool ok<span class="token punctuation">;</span>
        quint16 hex1 <span class="token operator">=</span>stt<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ok<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将textedit中读取到的数据转换为16进制发送</span>
        writeUnit<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span>hex1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置发送数据</span>
     <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">*</span>reply <span class="token operator">=</span> My_client<span class="token operator">-&gt;</span><span class="token function">sendWriteRequest</span><span class="token punctuation">(</span>writeUnit<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// ui-&gt;spinBox_SerAddress-&gt;value()是server address   sendWriteRequest是向服务器写数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply<span class="token operator">-&gt;</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//reply Returns true when the reply has finished or was aborted.</span>
                <span class="token function">connect</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QModbusReply<span class="token operator">::</span>finished<span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token punctuation">[</span>this<span class="token punctuation">,</span> reply<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QModbusDevice<span class="token operator">::</span>ProtocolError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Write response error: %1 (Mobus exception: 0x%2)"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">errorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">rawResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> QModbusDevice<span class="token operator">::</span>NoError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Write response error: %1 (code: 0x%2)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                            <span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">errorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// broadcast replies return immediately</span>
                reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Write error: "</span><span class="token punctuation">)</span> <span class="token operator">+</span> My_client<span class="token operator">-&gt;</span><span class="token function">errorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>！！！写数据时必须转化位16进制写入</p> 
<h4><a id="4_365"></a>（4）给保持寄存器写数据</h4> 
<pre><code class="prism language-c"><span class="token comment">/********************************************
 * 函数名称： Write_modbus_tcp_HoldingRegisters(QString str1,int star_add,int number)
 * 功   能： 将想要修改的数据写入到modbus设备某个（某些）地址的HoldingRegisters中。
 * 工作方式：
 * 参   数：
 *          参数1：要写入的数据（例：FF A0 00等）   QString 类型
 *          参数2：写入数据的起始地址               int 类型
 *          参数3：写入数据的个数                   quint16
 * 返回值：没有返回值
 * 备注：一次性可以写入单个或者多个数据，取决于该函数执行时参数。
 * 修改记录
*********************************************/</span>
bool My_modbus_tcp<span class="token operator">::</span><span class="token function">Write_modbus_tcp_HoldingRegisters</span><span class="token punctuation">(</span>QString str1<span class="token punctuation">,</span><span class="token keyword">int</span> star_add<span class="token punctuation">,</span><span class="token keyword">int</span> number<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"准备写holding数据：："</span><span class="token punctuation">;</span>
    QByteArray str2 <span class="token operator">=</span> QByteArray<span class="token operator">::</span><span class="token function">fromHex</span> <span class="token punctuation">(</span>str1<span class="token punctuation">.</span><span class="token function">toLatin1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//按十六进制编码接入文本</span>
    QString str3 <span class="token operator">=</span> str2<span class="token punctuation">.</span><span class="token function">toHex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//以十六进制显示</span>

    quint16 number1 <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>quint16<span class="token operator">&gt;</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    QModbusDataUnit <span class="token function">writeUnit</span><span class="token punctuation">(</span>QModbusDataUnit<span class="token operator">::</span>HoldingRegisters<span class="token punctuation">,</span>star_add<span class="token punctuation">,</span>number1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i1 <span class="token operator">&lt;</span> writeUnit<span class="token punctuation">.</span><span class="token function">valueCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i1<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>i1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            j1 <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>i1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
           j1 <span class="token operator">=</span> j1<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        QString stt <span class="token operator">=</span> str1<span class="token punctuation">.</span><span class="token function">mid</span> <span class="token punctuation">(</span>j1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bool ok<span class="token punctuation">;</span>
        quint16 hex1 <span class="token operator">=</span>static_cast<span class="token operator">&lt;</span>quint16<span class="token operator">&gt;</span><span class="token punctuation">(</span>stt<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ok<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将textedit中读取到的数据转换为16进制发送</span>
        writeUnit<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>static_cast<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>i1<span class="token punctuation">)</span><span class="token punctuation">,</span>hex1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置发送数据</span>
     <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">*</span>reply <span class="token operator">=</span> My_client<span class="token operator">-&gt;</span><span class="token function">sendWriteRequest</span><span class="token punctuation">(</span>writeUnit<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// ui-&gt;spinBox_SerAddress-&gt;value()是server address   sendWriteRequest是向服务器写数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply<span class="token operator">-&gt;</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//reply Returns true when the reply has finished or was aborted.</span>
                <span class="token function">connect</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QModbusReply<span class="token operator">::</span>finished<span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token punctuation">[</span>this<span class="token punctuation">,</span> reply<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QModbusDevice<span class="token operator">::</span>ProtocolError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Write response error: %1 (Mobus exception: 0x%2)"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">errorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">rawResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> QModbusDevice<span class="token operator">::</span>NoError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Write response error: %1 (code: 0x%2)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                            <span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">errorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// broadcast replies return immediately</span>
                reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Write error: "</span><span class="token punctuation">)</span> <span class="token operator">+</span> My_client<span class="token operator">-&gt;</span><span class="token function">errorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_426"></a>总结</h2> 
<p><font color="#999AAA">下班了 后续增加写入数据的详细解释</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/741cb0b1f1e95eb422ce5db67b5e381e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C# 网口通信（modbus），自动重连</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e26dceeb37daa9e61b76efe7aa6fbab0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Modbus TCP协议</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>