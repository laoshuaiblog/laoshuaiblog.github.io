<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>快速上手Spring Cloud三：API网关深入探索与实战应用 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/328a4b08a8e8dbf59d836e748b881ecc/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="快速上手Spring Cloud三：API网关深入探索与实战应用">
  <meta property="og:description" content="快速上手Spring Cloud 一：Spring Cloud 简介
快速上手Spring Cloud 二：核心组件解析
快速上手Spring Cloud 三：API网关深入探索与实战应用
快速上手Spring Cloud 四：微服务治理与安全
快速上手Spring Cloud 五：Spring Cloud与持续集成/持续部署（CI/CD）
快速上手Spring Cloud 六：容器化与微服务化
快速上手Spring Cloud 七：事件驱动架构与Spring Cloud
快速上手Spring Cloud 八：微服务架构中的数据管理
快速上手Spring Cloud 九：服务间通信与消息队列
快速上手Spring Cloud 十：Spring Cloud与微前端
快速上手Spring Cloud 十一：微服务架构下的安全与权限管理
快速上手Spring Cloud 十二：与云原生不得不说的故事
一、服务发现与动态路由 在微服务架构中，服务的动态注册与发现是一个核心功能。API网关可以与服务注册中心（如Eureka、Consul等）集成，动态获取服务实例的信息，并根据这些信息构建路由规则。这样，即使服务实例的地址发生变化，API网关也能自动更新路由规则，确保请求的正确转发。
示例代码：使用Eureka与Spring Cloud Gateway实现服务发现与动态路由
首先，确保Eureka服务注册中心已经搭建并运行。然后，在Spring Cloud Gateway的配置中启用服务发现功能：
spring: cloud: gateway: discovery: locator: enabled: true # 启用服务发现功能 接下来，你可以通过服务名称来定义路由规则，而无需指定具体的IP地址和端口：
spring: cloud: gateway: routes: - id: myservice_route uri: lb://MYSERVICE # 使用服务名称替代具体的URI predicates: - Path=/myservice/** 在上述配置中，lb://MYSERVICE表示将请求负载均衡到名为MYSERVICE的服务实例上。Spring Cloud Gateway会自动从Eureka中获取MYSERVICE的服务实例列表，并根据负载均衡算法选择一个实例进行请求转发。">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-27T23:59:22+08:00">
    <meta property="article:modified_time" content="2024-03-27T23:59:22+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">快速上手Spring Cloud三：API网关深入探索与实战应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/38/49/bNl02W93_o.jpg" alt="在这里插入图片描述"><a href="https://blog.csdn.net/m290345792/article/details/136978072">快速上手Spring Cloud 一：Spring Cloud 简介</a><br> <a href="https://blog.csdn.net/m290345792/article/details/136978246">快速上手Spring Cloud 二：核心组件解析</a><br> <a href="https://blog.csdn.net/m290345792/article/details/136983225">快速上手Spring Cloud 三：API网关深入探索与实战应用</a><br> <a href="https://blog.csdn.net/m290345792/article/details/136978470">快速上手Spring Cloud 四：微服务治理与安全</a><br> <a href="https://blog.csdn.net/m290345792/article/details/136978535">快速上手Spring Cloud 五：Spring Cloud与持续集成/持续部署（CI/CD）</a><br> <a href="https://blog.csdn.net/m290345792/article/details/136995433">快速上手Spring Cloud 六：容器化与微服务化</a><br> <a href="https://blog.csdn.net/m290345792/article/details/136996170">快速上手Spring Cloud 七：事件驱动架构与Spring Cloud</a><br> <a href="https://blog.csdn.net/m290345792/article/details/137059557">快速上手Spring Cloud 八：微服务架构中的数据管理</a><br> <a href="https://blog.csdn.net/m290345792/article/details/137061439">快速上手Spring Cloud 九：服务间通信与消息队列</a><br> <a href="https://blog.csdn.net/m290345792/article/details/137090837">快速上手Spring Cloud 十：Spring Cloud与微前端</a><br> <a href="https://blog.csdn.net/m290345792/article/details/137092395">快速上手Spring Cloud 十一：微服务架构下的安全与权限管理</a><br> <a href="https://blog.csdn.net/m290345792/article/details/137093049">快速上手Spring Cloud 十二：与云原生不得不说的故事</a></p> 
<h2><a id="_14"></a><strong>一、服务发现与动态路由</strong></h2> 
<p>在微服务架构中，服务的动态注册与发现是一个核心功能。API网关可以与服务注册中心（如Eureka、Consul等）集成，动态获取服务实例的信息，并根据这些信息构建路由规则。这样，即使服务实例的地址发生变化，API网关也能自动更新路由规则，确保请求的正确转发。</p> 
<p><strong>示例代码：使用Eureka与Spring Cloud Gateway实现服务发现与动态路由</strong></p> 
<p>首先，确保Eureka服务注册中心已经搭建并运行。然后，在Spring Cloud Gateway的配置中启用服务发现功能：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 启用服务发现功能</span>
</code></pre> 
<p>接下来，你可以通过服务名称来定义路由规则，而无需指定具体的IP地址和端口：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> myservice_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//MYSERVICE <span class="token comment"># 使用服务名称替代具体的URI</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/myservice/<span class="token important">**</span>
</code></pre> 
<p>在上述配置中，<code>lb://MYSERVICE</code>表示将请求负载均衡到名为<code>MYSERVICE</code>的服务实例上。Spring Cloud Gateway会自动从Eureka中获取<code>MYSERVICE</code>的服务实例列表，并根据负载均衡算法选择一个实例进行请求转发。<br> <img src="https://images2.imgbox.com/1a/00/2vDG7Gmc_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_47"></a><strong>二、请求监控与日志记录</strong></h2> 
<p>API网关作为所有请求的入口，是收集和分析请求数据、监控服务性能的理想位置。通过集成监控和日志记录工具（如Prometheus、Zipkin、ELK等），我们可以实时了解API的使用情况、性能瓶颈以及潜在的安全问题。</p> 
<h3><a id="Prometheus_51"></a><strong>示例代码：集成Prometheus进行请求监控</strong></h3> 
<p>要在Spring Cloud Gateway中集成Prometheus进行监控，你可以添加相关的依赖和配置：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 在pom.xml中添加Prometheus依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-actuator-prometheus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>然后，在配置文件中启用Prometheus的监控端点：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> prometheus <span class="token comment"># 暴露Prometheus监控端点</span>
</code></pre> 
<p>启动Spring Cloud Gateway后，你可以通过访问<code>/actuator/prometheus</code>端点来获取Prometheus格式的监控数据。接下来，你可以将这些数据导入到Prometheus服务器中进行可视化展示和告警配置。</p> 
<h2><a id="_75"></a><strong>三、性能优化</strong></h2> 
<p>在构建高性能的微服务架构时，API网关作为整个系统的入口，其性能表现直接关系到用户体验和系统的稳定性。Spring Cloud Gateway作为Spring Cloud生态中的核心组件，提供了丰富的功能集，让我们能够轻松实现各种性能优化措施。接下来，我们将深入探讨如何通过缓存、压缩和限流等手段，来提升Spring Cloud Gateway的性能。</p> 
<h3><a id="1_API_79"></a><strong>1. 缓存：加速API响应的利器</strong></h3> 
<p>在微服务架构中，许多API请求都是重复或相似的，这些请求往往访问相同的数据或服务。通过缓存这些频繁访问的API响应，我们可以减少对后端服务的调用次数，从而显著提高系统的响应速度和吞吐量。</p> 
<p>Spring Cloud Gateway内置了对缓存的支持，我们可以结合Redis等缓存系统来实现响应的缓存。下面是一个简单的示例，展示了如何在Spring Cloud Gateway中配置基于Redis的响应缓存：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisCacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置缓存过期时间</span>
            <span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不缓存空值</span>
    <span class="token keyword">return</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">customCacheGlobalFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> <span class="token function">generateCacheKey</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成缓存键</span>
        <span class="token class-name">Cache</span> cache <span class="token operator">=</span> cacheManager<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果缓存中存在，直接返回缓存内容</span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBufferFactory</span> bufferFactory <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBuffer</span> wrappedBuffer <span class="token operator">=</span> bufferFactory<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>wrappedBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果缓存中不存在，继续执行后续的过滤器链</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将响应内容存入缓存</span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBufferUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>dataBuffer <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>dataBuffer<span class="token punctuation">.</span><span class="token function">readableByteCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        dataBuffer<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">DataBufferUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的代码中，我们首先定义了一个<code>RedisCacheManager</code> bean，用于配置Redis缓存的相关参数。然后，我们创建了一个自定义的全局过滤器<code>customCacheGlobalFilter</code>，该过滤器会在每次请求到来时检查缓存中是否存在对应的响应。如果存在，则直接从缓存中返回响应内容；如果不存在，则继续执行后续的过滤器链，并在响应返回后将内容存入缓存。</p> 
<h3><a id="2__129"></a><strong>2. 压缩：减少网络传输开销</strong></h3> 
<p>对于大量的数据传输，网络带宽往往成为性能瓶颈。通过对API响应进行压缩，我们可以显著减少网络传输的数据量，从而加快响应速度。</p> 
<p>Spring Cloud Gateway支持Gzip等压缩算法，我们可以根据需要配置压缩选项。下面是一个配置Gzip压缩的示例：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">gzipFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">CONTENT_ENCODING</span><span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">DataBufferFactory</span> bufferFactory <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">GzipEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GzipEncoder</span><span class="token punctuation">(</span>bufferFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> cachedFlux <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBufferUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cachedFlux<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>dataBuffer <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> compressed <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> bufferFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 释放原始数据缓冲区</span>
                    <span class="token class-name">DataBufferUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> compressed<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>response<span class="token operator">::</span><span class="token function">writeWith</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的代码中，我们创建了一个自定义的全局过滤器<code>gzipFilter</code>，该过滤器会在响应返回前对响应体进行Gzip压缩，并设置相应的<code>Content-Encoding</code>头部。这样，客户端在接收到响应时，就可以根据头部信息对压缩后的数据进行解压。</p> 
<h3><a id="3__161"></a>3. 限流：保护后端服务免受冲击的利器</h3> 
<p>在微服务架构中，API网关作为流量入口，需要面对大量的请求。为了防止API被恶意攻击或由于突发流量导致的过载，实施限流策略显得尤为重要。限流可以限制某个时间段内请求的数量或速率，从而保护后端服务免受大量请求的冲击。</p> 
<p>Spring Cloud Gateway提供了基于令牌桶算法、漏桶算法等限流机制的实现。这些算法能够有效地控制请求通过的速度，避免系统过载。下面是一个基于令牌桶算法的限流示例：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">requestRateLimiterFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RequestRateLimiterConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestRateLimiterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setBurstCapacity</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 令牌桶的容量</span>
            <span class="token punctuation">.</span><span class="token function">setReplenishRate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 每秒新增的令牌数</span>
            <span class="token punctuation">.</span><span class="token function">setAcquireRateLimiter</span><span class="token punctuation">(</span><span class="token class-name">RateLimiter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"mykey"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建限流器</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Route</span> route <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">.</span><span class="token constant">GATEWAY_ROUTE_ATTR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>route <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> id <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取限流配置</span>
            <span class="token class-name">RequestRateLimiterConfig</span> rateLimiterConfig <span class="token operator">=</span> configMap<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rateLimiterConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">RateLimiter</span> rateLimiter <span class="token operator">=</span> rateLimiterConfig<span class="token punctuation">.</span><span class="token function">getAcquireRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> isAllowed <span class="token operator">=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAllowed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果请求被限流，返回429状态码</span>
                    <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的代码中，我们定义了一个全局过滤器<code>requestRateLimiterFilter</code>，该过滤器会在每个请求到达时检查是否超过了限流阈值。如果超过了阈值，则返回429状态码告知客户端请求过多；否则，继续执行后续的过滤器链。</p> 
<p>为了使用不同的限流配置，我们可以将配置信息存储在一个Map中，并根据请求的路由ID来获取对应的配置。这样，我们可以为不同的路由设置不同的限流策略。</p> 
<p>需要注意的是，限流策略应该根据实际的业务场景和需求来制定。过于严格的限流可能会导致正常的请求被拒绝，而过于宽松的限流则可能无法有效保护后端服务。因此，在实际应用中，我们需要根据系统的负载情况、请求的分布特性等因素来调整限流参数，以达到最佳的效果。</p> 
<p>综上所述，通过缓存、压缩和限流等手段，我们可以有效提升Spring Cloud Gateway的性能，为构建高性能的微服务架构提供有力支持。当然，除了这些措施外，还有其他一些优化手段，如连接池管理、异步处理等，都可以帮助我们进一步提升系统的性能和稳定性。在实际应用中，我们需要根据具体的业务需求和系统特点来选择合适的优化策略，并不断进行监控和调整，以确保系统的最佳运行状态。<br> ![在<img src="https://images2.imgbox.com/53/02/iIvMxT4l_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="_205"></a><strong>总结</strong></h2> 
<p>API网关作为微服务架构的核心组件，不仅实现了请求的统一管理和安全控制，还提供了服务发现、动态路由、请求监控与日志记录以及性能优化等高级功能。通过深入了解和掌握这些功能，我们可以构建出更加高效、安全、可靠的微服务应用。在实际应用中，我们应该根据业务需求和技术栈选择合适的技术和工具，并结合最佳实践进行配置和优化，以充分发挥API网关的优势。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/375e26c09f514e428cc2775419b39716/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【FFmpeg】ffmpeg 命令行参数 ⑥ ( 使用 FFmpeg 提取 YUV 像素格式数据 | 使用 FFmpeg 提取 RGB 像素格式数据 | RGB 与 YUV 之间的格式转换 )</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/20effa966ca9009276d2ce59fd74c5d1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">写读后感的时候，可以适当地引用书中的内容吗？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>