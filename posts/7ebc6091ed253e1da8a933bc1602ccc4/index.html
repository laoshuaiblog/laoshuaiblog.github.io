<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python中数字和字符串的最佳实践(下) - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/7ebc6091ed253e1da8a933bc1602ccc4/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Python中数字和字符串的最佳实践(下)">
  <meta property="og:description" content="上一讲中我们学习了python中枚举、魔数的使用，今天咱们来看看还有那些实用小TIP。
实用小贴士 布尔值其实是“数字” 在 Python 中，布尔值 True 和 False 在大多数情况下可以直接等同于两个整数 1 和 0，就像这样：
&amp;gt;&amp;gt;&amp;gt; True &#43; 1 2 &amp;gt;&amp;gt;&amp;gt; 1 / False Traceback (most recent call last): File &#34;&#34;, line 1, in ZeroDivisionError: division by zero 那么记住这一点有什么用呢？首先，它们可以与 sum 函数结合使用，在计算总数时简化操作。
&amp;gt;&amp;gt;&amp;gt; l = [1, 2, 4, 5, 7] &amp;gt;&amp;gt;&amp;gt; sum(i % 2 == 0 for i in l) 2 此外，如果布尔表达式用作列表的索引，它可以实现类似于三元表达式的目的。
# 类似的三元表达式：&#34;Javascript&#34; if 2 &amp;gt; 1 else &#34;Python&#34; &amp;gt;&amp;gt;&amp;gt; [&#34;Python&#34;, &#34;">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-08T08:37:11+08:00">
    <meta property="article:modified_time" content="2024-02-08T08:37:11+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python中数字和字符串的最佳实践(下)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="https://blog.csdn.net/Tory2/article/details/136051013">上一讲</a>中我们学习了python中枚举、魔数的使用，今天咱们来看看还有那些实用小TIP。</p> 
<h2><a id="_3"></a>实用小贴士</h2> 
<h3><a id="_4"></a>布尔值其实是“数字”</h3> 
<p>在 Python 中，布尔值 True 和 False 在大多数情况下可以直接等同于两个整数 1 和 0，就像这样：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token boolean">True</span> <span class="token operator">+</span> <span class="token number">1</span>  
<span class="token number">2</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token boolean">False</span>  
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  
File <span class="token string">""</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span>  
ZeroDivisionError<span class="token punctuation">:</span> division by zero
</code></pre> 
<p>那么记住这一点有什么用呢？首先，它们可以与 sum 函数结合使用，在计算总数时简化操作。</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> l<span class="token punctuation">)</span>  
<span class="token number">2</span>
</code></pre> 
<p>此外，如果布尔表达式用作列表的索引，它可以实现类似于三元表达式的目的。</p> 
<pre><code class="prism language-python"><span class="token comment"># 类似的三元表达式："Javascript" if 2 &gt; 1 else "Python"  </span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"Python"</span><span class="token punctuation">,</span> <span class="token string">"Javascript"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span>  
<span class="token string">'Javascript'</span>
</code></pre> 
<h3><a id="_28"></a>提高长字符串的可读性</h3> 
<p>单行代码的长度不应太长。例如，PEP8 建议每行字符数不超过 79。在现实世界中，大多数人遵循每行字符数在 79 到 119 之间的最大限制。如果只是代码，这些要求相对容易满足，但如果代码中需要非常长的字符串怎么办呢？</p> 
<p>在这种情况下，除了使用反斜杠 <code>\</code> 和加号 <code>+</code> 将长字符串拆分成多行外，还有另一种更简单的方法：<strong>将长字符串放在括号中允许任意换行：</strong></p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> <span class="token punctuation">(</span>  
<span class="token string">"There is something really bad happened during the process. "</span>  
<span class="token string">"Please contact your administrator."</span>  
<span class="token punctuation">)</span>  
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>  
  
  
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>  
<span class="token string">"There is something really bad happened during the process. "</span>  
<span class="token string">"Please contact your administrator."</span>  
<span class="token punctuation">)</span>
</code></pre> 
<p><strong>在多层缩进中存在多行字符串时</strong><br> 在日常编码中，还有一种更麻烦的情况。那就是当我们需要将多行字符串字面量插入已经有缩进级别的代码时。由于多行字符串不能包含当前缩进空格，我们需要这样编写代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
<span class="token keyword">if</span> user<span class="token punctuation">.</span>is_active<span class="token punctuation">:</span>  
message <span class="token operator">=</span> <span class="token triple-quoted-string string">"""Welcome, today's movie list:  
- Jaw (1975)  
- The Shining (1980)  
- Saw (2004)"""</span>
</code></pre> 
<p>然而，这样写会破坏整个段落代码的可视效果，显得非常突兀。有许多改进方法，例如将这个多行字符串提取为模块的最外层变量。但如果使用字面量更适合您的代码逻辑，您也可以使用标准库 <code>textwrap</code> 来解决这个问题。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> textwrap <span class="token keyword">import</span> dedent  
  
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
<span class="token keyword">if</span> user<span class="token punctuation">.</span>is_active<span class="token punctuation">:</span>  
<span class="token comment"># dedent 会删除整个段落左侧的前导空格。  </span>
message <span class="token operator">=</span> dedent<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""\  
Welcome, today's movie list:  
- Jaw (1975)  
- The Shining (1980)  
- Saw (2004)"""</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>大数字也可以更易读</strong></p> 
<p>对于特别大的数字，您可以通过在中间添加下划线来提高可读性（<a href="https://peps.python.org/pep-0515/" rel="nofollow">PEP515</a>，需要 Python 3.6+）。</p> 
<p>例如：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">10_000_000.0</span> <span class="token comment"># 每三位数划分。  </span>
<span class="token number">10000000.0</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">0xCAFE_F00D</span> <span class="token comment"># 十六进制数字也有效，将其分组为四位数时更易读。  </span>
<span class="token number">3405705229</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">0b_0011_1111_0100_1110</span> <span class="token comment"># 二进制也是有效的。  </span>
<span class="token number">16206</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">'0b_1111_0000'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 在处理字符串时，下划线也会被正确处理。  </span>
<span class="token number">240</span>
</code></pre> 
<h3><a id="r_89"></a>不要忘记以“r”开头的内置字符串函数</h3> 
<p>Python 的字符串有许多有用的内置方法，最常用的是 <code>.strip()</code> 和 <code>.split()</code>。大多数这些内置方法是从左到右处理的。但是，一些以 <code>r</code> 开头的镜像方法是从<strong>右到左</strong>处理的。在处理特定逻辑时，使用它们可以极大地提高效率。</p> 
<p>假设我们需要解析一些格式为 “{user_agent}” {content_length} 的访问日志：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> log_line <span class="token operator">=</span> <span class="token string">'"AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36" 47632'</span>
</code></pre> 
<p>然而，如果使用 <code>.rsplit()</code>，处理逻辑会更加直观：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> log_line<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  
<span class="token punctuation">[</span><span class="token string">'"AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36"'</span><span class="token punctuation">,</span> <span class="token string">'47632'</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_floatinf_103"></a>使用“无穷大” float(“inf”)</h3> 
<p>如果有人问你，“<em>Python 中最大/最小的数字是什么？</em>” 你该如何回答？这样的东西存在吗？</p> 
<p>答案是：“<em>是的，它们是：</em> <code>float(“inf”)</code> <em>和</em> <code>float(“-inf”)</code>”。它们对应于数学世界中的正无穷和负无穷。与任何数值进行比较时，它们遵循这个规则：<code>float(“-inf”) &lt; 任何数值 &lt; float(“inf”)</code>。</p> 
<p>由于这些特性，我们可以在某些场景中使用它们。</p> 
<pre><code class="prism language-python"><span class="token comment"># A. 按年龄升序排序，而不是将年龄放在最后。  </span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> users <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"tom"</span><span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">"jenny"</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">"jack"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">"andrew"</span><span class="token punctuation">:</span> <span class="token number">43</span><span class="token punctuation">}</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> user<span class="token punctuation">:</span> users<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  
<span class="token punctuation">[</span><span class="token string">'jenny'</span><span class="token punctuation">,</span> <span class="token string">'tom'</span><span class="token punctuation">,</span> <span class="token string">'andrew'</span><span class="token punctuation">,</span> <span class="token string">'jack'</span><span class="token punctuation">]</span>  
  
<span class="token comment"># B. 作为循环的初始值，简化第一次判断的逻辑。  </span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> max_num <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># 在列表中找到最大的数字。  </span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span> <span class="token keyword">if</span> i <span class="token operator">&gt;</span> max_num<span class="token punctuation">:</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span> max_num <span class="token operator">=</span> i  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>  
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> max_num  
<span class="token number">71</span>
</code></pre> 
<h2><a id="_129"></a>常见误解</h2> 
<h3><a id="value__1__131"></a>“value += 1” 不是线程安全的</h3> 
<p>当我们编写多线程程序时，通常需要处理复杂的共享变量和竞争条件。</p> 
<p>“线程安全”通常用于描述一种行为或一类数据结构，它们可以在多线程环境中共享和使用，以产生预期的结果。符合 “线程安全” 要求的典型模块是 <a href="https://docs.python.org/3/library/queue.html" rel="nofollow">queue 模块</a>。</p> 
<p>而我们经常做的操作 <code>value += 1</code> 很容易被认为是“线程安全”的。因为它看起来像是一个原子操作（指执行过程中不插入任何其他操作的最小操作单元）。但这并不正确。尽管从 Python 代码的角度来看，<code>value += 1</code> 操作似乎是原子的。但当它由 Python 解释器执行时，它就不再是“原子”的了。</p> 
<p>我们可以使用前面提到的 <code>dis</code> 模块来验证：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">incr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>  
value <span class="token operator">+=</span> <span class="token number">1</span>  
  
  
<span class="token comment"># 使用 dis 模块查看字节码。  </span>
<span class="token keyword">import</span> dis  
  
dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>incr<span class="token punctuation">)</span>  
<span class="token number">0</span> LOAD_FAST <span class="token number">0</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span>  
<span class="token number">2</span> LOAD_CONST <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  
<span class="token number">4</span> INPLACE_ADD  
<span class="token number">6</span> STORE_FAST <span class="token number">0</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span>  
<span class="token number">8</span> LOAD_CONST <span class="token number">0</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>  
<span class="token number">10</span> RETURN_VALUE
</code></pre> 
<p>在上面的输出中，可以看到这个简单的累加语句会被编译成几个不同的步骤，包括值的检索和保存。在多线程环境中，任何其他线程都可能中断其中的一个步骤，从而妨碍您获得正确的结果。</p> 
<p><strong>因此，请不要依赖直觉来判断一个行为是否“线程安全”。否则，当在高并发条件下程序中出现奇怪的错误时，您将为自己的直觉付出痛苦的代价。</strong></p> 
<h3><a id="_160"></a>字符串拼接不慢</h3> 
<p>当我刚开始学习 Python 时，我在一个网站上看到一个说法：“<em>Python 中的字符串是不可变的，所以每次你连接字符串时，都会创建一个新对象，导致新的内存分配，效率非常低下。</em>” 我全然相信了这一点。</p> 
<p>因此，我一直尽量避免使用 <code>+=</code> 运算符来拼接字符串，而是使用像 <code>“”.join(str_list)</code> 这样的方法来替代。</p> 
<p>然而，偶然间，我对 <strong>Python 中的字符串拼接</strong> 进行了简单的性能测试，发现它一点也不慢！经过查阅一些信息，我终于发现了真相。</p> 
<p>在 Python 2.2 版本之前，Python 中的字符串拼接确实很慢，与我最初看到的情况一致。但由于这个操作非常常见，随后的版本对它进行了特定的性能优化。这极大地提高了执行效率。</p> 
<p>如今，使用 <code>+=</code> 运算符来拼接字符串的效率已经非常接近使用 <code>“”.join(str_list)</code>。因此，需要时可以放心拼接，不用担心任何性能问题。</p> 
<h2><a id="_172"></a>结语</h2> 
<p>以上是“Python 工匠”系列的第三篇文章，内容颇为零碎。由于篇幅限制，一些常见操作，如字符串格式化，在本文中没有涉及。如果有机会，我将稍后写一些关于它们的内容。</p> 
<p>让我们再次总结关键点：</p> 
<ul><li>在编写代码时，请考虑读者的体验，避免使用过多的神奇字面量。</li><li>在操作结构化字符串时，使用面向对象的模块比直接处理更具优势。</li><li>dis 模块非常有用，请经常使用它来验证您的猜想。</li><li>在多线程环境中进行编码非常复杂；谨慎行事，不要相信您的直觉。</li><li>Python 语言更新非常迅速；不要受到他人经验的影响。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8724617ab6e28a692e680b0762840c89/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一篇文章入门Shell编程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/798d095e8c313ee15d4b313dd773c876/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;57个入门知识点_44：单例的实现与理解（单例：提供唯一类的实例；静态对象的存储位置及生命周期；静态对象指针实现单例（懒汉式，较多用）；静态对象引用实现单例（更安全），禁用拷贝构造）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>