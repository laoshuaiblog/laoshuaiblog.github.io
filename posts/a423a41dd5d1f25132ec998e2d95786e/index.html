<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何使用MCP2518FD外部CAN FD控制器实现速速CAN通信 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/a423a41dd5d1f25132ec998e2d95786e/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="如何使用MCP2518FD外部CAN FD控制器实现速速CAN通信">
  <meta property="og:description" content="MCP2518FD外部CAN FD控制器具有小尺寸和SPI接口，可实现轻松连接。可将CAN FD通道轻松添加到缺少CAN FD外设或没有所需CAN FD通道的微控制器上。MCP2518FD支持经典格式 (CAN 2.0B) 和CAN灵活数据速率 (CAN FD) 格式中的CAN帧格式，符合ISO11898-1:2015标准。
框图：
本文实验板MCU：STM32F103C8T6
CAN FD控制器：MCP2518FD
CAN FD收发器：ATA6560
开发环境：Keil uVision5.28
想了解开发板更详细信息，请点击 MCP2518FD学习评估套件
MCP2518FD学习评估套件 电路图如下：
典型应用
上图有两部分组成，一部分是CAN控制器mcp2518fd，另一部分就是CANFD收发器ATA6563，我们实验板上用的是ATA6560，和ATA6563 PIN to PIN。
对于CAN 收发器，有两个引脚要特别注意，就是STBY和NSIL引脚，这两个引脚的状态控制CAN收发器工作状态，如下图：
CAN收发器STBY接地，VIO（NSIL）接3.3v，VDD接5V，VSS接地。
1、SPI时序 我们要配置寄存器，要通过SPI总线发数据过去，相对于外设就是SDI接口的数据：Command &#43; Address &#43; Data.
第一个字节：4位命令&#43;4位地址；第二个字节：8位地址；第三个字节及以后：都是数据； 所以往寄存器写一个字节时序可以这么写：
// write one byte
spiTransmitBuffer[0] = (uint8_t) ((CMD &amp;lt;&amp;lt; 4) &#43; ((ADDR &amp;gt;&amp;gt; 8) &amp;amp; 0xF)); // 4位指令码&#43;地址高4位
spiTransmitBuffer[1] = (uint8_t) (ADDR&amp;amp; 0xFF); // 地址低8位
spiTransmitBuffer[2] = txdata; // 数据位">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-10-23T11:37:16+08:00">
    <meta property="article:modified_time" content="2022-10-23T11:37:16+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何使用MCP2518FD外部CAN FD控制器实现速速CAN通信</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>         MCP2518FD外部CAN FD控制器具有小尺寸和SPI接口，可实现轻松连接。可将CAN FD通道轻松添加到缺少CAN FD外设或没有所需CAN FD通道的微控制器上。MCP2518FD支持经典格式 (CAN 2.0B) 和CAN灵活数据速率 (CAN FD) 格式中的CAN帧格式，符合ISO11898-1:2015标准。</p> 
<p><img alt="" height="253" src="https://images2.imgbox.com/c1/dd/MUOXmYBO_o.png" width="999"></p> 
<p> 框图：<img alt="" height="562" src="https://images2.imgbox.com/6d/b9/NXirce5w_o.png" width="991"></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#e36c0a;">本文实验板</span></strong><strong><span style="color:#e36c0a;">MCU</span></strong><strong><span style="color:#e36c0a;">：</span></strong><strong><span style="color:#e36c0a;">STM32F103C8T6</span></strong></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#e36c0a;">CAN FD</span></strong><strong><span style="color:#e36c0a;">控制器：</span></strong><strong><span style="color:#e36c0a;">MCP2518FD</span></strong></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#e36c0a;">CAN FD</span></strong><strong><span style="color:#e36c0a;">收发器：</span></strong><strong><span style="color:#e36c0a;">ATA6560</span></strong></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#e36c0a;">开发环境：</span></strong><strong><span style="color:#e36c0a;">Keil uVision5.28</span></strong></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#e36c0a;">想了解开发板更详细信息，请点击 </span></strong>MCP2518FD学习评估套件</p> 
<h4><a class="link-info" href="https://item.taobao.com/item.htm?spm=a21dvs.23580594.0.0.52de3d0dXRZrF4&amp;ft=t&amp;id=687963081248" rel="nofollow" title="MCP2518FD学习评估套件">MCP2518FD学习评估套件</a></h4> 
<p><img alt="" height="600" src="https://images2.imgbox.com/09/1d/gYknuSou_o.jpg" width="600"></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:justify;">电路图如下：</p> 
<p><img alt="" height="725" src="https://images2.imgbox.com/19/38/bcf3efuB_o.png" width="869"></p> 
<p> 典型应用</p> 
<p><img alt="" height="502" src="https://images2.imgbox.com/af/54/BkLr03oG_o.png" width="869"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4f4f4f;">上图有两部分组成，一部分是</span><span style="color:#4f4f4f;">CAN</span><span style="color:#4f4f4f;">控制器</span><span style="color:#4f4f4f;">mcp2518fd</span><span style="color:#4f4f4f;">，另一部分就是</span><span style="color:#4f4f4f;">CANFD</span><span style="color:#4f4f4f;">收发器</span><span style="color:#4f4f4f;">ATA6563</span><span style="color:#4f4f4f;">，我们实验板上用的是</span><span style="color:#4f4f4f;">ATA6560</span><span style="color:#4f4f4f;">，和</span><span style="color:#4f4f4f;">ATA6563 PIN to PIN</span><span style="color:#4f4f4f;">。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4f4f4f;">对于</span><span style="color:#4f4f4f;">CAN </span><span style="color:#4f4f4f;">收发器，有两个引脚要特别注意，就是</span><span style="color:#4f4f4f;">STBY</span><span style="color:#4f4f4f;">和</span><span style="color:#4f4f4f;">NSIL</span><span style="color:#4f4f4f;">引脚，这两个引脚的状态控制</span><span style="color:#4f4f4f;">CAN</span><span style="color:#4f4f4f;">收发器工作状态，如下图：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">CAN</span></span></strong><strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">收发器</span></span></strong><strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">STBY</span></span></strong><strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">接地</span></span></strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">，</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">VIO</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">（</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">NSIL</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">）接</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">3.3v</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">，</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">VDD</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">接</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">5V</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">，</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">VSS</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">接地。</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="480" src="https://images2.imgbox.com/be/9b/j5PZeAu7_o.png" width="1200"></p> 
<h2><span style="background-color:#f9eda6;"> 1、SPI时序</span></h2> 
<p></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="438" src="https://images2.imgbox.com/5b/34/BNMg85oz_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">我们要配置寄存器，要通过SPI总线发数据过去，相对于外设就是SDI接口的数据：<strong><span style="color:#3c3b3b;">Command</span></strong> + <strong><span style="color:#f33b45;">Address</span></strong> +<strong><span style="color:#f33b45;"> Data</span></strong>.</p> 
<ul><li style="text-align:left;"><span style="background-color:#f4f4f4;"><span style="color:#7c79e5;">第一个字节：</span><span style="color:#7c79e5;">4</span><span style="color:#7c79e5;">位命令</span><span style="color:#7c79e5;">+4</span><span style="color:#7c79e5;">位地址；</span></span></li><li style="text-align:left;"><span style="background-color:#f4f4f4;"><span style="color:#7c79e5;">第二个字节：</span><span style="color:#7c79e5;">8</span><span style="color:#7c79e5;">位地址；</span></span></li><li style="text-align:left;"><span style="background-color:#f4f4f4;"><span style="color:#7c79e5;">第三个字节及以后：都是数据；</span></span></li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">所以往寄存器写一个字节时序可以这么写：</p> 
<p style="margin-left:.0001pt;text-align:justify;">// write one byte</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">spiTransmitBuffer[0] = (uint8_t) ((CMD &lt;&lt; 4) + ((ADDR &gt;&gt; 8) &amp; 0xF));</span>  // 4位指令码+地址高4位</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">spiTransmitBuffer[1] = (uint8_t) (ADDR&amp; 0xFF);   </span>         // 地址低8位</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">spiTransmitBuffer[2] = txdata;                                          </span><span style="color:#000000;">// </span><span style="color:#000000;">数据位</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">同理，写halfWord或者one Word也可以这样定义。</p> 
<p style="margin-left:.0001pt;text-align:justify;">指令：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="516" src="https://images2.imgbox.com/c9/37/LGEtJ7EV_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">注意：只有在器件进入配置模式后才能发出RESET 指令</p> 
<h2><span style="background-color:#f9eda6;"> 2、MCP2518FD 驱动程序移植</span></h2> 
<h4>2.1 下载驱动程序</h4> 
<p style="margin-left:.0001pt;text-align:justify;">从Microchip 官网下载此IC的驱动程序，一共包括4个文件: drv_canfdspi_api.c，drv_canfdspi_api.h，drv_canfdspi_defines.h，drv_canfdspi_register.h</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="124" src="https://images2.imgbox.com/b0/a6/1hfXkUnF_o.png" width="775"></p> 
<p style="margin-left:.0001pt;text-align:justify;">drv_canfdspi_api.c 里面是MCP2515FD的驱动函数。</p> 
<p style="margin-left:.0001pt;text-align:justify;">drv_canfdspi_api.h 应对.c文件函数的声明</p> 
<p style="margin-left:.0001pt;text-align:justify;">drv_canfdspi_defines.h 寄存器的值定义，比如CAN_DLC等等</p> 
<p style="margin-left:.0001pt;text-align:justify;">drv_canfdspi_register.h 寄存器的定义</p> 
<p style="margin-left:.0001pt;text-align:justify;">由于这4个文件都是官方做好的，我们只管拿过来用，尽量不要去修改里面的内容。</p> 
<p style="margin-left:.0001pt;text-align:justify;">在Keil MDK建好工程后，直接把这4个文件添加到工程中。</p> 
<h4> 2.2 编写SPI驱动程序</h4> 
<p style="margin-left:.0001pt;text-align:justify;">//SPIx 读写一个字节</p> 
<p style="margin-left:.0001pt;text-align:justify;">//TxData:要写入的字节</p> 
<p style="margin-left:.0001pt;text-align:justify;">//返回值:读取到的字节  SPI通信可以同进读写数据</p> 
<p style="margin-left:.0001pt;text-align:justify;">uint8_t SPI2_ReadWriteByte(uint8_t TxData)</p> 
<p style="margin-left:.0001pt;text-align:justify;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">         u8 dat=0,i;</p> 
<p style="margin-left:.0001pt;text-align:justify;">        </p> 
<p style="margin-left:.0001pt;text-align:justify;">         for(i=0;i&lt;8;i++)</p> 
<p style="margin-left:.0001pt;text-align:justify;">         {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">                  if(TxData &amp; 0x80)                                       // 如果位为1，则发送1，否则发送0</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">                          CAN1_SPI_MOSI_HIGH();                // 发送1  </p> 
<p style="margin-left:.0001pt;text-align:justify;">                  }</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  else{CAN1_SPI_MOSI_LOW();                // 发送0</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  }</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  TxData&lt;&lt;= 1;</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  dat &lt;&lt;= 1;</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  __NOP();</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  __NOP();</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  if(CAN1_MISO())</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  {dat += 1; }</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  CAN1_SPI_CLK_HIGH();</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  __NOP();</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  __NOP();</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  CAN1_SPI_CLK_LOW();</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  __NOP();</p> 
<p style="margin-left:.0001pt;text-align:justify;">                  __NOP();</p> 
<p style="margin-left:.0001pt;text-align:justify;">         }</p> 
<p style="margin-left:.0001pt;text-align:justify;">         CAN1_SPI_MOSI_LOW();</p> 
<p style="margin-left:.0001pt;text-align:justify;">         return dat;</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<h4> 2.3 SPI通信</h4> 
<p style="margin-left:.0001pt;text-align:justify;">通过分析官方给的4个文件，我们真正关心的，其实就是drv_canfdspi_api.c里的驱动函数，那如何将stm32f103c8t6的SPI函数连接上里面的函数呢？</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">SPI </span><span style="color:#c00000;">数据的读写：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">//</span><span style="color:#c00000;">数据读写</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">int8_t DRV_SPI_TransferData(uint8_t spiSlaveDeviceIndex, uint8_t *SpiTxData, uint8_t *SpiRxData, uint16_t spiTransferSize);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">没错，就是这个函数。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">spiSlaveDeviceIndex</span><span style="color:#c00000;">：</span> <span style="color:#c00000;">由于</span><span style="color:#c00000;">SPI</span><span style="color:#c00000;">总线只接</span><span style="color:#c00000;">1</span><span style="color:#c00000;">个</span><span style="color:#c00000;">MCP2518FD</span><span style="color:#c00000;">，所以这个值一直定义为</span><span style="color:#c00000;">0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">*SpiTxData</span><span style="color:#c00000;">：要发送的数据首地址</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">*SpiRxData</span><span style="color:#c00000;">：接收数据存放在首地址</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">spiTransferSize</span><span style="color:#c00000;">：发送数据的字节数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">完整函数如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="169" src="https://images2.imgbox.com/71/c5/ZjVbcsJo_o.png" width="865"></p> 
<p><img alt="" height="384" src="https://images2.imgbox.com/19/d1/GEpWYl8p_o.png" width="865"></p> 
<h4 style="margin-left:0px;text-align:justify;"><a name="_Toc115632649">2.4 CAN</a>初始化</h4> 
<p style="margin-left:.0001pt;text-align:justify;">void MCP251xFD_canfd_cfg_init(CAN_BITTIME_SETUP baud)</p> 
<p style="margin-left:.0001pt;text-align:justify;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">         REG_CiFLTOBJ fObj;</p> 
<p style="margin-left:.0001pt;text-align:justify;">         REG_CiMASK mObj;</p> 
<p style="margin-left:.0001pt;text-align:justify;">         CAN_TX_FIFO_CONFIG txConfig;</p> 
<p style="margin-left:.0001pt;text-align:justify;">         CAN_RX_FIFO_CONFIG rxConfig;</p> 
<p style="margin-left:.0001pt;text-align:justify;">         CAN_CONFIG config;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Reset device</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_Reset(CANFD_CH1);   <span style="color:#00863d;">//</span><span style="color:#00863d;">复位</span><span style="color:#00863d;">MCP2518FD </span><span style="color:#00863d;">所有</span><span style="color:#00863d;">SFR</span><span style="color:#00863d;">和状态机都会像上电复位期间一样复位，器件会立即进入配置模式</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         // Enable ECC and initialize RAM</p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_EccEnable(CANFD_CH1);    <span style="color:#00863d;">//</span><span style="color:#00863d;">使能</span><span style="color:#00863d;">ECC(ECC</span><span style="color:#00863d;">逻辑支持单个位错误纠正和双位错误检测</span><span style="color:#00863d;">)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_RamInit(CANFD_CH1, 0xff);         <span style="color:#00863d;">//</span><span style="color:#00863d;">并将</span><span style="color:#00863d;">RAM</span><span style="color:#00863d;">空间初始化为初值</span><span style="color:#00863d;">0xFF</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">                         </p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Configure device</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_ConfigureObjectReset(&amp;config);<span style="color:#00863d;">       //MCP2518FD</span><span style="color:#00863d;">配置信息复位</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         config.IsoCrcEnable = 1;                 <span style="color:#00863d;">// </span><span style="color:#00863d;">使能</span><span style="color:#00863d;">CAN FD</span><span style="color:#00863d;">帧中的</span><span style="color:#00863d;">ISO CRC</span><span style="color:#00863d;">位</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         config.StoreInTEF = 0;<span style="color:#00863d;">// </span><span style="color:#00863d;">不将发送的报文保存到</span><span style="color:#00863d;">TEF</span><span style="color:#00863d;">中，也就不在</span><span style="color:#00863d;">RAM</span><span style="color:#00863d;">中预留</span><span style="color:#00863d;">TEF</span><span style="color:#00863d;">空间</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         config.BitRateSwitchDisable = 0; <span style="color:#00863d;"> // Depends on the BRS bit on TX msg</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         //CiCON-&gt;addr:0x00-03 </span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_Configure(CANFD_CH1, &amp;config);     <span style="color:#00863d;">//MCP2518FD</span><span style="color:#00863d;">配置</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Setup TX FIFO  </span><span style="color:#00863d;">发送</span><span style="color:#00863d;">FIFO</span><span style="color:#00863d;">配置</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_TransmitChannelConfigureObjectReset(&amp;txConfig);</p> 
<p style="margin-left:.0001pt;text-align:justify;">         txConfig.FifoSize = 11;                                                              <span style="color:#00863d;">// </span><span style="color:#00863d;">采用</span><span style="color:#00863d;">FIFO11</span><span style="color:#00863d;">作为发送</span><span style="color:#00863d;">FIFO</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         txConfig.PayLoadSize = CAN_PLSIZE_64;     <span style="color:#00863d;">// </span><span style="color:#00863d;">有效负载大小位</span><span style="color:#00863d;">64</span><span style="color:#00863d;">个数据字节</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         txConfig.TxPriority = 1;                                                       <span style="color:#00863d;">// </span><span style="color:#00863d;">使能奇偶校验位</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">//CiTXQCON-&gt;addr:0x50-53 + CAN_FIFO_CHn*12</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_TransmitChannelConfigure(CANFD_CH1, CAN_TX_FIFO, &amp;txConfig);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         // Setup RX FIFO              </span><span style="color:#00863d;">接收</span><span style="color:#00863d;">FIFO</span><span style="color:#00863d;">配置</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_ReceiveChannelConfigureObjectReset(&amp;rxConfig);</p> 
<p style="margin-left:.0001pt;text-align:justify;">         rxConfig.FifoSize = 15;                                                        <span style="color:#00863d;">       // </span><span style="color:#00863d;">采用</span><span style="color:#00863d;">FIFO15</span><span style="color:#00863d;">作为接收</span><span style="color:#00863d;">FIFO</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         rxConfig.PayLoadSize = CAN_PLSIZE_64;     <span style="color:#00863d;">// </span><span style="color:#00863d;">有效负载大小位</span><span style="color:#00863d;">64</span><span style="color:#00863d;">个数据字节</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         rxConfig.RxTimeStampEnable = 1;                                   <span style="color:#00863d;">// </span><span style="color:#00863d;">捕捉时间戳</span><span style="color:#00863d;"> (</span><span style="color:#00863d;">去研究下，捕捉和不捕捉的区别在哪里</span><span style="color:#00863d;">)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">        </p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         //CiFIFOCON1-&gt;addr:0x50-53 + CAN_FIFO_CHn*12</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_ReceiveChannelConfigure(CANFD_CH1, CAN_RX_FIFO, &amp;rxConfig);</p> 
<p style="margin-left:.0001pt;text-align:justify;">        </p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         // set time stamp</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_TimeStampModeConfigure(CANFD_CH1,CAN_TS_RES);</p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_TimeStampPrescalerSet(CANFD_CH1,40-1);     <span style="color:#00863d;">//40 clk </span><span style="color:#00863d;">加</span><span style="color:#00863d;">1</span><span style="color:#00863d;">，</span><span style="color:#00863d;">40M</span><span style="color:#00863d;">晶体，单位</span><span style="color:#00863d;">1us</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_TimeStampSet(CANFD_CH1,0);</p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_TimeStampEnable(CANFD_CH1);       <span style="color:#00863d;">//</span><span style="color:#00863d;">使能时间戳</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         // Setup RX Filter           </span><span style="color:#00863d;">接收滤波器设置</span> <span style="color:#00863d;">，只接收数据侦</span><span style="color:#00863d;">ID</span><span style="color:#00863d;">为</span><span style="color:#00863d;">0x128</span><span style="color:#00863d;">的数据（前提是屏蔽寄存器有效）</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         fObj.word = 0;</p> 
<p style="margin-left:.0001pt;text-align:justify;">         fObj.bF.SID = 0x128;       <span style="color:#00863d;">// </span><span style="color:#00863d;">接收标准标识符</span><span style="color:#00863d;"> 11bit             </span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         fObj.bF.EXIDE = 0;           <span style="color:#00863d;">// </span><span style="color:#00863d;">接收扩展标识符使能位</span><span style="color:#00863d;"> 1 enable, 0 disable  1bit</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         fObj.bF.EID = 0;                <span style="color:#00863d;">         // </span><span style="color:#00863d;">接收扩展标识符</span><span style="color:#00863d;"> 18bit</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">//CiFLTCON0-&gt;0x1D0-0x1D3</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_FilterObjectConfigure(CANFD_CH1, CAN_FILTER0, &amp;fObj.bF);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Setup RX Mask                     </span><span style="color:#00863d;">接收屏蔽器设置</span> <span style="color:#00863d;">高电平有效</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         mObj.word = 0;                                 <span style="color:#00863d;">// 32bit </span><span style="color:#00863d;">寄存器写法，这里不用</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         mObj.bF.MSID = 0x128;<span style="color:#00863d;">  // </span><span style="color:#00863d;">接收标准标识符屏蔽位</span> <span style="color:#00863d;">如果不应用于范围控制，就设置值等于</span><span style="color:#00863d;"> fObj.bF.SID</span><span style="color:#00863d;">，一对一对应</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         mObj.bF.MIDE = 1;                  <span style="color:#00863d;">// </span><span style="color:#00863d;">只适用于扩展侦模式，标准侦模式时，这个位不起作用</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         mObj.bF.MEID = 0;          <span style="color:#00863d;">         // </span><span style="color:#00863d;">接收扩展标识符屏蔽位</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">        </p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         //CiMASK0       </span>                                                                              </p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_FilterMaskConfigure(CANFD_CH1, CAN_FILTER0, &amp;mObj.bF);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Link FIFO and Filter </span><span style="color:#00863d;">将接收滤波器与接收屏蔽器与接收</span><span style="color:#00863d;">FIFO</span><span style="color:#00863d;">绑定，则满足接收滤波器和接收屏蔽器规则的报文会在相应的</span><span style="color:#00863d;">FIFO</span><span style="color:#00863d;">接收。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_FilterToFifoLink(CANFD_CH1, CAN_FILTER0, CAN_RX_FIFO, true);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Setup Bit Time </span><span style="color:#00863d;">设置位时间</span>  <span style="color:#00863d;">总线波特率</span><span style="color:#00863d;"> baud</span><span style="color:#00863d;">，这里采用自动测量发送器延时的方式实现二次采样点采集数据位</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         // CiNBTCFG-&gt;0x04-0x07</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_BitTimeConfigure(CANFD_CH1, baud, CAN_SSP_MODE_AUTO, CAN_SYSCLK_40M);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Setup Transmit and Receive Interrupts</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         // IOCONN-&gt;0xE04-0xE07</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_GpioModeConfigure(CANFD_CH1, GPIO_MODE_INT, GPIO_MODE_INT);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         //CiFOFICON0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_ReceiveChannelEventEnable(CANFD_CH1, CAN_RX_FIFO, CAN_RX_FIFO_NOT_EMPTY_EVENT);</p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">//CiINT-&gt;0x1C</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_ModuleEventEnable(CANFD_CH1, CAN_RX_EVENT);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">         <span style="color:#00863d;">// Select Normal Mode    </span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00863d;">         //CiCON-&gt;0x00-0x03</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">         DRV_CANFDSPI_OperationModeSelect(CANFD_CH1, CAN_NORMAL_MODE);</p> 
<p style="margin-left:.0001pt;text-align:justify;">//     DRV_CANFDSPI_OperationModeSelect(CANFD_CH1, CAN_INTERNAL_LOOPBACK_MODE);</p> 
<p style="margin-left:.0001pt;text-align:justify;">                                                       </p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<h4>2.5 CAN收发函数</h4> 
<p style="margin-left:.0001pt;text-align:justify;">先将数据打包，然后发送</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="299" src="https://images2.imgbox.com/43/6d/1CEUScPx_o.png" width="1194"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">CAN接收数据，这里用的是查询方式，先查询MCP2518FD INT引脚状态变化，如有变化，接收数据，其实，这个方法，很容易应用中断方式来接收。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="550" src="https://images2.imgbox.com/7c/61/i7C6W8jL_o.png" width="834">  数据接收的过程在 int8_t MCP251XFD_canfd_rcv_poll(void) 这个函数完成。</p> 
<h2><span style="background-color:#f9eda6;">3 移植大概思路</span></h2> 
<p style="margin-left:.0001pt;text-align:justify;">3.1 先从官网下载驱动代码</p> 
<p style="margin-left:.0001pt;text-align:justify;">   工程路径：MCP2518FD_STM32F103C8T6\Driver\canfdspi</p> 
<p style="margin-left:.0001pt;text-align:justify;">   <img alt="" height="130" src="https://images2.imgbox.com/9c/b6/LT0uZpxv_o.png" width="534"></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:justify;">3.2 编写STM32F103 SPI函数</p> 
<p style="margin-left:.0001pt;text-align:justify;">  工程路径：MCP2518FD_STM32F103C8T6\Driver</p> 
<p style="margin-left:.0001pt;text-align:justify;">   SPI_mcp2518fd.c 和 SPI_mcp2518fd.h</p> 
<p style="margin-left:.0001pt;text-align:justify;">  使用IO模拟SPI，并把SPI驱动连接到 drv_canfdspi_api.c 里的函数</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">int8_t DRV_SPI_TransferData(uint8_t spiSlaveDeviceIndex, uint8_t *SpiTxData, uint8_t *SpiRxData, uint16_t spiTransferSize)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">3.3 编写MCP2518FD 初始化程序</p> 
<p style="margin-left:.0001pt;text-align:justify;">  工程路径：MCP2518FD_STM32F103C8T6\User</p> 
<p style="margin-left:.0001pt;text-align:justify;">  Canfd.c 和 canfd.h</p> 
<p style="margin-left:.0001pt;text-align:justify;">  这个文件完成对MCP2518FD初始化，时钟配置，工作模式等等，都在这个函数完成：</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#c00000;">void MCP251xFD_canfd_cfg_init(CAN_BITTIME_SETUP baud)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#c00000;">当然这个文件其它函数也是常用的，比如</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">   int8_t MCP251xFD_can_transmit_msg(CANFDSPI_MODULE_ID index,CANFD_TX_MSG *tx_msg)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">   <span style="color:#c00000;">这个就是数据发送的。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">3.4 发送数据打包 和 接收数据过程</p> 
<p style="margin-left:.0001pt;text-align:justify;">   打包数据：</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <img alt="" height="353" src="https://images2.imgbox.com/e0/4b/MDREm1XX_o.png" width="729"></p> 
<p style="margin-left:.0001pt;text-align:justify;">接收数据，通过查询方式接收。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="389" src="https://images2.imgbox.com/98/47/flPck1jY_o.png" width="865"></p> 
<p></p> 
<h2 style="margin-left:0cm;"><a name="_Toc115632652"></a></h2> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6697db7de04008ce157f44949dd8fb84/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构（三）——LinkList与链表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6d24e05e328dc6fb66b7d9aa13ef797c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CAD弹窗拦截器/CAD字体自动替换工具</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>