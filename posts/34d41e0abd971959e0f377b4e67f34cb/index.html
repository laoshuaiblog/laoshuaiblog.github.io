<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Amazon SageMaker &#43; Stable Diffusion 搭建文本生成图像模型 - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/34d41e0abd971959e0f377b4e67f34cb/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="Amazon SageMaker &#43; Stable Diffusion 搭建文本生成图像模型">
  <meta property="og:description" content="如果我们的计算机视觉系统要真正理解视觉世界，它们不仅必须能够识别图像，而且必须能够生成图像。文本到图像的 AI 模型仅根据简单的文字输入就可以生成图像。
近两年，以ChatGPT为代表的AIGC技术崭露头角，逐渐从学术研究的象牙塔迈向工业应用的广阔天地。随着下游行业对快速处理柔性商业业务的需求日益增长，如何提供一个便捷、高效且完整的企业级人工智能解决方案成为了业界亟待解决的问题。幸运的是，亚马逊云服务推出了Amazon SageMaker平台，为企业提供了一站式的人工智能解决方案，满足了市场的迫切需求。
本篇文章将采用Amazon SageMaker&#43;Stable Diffusion实现文本生成图像Demo！
一、Amazon SageMaker简介 Amazon SageMaker是一款亚马逊云服务旗下的全面托管机器学习平台。该平台集成了众多高效工具和服务，使得构建、训练和部署机器学习模型变得前所未有的简单。Amazon SageMaker拥有灵活的计算资源及配置选项，无论项目规模大小，它都能以强大的计算能力，助力训练大型模型。此外，它还提供了强大的管理和监控功能，确保机器学习工作流程的顺畅运行。
Amazon SageMaker机器学习平台提供了一系列能够快速构建、训练和部署机器学习模型的工具和服务，使机器学习工作流程更加高效、易用和可扩展。现在进入
亚马逊云科技: https://mic.anruicloud.com/url/1037
可以免费试用！
​
二、Amazon SageMaker &#43; Stable Diffusion实践 2.1、创建Amazon SageMaker实例 首先打开亚马逊云控制台，在查找服务处搜索关键词SageMaker，进入Amazon SageMaker环境：
​
随后，在界面左侧定位至“笔记本”选项并点击。接着，依次选择“笔记本实例”和“创建笔记本实例”，进入配置页面。在此页面中，需注意选择适合的“笔记本实例类型”申请资源的类型，这里建议选择加速型g4dn.xlarge实例，确保高效的计算性能。
​
在操作系统方面，推荐选择Amazon Linux 2，并搭配Jupyter Lab 3这一交互式编程环境。“卷大小”可根据个人需求进行选择，建议至少设置为20GB，最后点击确定。
2.2、简单测试（可选） 创建实例成功后，可以新建一个初始notebook，复制并粘贴以下代码片段到笔记本的单元格，安装所需依赖
pip install --upgrade -q aiobotocore pip install -q xgboost==1.3.1 然后复制并粘贴以下代码片段，点击run运行：
import pandas as pd import boto3 import sagemaker import json import joblib import xgboost as xgb from sklearn.metrics import roc_auc_score # Set SageMaker and S3 client variables sess = sagemaker.">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-21T10:38:45+08:00">
    <meta property="article:modified_time" content="2024-03-21T10:38:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Amazon SageMaker &#43; Stable Diffusion 搭建文本生成图像模型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>如果我们的</strong><strong>计算机视觉</strong><strong>系统要真正理解视觉世界，它们不仅必须能够识别图像，而且必须能够生成图像</strong>。<strong>文本到图像的 </strong><strong>AI</strong><strong> 模型仅根据简单的文字输入就可以生成图像</strong>。</p> 
<p class="img-center"><img alt="" height="317" src="https://images2.imgbox.com/b2/80/HX44k2YJ_o.png" width="564"></p> 
<p>近两年，以ChatGPT为代表的AIGC技术崭露头角，逐渐从学术研究的象牙塔迈向工业应用的广阔天地。随着下游行业对快速处理柔性商业业务的需求日益增长，如何提供一个便捷、高效且完整的企业级人工智能解决方案成为了业界亟待解决的问题。幸运的是，亚马逊云服务推出了Amazon SageMaker平台，为企业提供了一站式的人工智能解决方案，满足了市场的迫切需求。</p> 
<p>本篇文章将采用Amazon SageMaker+Stable Diffusion实现文本生成图像Demo！</p> 
<h2>一、Amazon SageMaker简介</h2> 
<p>Amazon SageMaker是一款亚马逊云服务旗下的全面托管机器学习平台。该平台集成了众多高效工具和服务，使得构建、训练和部署机器学习模型变得前所未有的简单。Amazon SageMaker拥有灵活的计算资源及配置选项，无论项目规模大小，它都能以强大的计算能力，助力训练大型模型。此外，它还提供了强大的管理和监控功能，确保机器学习工作流程的顺畅运行。</p> 
<p class="img-center"><img alt="" height="281" src="https://images2.imgbox.com/7e/0a/wfv87PV9_o.png" width="647"></p> 
<p>Amazon SageMaker机器学习平台提供了一系列能够快速构建、训练和部署机器学习模型的工具和服务，使机器学习工作流程更加高效、易用和可扩展。现在进入</p> 
<p>亚马逊云科技: <a class="link-info" href="https://mic.anruicloud.com/url/1037" rel="nofollow" title="https://mic.anruicloud.com/url/1037">https://mic.anruicloud.com/url/1037</a></p> 
<p>可以免费试用！</p> 
<div> 
 <p class="img-center"><img alt="" height="446" src="https://images2.imgbox.com/cc/7b/jSeoZzCf_o.png" width="668"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<h2>二、Amazon SageMaker + Stable Diffusion实践</h2> 
<h3>2.1、创建Amazon SageMaker实例</h3> 
<p>首先打开亚马逊云控制台，在查找服务处搜索关键词SageMaker，进入Amazon SageMaker环境：</p> 
<div> 
 <p class="img-center"><img alt="" height="256" src="https://images2.imgbox.com/1a/ef/Ex1l2FhF_o.png" width="662"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<p>随后，在界面左侧定位至“笔记本”选项并点击。接着，依次选择“笔记本实例”和“创建笔记本实例”，进入配置页面。在此页面中，需注意选择适合的“笔记本实例类型”申请资源的类型，这里建议选择加速型g4dn.xlarge实例，确保高效的计算性能。</p> 
<div> 
 <p class="img-center"><img alt="" height="552" src="https://images2.imgbox.com/53/f3/sh1LNp5D_o.png" width="588"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<p>在操作系统方面，推荐选择Amazon Linux 2，并搭配Jupyter Lab 3这一交互式编程环境。“卷大小”可根据个人需求进行选择，建议至少设置为20GB，最后点击确定。</p> 
<h3>2.2、简单测试（可选）</h3> 
<p>创建实例成功后，可以新建一个初始notebook，复制并粘贴以下代码片段到笔记本的单元格，安装所需依赖</p> 
<div> 
 <pre><code class="language-python hljs">pip install --upgrade -q aiobotocore

pip install -q xgboost==<span class="hljs-number">1.3</span><span class="hljs-number">.1</span></code></pre> 
</div> 
<p>然后复制并粘贴以下代码片段，点击run运行：</p> 
<div> 
 <pre><code class="language-python hljs"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> sagemaker
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> joblib
<span class="hljs-keyword">import</span> xgboost <span class="hljs-keyword">as</span> xgb
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> roc_auc_score

<span class="hljs-comment"># Set SageMaker and S3 client variables</span>
sess = sagemaker.Session()

region = sess.boto_region_name
s3_client = boto3.client(<span class="hljs-string">"s3"</span>, region_name=region)

sagemaker_role = sagemaker.get_execution_role()

<span class="hljs-comment"># Set read and write S3 buckets and locations</span>
write_bucket = sess.default_bucket()
write_prefix = <span class="hljs-string">"fraud-detect-demo"</span>

read_bucket = <span class="hljs-string">"sagemaker-sample-files"</span>
read_prefix = <span class="hljs-string">"datasets/tabular/synthetic_automobile_claims"</span> 

train_data_key = <span class="hljs-string">f"<span class="hljs-subst">{read_prefix}</span>/train.csv"</span>
test_data_key = <span class="hljs-string">f"<span class="hljs-subst">{read_prefix}</span>/test.csv"</span>
model_key = <span class="hljs-string">f"<span class="hljs-subst">{write_prefix}</span>/model"</span>
output_key = <span class="hljs-string">f"<span class="hljs-subst">{write_prefix}</span>/output"</span>

train_data_uri = <span class="hljs-string">f"s3://<span class="hljs-subst">{read_bucket}</span>/<span class="hljs-subst">{train_data_key}</span>"</span>
test_data_uri = <span class="hljs-string">f"s3://<span class="hljs-subst">{read_bucket}</span>/<span class="hljs-subst">{test_data_key}</span>"</span>
hyperparams = {
                <span class="hljs-string">"max_depth"</span>: <span class="hljs-number">3</span>,
                <span class="hljs-string">"eta"</span>: <span class="hljs-number">0.2</span>,
                <span class="hljs-string">"objective"</span>: <span class="hljs-string">"binary:logistic"</span>,
                <span class="hljs-string">"subsample"</span> : <span class="hljs-number">0.8</span>,
                <span class="hljs-string">"colsample_bytree"</span> : <span class="hljs-number">0.8</span>,
                <span class="hljs-string">"min_child_weight"</span> : <span class="hljs-number">3</span>
              }

num_boost_round = <span class="hljs-number">100</span>
nfold = <span class="hljs-number">3</span>
early_stopping_rounds = <span class="hljs-number">10</span>



<span class="hljs-comment"># Set up data input</span>
label_col = <span class="hljs-string">"fraud"</span>
data = pd.read_csv(train_data_uri)

<span class="hljs-comment"># Read training data and target</span>
train_features = data.drop(label_col, axis=<span class="hljs-number">1</span>)
train_label = pd.DataFrame(data[label_col])
dtrain = xgb.DMatrix(train_features, label=train_label)

<span class="hljs-comment"># Cross-validate on training data</span>
cv_results = xgb.cv(
    params=hyperparams,
    dtrain=dtrain,
    num_boost_round=num_boost_round,
    nfold=nfold,
    early_stopping_rounds=early_stopping_rounds,
    metrics=[<span class="hljs-string">"auc"</span>],
    seed=<span class="hljs-number">10</span>,
)


metrics_data = {
    <span class="hljs-string">"binary_classification_metrics"</span>: {
        <span class="hljs-string">"validation:auc"</span>: {
            <span class="hljs-string">"value"</span>: cv_results.iloc[-<span class="hljs-number">1</span>][<span class="hljs-string">"test-auc-mean"</span>],
            <span class="hljs-string">"standard_deviation"</span>: cv_results.iloc[-<span class="hljs-number">1</span>][<span class="hljs-string">"test-auc-std"</span>]
        },
        <span class="hljs-string">"train:auc"</span>: {
            <span class="hljs-string">"value"</span>: cv_results.iloc[-<span class="hljs-number">1</span>][<span class="hljs-string">"train-auc-mean"</span>],
            <span class="hljs-string">"standard_deviation"</span>: cv_results.iloc[-<span class="hljs-number">1</span>][<span class="hljs-string">"train-auc-std"</span>]
        },
    }
}


<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Cross-validated train-auc:<span class="hljs-subst">{cv_results.iloc[-<span class="hljs-number">1</span>][<span class="hljs-string">'train-auc-mean'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Cross-validated validation-auc:<span class="hljs-subst">{cv_results.iloc[-<span class="hljs-number">1</span>][<span class="hljs-string">'test-auc-mean'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)</code></pre> 
</div> 
<p>这段代码的主要作用是在Amazon S3存储桶中的的汽车保险索赔数据集上，训练一个 XGBoost 二进制分类模型，并评估模型的性能并使用交叉验证来评估其性能，运行单元格后会显示交叉验证训练和验证 AUC 分数。</p> 
<h3>2.3、Stable Diffusion实践</h3> 
<p>上一步运行没问题后，我们重新打开Jupyter页面，进入对应实例，选择右侧upload，上传Notebook代码，代码下载链接：</p> 
<p>https://static.us-east-1.prod.workshops.aws/public/648e1f0c-f5e0-40eb-87b1-7f3638dba539/static/code/notebook-stable-diffusion.ipynb</p> 
<p>上传到笔记本实例当中，上传成功后，点击打开，选择conda_pytorch_p39核，并点击set kernel</p> 
<div> 
 <p class="img-center"><img alt="" height="271" src="https://images2.imgbox.com/0a/95/v6b4mbqq_o.png" width="655"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<p>这个Diffusion Model的Amazon SageMaker Jupyter文件已经为我们写好了所有配置步骤，环境安装，我们直接点击Run：</p> 
<div> 
 <p class="img-center"><img alt="" height="502" src="https://images2.imgbox.com/1c/3c/6iMqzQOo_o.png" width="668"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<p>该代码在笔记本实例中下载并测试Stable Diffusion模型文件，然后编写模型推理入口，打包模型文件，并上传至S3桶，最后使用代码部署模型至Amazon SageMaker Inference Endpoint。</p> 
<p>在juypter notebook的最后，加上这样一段代码，然后将想要生成的句子可以写在prompt里面，就可以实现完整的文本生成图像功能：</p> 
<div> 
 <pre><code class="language-python hljs"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO
<span class="hljs-keyword">import</span> base64

<span class="hljs-comment"># helper decoderdef decode_base64_image(image_string):</span>
    base64_image = base64.b64decode(image_string)
    buffer = BytesIO(base64_image)
    <span class="hljs-keyword">return</span> Image.<span class="hljs-built_in">open</span>(buffer)

<span class="hljs-comment">#run prediction</span>
response = predictor[SD_MODEL].predict(data={
    <span class="hljs-string">"prompt"</span>: [
        <span class="hljs-string">"A cute panda is sitting on the sofa"</span>,
        <span class="hljs-string">"a siamese cat wearing glasses,  working hard at the computer"</span>,
    ],
    <span class="hljs-string">"height"</span> : <span class="hljs-number">512</span>,
    <span class="hljs-string">"width"</span> : <span class="hljs-number">512</span>,
    <span class="hljs-string">"num_images_per_prompt"</span>:<span class="hljs-number">1</span>
  }
)

<span class="hljs-comment">#decode images</span>
decoded_images = [decode_base64_image(image) <span class="hljs-keyword">for</span> image <span class="hljs-keyword">in</span> response[<span class="hljs-string">"generated_images"</span>]]

<span class="hljs-comment">#visualize generationfor image in decoded_images:</span>
    display(image)</code></pre> 
</div> 
<p>如上，我们试着生成<strong>一张可爱的熊猫坐在沙发上面</strong>，等待几秒钟后，推理完成，得到如下结果：</p> 
<div> 
 <p class="img-center"><img alt="" height="458" src="https://images2.imgbox.com/4d/24/0mVR2pSc_o.png" width="458"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<h2>三、Amazon SageMaker 的功能特性</h2> 
<p>Amazon SageMaker以其强大的功能特性和灵活的配置选项，为数据科学家、业务分析师以及广大开发者提供了全面、高效的机器学习解决方案。</p> 
<p>首先，Amazon SageMaker能够让不同背景的用户都能够轻松利用机器学习进行创新。对于数据科学家而言，其提供了功能强大的集成开发环境（IDE），使得他们能够轻松构建、训练和部署复杂的机器学习模型。而对于业务分析师，其提供了无代码界面，即便没有深厚的编程背景，也能通过简单的操作实现机器学习的应用。</p> 
<div> 
 <p class="img-center"><img alt="" height="321" src="https://images2.imgbox.com/49/bd/YEYrx5h5_o.png" width="642"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<p>其次，Amazon SageMaker 支持如 TensorFlow、PyTorch 和 Apache MXNet多种主流的机器学习框架、支持如scikit-learn、XGBoost等各种机器学习工具包、支持Python、R 等多种编程语言，使得用户能够充分利用现有的技术资源和经验，在机器学习领域实现更快速、更高效的创新。无论是数据科学家、机器学习工程师还是开发者，都能从 Amazon SageMaker 中受益，推动机器学习技术的不断发展和应用。</p> 
<div> 
 <p class="img-center"><img alt="" height="166" src="https://images2.imgbox.com/ed/10/1ydsFWQm_o.png" width="630"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<p>最后，Amazon SageMaker拥有完全托管、可扩展的基础设施。用户无需担心底层硬件的维护和扩展问题，只需专注于模型的开发和优化。Amazon SageMaker通过高性能、经济实惠的基础设施支持，帮助用户轻松构建自己的机器学习模型和生成式人工智能应用程序的开发。</p> 
<p>现在进入亚马逊云科技: <a class="link-info" href="https://mic.anruicloud.com/url/1037" rel="nofollow" title="https://mic.anruicloud.com/url/1037">https://mic.anruicloud.com/url/1037</a></p> 
<p>可以获取Studio 笔记本上每月 <strong>250 个小时</strong>的 ml.t3.medium，或者按需笔记本实例上每月 <strong>250 个小时</strong>的 ml.t2 medium 或 ml.t3.medium，每月 <strong>50 个小时</strong>的 m4.xlarge 或<strong>150小时</strong> 的m5.xlarge 实例试用。除此之外，更有云服务器（Amazon EC2），云存储（Amazon S3），负载均衡（Elastic Load Balancing），虚拟服务器VPS（Amazon Lightsail）、视频会议（Amazon Chime ）等等100 余种云产品或服务免费试用。</p> 
<div> 
 <p class="img-center"><img alt="" height="492" src="https://images2.imgbox.com/ea/27/PO342p0y_o.png" width="734"><span title="点击并拖拽以改变尺寸">​</span></p> 
</div> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/624d2a2fc27a918e38518979e929ab26/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">若依微服务跑起来-微服务小白入门（1）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/370d16cbf4a194cb1f4d5bfc86c39b4a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">指令的装载和运行</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>